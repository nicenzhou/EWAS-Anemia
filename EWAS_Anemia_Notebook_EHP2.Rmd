---
title: "EWAS_Anemia_Notes"
author: "Jiayan Zhou"
date: "APR 15h 2022"
output:
  html_notebook: default
  word_document: default
  pdf_document: default
  html_document:
    df_print: paged
---

***

# Preparation
## Read the files and indicate the libraries
* Update the CLARITE Package
* Introduce the Pregnancy Status and other variables
```{r include=FALSE}
#Update the CLARITE package
#devtools::install_github("HallLab/clarite", ref="develop", force = TRUE)
MainTable <- read.csv("~/Desktop/Anemia/Data/MainTable.csv")
VarDescription <- read.csv("~/Desktop/Anemia/Data/VarDescription.csv")
library(clarite)

# Introduce the Pregnancy status and other variables
library(readxl)
UC <- read_excel("~/Desktop/Anemia/Data/UC.xlsx")
UC_B <- read_excel("~/Desktop/Anemia/Data/UC_B.xlsx")
UC_C <- read_excel("~/Desktop/Anemia/Data/UC_C.xlsx")
UCPREG_D <- read_excel("~/Desktop/Anemia/Data/UCPREG_D.xlsx")
SSTFR_A <- read_excel("~/Desktop/Anemia/Data/SSTFR_A.xlsx")
SSTFR_B <- read_excel("~/Desktop/Anemia/Data/SSTFR_B.xlsx")
L06TFR_C <- read_excel("~/Desktop/Anemia/Data/L06TFR_C.xlsx")
FERTIN_D <- read_excel("~/Desktop/Anemia/Data/FERTIN_D.xlsx")

library(SASxport)
library(Hmisc)
LAB06 <- read.xport("~/Desktop/Anemia/Data/LAB06.XPT")
L06_B <- read.xport("~/Desktop/Anemia/Data/L06_B.XPT")
L40FE_B <- read.xport("~/Desktop/Anemia/Data/L40FE_B.XPT")
L39_B <- read.xport("~/Desktop/Anemia/Data/L39_B.XPT")
L06NB_C <- read.xport("~/Desktop/Anemia/Data/L06NB_C.XPT")
L40FE_C <- read.xport("~/Desktop/Anemia/Data/L40FE_C.XPT")
L39EPP_C <- read.xport("~/Desktop/Anemia/Data/L39EPP_C.XPT")
FOLATE_D <- read.xport("~/Desktop/Anemia/Data/FOLATE_D.XPT")
B12_D <- read.xport("~/Desktop/Anemia/Data/B12_D.XPT")
FETIB_D <- read.xport("~/Desktop/Anemia/Data/FETIB_D.XPT")
EPP_D <- read.xport("~/Desktop/Anemia/Data/EPP_D.XPT")
DEMO <- read.xport("~/Desktop/Anemia/Data/DEMO.XPT")
DEMO_B <- read.xport("~/Desktop/Anemia/Data/DEMO_B.XPT")
DEMO_C <- read.xport("~/Desktop/Anemia/Data/DEMO_C.XPT")
DEMO_D <- read.xport("~/Desktop/Anemia/Data/DEMO_D.XPT")
LAB18 <- read.xport("~/Desktop/Anemia/Data/LAB18.XPT")
L40_B <- read.xport("~/Desktop/Anemia/Data/L40_B.XPT")
L40_C <- read.xport("~/Desktop/Anemia/Data/L40_C.XPT")
BIOPRO_D <- read.xport("~/Desktop/Anemia/Data/BIOPRO_D.XPT")
```

```{r}
# Update the functions
library(survey)

# Catch errors from glm and similar, warning instead
warn_on_e <- function(var_name, e){
  warning(paste0("NULL result for ", var_name, " due to: ", e), call=FALSE)
  return(NULL)
}

# Get required data for regressing a specific variable
get_varying_covariates <- function(df, covariates, variable, allowed_nonvarying){
  # Get number of unique values in covariates among observations where the variable is not NA
  cov_counts <- sapply(covariates, function(c) {length(unique(df[!is.na(df[c]) & !is.na(df[variable]), c]))})
  varying_covariates <- covariates[cov_counts >= 2]
  nonvarying_covariates <- covariates[cov_counts <2]
  # Compare to the covariates that are allowed to vary
  not_allowed_nonvarying <- setdiff(nonvarying_covariates, allowed_nonvarying)
  if(length(not_allowed_nonvarying) > 0){
    # Null Result
    print(paste0("    NULL result: Some covariates don't vary when '", variable, "' is not NA and aren't specified as allowed: ",
                 paste(not_allowed_nonvarying, collapse = ", ")))
    return(NULL)
  } else if(length(nonvarying_covariates) > 0){
    # Ignore those
    print(paste0("    Some covariates don't vary when '", variable, "' is not NA but are allowed to do so: ",
                 paste(nonvarying_covariates, collapse = ", ")))
  }
  # Return the list of covariates that are kept
  return(varying_covariates)
}

###Continuous###
regress_cont <- function(data, varying_covariates, outcome, var_name, regression_family){

  # Create a regression formula
  if(length(varying_covariates)>0){
    fmla <- paste(outcome, "~", var_name, "+", paste(varying_covariates, collapse="+"), sep="")
  } else {
    fmla <- paste(outcome, "~", var_name, sep="")
  }

  var_result <- tryCatch(glm(stats::as.formula(fmla),
                             family=regression_family,
                             data=data,
                             na.action=na.omit),
                         error=function(e) warn_on_e(var_name, e))
  # Collect Results
  if (!is.null(var_result)){
    var_summary <- summary(var_result)
    # Update with processed summary results
    # Assume non-convergence if no p values are generated
    num_coeff_cols <- length(var_summary$coefficients)/nrow(var_summary$coefficients)
    if (num_coeff_cols < 4){
      return(NULL)
    } else {
      return(data.frame(
        Converged = TRUE,
        Beta = var_summary$coefficients[2,1],
        SE = var_summary$coefficients[2,2],
        Variable_pvalue = var_summary$coefficients[2,4],
        pval = var_summary$coefficients[2,4]
      ))
    }
  } else{
    return(NULL)
  }
}

regress_cont_survey <- function(data, varying_covariates, outcome, var_name, regression_family,
                                weight_values, strata_values, fpc_values, id_values, subset_array, ...){

  # Create survey design
  if(is.null(id_values)){
    survey_design <- survey::svydesign(ids = ~1,
                                       weights = weight_values,
                                       data = data,
                                       strata = strata_values,
                                       fpc = fpc_values, ...)
  } else{
    survey_design <- survey::svydesign(ids = id_values,
                                       weights = weight_values,
                                       data = data,
                                       strata = strata_values,
                                       fpc = fpc_values, ...)
  }

  # Update subset array to drop NA values of the outcome variable and subset the survey design
  survey_design <- subset(survey_design, subset_array)

  # Create a regression formula
  if(length(varying_covariates)>0){
    fmla <- paste(outcome, "~", var_name, "+", paste(varying_covariates, collapse="+"), sep="")
  } else {
    fmla <- paste(outcome, "~", var_name, sep="")
  }

  var_result <- tryCatch(survey::svyglm(stats::as.formula(fmla), survey_design, family=regression_family, na.action=na.omit),
                         error=function(e) warn_on_e(var_name, e))
  # Collect Results
  if (!is.null(var_result)){
    var_summary <- summary(var_result)
    # Update with processed summary results
    num_coeff_cols <- length(var_summary$coefficients)/nrow(var_summary$coefficients)
    if (num_coeff_cols < 2){
      # Assume non-convergence if no p values are generated
      return(NULL)
    } else if (num_coeff_cols == 2) {
      return(data.frame(
        Converged = TRUE,
        Beta = var_summary$coefficients[2,1],
        SE = var_summary$coefficients[2,2],
        Variable_pvalue = 1.0,
        pval = 1.0
      ))
    } else {
      return(data.frame(
        Converged = TRUE,
        Beta = var_summary$coefficients[2,1],
        SE = var_summary$coefficients[2,2],
        Variable_pvalue = var_summary$coefficients[2,4],
        pval = var_summary$coefficients[2,4]
      ))
    }
  } else{
    return(NULL)
  }
}

###Categorical###
regress_cat <- function(data, varying_covariates, outcome, var_name, regression_family){

  # Create a regression formula and a restricted regression formula
  if(length(varying_covariates)>0){
    fmla <- paste(outcome, "~", var_name, "+", paste(varying_covariates, collapse="+"), sep="")
    fmla_restricted <- paste(outcome, "~", paste(varying_covariates, collapse="+"), sep="")
  } else {
    fmla <- paste(outcome, "~", var_name, sep="")
    fmla_restricted <- paste(outcome, "~1", sep="")
  }

  # Run GLM Functions
  var_result <- tryCatch(glm(stats::as.formula(fmla), family=regression_family, data=data, na.action=na.omit),
                         error=function(e) warn_on_e(var_name, e))
  # Only run if the full model did not have an error (isn't NULL)
  if(!is.null(var_result)){
    restricted_result <- tryCatch(glm(stats::as.formula(fmla_restricted), family=regression_family,
                                      data=var_result$model),  # Use the same data as the full model
                                  error=function(e) warn_on_e(var_name, e))
  } else {
    restricted_result <- NULL
  }

  if(!is.null(restricted_result)){
    # Get the LRT using anova
    lrt <- list(p=NA)  # Start with NA for p in case anova fails
    tryCatch(lrt <- anova(var_result, restricted_result, test = "LRT"), error=function(e) warn_on_e(var_name, e))
    return(data.frame(
      Converged = var_result$converged,
      LRT_pvalue = lrt$`Pr(>Chi)`[2],
      Diff_AIC = var_result$aic - restricted_result$aic,
      pval = lrt$`Pr(>Chi)`[2]
    ))
  } else {
    return(NULL)
  }
}


regress_cat_survey <- function(data, varying_covariates, outcome, var_name, regression_family,
                               weight_values, strata_values, fpc_values, id_values, subset_array, ...) {

  # Create survey design
  if(is.null(id_values)){
    survey_design <- survey::svydesign(ids = ~1,
                                       weights = weight_values,
                                       data = data,
                                       strata = strata_values,
                                       fpc = fpc_values, ...)
  } else{
    survey_design <- survey::svydesign(ids = id_values,
                                       weights = weight_values,
                                       data = data,
                                       strata = strata_values,
                                       fpc = fpc_values, ...)
  }
  # Subset the survey design.  Including where the variable is NA to ensure same data is used for both models.
  subset_array <- subset_array & !is.na(data[var_name])
  survey_design <- subset(survey_design, subset_array)

  # Create a regression formula and a restricted regression formula
  if(length(varying_covariates)>0){
    fmla <- paste(outcome, "~", var_name, "+", paste(varying_covariates, collapse="+"), sep="")
    fmla_restricted <- paste(outcome, "~", paste(varying_covariates, collapse="+"), sep="")
  } else {
    fmla <- paste(outcome, "~", var_name, sep="")
    fmla_restricted <- paste(outcome, "~1", sep="")
  }

  # Results using surveyglm
  survey_design <<- survey_design  # needed to make the anova function work
  regression_family <<- regression_family  # needed to make the anova function work
  var_result <- tryCatch(survey::svyglm(stats::as.formula(fmla), design=survey_design, family=regression_family, na.action=na.omit),
                         error=function(e) warn_on_e(var_name, e))
  # Restricted result uses the design from the full result to ensure the same observations are used.
  # Otherwise some dropped by 'na.omit' may be included in the restricted model.
  # Only run if the full model did not have an error (isn't NULL)
  if(!is.null(var_result)){
    restricted_result <- tryCatch(survey::svyglm(stats::as.formula(fmla_restricted), design=var_result$survey.design,
                                                 family=regression_family),
                                  error=function(e) warn_on_e(var_name, e))
  } else {
    restricted_result <- NULL
  }

  # Collect results if restricted_result is not NULL
  if(!is.null(restricted_result)){
    # Get the LRT using anova
    lrt <- list(p=NA)  # Start with NA for p in case anova fails
    tryCatch(lrt <- anova(var_result, restricted_result, method = "LRT"), error=function(e) warn_on_e(var_name, e))
    return(data.frame(
      Converged = var_result$converged,
      LRT_pvalue = lrt$p,
      pval = lrt$p
    ))
  } else {
    return(NULL)
  }
}

# General Regression function which applies some filters/tests before calling the actual regression
regress <- function(data, y, var_name, covariates, min_n, allowed_nonvarying, regression_family, var_type,
                    use_survey, single_weight, weights, strata, fpc, ids, subset_array, drop_unweighted, ...){
  # The result list will be used to update results for this variable
  result = list()

  # Figure out which observations will drop due to NAs
  subset_data <- complete.cases(data[, c(y, var_name, covariates)])  # Returns a boolean array
  if(!is.null(subset_array)){
    subset_data <- subset_data & subset_array
  }

  # Gather survey info if needed
  if(use_survey){
    # Get weight
    if(single_weight){
      weight <- weights
    } else {
      weight <- weights[[var_name]]
    }

    # Record weight name
    if(is.null(weight)){
      warning(paste(var_name, " had a NULL result because no weight was specified"))
      return(NULL)
    } else {
      result$weight <- weight
    }
    # Get weight values, returning early if there is a problem with the weight
    if(!(weight %in% names(data))){
      # Weight values are missing
      warning(paste(var_name, " had a NULL result because its weight (", weight, ") was not found"))
      result$weight <- paste(weight, " (not found)")
      return(data.frame(result, stringsAsFactors = FALSE))
    }
    missing_weight_count <- sum(!is.na(data[var_name]) & is.na(data[weight]) & subset_data)
    if(missing_weight_count > 0){
      # Some weights in the subset are missing when the variable is not
      warning(paste(var_name, " had a NULL result because its weight (", weight, ") had ", missing_weight_count, " missing values when the variable was not missing"))
      result$weight <- paste0(weight, " (", missing_weight_count, " observations are missing weights)")
      if (!drop_unweighted){
        # Return early with no result if dropping unweighted was not enabled
        return(data.frame(result, stringsAsFactors = FALSE))
      } else {
        # Drop rows with missing weights
        subset_data <- subset_data & !(!is.na(data[var_name]) & is.na(data[weight]))
      }
    }
    # Get weights
    weight_values <- data[weight]
    # Fill NA weight values with 0 to pass an internal check by survey
    weight_values[is.na(weight_values),] <- 0

    # Load strata, fpc, and ids
    if(!is.null(strata)){
      strata_values <- data[strata]
    } else {
      strata_values <- NULL
    }
    if(!is.null(fpc)){
      fpc_values <- data[fpc]
    } else {
      fpc_values <- NULL
    }
    if(!is.null(ids)){
      id_values <- data[ids]
    } else {
      id_values <- NULL
    }
  }
  
  # Skip regression if any covariates are constant (after removing NAs) without being specified as allowed
  varying_covariates <- get_varying_covariates(data[subset_data,], covariates, var_name, allowed_nonvarying)
  # If 'get_varying_covarites' returned NULL it found a nonvarying covariate the wasn't allowed)
  if (is.null(varying_covariates) && !is.null(covariates)){
    return(data.frame(result, stringsAsFactors = FALSE))
  }

  # Record N and skip regression if the min_n filter isn't met
  non_na_obs <- sum(subset_data)
  result$N <- non_na_obs
  if (non_na_obs < min_n){
    warning(paste(var_name, " had a NULL result due to the min_n filter (", non_na_obs, " < ", min_n, ")"))
    return(data.frame(result, stringsAsFactors = FALSE))
  }

  # Run Regression for the single variable
  if(!use_survey){
    if(var_type == 'bin'){
      regression_result <- regress_cont(data, varying_covariates, outcome=y, var_name, regression_family)
    } else if(var_type == 'cat'){
      regression_result <- regress_cat(data, varying_covariates, outcome=y, var_name, regression_family)
    } else if(var_type == 'cont'){
      regression_result <- regress_cont(data, varying_covariates, outcome=y, var_name, regression_family)
    }
  } else {
    if(var_type == 'bin'){
      regression_result <- regress_cont_survey(data, varying_covariates, outcome=y, var_name, regression_family,
                                               weight_values, strata_values, fpc_values, id_values,
                                               subset_data, ...)
    } else if(var_type == 'cat'){
      regression_result <- regress_cat_survey(data, varying_covariates, outcome=y, var_name, regression_family,
                                              weight_values, strata_values, fpc_values, id_values,
                                              subset_data, ...)
    } else if(var_type == 'cont'){
      regression_result <- regress_cont_survey(data, varying_covariates, outcome=y, var_name, regression_family,
                                               weight_values, strata_values, fpc_values, id_values,
                                               subset_data, ...)
    }
  }
  # Update result with the regression results
  if(!is.null(regression_result)){
    regression_result[names(result)] <- result
  } else {
    regression_result <- data.frame(result, stringsAsFactors = FALSE)
  }

  # Return
  return(regression_result)

}


#' ewas
#'
#' Run environment-wide association study, optionally using \code{\link[survey]{svydesign}} from the \pkg{survey} package
#' Note: It is possible to specify \emph{ids} and/or \emph{strata}.  When \emph{ids} is specified without \emph{strata},
#' the standard error is infinite and the anova calculation for categorical variables fails.  This is due to the
#' \href{http://r-survey.r-forge.r-project.org/survey/exmample-lonely.html}{lonely psu} problem.
#' @param d data.frame containing all of the data
#' @param bin_vars List of variables to regress that are binary
#' @param cat_vars List of variables to regress that are categorical
#' @param cont_vars  List of variables to regress that are continuous
#' @param y name(s) of response variable(s)
#' @param bin_covars List of covariates that are continuous
#' @param cat_covars List of covariates that are categorical
#' @param cont_covars List of covariates that are continuous
#' @param regression_family family for the regression model as specified in glm ('gaussian' by default)
#' @param allowed_nonvarying list of covariates that are excluded from the regression when they do not vary instead of returning a NULL result.
#' @param min_n minimum number of observations required (after dropping those with NA values) before running the regression (200 by default)
#' @param weights NULL by default (for unweighted).  May be set to a string name of a single weight to use for every variable, or a named list that maps variable names to the weights that should be used for that variable's regression
#' @param ids NULL by default (for no clusters).  May be set to a string name of a column in the data which provides cluster IDs.
#' @param strata NULL by default (for no strata).  May be set to a string name of a column in the data which provides strata IDs.
#' @param fpc NULL by default (for no fpc).  May be set to a string name of a column in the data which provides fpc values.
#' @param subset_array NULL by default (for no subset).  May be set to a boolean array used to subset the data after creating the design
#' @param ... other arguments passed to svydesign which are ignored if 'weights' is NULL
#' @return data frame containing following fields Variable, Sample Size, Converged, SE, Beta, Variable p-value, LRT, AIC, pval, outcome, weight
#' @export
#' @family analysis functions
#' @examples
#' \dontrun{
#' ewas(d, cat_vars, cont_vars, y, cat_covars, cont_covars, regression_family)
#' }
ewas <- function(d, bin_vars=NULL, cat_vars=NULL, cont_vars=NULL, y,
                 bin_covars=NULL, cat_covars=NULL, cont_covars=NULL,
                 regression_family="gaussian", allowed_nonvarying=NULL, min_n=200, weights=NULL,
                 ids=NULL, strata=NULL, fpc=NULL, subset_array=NULL, ...){
  # Record start time
  t1 <- Sys.time()

  # Validate inputs
  #################
  if(missing(y)){
    stop("Please specify an outcome 'y' variable")
  }
  if(is.null(bin_vars)){
    bin_vars <- list()
  }
  if(is.null(cat_vars)){
    cat_vars <- list()
  }
  if(is.null(cont_vars)){
    cont_vars <- list()
  }
  if(is.null(bin_covars)){
    bin_covars <- list()
  }
  if(is.null(cat_covars)){
    cat_covars <- list()
  }
  if(is.null(cont_covars)){
    cont_covars <- list()
  }
  if(is.null(allowed_nonvarying)){
    allowed_nonvarying <- list()
  }
  if(!is.null(ids)){
    if(!(ids %in% colnames(d))){
      stop(paste("'ids' was specified (", ids, ") but not found in the data", sep=""))
    }
  }
  if(!is.null(strata)){
    if(!(strata %in% colnames(d))){
      stop(paste("'strata' was specified (", strata, ") but not found in the data", sep=""))
    }
  }
  if(!is.null(fpc)){
    if(!(fpc %in% colnames(d))){
      stop(paste("'fpc' was specified (", fpc, ") but not found in the data", sep=""))
    }
  }
  if(!is.null(ids) && is.null(strata) && is.null(fpc)){
    warning("PSU IDs were specified without strata or fpc, preventing calculation of standard error")
  }

  # Ignore the covariates, outcome, and ID if they were included in the variable lists
  remove <- c(y, bin_covars, cat_covars, cont_covars, "ID")
  bin_vars <- setdiff(bin_vars, remove)
  cat_vars <- setdiff(cat_vars, remove)
  cont_vars <- setdiff(cont_vars, remove)
  # Ignore the outcome, and ID if they were included in the covariates lists
  remove <- c(y, "ID")
  bin_covars <- setdiff(bin_covars, remove)
  cat_covars <- setdiff(cat_covars, remove)
  cont_covars <- setdiff(cont_covars, remove)

  # Check data
  if(class(d)[1] != "data.frame"){
    stop("Data must be a data.frame object")
  }

  # Check weights
  if(is.null(weights)){
    print("Running EWAS without a survey design adjustment")
    use_survey <- FALSE
  } else if(class(weights) == "character"){
    single_weight <- TRUE
    if(!(weights %in% names(d))){
      stop(paste(weights, "was specified as the weight, but was not found in the dataframe", sep=" "))
    }
    print("Running EWAS with a single weight used for all variables")
    use_survey <- TRUE
  } else if(class(weights) == "list"){
    single_weight <- FALSE
    print("Running EWAS with specific weights assigned for each variable")
    use_survey <- TRUE
  } else {
    stop("weights must be a string or a list")
  }

  #Correct the types and check for IDs
  #####################################
  # ID
  if(is.element('ID', names(d))==FALSE){stop("Please add ID to the data as column 1")}
  d$ID <- factor(d$ID)
  # Binary
  if(length(bin_vars) > 0){d[bin_vars] <- lapply(d[bin_vars], factor)}
  if(length(bin_covars) > 0){d[bin_covars] <- lapply(d[bin_covars], factor)}
  # Categorical
  if(length(cat_vars) > 0){d[cat_vars] <- lapply(d[cat_vars], factor)}
  if(length(cat_covars) > 0){d[cat_covars] <- lapply(d[cat_covars], factor)}
  # Continuous
  if(length(cont_vars) > 0){
    if(sum(sapply(d[cont_vars], is.numeric))!=length(cont_vars)){
      # TODO: This isn't right
      non_numeric_cont_vars <- setdiff(cont_vars, names(d[sapply(d, is.numeric)]))
      stop("Some continuous variables are not numeric: ", paste(non_numeric_cont_vars, collapse=", "))
    }
  }
  if (length(cont_covars) > 0){
    if(sum(sapply(d[cont_covars], is.numeric))!=length(cont_covars)){
      non_numeric_cont_covars <- setdiff(cont_covars, names(d[sapply(d, is.numeric)]))
      stop("Some continuous covariates are not numeric: ", paste(non_numeric_cont_covars, collapse=", "))
    }
  }

  # Get a combined vector of covariates (must 'unlist' lists to vectors)
  covariates <- c(unlist(bin_covars), unlist(cat_covars), unlist(cont_covars))

  # Run Regressions
  #################

  # Create a placeholder dataframe for results, anything not updated will be NA
  n <- length(bin_vars) + length(cat_vars) + length(cont_vars)
  ewas_result_df <- data.frame(Variable = character(n),
                               Variable_type = character(n),
                               N = numeric(n),
                               Converged = logical(n),
                               Beta = numeric(n),
                               SE = numeric(n),
                               Variable_pvalue = numeric(n),
                               LRT_pvalue = numeric(n),
                               Diff_AIC = numeric(n),
                               pval = numeric(n),
                               outcome = character(n),
                               weight = character(n),
                               stringsAsFactors = FALSE)
  ewas_result_df[] <- NA  # Fill df with NA values
  ewas_result_df$Converged <- FALSE  # Default to not converged
  i <- 0 # Increment before processing each variable

  # Process binary variables, if any
  print(paste("Processing ", length(bin_vars), " binary variables", sep=""))
  for(var_name in bin_vars){
    # Get new row in the results
    i <- i + 1
    # Update var name and outcome
    ewas_result_df$Variable[i] <- var_name
    ewas_result_df$outcome[i] <- y
    ewas_result_df$Variable_type[i] <- "binary"

    result <- regress(d, y, var_name, covariates, min_n, allowed_nonvarying, regression_family, var_type="bin",
                      use_survey, single_weight, weights, strata, fpc, ids, subset_array, ...)

    # Save results
    if(!is.null(result)){
      ewas_result_df[i, colnames(result)] <- result
    }
  }

  # Process categorical variables, if any
  print(paste("Processing ", length(cat_vars), " categorical variables", sep=""))
  for(var_name in cat_vars){
    # Get new row in the results
    i <- i + 1
    # Update var name and outcome
    ewas_result_df$Variable[i] <- var_name
    ewas_result_df$outcome[i] <- y
    ewas_result_df$Variable_type[i] <- "categorical"

    result <- regress(d, y, var_name, covariates, min_n, allowed_nonvarying, regression_family, var_type="cat",
                      use_survey, single_weight, weights, strata, fpc, ids, subset_array, ...)

    # Save results
    if(!is.null(result)){
      ewas_result_df[i, colnames(result)] <- result
    }
  }

  # Process continuous variables, if any
  print(paste("Processing ", length(cont_vars), " continuous variables", sep=""))
  for(var_name in cont_vars){
    # Get new row in the results
    i <- i + 1
    # Update var name and outcome
    ewas_result_df$Variable[i] <- var_name
    ewas_result_df$outcome[i] <- y
    ewas_result_df$Variable_type[i] <- "continuous"

    result <- regress(d, y, var_name, covariates, min_n, allowed_nonvarying, regression_family, var_type="cont",
                      use_survey, single_weight, weights, strata, fpc, ids, subset_array, ...)

    # Save results
    if(!is.null(result)){
      ewas_result_df[i, colnames(result)] <- result
    }
  }

  t2 <- Sys.time()
  print(paste("Finished in", round(as.numeric(difftime(t2,t1, units="secs")), 6), "secs", sep=" "))
  n_null_results <- sum(is.null(ewas_result_df$pval))
  if (n_null_results > 0){
    warning(paste(n_null_results, "of", nrow(ewas_result_df), "variables had a NULL result due to an error (see earlier warnings for details)"))
  }

  # Sort by pval
  ewas_result_df <- ewas_result_df[order(ewas_result_df$pval),]

  # Replace NA with 'None' for correct conversion back to Pandas format
  ewas_result_df[is.na(ewas_result_df)]='None'

  return(ewas_result_df)
}

ewas_pval_adjust = function (ewas_result, bonferroni = TRUE, fdr = TRUE) 
{
    t1 <- Sys.time()
    expected_col_names <- list("Variable", "N", "Converged", 
        "Beta", "SE", "Variable_pvalue", "pval", "LRT_pvalue", 
        "Diff_AIC", "outcome")
    missing_col_names <- setdiff(expected_col_names, names(ewas_result))
    if (length(missing_col_names) > 0) {
        stop("Missing expected columns from the input ewas_result dataframe: ", 
            paste(missing_col_names, collapse = ", "))
    }
    if (bonferroni) {
        ewas_result$pvalue_Bonf <- stats::p.adjust(ewas_result$pval, 
            method = "bonferroni")
        ewas_result <- ewas_result[order(ewas_result$pvalue_Bonf), 
            ]
    }
    if (fdr) {
        ewas_result$pvalue_FDR <- stats::p.adjust(ewas_result$pval, 
            method = "fdr")
        ewas_result <- ewas_result[order(ewas_result$pvalue_FDR), 
            ]
    }
    t2 <- Sys.time()
    print(paste("Finished in", round(as.numeric(difftime(t2, 
        t1, units = "secs")), 6), "secs", sep = " "))
    return(ewas_result)
}

eman_o = function (d, ewas = TRUE, groups = NULL, line = NULL, title = NULL, 
          morecolors = FALSE, file = "eman", hgt = 7, wi = 12, res = 300) 
{
  t1 <- Sys.time()
  print("Running...")
  if (!requireNamespace(c("ggplot2"), quietly = TRUE) == TRUE) {
    stop("Please install ggplot2 to create visualization.", 
         call. = FALSE)
  }
  gap_size <- 4
  if (ewas == TRUE) {
    if ("Variable_pvalue" %in% names(d) & "LRT_pvalue" %in% 
        names(d)) {
      d$pvalue <- ifelse(!is.na(d$Variable_pvalue), d$Variable_pvalue, 
                         ifelse(!is.na(d$LRT_pvalue), d$LRT_pvalue, NA))
    }
    else if ("Variable_pvalue" %in% names(d)) {
      d$pvalue <- d$Variable_pvalue
    }
    else if ("LRT_pvalue" %in% names(d)) {
      d$pvalue <- d$LRT_pvalue
    }
  }
  if (is.null(groups) == TRUE) {
    if ("Shape" %in% names(d)) {
      p <- ggplot2::ggplot() + ggplot2::geom_point(data = d, 
                                                   aes(x = factor(Variable), y = -log10(pvalue), 
                                                       shape = factor(Shape)))
      p <- p + ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90, 
                                                                  hjust = 0.95, vjust = 0.2), axis.title.x = ggplot2::element_blank(), 
                              legend.position = "bottom", legend.title = ggplot2::element_blank())
    }
    else {
      p <- ggplot2::ggplot(d, aes(x = factor(Variable), 
                                  y = -log10(pvalue)))
      p <- p + ggplot2::geom_point()
      p <- p + ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90), 
                              axis.title.x = ggplot2::element_blank())
    }
  }
  else {
    subd <- d[, colnames(d) %in% c("Variable", "pvalue", 
                                   "Shape")]
    colnames(groups)[2] <- "Color"
    dg <- merge(subd, groups, by = "Variable")
    dg_order <- dg[order(dg$Color, dg$Variable), ]
    dg_order$Variable <- factor(dg_order$Variable, levels = unique(dg_order$Variable))
    dg_order$Color <- factor(dg_order$Color, levels = unique(dg_order$Color))
    dg_order$pos_index <- as.integer(dg_order$Variable) + 
      (gap_size * as.integer(dg_order$Color))
    maxRows <- by(dg_order, dg_order$Color, function(x) x[which.max(x$pos_index), 
                                                          ])
    minRows <- by(dg_order, dg_order$Color, function(x) x[which.min(x$pos_index), 
                                                          ])
    milimits <- do.call(rbind, minRows)
    malimits <- do.call(rbind, maxRows)
    lims <- merge(milimits, malimits, by = "Color")
    if ("Shape" %in% names(dg)) {
      names(lims) <- c("Color", "Varx", "px", "Shapex", 
                       "posmin", "Vary", "py", "Shapey", "posmax")
    }
    else {
      names(lims) <- c("Color", "Varx", "px", "posmin", 
                       "Vary", "py", "posmax")
    }
    lims$av <- (lims$posmin + lims$posmax)/2
    lims$shademap <- rep(c("shade_ebebeb", "shade_fffff"), 
                         each = 1, length = nrow(lims))
    ncolors <- nlevels(lims$Color)
    if (morecolors == TRUE) {
      if (!requireNamespace(c("RColorBrewer"), quietly = TRUE) == 
          TRUE) {
        stop("Please install RColorBrewer to add color attribute.", 
             call. = FALSE)
      }
      getPalette = grDevices::colorRampPalette(RColorBrewer::brewer.pal(11, 
                                                                        "Spectral"))
      newcols <- c(getPalette(ncolors), "#EBEBEB", "#FFFFFF")
    }
    else {
      newcols <- c(rep(x = c("#53868B", "#4D4D4D"), length.out = ncolors, 
                       each = 1), "#EBEBEB", "#FFFFFF")
    }
    names(newcols) <- c(levels(factor(lims$Color)), levels(factor(lims$shademap)))
    p <- ggplot2::ggplot() + ggplot2::geom_rect(data = lims, 
                                                aes(xmin = posmin - gap_size/2 - 0.5, xmax = posmax + 
                                                      gap_size/2 + 0.5, ymin = 0, ymax = Inf, fill = factor(shademap)), 
                                                alpha = 0.7)
    if ("Shape" %in% names(dg)) {
      p <- p + ggplot2::geom_point(data = dg_order, aes(x = pos_index, 
                                                        y = -log10(pvalue), color = Color, shape = factor(Shape)))
    }
    else {
      p <- p + ggplot2::geom_point(data = dg_order, aes(x = pos_index, 
                                                        y = -log10(pvalue), color = Color))
    }
    p <- p + ggplot2::scale_x_continuous(breaks = lims$av, 
                                         labels = lims$Color, expand = c(0, 0))
    p <- p + ggplot2::geom_hline(yintercept = -log10(0.05), colour="red")
    p <- p + ggplot2::geom_rect(data = lims, aes(xmin = posmin - 
                                                   gap_size/2 - 0.5, xmax = posmax + gap_size/2 + 0.5, 
                                                 ymin = -Inf, ymax = 0, fill = Color), alpha = 1)
    p <- p + ggplot2::scale_colour_manual(name = "Color", 
                                          values = newcols, ggplot2::guides(alpha = "none"))
    p <- p + ggplot2::scale_fill_manual(name = "Color", values = newcols, 
                                        ggplot2::guides(alpha = "none"))
    p <- p + ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90, 
                                                                hjust = 0.95, vjust = 0.2), panel.grid.minor.x = ggplot2::element_blank(), 
                            panel.grid.major.x = ggplot2::element_blank(), axis.title.x = ggplot2::element_blank(), 
                            legend.position = "bottom", legend.title = ggplot2::element_blank())
    p <- p+guides(color = "none", size = "none", fill = "none")
  }
  p <- p + ggplot2::ggtitle(title) + ggplot2::ylab(expression(paste("-log"[10], 
                                                                    "(adjusted p-value)", sep = "")))
  if (!is.null(line)) {
    p <- p + ggplot2::geom_hline(yintercept = -log10(line), 
                                 colour = "red")
  }
  print(paste("Saving plot to ", file, ".png", sep = ""))
  ggplot2::ggsave(p, filename = paste(file, ".png", sep = ""), 
                  dpi = res, units = "in", height = hgt, width = wi)
  print(p)
  t2 <- Sys.time()
  print(paste("Finished in", round(as.numeric(difftime(t2, 
                                                       t1, units = "secs")), 6), "secs", sep = " "))
  return(p)
}

eman <- function (d, ewas = TRUE, groups = NULL, line = NULL, title = NULL, 
                  morecolors = FALSE, file = "eman", hgt = 7, wi = 12, res = 300) 
{
  t1 <- Sys.time()
  print("Running...")
  if (!requireNamespace(c("ggplot2"), quietly = TRUE) == TRUE) {
    stop("Please install ggplot2 to create visualization.", 
         call. = FALSE)
  }
  gap_size <- 4
  if (ewas == TRUE) {
    if ("Variable_pvalue" %in% names(d) & "LRT_pvalue" %in% 
        names(d)) {
      d$pvalue <- ifelse(!is.na(d$Variable_pvalue), d$Variable_pvalue, 
                         ifelse(!is.na(d$LRT_pvalue), d$LRT_pvalue, NA))
    }
    else if ("Variable_pvalue" %in% names(d)) {
      d$pvalue <- d$Variable_pvalue
    }
    else if ("LRT_pvalue" %in% names(d)) {
      d$pvalue <- d$LRT_pvalue
    }
  }
  if (is.null(groups) == TRUE) {
    if ("Shape" %in% names(d)) {
      p <- ggplot2::ggplot() + ggplot2::geom_point(data = d, 
                                                   aes(x = factor(Variable), y = -log10(pvalue), 
                                                       shape = factor(Shape)))
      p <- p + ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90, 
                                                                  hjust = 0.95, vjust = 0.2), axis.title.x = ggplot2::element_blank(), 
                              legend.position = "bottom", legend.title = ggplot2::element_blank())
    }
    else {
      p <- ggplot2::ggplot(d, aes(x = factor(Variable), 
                                  y = -log10(pvalue)))
      p <- p + ggplot2::geom_point()
      p <- p + ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90), 
                              axis.title.x = ggplot2::element_blank())
    }
  }
  else {
    subd <- d[, colnames(d) %in% c("Variable", "pvalue", 
                                   "Shape")]
    colnames(groups)[2] <- "Color"
    dg <- merge(subd, groups, by = "Variable")
    dg_order <- dg[order(dg$Color, dg$Variable), ]
    dg_order$Variable <- factor(dg_order$Variable, levels = unique(dg_order$Variable))
    dg_order$Color <- factor(dg_order$Color, levels = unique(dg_order$Color))
    dg_order$pos_index <- as.integer(dg_order$Variable) + 
      (gap_size * as.integer(dg_order$Color))
    maxRows <- by(dg_order, dg_order$Color, function(x) x[which.max(x$pos_index), 
                                                          ])
    minRows <- by(dg_order, dg_order$Color, function(x) x[which.min(x$pos_index), 
                                                          ])
    milimits <- do.call(rbind, minRows)
    malimits <- do.call(rbind, maxRows)
    lims <- merge(milimits, malimits, by = "Color")
    if ("Shape" %in% names(dg)) {
      names(lims) <- c("Color", "Varx", "px", "Shapex", 
                       "posmin", "Vary", "py", "Shapey", "posmax")
    }
    else {
      names(lims) <- c("Color", "Varx", "px", "posmin", 
                       "Vary", "py", "posmax")
    }
    lims$av <- (lims$posmin + lims$posmax)/2
    lims$shademap <- rep(c("shade_ebebeb", "shade_fffff"), 
                         each = 1, length = nrow(lims))
    ncolors <- nlevels(lims$Color)
    if (morecolors == TRUE) {
      if (!requireNamespace(c("RColorBrewer"), quietly = TRUE) == 
          TRUE) {
        stop("Please install RColorBrewer to add color attribute.", 
             call. = FALSE)
      }
      getPalette = grDevices::colorRampPalette(RColorBrewer::brewer.pal(11, 
                                                                        "Spectral"))
      newcols <- c(getPalette(ncolors), "#EBEBEB", "#FFFFFF")
    }
    else {
      newcols <- c(rep(x = c("#53868B", "#4D4D4D"), length.out = ncolors, 
                       each = 1), "#EBEBEB", "#FFFFFF")
    }
    names(newcols) <- c(levels(factor(lims$Color)), levels(factor(lims$shademap)))
    p <- ggplot2::ggplot() + ggplot2::geom_rect(data = lims, 
                                                aes(xmin = posmin - gap_size/2 - 0.5, xmax = posmax + 
                                                      gap_size/2 + 0.5, ymin = 0, ymax = Inf, fill = factor(shademap)), 
                                                alpha = 0.7)
    if ("Shape" %in% names(dg)) {
      p <- p + ggplot2::geom_point(data = dg_order, aes(x = pos_index, 
                                                        y = -log10(pvalue), color = Color, shape = factor(Shape)))
    }
    else {
      p <- p + ggplot2::geom_point(data = dg_order, aes(x = pos_index, 
                                                        y = -log10(pvalue), color = Color))
    }
    p <- p + ggplot2::scale_x_continuous(breaks = lims$av, 
                                         labels = lims$Color, expand = c(0, 0))
    #p <- p + ggplot2::scale_y_continuous(name="Discovery", sec.axis = sec_axis(~ 1*., name="Repliation"))
    p <- p + ggplot2::geom_hline(yintercept = -log10(0.1), colour="red")
    p <- p + ggplot2::geom_hline(yintercept = -log10(0.05), colour="blue")
    p <- p + ggplot2::geom_rect(data = lims, aes(xmin = posmin - 
                                                   gap_size/2 - 0.5, xmax = posmax + gap_size/2 + 0.5, 
                                                 ymin = -Inf, ymax = 0, fill = Color), alpha = 1)
    p <- p + ggplot2::scale_colour_manual(name = "Color", 
                                          values = newcols, ggplot2::guides(alpha = "none"))
    p <- p + ggplot2::scale_fill_manual(name = "Color", values = newcols, 
                                        ggplot2::guides(alpha = "none"))
    p <- p + ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90, 
                                                                hjust = 0.95, vjust = 0.2), panel.grid.minor.x = ggplot2::element_blank(), 
                            panel.grid.major.x = ggplot2::element_blank(), axis.title.x = ggplot2::element_blank(), 
                            legend.position = "bottom", legend.title = ggplot2::element_blank())
    
    p <- p+guides(color = "none", size = "none", fill = "none")
  }
  p <- p + ggplot2::ggtitle(title) + ggplot2::ylab(expression(paste("-log"[10], 
                                                                    "(adjusted p-value)", sep = "")))
  if (!is.null(line)) {
    p <- p + ggplot2::geom_hline(yintercept = -log10(line), 
                                 colour = "red")
  }
  print(paste("Saving plot to ", file, ".png", sep = ""))
  ggplot2::ggsave(p, filename = paste(file, ".png", sep = ""), 
                  dpi = res, units = "in", height = hgt, width = wi)
  print(p)
  t2 <- Sys.time()
  print(paste("Finished in", round(as.numeric(difftime(t2, 
                                                       t1, units = "secs")), 6), "secs", sep = " "))
  return(p)
}
```

## Incooperate the extra variables to the Main Table
* UC:Pregnancy test
* LBXFER_adjusted: Adjust the reading of the LBXFER due to the technological difference for yr99-02 and yr03-06
* Folate RBC in SI unit
* Folate Serum in SI unit
* Vitmin B12 in SI unit
* Protoporphyrin in SI unit
* Iron Frozen in SI unit
* Iron Serum in SI unit
* WYINT weight 2yrs and 4yrs

```{r}
##Combined UC results and remove NA
UC_ALL <- rbind(UC, UC_B, UC_C, UCPREG_D)
UC_ALL <- na.omit(UC_ALL)

##Divided to based on series
y99_00 <- MainTable[MainTable$SDDSRVYR < 1.5, ]
y01_02 <- MainTable[MainTable$SDDSRVYR > 1.5 & MainTable$SDDSRVYR < 2.5, ]
y03_04 <- MainTable[MainTable$SDDSRVYR > 2.5 & MainTable$SDDSRVYR < 3.5, ]
y05_06 <- MainTable[MainTable$SDDSRVYR > 3.5 & MainTable$SDDSRVYR < 4.5, ]
y99_02 <- rbind(y99_00, y01_02)
y03_06 <- rbind(y03_04, y05_06)

##Separte Ferritin base on years for correcting the readings from technology differences
LBXFER99_02 <- as.data.frame(cbind(y99_02$SEQN, y99_02$LBXFER))
colnames(LBXFER99_02)[1] <- "SEQN"
colnames(LBXFER99_02)[2] <- "LBXFER"

completeFun <- function(data, desiredCols) {
  completeVec <- complete.cases(data[, desiredCols])
  return(data[completeVec, ])
} #Function to remove the individuals who have the NA in certain variable

LBXFER99_02 <- completeFun(LBXFER99_02, "LBXFER")

LBXFER03_06 <- as.data.frame(cbind(y03_06$SEQN, y03_06$LBXFER))
colnames(LBXFER03_06)[1] <- "SEQN"
colnames(LBXFER03_06)[2] <- "LBXFER"

##Focus the ferritin level for 99_02
LBXFER99_02_lessEqual25 <- LBXFER99_02[LBXFER99_02$LBXFER <= 25,]
LBXFER99_02_25to65 <- LBXFER99_02[LBXFER99_02$LBXFER >25 & LBXFER99_02$LBXFER <= 65,]
LBXFER99_02_more65 <- LBXFER99_02[LBXFER99_02$LBXFER > 65,]

##Convert serum ferritin to new techn
LBXFER99_02_LE25_C <- as.data.frame(LBXFER99_02_lessEqual25$LBXFER*1.2534+1.4683)
LBXFER99_02_LE25_f <- as.data.frame(cbind(LBXFER99_02_lessEqual25[,1], LBXFER99_02_LE25_C[,1]))
colnames(LBXFER99_02_LE25_f)[1] <- "SEQN"
colnames(LBXFER99_02_LE25_f)[2] <- "LBXFER"
LBXFER99_02_25to65_C <- as.data.frame(LBXFER99_02_25to65[,2]*1.2001+1.4693)
LBXFER99_02_25to65_f <- as.data.frame(cbind(LBXFER99_02_25to65[,1], LBXFER99_02_25to65_C[,1]))
colnames(LBXFER99_02_25to65_f)[1] <- "SEQN"
colnames(LBXFER99_02_25to65_f)[2] <- "LBXFER"
LBXFER99_02_more65_C <- as.data.frame(LBXFER99_02_more65[,2]*1.0791+4.8183)
LBXFER99_02_more65_f <- as.data.frame(cbind(LBXFER99_02_more65[,1], LBXFER99_02_more65_C[,1]))
colnames(LBXFER99_02_more65_f)[1] <- "SEQN"
colnames(LBXFER99_02_more65_f)[2] <- "LBXFER"

##Combine adjusted serum ferritin for 1999 to 2002
LBXFER99_02_adjuested <- rbind(LBXFER99_02_LE25_f, LBXFER99_02_25to65_f, LBXFER99_02_more65_f)

##Create the list for combining to the main_table
UC_T <- matrix(c(1:41474), nrow = 41474, ncol = 1)
UC_T <- as.data.frame(UC_T)
colnames(UC_T) <- "SEQN"
UC_T$URXPREG <- UC_ALL$URXPREG[match(UC_T$SEQN, UC_ALL$SEQN)]

LBXFER_T <- matrix(c(1:21004), nrow = 21004, ncol = 1)
LBXFER_T <- as.data.frame(LBXFER_T)
colnames(LBXFER_T) <- "SEQN"
LBXFER_T$LBXFER <- LBXFER99_02_adjuested$LBXFER[match(LBXFER_T$SEQN, LBXFER99_02_adjuested$SEQN)]
LBXFER_Adjusted <- rbind.data.frame(LBXFER_T,LBXFER03_06)

##Combine the PREG-Status and serum ferritin to the main-table
Main_table <- cbind(MainTable, UC_T[,2], LBXFER_Adjusted[,2])
colnames(Main_table)[1192] <- "URXPREG"
colnames(Main_table)[1193] <- "LBXFER_Adjusted"

##Add the transferrin receptor for y99-02, values for pregnant women only
LBXTFRT <- as.matrix(cbind.data.frame(MainTable$SEQN, MainTable$LBXTFR))
colnames(LBXTFRT)[1] <- "SEQN"
colnames(LBXTFRT)[2] <- "LBXTFR"
colnames(SSTFR_A)[2] <- "LBXTFR"
colnames(SSTFR_B)[2] <- "LBXTFR"
LBXTFRTs1s2 <- rbind.data.frame(SSTFR_A,SSTFR_B)
LBXTFRTs1s2 <- LBXTFRTs1s2[,c(1,2)]
LBXTFRTs1s2 <- rbind.data.frame(LBXTFRTs1s2, LBXTFRT[c(20977:41474),])
LBXTFRTa <- matrix(c(1:41474), nrow = 41474, ncol = 1)
LBXTFRTa <- as.data.frame(LBXTFRTa)
colnames(LBXTFRTa) <- "SEQN"
LBXTFRTa$LBXTFR_A <- LBXTFRTs1s2$LBXTFR[match(LBXTFRTa$SEQN, LBXTFRTs1s2$SEQN)]
Main_table <- cbind(Main_table, LBXTFRTa[,2])
colnames(Main_table)[1194] <- "LBXTFR_F"
colnames(Main_table)[1] <- "ID"

#Combine the Folate, RBC (LBDRBFSI in nmol/L or nM) to the Main_table
LBDRBFSI99_00 <- as.data.frame(cbind(LAB06$SEQN,LAB06$LBDRBFSI))
LBDRBFSI01_02 <- as.data.frame(cbind(L06_B$SEQN,L06_B$LBDRBFSI))
LBDRBFSI03_04 <- as.data.frame(cbind(L06NB_C$SEQN,L06NB_C$LBDRBFSI))
LBDRBFSI05_06 <- as.data.frame(cbind(FOLATE_D$SEQN,FOLATE_D$LBDRBFSI))

LBDRBFSI <- rbind(LBDRBFSI99_00 , LBDRBFSI01_02, LBDRBFSI03_04, LBDRBFSI05_06)
colnames(LBDRBFSI)[1] <- "ID"
colnames(LBDRBFSI)[2] <- "LBDRBFSI"

Main_table <- clarite::merge_data(Main_table, LBDRBFSI)

#Combine the Folate, Serum (LBDFOLSI in nmol/L or nM) to the Main_table
LBDFOLSI99_00 <- as.data.frame(cbind(LAB06$SEQN,LAB06$LBDFOLSI))
LBDFOLSI01_02 <- as.data.frame(cbind(L06_B$SEQN,L06_B$LBDFOLSI))
LBDFOLSI03_04 <- as.data.frame(cbind(L06NB_C$SEQN,L06NB_C$LBDFOLSI))
LBDFOLSI05_06 <- as.data.frame(cbind(FOLATE_D$SEQN,FOLATE_D$LBDFOLSI))

LBDFOLSI <- rbind(LBDFOLSI99_00 , LBDFOLSI01_02, LBDFOLSI03_04, LBDFOLSI05_06)
colnames(LBDFOLSI)[1] <- "ID"
colnames(LBDFOLSI)[2] <- "LBDFOLSI"

Main_table <- clarite::merge_data(Main_table, LBDFOLSI)

#Combine the Vitamin B12, Serum (LBDB12SI in nmol/L or nM) to the Main_table
LBDB12SI99_00 <- as.data.frame(cbind(LAB06$SEQN,LAB06$LBDB12SI))
LBDB12SI01_02 <- as.data.frame(cbind(L06_B$SEQN,L06_B$LBDB12SI))
LBDB12SI03_04 <- as.data.frame(cbind(L06NB_C$SEQN,L06NB_C$LBDB12SI))
LBDB12SI05_06 <- as.data.frame(cbind(B12_D$SEQN,B12_D$LBDB12SI))

LBDB12SI <- rbind(LBDB12SI99_00 , LBDB12SI01_02, LBDB12SI03_04, LBDB12SI05_06)
colnames(LBDB12SI)[1] <- "ID"
colnames(LBDB12SI)[2] <- "LBDB12SI"

Main_table <- clarite::merge_data(Main_table, LBDB12SI)

#Combine the Iron Frozen, Serum (LBDIRNSI in umol/L or uM) to the Main_table
LBDIRNSI99_00 <- as.data.frame(cbind(LAB06$SEQN,LAB06$LBDIRNSI))
LBDIRNSI01_02 <- as.data.frame(cbind(L40FE_B$SEQN,L40FE_B$LBDIRNSI))
LBDIRNSI03_04 <- as.data.frame(cbind(L40FE_C$SEQN,L40FE_C$LBDIRNSI))
LBDIRNSI05_06 <- as.data.frame(cbind(FETIB_D$SEQN,FETIB_D$LBDIRNSI))

LBDIRNSI <- rbind(LBDIRNSI99_00 , LBDIRNSI01_02, LBDIRNSI03_04, LBDIRNSI05_06)
colnames(LBDIRNSI)[1] <- "ID"
colnames(LBDIRNSI)[2] <- "LBDIRNSI"

Main_table <- clarite::merge_data(Main_table, LBDIRNSI)

#Combine the Iron refg, Serum (LBDSIRSI in umol/L or uM) to the Main_table
LBDSIRSI99_00 <- as.data.frame(cbind(LAB18$SEQN,LAB18$LBDSIRSI))
LBDSIRSI01_02 <- as.data.frame(cbind(L40_B$SEQN,L40_B$LBDSIRSI))
LBDSIRSI03_04 <- as.data.frame(cbind(L40_C$SEQN,L40_C$LBDSIRSI))
LBDSIRSI05_06 <- as.data.frame(cbind(BIOPRO_D$SEQN,BIOPRO_D$LBDSIRSI))

LBDSIRSI <- rbind(LBDSIRSI99_00 , LBDSIRSI01_02, LBDSIRSI03_04, LBDSIRSI05_06)
colnames(LBDSIRSI)[1] <- "ID"
colnames(LBDSIRSI)[2] <- "LBDSIRSI"

Main_table <- clarite::merge_data(Main_table, LBDSIRSI)

#Combine the Protoporphyrin (LBDEPPSI in umol/L or uM) to the Main_table
LBDEPPSI99_00 <- as.data.frame(cbind(LAB06$SEQN,LAB06$LBDEPPSI))
LBDEPPSI01_02 <- as.data.frame(cbind(L39_B$SEQN,L39_B$LBDEPPSI))
LBDEPPSI03_04 <- as.data.frame(cbind(L39EPP_C$SEQN,L39EPP_C$LBDEPPSI))
LBDEPPSI05_06 <- as.data.frame(cbind(EPP_D$SEQN,EPP_D$LBDEPPSI))

LBDEPPSI <- rbind(LBDEPPSI99_00 , LBDEPPSI01_02, LBDEPPSI03_04, LBDEPPSI05_06)
colnames(LBDEPPSI)[1] <- "ID"
colnames(LBDEPPSI)[2] <- "LBDEPPSI"

Main_table <- clarite::merge_data(Main_table, LBDEPPSI)

#Combine the Interview/Examination Status (RIDSTATR) to the Main_table
RIDSTATR99_00 <- as.data.frame(cbind(DEMO$SEQN,DEMO$RIDSTATR))
RIDSTATR01_02 <- as.data.frame(cbind(DEMO_B$SEQN,DEMO_B$RIDSTATR))
RIDSTATR03_04 <- as.data.frame(cbind(DEMO_C$SEQN,DEMO_C$RIDSTATR))
RIDSTATR05_06 <- as.data.frame(cbind(DEMO_D$SEQN,DEMO_D$RIDSTATR))

RIDSTATR <- rbind(RIDSTATR99_00 , RIDSTATR01_02, RIDSTATR03_04, RIDSTATR05_06)
colnames(RIDSTATR)[1] <- "ID"
colnames(RIDSTATR)[2] <- "RIDSTATR"

Main_table <- clarite::merge_data(Main_table, RIDSTATR)

#Combine the WEIGHTS (WTINT2Y) to the Main_table
WEIGHTS99_00 <- as.data.frame(cbind(DEMO$SEQN, DEMO$WTINT2YR))
WEIGHTS01_02 <- as.data.frame(cbind(DEMO_B$SEQN, DEMO_B$WTINT2YR))
WEIGHTS03_04 <- as.data.frame(cbind(DEMO_C$SEQN, DEMO_C$WTINT2YR))
WEIGHTS05_06 <- as.data.frame(cbind(DEMO_D$SEQN, DEMO_D$WTINT2YR))

WEIGHTS <- rbind(WEIGHTS99_00 , WEIGHTS01_02, WEIGHTS03_04, WEIGHTS05_06)
colnames(WEIGHTS)[1] <- "ID"
colnames(WEIGHTS)[2] <- "WTINT2YR"

Main_table <- clarite::merge_data(Main_table, WEIGHTS)

#Combine the WEIGHTS_4Y (WTINT4Y_99_02) to the Main_table
WEIGHTS_4Y_99_00 <- as.data.frame(cbind(DEMO$SEQN, DEMO$WTINT4YR))
WEIGHTS_4Y_01_02 <- as.data.frame(cbind(DEMO_B$SEQN, DEMO_B$WTINT4YR))

WEIGHTS_4Y_99_02 <- rbind(WEIGHTS_4Y_99_00 , WEIGHTS_4Y_01_02)
colnames(WEIGHTS_4Y_99_02)[1] <- "ID"
colnames(WEIGHTS_4Y_99_02)[2] <- "WTINT4YR"

Main_table <- clarite::merge_data(Main_table, WEIGHTS_4Y_99_02)
```

##Load Survey Weight
* Variables and corresponded weights
* Values for weigths in discovery (yr99-02) and replication (yr03-06)
```{r}
#Read the files for variables and their related survey weights
VarWeight <- read.csv("~/Desktop/Anemia/Data/VarWeight_updated.csv")
VarWeight <- completeFun(VarWeight, "Series1.2")
VarWeight <- completeFun(VarWeight, "Series3.4")
VarWeight_URXPREG <- data.frame("URXPREG", "WTMEC4YR","WTMEC4YR")
names(VarWeight_URXPREG)<- c("Variable", "Series1.2", "Series3.4")
VarWeight_discovery <- rbind(VarWeight, VarWeight_URXPREG)
weights_discovery <- read.delim("~/Desktop/Anemia/Data/weights_discovery.txt")
weights_replication <- read.delim("~/Desktop/Anemia/Data/weights_replication.txt")

# Get survey info
survey_design_discovery <- weights_discovery
colnames(survey_design_discovery)[1] <- "ID"
survey_design_discovery <- colfilter(survey_design_discovery, c("SDDSRVYR"), exclude=TRUE)

survey_design_replication <- weights_replication
colnames(survey_design_replication)[1] <- "ID" 
survey_design_replication <- colfilter(survey_design_replication, c("SDDSRVYR"), exclude=TRUE)

# Get weight mapping data
var_weights <- VarWeight
weights_discovery <- setNames(as.list(var_weights$`Series1.2`), as.list(var_weights$Variable))
weights_replication <- setNames(as.list(var_weights$`Series3.4`), as.list(var_weights$Variable))

# Divide replication weights by 2 to get 4 year weights
survey_design_replication[,-(1:4)] <- survey_design_replication[,-(1:4)] / 2

# 8 year-weight
# Divide replication weights by 2 to get 4 year weights
survey_design_8yrs <- read.csv("~/Desktop/Anemia/Data/survey_design_8yrs.csv")
VarWeight_8 <- read_excel("~/Desktop/Anemia/Data/VarWeight_8.xlsx")
VarWeight_8 <- completeFun(VarWeight_8, "Series1.4")
weights_8yrs <- setNames(as.list(VarWeight_8$`Series1.4`), as.list(VarWeight_8$Variable))
```

***

#Anemia Case Identification
##Determination of the Anemia cases in general
```{r}
##Number of individual in each year for all population
length(which(Main_table$SDDSRVYR == "1"))
length(which(Main_table$SDDSRVYR == "2"))
length(which(Main_table$SDDSRVYR == "3"))
length(which(Main_table$SDDSRVYR == "4"))

##Divide by sex
male <- Main_table[Main_table$male > 0,]
female <- Main_table[Main_table$female > 0,]

##Number of individual based on gander in each year for all population
length(which(male$SDDSRVYR == "1"))
length(which(male$SDDSRVYR == "2"))
length(which(male$SDDSRVYR == "3"))
length(which(male$SDDSRVYR == "4"))

length(which(female$SDDSRVYR == "1"))
length(which(female$SDDSRVYR == "2"))
length(which(female$SDDSRVYR == "3"))
length(which(female$SDDSRVYR == "4"))

##Divide by Age
male0_5 <- male[male$RIDAGEYR < 5,]
male5_12 <- male[male$RIDAGEYR >= 5 & male$RIDAGEYR < 12,]
male12_15 <- male[male$RIDAGEYR >= 12 & male$RIDAGEYR < 15,]
male15_R <- male[male$RIDAGEYR >= 15,]

female0_5 <- female[female$RIDAGEYR < 5,]
female5_12 <- female[female$RIDAGEYR >= 5 & female$RIDAGEYR < 12,]
female12_15 <- female[female$RIDAGEYR >= 12 & female$RIDAGEYR < 15,]
female15_R <- female[female$RIDAGEYR >= 15,]

##Determine the pregnancy status
female15_R["URXPREG"][is.na(female15_R["URXPREG"])] <- 0
PREG_None <- female15_R[female15_R$URXPREG < 0.5,]
PREG_Positive <- female15_R[female15_R$URXPREG > 0.5 & female15_R$URXPREG < 1.5,]
PREG_Negative <- female15_R[female15_R$URXPREG > 1.5 & female15_R$URXPREG < 2.5,]
PREG_NotDone <- female15_R[female15_R$URXPREG > 2.5 & female15_R$URXPREG < 3.5,]
PREG_Invalid <- female15_R[female15_R$URXPREG > 3.5 & female15_R$URXPREG < 4.5,]
female15_R_PREG_Y <- PREG_Positive
female15_R_PREG_N <- rbind(PREG_None, PREG_Negative, PREG_NotDone, PREG_Invalid)

##Remove indivudiuals with NA for hemoglobin
completeFun <- function(data, desiredCols) {
  completeVec <- complete.cases(data[, desiredCols])
  return(data[completeVec, ])
}

male0_5_DA <- completeFun(male0_5, "LBXHGB")
male5_12_DA <- completeFun(male5_12, "LBXHGB")
male12_15_DA <- completeFun(male12_15, "LBXHGB")
male15_R_DA <- completeFun(male15_R, "LBXHGB")

female0_5_DA <- completeFun(female0_5, "LBXHGB")
female5_12_DA <- completeFun(female5_12, "LBXHGB")
female12_15_DA <- completeFun(female12_15, "LBXHGB")
female15_R_PREG_Y_DA <- completeFun(female15_R_PREG_Y, "LBXHGB")
female15_R_PREG_N_DA <- completeFun(female15_R_PREG_N, "LBXHGB")

##Individuals with value for Hemoglobin
Hemoglobin_Y <- rbind.data.frame(male0_5_DA, male5_12_DA, male12_15_DA, male15_R_DA, female0_5_DA, female5_12_DA, female12_15_DA, female15_R_PREG_Y_DA, female15_R_PREG_N_DA)

##Determine the case and control for anemia
all0_5 <- rbind.data.frame(male0_5_DA, female0_5_DA)
all0_5_A <- all0_5[all0_5$LBXHGB <= 11.0, ]
all0_5_NA <- all0_5[all0_5$LBXHGB > 11.0, ]

all5_12 <- rbind.data.frame(male5_12_DA, female5_12_DA)
all5_12_A <- all5_12[all5_12$LBXHGB <= 11.5, ]
all5_12_NA <- all5_12[all5_12$LBXHGB > 11.5, ]

all12_15 <- rbind.data.frame(male12_15_DA, female12_15_DA)
all12_15_A <- all12_15[all12_15$LBXHGB <= 12.0, ]
all12_15_NA <- all12_15[all12_15$LBXHGB > 12.0, ]

male15_R_A <- male15_R_DA[male15_R_DA$LBXHGB <= 13.0, ]
male15_R_NA <- male15_R_DA[male15_R_DA$LBXHGB > 13.0, ]

female15_R_PREG_Y_A <- female15_R_PREG_Y_DA[female15_R_PREG_Y_DA$LBXHGB <= 11.0, ]
female15_R_PREG_Y_NA <- female15_R_PREG_Y_DA[female15_R_PREG_Y_DA$LBXHGB > 11.0, ]

female15_R_PREG_N_A <- female15_R_PREG_N_DA[female15_R_PREG_N_DA$LBXHGB <= 12.0, ]
female15_R_PREG_N_NA <- female15_R_PREG_N_DA[female15_R_PREG_N_DA$LBXHGB > 12.0, ]

Anemia_case <- rbind.data.frame(all0_5_A, all5_12_A, all12_15_A, male15_R_A, female15_R_PREG_Y_A, female15_R_PREG_N_A)
Anemia_control <- rbind.data.frame(all0_5_NA, all5_12_NA, all12_15_NA, male15_R_NA, female15_R_PREG_Y_NA, female15_R_PREG_N_NA)

##Count the number of people with/without anemia in different years
length(which(Anemia_case$SDDSRVYR == "1"))
length(which(Anemia_case$SDDSRVYR == "2"))
length(which(Anemia_case$SDDSRVYR == "3"))
length(which(Anemia_case$SDDSRVYR == "4"))

length(which(Anemia_control$SDDSRVYR == "1"))
length(which(Anemia_control$SDDSRVYR == "2"))
length(which(Anemia_control$SDDSRVYR == "3"))
length(which(Anemia_control$SDDSRVYR == "4"))
```

##Classification of the Anemia Cases into categories
* VB12 Deficiency Anemia

###Determine the VB12 Deficiency Anemia
```{r}
Anemia_case_B12 <- completeFun(Anemia_case, "LBDB12SI")
Anemia_case_B12_Y <- Anemia_case_B12[Anemia_case_B12$LBDB12SI < 147.56, ]

length(which(Anemia_case_B12_Y$SDDSRVYR == "1"))
length(which(Anemia_case_B12_Y$SDDSRVYR == "2"))
length(which(Anemia_case_B12_Y$SDDSRVYR == "3"))
length(which(Anemia_case_B12_Y$SDDSRVYR == "4"))
```

###Determine the Folate Deficiency Anemia
```{r}
Anemia_case_group <- completeFun(Anemia_case, "RIDSTATR")
Anemia_case_group <- completeFun(Anemia_case_group, "LBDRBFSI")
Anemia_case_group <- completeFun(Anemia_case_group, "ID")
Anemia_case_home <- Anemia_case_group[Anemia_case_group$RIDSTATR == 1, ]
Anemia_case_home <- completeFun(Anemia_case_home, "ID")
Anemia_case_MEC <- Anemia_case_group[Anemia_case_group$RIDSTATR == 2, ]
Anemia_case_MEC <- completeFun(Anemia_case_MEC, "ID")

Anemia_case_folate_Y <- Anemia_case_MEC[Anemia_case_MEC$LBDRBFSI < 232.49, ]

length(which(Anemia_case_folate_Y$SDDSRVYR == "1"))
length(which(Anemia_case_folate_Y$SDDSRVYR == "2"))
length(which(Anemia_case_folate_Y$SDDSRVYR == "3"))
length(which(Anemia_case_folate_Y$SDDSRVYR == "4"))
```

###Determine the Iron Deficiency Anemia
```{r}
Anemia_case_IDA_TF <- completeFun(Anemia_case, "LBDPCT")
Anemia_case_IDA_TF <- completeFun(Anemia_case_IDA_TF, "SDDSRVYR")
Anemia_case_IDA_TF_Y <- Anemia_case_IDA_TF[Anemia_case_IDA_TF$LBDPCT < 15, ]
Anemia_case_IDA_TF_SF <- completeFun(Anemia_case_IDA_TF_Y, "LBXFER")
Anemia_case_IDA_TF_SF_Y <- Anemia_case_IDA_TF_SF[Anemia_case_IDA_TF_SF$LBXFER < 12, ]

Anemia_case_IDA_TF_SF_N <- Anemia_case_IDA_TF_SF[Anemia_case_IDA_TF_SF$LBXFER >= 12, ]
Anemia_case_IDA_TF_SF_EP_Y <- Anemia_case_IDA_TF_SF_N[Anemia_case_IDA_TF_SF_N$LBDEPPSI > 1.24, ]

Anemia_case_IDA_TF_N <- Anemia_case_IDA_TF[Anemia_case_IDA_TF$LBDPCT >= 15, ]
Anemia_case_IDA_TF_N_SF <- Anemia_case_IDA_TF_N[Anemia_case_IDA_TF_N$LBXFER < 12, ]
Anemia_case_IDA_TF_N_SF_EP_Y <- Anemia_case_IDA_TF_N_SF[Anemia_case_IDA_TF_N_SF$LBDEPPSI > 1.24, ]

Anemia_case_IDA <- rbind(Anemia_case_IDA_TF_SF_Y, Anemia_case_IDA_TF_SF_EP_Y, Anemia_case_IDA_TF_N_SF_EP_Y)
Anemia_case_IDA_Distinct <- dplyr::distinct(Anemia_case_IDA)
Anemia_case_IDA_Distinct <- completeFun(Anemia_case_IDA_Distinct, "SDDSRVYR")

length(which(Anemia_case_IDA_Distinct$SDDSRVYR == "1"))
length(which(Anemia_case_IDA_Distinct$SDDSRVYR == "2"))
length(which(Anemia_case_IDA_Distinct$SDDSRVYR == "3"))
length(which(Anemia_case_IDA_Distinct$SDDSRVYR == "4"))
```

###Nutrient Deficiency Anemia in total
```{r}
Anemia_case_NDA <- rbind(Anemia_case_B12_Y, Anemia_case_folate_Y, Anemia_case_IDA_Distinct)
Anemia_case_NDA_Distinct <- dplyr::distinct(Anemia_case_NDA)
Anemia_case_NDA_Distinct <- completeFun(Anemia_case_NDA_Distinct, "SDDSRVYR")

length(which(Anemia_case_NDA_Distinct$SDDSRVYR == "1"))
length(which(Anemia_case_NDA_Distinct$SDDSRVYR == "2"))
length(which(Anemia_case_NDA_Distinct$SDDSRVYR == "3"))
length(which(Anemia_case_NDA_Distinct$SDDSRVYR == "4"))
```

###Undefined Anemia
```{r}
Undefined_Anemia <- Anemia_case[!(Anemia_case$ID %in% Anemia_case_NDA_Distinct$ID),]
```

###Chronic Kidney Disease Related Anemia
```{r}
UA_M <- Undefined_Anemia
UA_M <- completeFun(UA_M, "ID")
UA_M <- completeFun(UA_M, "RIDAGEYR")
UA_M <- completeFun(UA_M, "LBXSCR")
UA_M <- completeFun(UA_M, "female")
UA_M <- completeFun(UA_M, "black")

GFR_table <- as.data.frame(cbind(UA_M$ID, UA_M$RIDAGEYR, UA_M$LBXSCR, UA_M$female, UA_M$black))
colnames(GFR_table)[1] <- "ID"
colnames(GFR_table)[2] <- "RIDAGEYR"
colnames(GFR_table)[3] <- "LBXSCR"
colnames(GFR_table)[4] <- "female"
colnames(GFR_table)[5] <- "black"

GFR_table$female[GFR_table$female == "1"] <- "0.742"
GFR_table$female[GFR_table$female == "0"] <- "1"
GFR_table$black [GFR_table$black == "1"] <- "1.21"
GFR_table$black [GFR_table$black == "0"] <- "1"

a <- as.data.frame((GFR_table$LBXSCR)^(-1.154))
b <- as.data.frame((GFR_table$RIDAGEYR)^(-0.203))
GFR_F <- as.data.frame(as.numeric(GFR_table$female))
GFR_b <- as.data.frame(as.numeric(GFR_table$black))
eGFR_cal <- as.data.frame(186.3*a*b*(GFR_F)*(GFR_b))
eGFR <- cbind.data.frame(GFR_table$ID, eGFR_cal)
colnames(eGFR)[1] <- "ID"
colnames(eGFR)[2] <- "eGFR"

UA_M$eGFR <- eGFR$eGFR[match(eGFR$ID, UA_M$ID)]

##Determine the Chornic Kidney Deficiency related Anemia
CKDA <- UA_M[UA_M$eGFR < 60, ]
length(which(CKDA$SDDSRVYR == "1"))
length(which(CKDA$SDDSRVYR == "2"))
length(which(CKDA$SDDSRVYR == "3"))
length(which(CKDA$SDDSRVYR == "4"))
```

###Determine the Chornic Disease related Anemia
```{r}
##Iron Deficiency omit for the Undefined Anemia individuals
UA_BI <- Undefined_Anemia
UA_BI <- completeFun(UA_BI, "ID")
UA_BI <- completeFun(UA_BI, "LBXFER_Adjusted")
UA_BI <- completeFun(UA_BI, "LBXTFR_F")

BI_table <- as.data.frame(cbind(UA_BI$ID, UA_BI$LBXFER_Adjusted, UA_BI$LBXTFR))
colnames(BI_table)[1] <- "ID"
colnames(BI_table)[2] <- "LBXFER_Adjusted"
colnames(BI_table)[3] <- "LBXTFR_F"

FsTfR <- as.data.frame(1000*((BI_table$LBXTFR_F)*1.5+0.35))
SF_A <- as.data.frame(BI_table$LBXFER_Adjusted)
TBI <- as.data.frame((-(log10(FsTfR/SF_A)-2.8229))/0.1207)

TBI_Table <- cbind.data.frame(BI_table$ID, TBI)
colnames(TBI_Table)[1] <- "ID"
colnames(TBI_Table)[2] <- "TBI"

UA_BI$TBI <- TBI_Table$TBI[match(TBI_Table$ID, UA_BI$ID)]

##Determine the Chornic Disease related Anemia
UA_ID_Y <- UA_BI[UA_BI$TBI > 0, ]
UA_ID_Y_1 <- completeFun(UA_ID_Y, "LBDSIRSI")
CIA_1 <- UA_ID_Y[UA_ID_Y$LBDSIRSI < 10.74, ]

UA_ID_Y_2 <- UA_ID_Y[!(UA_ID_Y$ID %in% UA_ID_Y_1$ID),]
UA_ID_Y_2 <- completeFun(UA_ID_Y_2, "LBDIRNSI")
CIA_2 <- UA_ID_Y_2[UA_ID_Y_2$LBDIRNSI < 10.74, ]

CIA <- rbind.data.frame(CIA_1, CIA_2)
CIA <- completeFun(CIA, "ID")

length(which(CIA$SDDSRVYR == "1"))
length(which(CIA$SDDSRVYR == "2"))
length(which(CIA$SDDSRVYR == "3"))
length(which(CIA$SDDSRVYR == "4"))

##Determine the Unexplained Anemia
CKDA_Ad <- CKDA[,-(length(colnames(Main_table))+1)]
CIA_Ad <- CIA[,-(length(colnames(Main_table))+1)]
Explained_A <- rbind(CKDA_Ad, CIA_Ad)
Explained_A_Distinct <- dplyr::distinct(Explained_A)
Explained_A_Distinct <- completeFun(Explained_A_Distinct, "SDDSRVYR")
Unexplained_Anemia <- Undefined_Anemia[!(Undefined_Anemia$ID %in% Explained_A_Distinct$ID),]
Unexplained_Anemia <- completeFun(Unexplained_Anemia, "SDDSRVYR")

length(which(Unexplained_Anemia$SDDSRVYR == "1"))
length(which(Unexplained_Anemia$SDDSRVYR == "2"))
length(which(Unexplained_Anemia$SDDSRVYR == "3"))
length(which(Unexplained_Anemia$SDDSRVYR == "4"))
```

***
#Anemia control identification and quality control

## Supplement intake checks
* Supplements in Iron, Vitamin B12, and Folic Ascids
```{r}
##Control standard check
iron_ryco <- completeFun(Anemia_control, "IRON_mg")
VB12_ryco <- completeFun(Anemia_control, "VITAMIN_B_12_mcg")
FA_ryco <- completeFun(Anemia_control,"FOLIC_ACID_mcg")

iron_ryco_0 <- iron_ryco[iron_ryco$IRON_mg == 0, ]
length(iron_ryco_0$IRON_mg)
iron_ryco_N0 <- iron_ryco[!(iron_ryco$ID %in% iron_ryco_0$ID),]
length(iron_ryco_N0$IRON_mg)
VB12_ryco_0 <- VB12_ryco[VB12_ryco$VITAMIN_B_12_mcg == 0, ]
length(VB12_ryco_0$VITAMIN_B_12_mcg)
VB12_ryco_N0 <- VB12_ryco[!(VB12_ryco$ID %in% VB12_ryco_0$ID),]
length(VB12_ryco_N0$VITAMIN_B_12_mcg)
FA_ryco_0 <- FA_ryco[FA_ryco$FOLIC_ACID_mcg == 0, ]
length(FA_ryco_0$FOLIC_ACID_mcg)
FA_ryco_N0 <- FA_ryco[!(FA_ryco$ID %in% FA_ryco_0$ID),]
length(FA_ryco_N0$FOLIC_ACID_mcg)

iron_ryca <- completeFun(Anemia_case, "IRON_mg")
VB12_ryca <-completeFun(Anemia_case, "VITAMIN_B_12_mcg")
FA_ryca <- completeFun(Anemia_case,"FOLIC_ACID_mcg")

iron_ryca_0 <- iron_ryca[iron_ryca$IRON_mg == 0, ]
length(iron_ryca_0$IRON_mg)
iron_ryca_N0 <- iron_ryca[!(iron_ryca$ID %in% iron_ryca_0$ID),]
length(iron_ryca_N0$IRON_mg)
VB12_ryca_0 <- VB12_ryca[VB12_ryca$VITAMIN_B_12_mcg == 0, ]
length(VB12_ryca_0$VITAMIN_B_12_mcg)
VB12_ryca_N0 <-  VB12_ryca[!(VB12_ryca$ID %in% VB12_ryca_0$ID),]
length(VB12_ryca_N0$VITAMIN_B_12_mcg)
FA_ryca_0 <- FA_ryca[FA_ryca$FOLIC_ACID_mcg == 0, ]
length(FA_ryca_0$FOLIC_ACID_mcg)
FA_ryca_N0 <- FA_ryca[!(FA_ryca$ID %in% FA_ryca_0$ID),]
length(FA_ryca_N0$FOLIC_ACID_mcg)

hist.default(log(iron_ryca_N0$IRON_mg), main = "Iron Cases None Zero", xlab = "log transformed IRON mg", xlim = c(0,15))
hist.default(log(VB12_ryca_N0$VITAMIN_B_12_mcg), main = "VB12 Cases None Zero", xlab = "log transformed VB12 mcg", xlim = c(0,20))
hist.default(log(FA_ryca_N0$FOLIC_ACID_mcg), main = "FA Cases None Zero", xlab = "log transformed FA mcg", xlim = c(0,25))

hist.default(log(iron_ryco_N0$IRON_mg), main = "Iron Controls None Zero", xlab = "log transformed IRON mg", xlim = c(0,15))
hist.default(log(VB12_ryco_N0$VITAMIN_B_12_mcg), main = "VB12 Controls None Zero", xlab = "log transformed VB12 mcg", xlim = c(0,20))
hist.default(log(FA_ryco_N0$FOLIC_ACID_mcg), main = "FA Controls None Zero", xlab = "log transformed FA mcg", xlim = c(0,25))
```


##Quality-Controls for Control Populaitons
```{r}
##1 Omit Transferrin Saturation < 15% and NA
Anemia_control_LBDPCT_Y <- completeFun(Anemia_control, "LBDPCT")
Anemia_control_LBDPCT_Y_P <- Anemia_control_LBDPCT_Y[Anemia_control_LBDPCT_Y$LBDPCT > 15, ]
Anemia_control_LBDPCT_N <- Anemia_control[!(Anemia_control$ID %in% Anemia_control_LBDPCT_Y$ID),]

Anemia_control_1 <- rbind.data.frame(Anemia_control_LBDPCT_Y_P, Anemia_control_LBDPCT_N)
Anemia_control_1 <- completeFun(Anemia_control_1, "ID")

##2 Omit Serum Ferritin < 12 ng/mL
Anemia_control_1_Less3 <- Anemia_control_1[which(Anemia_control_1$RIDAGEYR < 3),]
Anemia_control_1_3_5 <- Anemia_control_1[which(Anemia_control_1$RIDAGEYR >= 3 & Anemia_control_1$RIDAGEYR <= 5),]
Anemia_control_1_5_12 <- Anemia_control_1[which(Anemia_control_1$RIDAGEYR > 5 & Anemia_control_1$RIDAGEYR < 12),]
Anemia_control_1_More12 <- Anemia_control_1[which(Anemia_control_1$RIDAGEYR >= 12),]
Anemia_control_1_More12_M <- Anemia_control_1_More12[which(Anemia_control_1_More12$female == "0"),]
Anemia_control_1_More12_F <- Anemia_control_1_More12[which(Anemia_control_1_More12$female == "1"),]

Anemia_control_LBXFER_check <- rbind.data.frame(Anemia_control_1_More12_F,Anemia_control_1_3_5)
Anemia_control_LBXFER_nocheck <- rbind.data.frame(Anemia_control_1_Less3,Anemia_control_1_5_12)
Anemia_control_LBXFER_nocheck <- rbind(Anemia_control_LBXFER_nocheck, Anemia_control_1_More12_M)

Anemia_control_LBXFER_Y <- completeFun(Anemia_control_LBXFER_check, "LBXFER")
Anemia_control_LBXFER_Y_P <- Anemia_control_LBXFER_Y[Anemia_control_LBXFER_Y$LBXFER > 12, ]

Anemia_control_LBXFER_All <- rbind.data.frame(Anemia_control_LBXFER_Y_P, Anemia_control_LBXFER_nocheck)

Anemia_control_2 <- completeFun(Anemia_control_LBXFER_All, "ID")
Anemia_control_2 <- dplyr::distinct(Anemia_control_2)

##3 Omit Erythrocyte Protoporphyrin > 1.24 M 

Anemia_control_2_Less3 <- Anemia_control_2[which(Anemia_control_2$RIDAGEYR < 3),]
Anemia_control_2_3_5 <- Anemia_control_2[which(Anemia_control_2$RIDAGEYR >= 3 & Anemia_control_2$RIDAGEYR <= 5),]
Anemia_control_2_5_12 <- Anemia_control_2[which(Anemia_control_2$RIDAGEYR > 5 & Anemia_control_2$RIDAGEYR < 12),]
Anemia_control_2_More12 <- Anemia_control_2[which(Anemia_control_2$RIDAGEYR >= 12),]
Anemia_control_2_More12_M <- Anemia_control_2_More12[which(Anemia_control_2_More12$female == "0"),]
Anemia_control_2_More12_F <- Anemia_control_2_More12[which(Anemia_control_2_More12$female == "1"),]

Anemia_control_LBDEPPSI_check <- rbind.data.frame(Anemia_control_2_More12_F,Anemia_control_2_3_5)
Anemia_control_LBDEPPSI_nocheck <- rbind.data.frame(Anemia_control_2_Less3,Anemia_control_2_5_12)
Anemia_control_LBDEPPSI_nocheck <- rbind(Anemia_control_LBDEPPSI_nocheck, Anemia_control_2_More12_M)

Anemia_control_LBDEPPSI_Y <- completeFun(Anemia_control_LBDEPPSI_check, "LBDEPPSI")
Anemia_control_LBDEPPSI_Y_P <- Anemia_control_LBDEPPSI_Y[Anemia_control_LBDEPPSI_Y$LBDEPPSI < 1.24, ]

Anemia_control_LBDEPPSI_All <- rbind.data.frame(Anemia_control_LBDEPPSI_Y_P, Anemia_control_LBDEPPSI_nocheck)

Anemia_control_3 <- completeFun(Anemia_control_LBDEPPSI_All, "ID")
Anemia_control_3 <- dplyr::distinct(Anemia_control_3)

##4 Omit Serum Vitamin B12 < 147.56pM 
Anemia_control_LBDB12SI_Y <- completeFun(Anemia_control_3, "LBDB12SI")
Anemia_control_LBDB12SI_Y_P <- Anemia_control_LBDB12SI_Y[Anemia_control_LBDB12SI_Y$LBDB12SI > 147.56, ]
Anemia_control_4 <- completeFun(Anemia_control_LBDB12SI_Y_P, "ID")

##5 Omit RBC Folate < 232.49 nM 
Anemia_control_5_Y <- completeFun(Anemia_control_4, "LBDRBFSI")
Anemia_control_5_group <- completeFun(Anemia_control_5_Y, "RIDSTATR")
Anemia_control_5_group <- completeFun(Anemia_control_5_Y, "LBDRBFSI")
Anemia_control_5_group <- completeFun(Anemia_control_5_Y, "ID")
Anemia_control_5_home <- Anemia_control_5_group[Anemia_control_5_group$RIDSTATR == 1, ]
Anemia_control_5_home <- completeFun(Anemia_control_5_home, "ID")
Anemia_control_5_MEC <- Anemia_control_5_group[Anemia_control_5_group$RIDSTATR == 2, ]
Anemia_control_5_MEC <- completeFun(Anemia_control_5_MEC, "ID")

Anemia_control_5_Y_P <- Anemia_control_5_MEC[Anemia_control_5_MEC$LBDRBFSI > 232.49, ]
Anemia_control_5 <- completeFun(Anemia_control_5_Y_P, "ID")

##6 Omit eGFR  < 60 mL/min/1.73 m^2, ignore individuals who do not have the readings
Anemia_control_5 <- completeFun(Anemia_control_5, "ID")
C_GFR <- Anemia_control_5

CGFR_table <- as.data.frame(cbind(C_GFR$ID, C_GFR$RIDAGEYR, C_GFR$LBXSCR, C_GFR$female, C_GFR$black))
colnames(CGFR_table)[1] <- "ID"
colnames(CGFR_table)[2] <- "RIDAGEYR"
colnames(CGFR_table)[3] <- "LBXSCR"
colnames(CGFR_table)[4] <- "female"
colnames(CGFR_table)[5] <- "black"

CGFR_table$female[GFR_table$female == "1"] <- "0.742"
CGFR_table$female[GFR_table$female == "0"] <- "1"
CGFR_table$black [GFR_table$black == "1"] <- "1.21"
CGFR_table$black [GFR_table$black == "0"] <- "1"

CGC <- as.data.frame((CGFR_table$LBXSCR)^(-1.154))
CGC2 <- as.data.frame((CGFR_table$RIDAGEYR)^(-0.203))
CGFR_F <- as.data.frame(as.numeric(CGFR_table$female))
CGFR_b <- as.data.frame(as.numeric(CGFR_table$black))
CeGFR_cal <- as.data.frame(186.3*CGC*CGC2*(CGFR_F)*(CGFR_b))
CeGFR <- cbind.data.frame(CGFR_table$ID, CeGFR_cal)
colnames(CeGFR)[1] <- "ID"
colnames(CeGFR)[2] <- "CeGFR"

C_GFR$CeGFR <- eGFR$eGFR[match(CeGFR$ID, C_GFR$ID)]
C_GFR <- completeFun(C_GFR, "ID")
C_GFR$CeGFR[is.na(C_GFR$CeGFR)] <- 999

C_GFR <- C_GFR[C_GFR$CeGFR > 60, ]
C_GFR <- completeFun(C_GFR, "ID")

Anemia_control_6 <- C_GFR
Anemia_control_6$eGFR[Anemia_control_6$CeGFR == 999] <- NA

##7 Omit IRON_mg > 0 and NA
Anemia_control_6 <- completeFun(Anemia_control_6, "IRON_mg")
Anemia_control_7 <- Anemia_control_6[Anemia_control_6$IRON_mg <= 0, ]

##8 Omit VITAMIN_B_12_mcg > 0 and NA
Anemia_control_7 <- completeFun(Anemia_control_7, "VITAMIN_B_12_mcg")
Anemia_control_8 <- Anemia_control_7[Anemia_control_7$VITAMIN_B_12_mcg <= 0, ]

##9 Omit FOLIC_ACID_mcg > 0 and NA
Anemia_control_8 <- completeFun(Anemia_control_8, "FOLIC_ACID_mcg")
Anemia_control_9 <- Anemia_control_8[Anemia_control_8$FOLIC_ACID_mcg <= 0, ]
Anemia_control_9 <- completeFun(Anemia_control_9, "ID")

##10 Omit Iron Deficiency (TBI < 0 mg/kg), ignore individuals who do not have the readings
CUA_BI <- Anemia_control_9
CUA_BI <- completeFun(CUA_BI, "ID")
CUA_BI <- completeFun(CUA_BI, "LBXFER_Adjusted")
CUA_BI <- completeFun(CUA_BI, "LBXTFR_F")

CBI_table <- as.data.frame(cbind(CUA_BI$ID, CUA_BI$LBXFER_Adjusted, CUA_BI$LBXTFR))
colnames(CBI_table)[1] <- "ID"
colnames(CBI_table)[2] <- "LBXFER_Adjusted"
colnames(CBI_table)[3] <- "LBXTFR_F"

CTBI_NA <- Anemia_control_9[!(Anemia_control_9$ID %in% CBI_table$ID),]

CFsTfR <- as.data.frame(1000*((CBI_table$LBXTFR_F)*1.5+0.35))
CSF_A <- as.data.frame(CBI_table$LBXFER_Adjusted)
CTBI <- as.data.frame((-(log10(CFsTfR/CSF_A)-2.8229))/0.1207)

CTBI_Table <- cbind.data.frame(CBI_table$ID, CTBI)
colnames(CTBI_Table)[1] <- "ID"
colnames(CTBI_Table)[2] <- "eCTBI"
CTBI_Table <- completeFun(CTBI_Table, "ID")

CUA_BI$eCTBI <- CTBI_Table$eCTBI[match(CTBI_Table$ID, CUA_BI$ID)]

CUA_BI <- CUA_BI[CUA_BI$eCTBI > 0, ]
CUA_BI <- completeFun(CUA_BI, "ID")
CUA_BI <- CUA_BI[,-length(names(CUA_BI))]

##Finalizing the Anemia Control QC
Anemia_control_10 <- rbind.data.frame(CUA_BI, CTBI_NA)
Anemia_control_10 <- dplyr::distinct(Anemia_control_10)
Anemia_control_10 <- completeFun(Anemia_control_10, "ID")

Anemia_control_qc <- Anemia_control_10
Anemia_control_qc <- completeFun(Anemia_control_qc, "ID")
length(which(Anemia_control_qc$SDDSRVYR == "1" & Anemia_control_qc$female == "0"))
length(which(Anemia_control_qc$SDDSRVYR == "2" & Anemia_control_qc$female == "0"))
length(which(Anemia_control_qc$SDDSRVYR == "3" & Anemia_control_qc$female == "0"))
length(which(Anemia_control_qc$SDDSRVYR == "4" & Anemia_control_qc$female == "0"))

length(which(Anemia_control_qc$SDDSRVYR == "1"))
length(which(Anemia_control_qc$SDDSRVYR == "2"))
length(which(Anemia_control_qc$SDDSRVYR == "3"))
length(which(Anemia_control_qc$SDDSRVYR == "4"))
```

***

#Logistic Regressions for people with/without Anemia
* Anemic vs non-anemic

#Anemic vs non-anemic
##Anemic vs non-anemic Discovery Group
```{r include=FALSE}
Anemia_case_s1s2 <- Anemia_case[Anemia_case$SDDSRVYR==2 | Anemia_case$SDDSRVYR==1, ]
Anemia_control_qc_s1s2 <- Anemia_control_qc[Anemia_control_qc$SDDSRVYR==2 | Anemia_control_qc$SDDSRVYR==1, ]

colnames(Anemia_case_s1s2)[1] <- "ID"
colnames(Anemia_control_qc_s1s2)[1] <- "ID"
MainTable_keepvar_over18 <- read.delim("~/Desktop/Anemia/Data/MainTable_keepvar_over18.tsv")
keepvar <- dput(names(MainTable_keepvar_over18))
keepvar <- c(paste(keepvar),"SDDSRVYR")
Anemia_case_s1s2_keepvar <- clarite::colfilter(d=Anemia_case_s1s2, cols=keepvar, exclude=F)
Anemia_control_qc_s1s2_keepvar <- clarite::colfilter(d=Anemia_control_qc_s1s2, cols=keepvar, exclude=F)

length(which(Anemia_case_s1s2_keepvar$female == "0"))
length(which(Anemia_case_s1s2_keepvar$female == "1"))
length(which(Anemia_control_qc_s1s2_keepvar$female == "0"))
length(which(Anemia_control_qc_s1s2_keepvar$female == "1"))

Anemia_case_s1s2_Children <- Anemia_case_s1s2_keepvar[Anemia_case_s1s2_keepvar$RIDAGEYR < 15,]
Anemia_case_s1s2_Adults <- Anemia_case_s1s2_keepvar[Anemia_case_s1s2_keepvar$RIDAGEYR >= 15,]

Anemia_control_qc_s1s2_Children <- Anemia_control_qc_s1s2_keepvar[Anemia_control_qc_s1s2_keepvar$RIDAGEYR < 15,]
Anemia_control_qc_s1s2_Adults <- Anemia_control_qc_s1s2_keepvar[Anemia_control_qc_s1s2_keepvar$RIDAGEYR >= 15,]


#Covariates and phenotype
covar_ac <- c("female", "black", "mexican", "other_hispanic", "other_eth", "BMXBMI", "SES_LEVEL", "RIDAGEYR", "SDDSRVYR")
covar_ac_cat <- c("female", "black", "mexican", "other_hispanic", "other_eth", "SES_LEVEL", "SDDSRVYR")
covar_ac_cont <- c("BMXBMI", "RIDAGEYR")

covar_ana <- c("female", "black", "mexican", "other_hispanic", "other_eth", "BMXBMI", "SES_LEVEL", "RIDAGEYR", "SDDSRVYR", "LBXCOT")
covar_ana_cat <- c("female", "black", "mexican", "other_hispanic", "other_eth", "SES_LEVEL", "SDDSRVYR")
covar_ana_cont <- c("BMXBMI", "RIDAGEYR", "LBXCOT")

pheno_ac <- c("anemia")

Anemia_case_s1s2_Children <- remove_incomplete_obs(Anemia_case_s1s2_Children, c(covar_ac))
Anemia_case_s1s2_Adults <- remove_incomplete_obs(Anemia_case_s1s2_Adults, c(covar_ana))
Anemia_control_qc_s1s2_Children <- remove_incomplete_obs(Anemia_control_qc_s1s2_Children, c(covar_ac))
Anemia_control_qc_s1s2_Adults <- remove_incomplete_obs(Anemia_control_qc_s1s2_Adults, c(covar_ana))

##Split into data type
#Get binary varibales into a separate file
Anemia_case_s1s2_Children_bin <- clarite::get_binary(Anemia_case_s1s2_Children)
Anemia_case_s1s2_Adults_bin <- clarite::get_binary(Anemia_case_s1s2_Adults)

Anemia_control_qc_s1s2_Children_bin <- clarite::get_binary(Anemia_control_qc_s1s2_Children)
Anemia_control_qc_s1s2_Adults_bin <- clarite::get_binary(Anemia_control_qc_s1s2_Adults)

#Get categorical variables into a separate file
Anemia_case_s1s2_Children_cat <- clarite::get_categorical(Anemia_case_s1s2_Children)
Anemia_case_s1s2_Adults_cat <- clarite::get_categorical(Anemia_case_s1s2_Adults)

Anemia_control_qc_s1s2_Children_cat <- clarite::get_categorical(Anemia_control_qc_s1s2_Children)
Anemia_control_qc_s1s2_Adults_cat <- clarite::get_categorical(Anemia_control_qc_s1s2_Adults)

#Changes values 7 and 9 using a pipeline format to NA. Cannot decipher meaning of values so make NA.
Anemia_case_s1s2_Adults_cat$SMQ077 <- ifelse(Anemia_case_s1s2_Adults_cat$SMQ077==7 | Anemia_case_s1s2_Adults_cat$SMQ077==9, NA, Anemia_case_s1s2_Adults_cat$SMQ077)

Anemia_control_qc_s1s2_Adults_cat$SMQ077 <- ifelse(Anemia_control_qc_s1s2_Adults_cat$SMQ077==7 | Anemia_control_qc_s1s2_Adults_cat$SMQ077==9, NA, Anemia_control_qc_s1s2_Adults_cat$SMQ077)

#Get continuous variables into a separate file
Anemia_case_s1s2_Children_cont <- clarite::get_continuous(Anemia_case_s1s2_Children)
Anemia_case_s1s2_Adults_cont <- clarite::get_continuous(Anemia_case_s1s2_Adults)

Anemia_control_qc_s1s2_Children_cont <- clarite::get_continuous(Anemia_control_qc_s1s2_Children)
Anemia_control_qc_s1s2_Adults_cont <- clarite::get_continuous(Anemia_control_qc_s1s2_Adults)

#Get ambiguous variables into a separate file
Anemia_case_s1s2_Children_check <- clarite::get_check(Anemia_case_s1s2_Children)
Anemia_case_s1s2_Adults_check <- clarite::get_check(Anemia_case_s1s2_Adults)

Anemia_control_qc_s1s2_Children_check <- clarite::get_check(Anemia_control_qc_s1s2_Children)
Anemia_control_qc_s1s2_Adults_check <- clarite::get_check(Anemia_control_qc_s1s2_Adults)

Anemia_case_s1s2_Children_cont_merge <- c("RIDAGEYR", "LBXBCD", "LBXTO1", "LBXTO2", "LBXPFOA", 
"LBXPFOS", "LBXPFHS", "LBXEPAH", "LBXMPAH", "LBXPFNA", "LBXPFSA", 
"URXMOP", "URXOP6", "LBX028", "LBX066", "LBX074", "LBX118", "LBXD01", 
"LBXD03", "LBXD04", "LBXD05", "LBXD07", "LBXF01", "LBXF02", "LBXF03", 
"LBXF04", "LBXF05", "LBXF06", "LBXF07", "LBXF08", "LBXF10", "LBXPCB", 
"LBXTC2", "LBXHXC", "LBXTCD", "LBX052", "LBX101", "LBX138", "LBX153", 
"LBX170", "LBX180", "LBXHCB", "LBXBHC", "LBXPDT", "LBXODT", "LBXOXY", 
"LBXTNA", "LBXHPE", "URXP08", "URXP11", "URXP12", "URXP15", "URXP16", 
"LBXRST", "URX1TB", "URX25T", "HRDHG", "HRXHG", 
"DR1TALCO", "VITAMIN_B_6_mg", "VITAMIN_B_12_mcg", "VITAMIN_C_mg", 
"VITAMIN_A_IU", "FOLIC_ACID_mcg", "CALCIUM_mg", "IRON_mg", "RIBOFLAVIN_mg", 
"THIAMIN_mg", "URXUUR", "URXP24")
Anemia_case_s1s2_Children_cat_merge <- c("house_age")
Anemia_case_s1s2_Adults_cont_merge <- c("LBXCD4", "LBXCD8", "LBXV3A", "LBXIHG", "LBXPFDE", "LBXPFUA", 
"URXMCP", "URX25T", "quantity_drink_per_day", "DUQ110", 
"RHQ564", "how_long_estrogen_progestin", "SMD220", "SMD100TR", 
"SMD100NI", "SMD100CO", "SMD080", "DRD350HQ", "DRD370BQ", "DRD370DQ", 
"DRD370TQ", "supplement_count", "DSDCOUNT", "TOTAL_CARBOHYDRATE_gm", 
"URXP22", "DRDCWATR")
Anemia_case_s1s2_Adults_cat_merge <- c("house_age")


Anemia_control_s1s2_Children_cont_merge <- c("RIDAGEYR", "LBXIHG", "URXUBE", "URXUPT", "LBXPFHP", 
"LBXTO3", "DRD350BQ", "DRD350HQ", "DRD370AQ", "DRD370BQ", 
"DRD370DQ", "DRD370TQ", "DSDCOUNT", "VITAMIN_A_IU", "CALCIUM_mg", 
"SODIUM_mg", "TOTAL_CARBOHYDRATE_gm", "LBD199", "LBXDIE")
Anemia_control_s1s2_Children_cat_merge <- c("house_age")
Anemia_control_s1s2_Adults_cont_merge <- c("URXUBE", "URXUPT", "LBXTO3", "SMD235", 
"DRD350BQ", "DRD350IQ", "DRD370AQ", "DRD370BQ", "DRD370DQ", "DRD370EQ", 
"DRD370FQ", "DRD370KQ", "DRD370MQ", "DRD370NQ", "DRD370TQ", "DRD370UQ", 
"CHOLESTEROL_mg", "GLYCINE_mg", "PHOSPHORUS_mg", "RIBOFLAVIN_mg", 
"THIAMIN_mg", "LBX189", "LBX087", "LBX149", "LBX151", "LBXALD", 
"LBXEND")
Anemia_control_s1s2_Adults_cat_merge <- c("house_age")


#Remove columns and rename data frame then merge data from ambiguous file into continuous file
Anemia_case_s1s2_Children_contmerged <- clarite::merge_data(Anemia_case_s1s2_Children_cont, Anemia_case_s1s2_Children_check, union=TRUE)
Anemia_case_s1s2_Children_cont_final <- clarite::colfilter(d=Anemia_case_s1s2_Children_contmerged, cols=Anemia_case_s1s2_Children_cat_merge, exclude=T)

Anemia_case_s1s2_Children_catmerged <- clarite::merge_data(Anemia_case_s1s2_Children_cat, Anemia_case_s1s2_Children_check, union=TRUE)
Anemia_case_s1s2_Children_cat_final <- clarite::colfilter(d=Anemia_case_s1s2_Children_catmerged, cols=Anemia_case_s1s2_Children_cont_merge, exclude=T)

Anemia_case_s1s2_Adults_contmerged <- clarite::merge_data(Anemia_case_s1s2_Adults_cont, Anemia_case_s1s2_Adults_check, union=TRUE)
Anemia_case_s1s2_Adults_cont_final <- clarite::colfilter(d=Anemia_case_s1s2_Adults_contmerged, cols=Anemia_case_s1s2_Adults_cat_merge, exclude=T)

Anemia_case_s1s2_Adults_catmerged <- clarite::merge_data(Anemia_case_s1s2_Adults_cat, Anemia_case_s1s2_Adults_check, union=TRUE)
Anemia_case_s1s2_Adults_cat_final <- clarite::colfilter(d=Anemia_case_s1s2_Adults_catmerged, cols=Anemia_case_s1s2_Adults_cont_merge, exclude=T)

Anemia_control_s1s2_Children_contmerged <- clarite::merge_data(Anemia_control_qc_s1s2_Children_cont, Anemia_control_qc_s1s2_Children_check, union=TRUE)
Anemia_control_s1s2_Children_cont_final <- clarite::colfilter(d=Anemia_control_s1s2_Children_contmerged, cols=Anemia_control_s1s2_Children_cat_merge, exclude=T)

Anemia_control_s1s2_Children_catmerged <- clarite::merge_data(Anemia_control_qc_s1s2_Children_cat, Anemia_control_qc_s1s2_Children_check, union=TRUE)
Anemia_control_s1s2_Children_cat_final <- clarite::colfilter(d=Anemia_control_s1s2_Children_catmerged, cols=Anemia_control_s1s2_Children_cont_merge, exclude=T)

Anemia_control_s1s2_Adults_contmerged <- clarite::merge_data(Anemia_control_qc_s1s2_Adults_cont, Anemia_control_qc_s1s2_Adults_check, union=TRUE)
Anemia_control_s1s2_Adults_cont_final <- clarite::colfilter(d=Anemia_control_s1s2_Adults_contmerged, cols=Anemia_control_s1s2_Adults_cat_merge, exclude=T)

Anemia_control_s1s2_Adults_catmerged <- clarite::merge_data(Anemia_control_qc_s1s2_Adults_cat, Anemia_control_qc_s1s2_Adults_check, union=TRUE)
Anemia_control_s1s2_Adults_cat_final <- clarite::colfilter(d=Anemia_control_s1s2_Adults_catmerged, cols=Anemia_control_s1s2_Adults_cont_merge, exclude=T)


#Extract unique values and return vector from columns in data dictionary
desc_info <- unique(VarDescription[, colnames(VarDescription) %in% c("tab_desc", "module", "var", "var_desc")])

#Define functions with labels such as X, N, NNZ...etc and combine objects by rows. Return them out to finish function
get0 <- function(x){
  x <- as.numeric(as.character(x))
  N <- length(x)
  NNZ <- length(x[x>0])
  PZ <- (N-NNZ)/N
  out <- rbind(N=N, NNZ=NNZ, PZ=PZ)
  return(out)
}

#Drop >90% of the samples with get0 function. Combine columns and create data another data frame with PZ as label for dropped variables. Write to text file.
Anemia_case_s1s2_Children_cont_0 <- as.data.frame(t(sapply(Anemia_case_s1s2_Children_cont_final[, -1], get0)))
Anemia_case_s1s2_Children_cont_0 <- cbind(rownames(Anemia_case_s1s2_Children_cont_0), data.frame(Anemia_case_s1s2_Children_cont_0, row.names=NULL))
names(Anemia_case_s1s2_Children_cont_0) <- c("var", "N", "NNZ", "PZ")
Anemia_case_s1s2_Children_cont_full <- merge(Anemia_case_s1s2_Children_cont_0, desc_info, by="var")
Anemia_case_s1s2_Children_cont_full <- Anemia_case_s1s2_Children_cont_full[order(Anemia_case_s1s2_Children_cont_full$PZ, decreasing=TRUE), ]
write.table(Anemia_case_s1s2_Children_cont_full, file="Anemia_case_s1s2_Children_percent_zero_values_series1-2.txt", sep="\t", quote=FALSE, row.names=FALSE)

Anemia_case_s1s2_Adults_cont_0 <- as.data.frame(t(sapply(Anemia_case_s1s2_Adults_cont_final[, -1], get0)))
Anemia_case_s1s2_Adults_cont_0 <- cbind(rownames(Anemia_case_s1s2_Adults_cont_0), data.frame(Anemia_case_s1s2_Adults_cont_0, row.names=NULL))
names(Anemia_case_s1s2_Adults_cont_0) <- c("var", "N", "NNZ", "PZ")
Anemia_case_s1s2_Adults_cont_full <- merge(Anemia_case_s1s2_Adults_cont_0, desc_info, by="var")
Anemia_case_s1s2_Adults_cont_full <- Anemia_case_s1s2_Adults_cont_full[order(Anemia_case_s1s2_Adults_cont_full$PZ, decreasing=TRUE), ]
write.table(Anemia_case_s1s2_Adults_cont_full, file="Anemia_case_s1s2_Adults_percent_zero_values_series1-2.txt", sep="\t", quote=FALSE, row.names=FALSE)


Anemia_control_s1s2_Children_cont_0 <- as.data.frame(t(sapply(Anemia_control_s1s2_Children_cont_final[, -1], get0)))
Anemia_control_s1s2_Children_cont_0 <- cbind(rownames(Anemia_control_s1s2_Children_cont_0), data.frame(Anemia_control_s1s2_Children_cont_0, row.names=NULL))
names(Anemia_control_s1s2_Children_cont_0) <- c("var", "N", "NNZ", "PZ")
Anemia_control_s1s2_Children_cont_full <- merge(Anemia_control_s1s2_Children_cont_0, desc_info, by="var")
Anemia_control_s1s2_Children_cont_full <- Anemia_control_s1s2_Children_cont_full[order(Anemia_control_s1s2_Children_cont_full$PZ, decreasing=TRUE), ]
write.table(Anemia_control_s1s2_Children_cont_full, file="Anemia_control_s1s2_Children_percent_zero_values_series1-2.txt", sep="\t", quote=FALSE, row.names=FALSE)

Anemia_control_s1s2_Adults_cont_0 <- as.data.frame(t(sapply(Anemia_control_s1s2_Adults_cont_final[, -1], get0)))
Anemia_control_s1s2_Adults_cont_0 <- cbind(rownames(Anemia_control_s1s2_Adults_cont_0), data.frame(Anemia_control_s1s2_Adults_cont_0, row.names=NULL))
names(Anemia_control_s1s2_Adults_cont_0) <- c("var", "N", "NNZ", "PZ")
Anemia_control_s1s2_Adults_cont_full <- merge(Anemia_control_s1s2_Adults_cont_0, desc_info, by="var")
Anemia_control_s1s2_Adults_cont_full <- Anemia_control_s1s2_Adults_cont_full[order(Anemia_control_s1s2_Adults_cont_full$PZ, decreasing=TRUE), ]
write.table(Anemia_control_s1s2_Adults_cont_full, file="Anemia_control_s1s2_Adults_percent_zero_values_series1-2.txt", sep="\t", quote=FALSE, row.names=FALSE)

#Remove PZ >= 0.90
Anemia_case_Children_pz <- Anemia_case_s1s2_Children_cont_full[Anemia_case_s1s2_Children_cont_full$PZ >= 0.9, 1, drop=FALSE]
Anemia_case_Adults_pz <- Anemia_case_s1s2_Adults_cont_full[Anemia_case_s1s2_Adults_cont_full$PZ >= 0.9, 1, drop=FALSE]

Anemia_control_Children_pz <- Anemia_control_s1s2_Children_cont_full[Anemia_control_s1s2_Children_cont_full$PZ >= 0.9, 1, drop=FALSE]
Anemia_control_Adults_pz <- Anemia_control_s1s2_Adults_cont_full[Anemia_control_s1s2_Adults_cont_full$PZ >= 0.9, 1, drop=FALSE]

#Filter out the >= 0.90 samples from continuous file.
Anemia_case_s1s2_Children_final_pz <- clarite::colfilter(d=Anemia_case_s1s2_Children_cont_final, cols=Anemia_case_Children_pz, exclude = TRUE)
Anemia_case_s1s2_Adults_final_pz <- clarite::colfilter(d=Anemia_case_s1s2_Adults_cont_final, cols=Anemia_case_Adults_pz, exclude = TRUE)

Anemia_control_s1s2_Children_final_pz <- clarite::colfilter(d=Anemia_control_s1s2_Children_cont_final, cols=Anemia_control_Children_pz, exclude = TRUE)
Anemia_control_s1s2_Adults_final_pz <- clarite::colfilter(d=Anemia_control_s1s2_Adults_cont_final, cols=Anemia_control_Adults_pz, exclude = TRUE)

#Drop the Hemoglobin reading and blood related components
drop_item_Anemia <- c("LBDHDD", "LBDHDL", "LBDLDL", "LBXSTR", "LBXTC","LBXTR", "LBXSCH", "DR1TCHOL","house_type","house_age","hepa","hepb","current_past_smoking","CVDVOMAX", "CVDESVO2", "CVDS1HR", "CVDS1SY", "CVDS1DI", "CVDS2HR", "CVDS2SY", "CVDS2DI", "CVDR1HR", "CVDR1SY", "CVDR1DI", "CVDR2HR", "CVDR2SY", "CVDR2DI", "physical_activity", "SMQ120","SMQ040","SMQ150","num_months_longest_job","cigarette_smoking","SMD410","SMD090","SMD070","SMD075")
Anemia_case_s1s2_Children_final_pz_final <- clarite::colfilter(d=Anemia_case_s1s2_Children_final_pz, cols=drop_item_Anemia, exclude = TRUE)
Anemia_case_s1s2_Adults_final_pz_final <- clarite::colfilter(d=Anemia_case_s1s2_Adults_final_pz, cols=drop_item_Anemia, exclude = TRUE)

Anemia_control_s1s2_Children_final_pz_final <- clarite::colfilter(d=Anemia_control_s1s2_Children_final_pz, cols=drop_item_Anemia, exclude = TRUE)
Anemia_control_s1s2_Adults_final_pz_final <- clarite::colfilter(d=Anemia_control_s1s2_Adults_final_pz, cols=drop_item_Anemia, exclude = TRUE)

#Merge categorical and binary files (data frames)
Anemia_case_s1s2_Children_cat_bin <- clarite::merge_data(Anemia_case_s1s2_Children_cat_final, Anemia_case_s1s2_Children_bin)
Anemia_case_s1s2_Adults_cat_bin <- clarite::merge_data(Anemia_case_s1s2_Adults_cat_final, Anemia_case_s1s2_Adults_bin)
Anemia_control_s1s2_Children_cat_bin <- clarite::merge_data(Anemia_control_s1s2_Children_cat_final, Anemia_control_qc_s1s2_Children_bin)
Anemia_control_s1s2_Adults_cat_bin <- clarite::merge_data(Anemia_control_s1s2_Adults_cat_final, Anemia_control_qc_s1s2_Adults_bin)

#Drop variables <200 and rename file
skip_acc <- covar_ac[!covar_ac %in% c("BMXBMI","RIDAGEYR", "LBXCOT", "SDMVPSU")]
skip_aca <- covar_ana[!covar_ana %in% c("BMXBMI","RIDAGEYR", "LBXCOT", "SDMVPSU")]

Anemia_case_s1s2_Children_cat_final <- clarite::min_cat_n(Anemia_case_s1s2_Children_cat_bin, skip = skip_acc)
Anemia_case_s1s2_Children_cat_final <- clarite::colfilter(d=Anemia_case_s1s2_Children_cat_final, cols=drop_item_Anemia, exclude = TRUE)

Anemia_case_s1s2_Adults_cat_final <- clarite::min_cat_n(Anemia_case_s1s2_Adults_cat_bin, skip = skip_aca)
Anemia_case_s1s2_Adults_cat_final <- clarite::colfilter(d=Anemia_case_s1s2_Adults_cat_final, cols=drop_item_Anemia, exclude = TRUE)

Anemia_control_s1s2_Children_cat_final <- clarite::min_cat_n(Anemia_control_s1s2_Children_cat_bin, skip = skip_acc)
Anemia_control_s1s2_Children_cat_final <- clarite::colfilter(d=Anemia_control_s1s2_Children_cat_final, cols=drop_item_Anemia, exclude = TRUE)

Anemia_control_s1s2_Adults_cat_final <- clarite::min_cat_n(Anemia_control_s1s2_Adults_cat_bin, skip = skip_aca)
Anemia_control_s1s2_Adults_cat_final <- clarite::colfilter(d=Anemia_control_s1s2_Adults_cat_final, cols=drop_item_Anemia, exclude = TRUE)

Anemia_case_s1s2_Children_final_pz_200 <- clarite::min_n(Anemia_case_s1s2_Children_final_pz_final, 150)
Anemia_case_s1s2_Adults_final_pz_200 <- clarite::min_n(Anemia_case_s1s2_Adults_final_pz_final)
Anemia_control_s1s2_Children_final_pz_200 <- clarite::min_n(Anemia_control_s1s2_Children_final_pz_final)
Anemia_control_s1s2_Adults_final_pz_200 <- clarite::min_n(Anemia_control_s1s2_Adults_final_pz_final)
```

##Anemic vs non-anemic Replication Group
```{r include=FALSE}
Anemia_case_s3s4 <- Anemia_case[Anemia_case$SDDSRVYR==4 | Anemia_case$SDDSRVYR==3, ]
Anemia_control_qc_s3s4 <- Anemia_control_qc[Anemia_control_qc$SDDSRVYR==4 | Anemia_control_qc$SDDSRVYR==3, ]

colnames(Anemia_case_s3s4)[1] <- "ID"
colnames(Anemia_control_qc_s3s4)[1] <- "ID"
MainTable_keepvar_over18 <- read.delim("~/Desktop/Anemia/Data/MainTable_keepvar_over18.tsv")
keepvar <- dput(names(MainTable_keepvar_over18))
keepvar <- c(paste(keepvar),"SDDSRVYR")
Anemia_case_s3s4_keepvar <- clarite::colfilter(d=Anemia_case_s3s4, cols=keepvar, exclude=F)
Anemia_control_qc_s3s4_keepvar <- clarite::colfilter(d=Anemia_control_qc_s3s4, cols=keepvar, exclude=F)

Anemia_case_s3s4_Children <- Anemia_case_s3s4_keepvar[Anemia_case_s3s4_keepvar$RIDAGEYR < 15,]
Anemia_case_s3s4_Adults <- Anemia_case_s3s4_keepvar[Anemia_case_s3s4_keepvar$RIDAGEYR >= 15,]

Anemia_control_qc_s3s4_Children <- Anemia_control_qc_s3s4_keepvar[Anemia_control_qc_s3s4_keepvar$RIDAGEYR < 15,]
Anemia_control_qc_s3s4_Adults <- Anemia_control_qc_s3s4_keepvar[Anemia_control_qc_s3s4_keepvar$RIDAGEYR >= 15,]

Anemia_case_s3s4_Children <- remove_incomplete_obs(Anemia_case_s3s4_Children, c(covar_ac))
Anemia_control_qc_s3s4_Children <- remove_incomplete_obs(Anemia_control_qc_s3s4_Children, c(covar_ac))
Anemia_case_s3s4_Adults <- remove_incomplete_obs(Anemia_case_s3s4_Adults, c(covar_ana))
Anemia_control_qc_s3s4_Adults <- remove_incomplete_obs(Anemia_control_qc_s3s4_Adults, c(covar_ana))

##Split into data type
#Get binary varibales into a separate file
Anemia_case_s3s4_Children_bin <- clarite::get_binary(Anemia_case_s3s4_Children)
Anemia_case_s3s4_Adults_bin <- clarite::get_binary(Anemia_case_s3s4_Adults)

Anemia_control_qc_s3s4_Children_bin <- clarite::get_binary(Anemia_control_qc_s3s4_Children)
Anemia_control_qc_s3s4_Adults_bin <- clarite::get_binary(Anemia_control_qc_s3s4_Adults)

#Get categorical variables into a separate file
Anemia_case_s3s4_Children_cat <- clarite::get_categorical(Anemia_case_s3s4_Children)
Anemia_case_s3s4_Adults_cat <- clarite::get_categorical(Anemia_case_s3s4_Adults)

Anemia_control_qc_s3s4_Children_cat <- clarite::get_categorical(Anemia_control_qc_s3s4_Children)
Anemia_control_qc_s3s4_Adults_cat <- clarite::get_categorical(Anemia_control_qc_s3s4_Adults)

#Changes values 7 and 9 using a pipeline format to NA. Cannot decipher meaning of values so make NA.
Anemia_case_s3s4_Adults_cat$SMQ077 <- ifelse(Anemia_case_s3s4_Adults_cat$SMQ077==7 | Anemia_case_s3s4_Adults_cat$SMQ077==9, NA, Anemia_case_s3s4_Adults_cat$SMQ077)

Anemia_control_qc_s3s4_Adults_cat$SMQ077 <- ifelse(Anemia_control_qc_s3s4_Adults_cat$SMQ077==7 | Anemia_control_qc_s3s4_Adults_cat$SMQ077==9, NA, Anemia_control_qc_s3s4_Adults_cat$SMQ077)

#Get continuous variables into a separate file
Anemia_case_s3s4_Children_cont <- clarite::get_continuous(Anemia_case_s3s4_Children)
Anemia_case_s3s4_Adults_cont <- clarite::get_continuous(Anemia_case_s3s4_Adults)

Anemia_control_qc_s3s4_Children_cont <- clarite::get_continuous(Anemia_control_qc_s3s4_Children)
Anemia_control_qc_s3s4_Adults_cont <- clarite::get_continuous(Anemia_control_qc_s3s4_Adults)

#Get ambiguous variables into a separate file
Anemia_case_s3s4_Children_check <- clarite::get_check(Anemia_case_s3s4_Children)
Anemia_case_s3s4_Adults_check <- clarite::get_check(Anemia_case_s3s4_Adults)

Anemia_control_qc_s3s4_Children_check <- clarite::get_check(Anemia_control_qc_s3s4_Children)
Anemia_control_qc_s3s4_Adults_check <- clarite::get_check(Anemia_control_qc_s3s4_Adults)

Anemia_case_s3s4_Children_cont_merge <- c("RIDAGEYR", "LBXWBF", "LBXWCF", "LBXWBM", "LBXWCM", "LBXV4C", 
"LBXVBM", "LBXVBZ", "LBXVCM", "LBXVDB", "LBXVEB", "LBXVME", "LBXVOX", 
"LBXVXY", "LBXMPAH", "LBXPFNA", "URXMNP", "URXOP2", "URXOP5", 
"LBX028", "LBX066", "LBX074", "LBX105", "LBX118", "LBXD01", "LBXD03", 
"LBXD04", "LBXD05", "LBXD07", "LBXF01", "LBXF02", "LBXF03", "LBXF04", 
"LBXF05", "LBXF06", "LBXF07", "LBXF08", "LBXF10", "LBXPCB", "LBXTC2", 
"LBXHXC", "LBXTCD", "LBX052", "LBX099", "LBX101", "LBX138", "LBX146", 
"LBX153", "LBX170", "LBX177", "LBX180", "LBX183", "LBX187", "LBXHCB", 
"LBXBHC", "LBXGHC", "LBXPDE", "LBXPDT", "LBXODT", "LBXOXY", "LBXTNA", 
"LBXHPE", "LBXMIR", "URX1TB", "URX3TB", "URXPCP", "URXOPP", "SMD430", 
"COPPER_mg", "PHOSPHORUS_mg", "SODIUM_mg", "TOTAL_CARBOHYDRATE_gm", 
"URXUMMA", "LBXD02", "LBXF09", "LBX044", "LBX049", "LBX087", 
"LBX110", "LBX149", "LBX151", "LBX194", "LBX196", "LBD199", "LBX206", 
"LBX209", "LBXALD", "LBXDIE", "LBXEND", "LBXBB1", "LBXBR2", "LBXBR3", 
"LBXBR4", "LBXBR5", "LBXBR6", "LBXBR7", "LBXBR8", "URXP20", "LBXII6", 
"LBXIM6", "LBXF13", "LBXIW1", "LBXIG5", "LBXIG2", "LBXIT7", "LBXW11", 
"LBXWNO", "URXBUP", "URXEPB", "URXMPB", "URXPPB", "DR1TATOA", 
"URXCNP", "URXCOP")
Anemia_case_s3s4_Children_cat_merge <- NULL
Anemia_case_s3s4_Adults_cont_merge <- c("LBXVTC", "URXUPT", "LBXTO1", "LBXEPAH", "LBXPFHP", "LBXPFSA", 
"LBXPFDO", "URXMCP", "URXOP6", "URXP08", "URXP11", "URXP12", 
"URXP13", "URXP14", "URXP15", "URXP16", "URX1TB", "quantity_drink_per_day", 
"RHQ572", "RHQ564", "how_long_progestin", "how_long_estrogen_progestin", 
"SMD220", "SMD160", "SMD130", "SMD100NI", "DRD350BQ", "DRD350HQ", 
"DRD370BQ", "DRD370DQ", "DRD370MQ", "DRD370RQ", "DRD370TQ", "DRD370UQ", 
"supplement_count", "DSDCOUNT", "PROTEIN_gm", "URXUAS3", "URXUAS5", 
"URXUAC", "LBXBR1", "URXP22", "URXP24", "LBXIF1", "LBXE74", "DUQ260", 
"DED038Q")
Anemia_case_s3s4_Adults_cat_merge <- NULL


Anemia_control_s3s4_Children_cont_merge <- c("LBXWME", "LBXTO1", "LBXDFSF", "LBXPFDE", "LBXPFHP", 
"LBXPFSA", "LBXPFUA", "URXMCP", "URXMNP", "URXOP6", "LBX128", 
"URXP12", "URXP13", "URXP14", "URXP15", "URXP16", "URX1TB",
"DR1TALCO", "DRD350HQ", "DRD370BQ", "DRD370TQ", "VITAMIN_C_mg", 
"URXUAS3", "URXUAS5", "LBX189", "LBX195", "LBXBR1", "URXP24", 
"LBXE72", "DR1CWATR")
Anemia_control_s3s4_Children_cat_merge <- c("house_age")
Anemia_control_s3s4_Adults_cont_merge <- c("LBXTO2", "LBXEPAH", "LBXPFSA", "LBXPFDO", 
"RHQ582", "RHQ572", "RHQ564", "how_long_progestin", "SMD235", 
"DRD350AQ", "DRD350BQ", "DRD350EQ", "DRD350GQ", "DRD350HQ", "DRD370AQ", 
"DRD370DQ", "DRD370FQ", "DRD370IQ", "DRD370MQ", "DRD370NQ", "DRD370RQ", 
"DRD370TQ", "DRD370UQ", "CHOLESTEROL_mg", "PROTEIN_gm", "LBXV2A", 
"LBXVMC", "URXUTM", "LBXPFBS", "DUQ280", "DED038Q")
Anemia_control_s3s4_Adults_cat_merge <- c("house_age")

#Remove columns and rename data frame then merge data from ambiguous file into continuous file
Anemia_case_s3s4_Children_contmerged <- clarite::merge_data(Anemia_case_s3s4_Children_cont, Anemia_case_s3s4_Children_check, union=TRUE)
Anemia_case_s3s4_Children_cont_final <- clarite::colfilter(d=Anemia_case_s3s4_Children_contmerged, cols=Anemia_case_s3s4_Children_cat_merge, exclude=T)

Anemia_case_s3s4_Children_catmerged <- clarite::merge_data(Anemia_case_s3s4_Children_cat, Anemia_case_s3s4_Children_check, union=TRUE)
Anemia_case_s3s4_Children_cat_final <- clarite::colfilter(d=Anemia_case_s3s4_Children_catmerged, cols=Anemia_case_s3s4_Children_cont_merge, exclude=T)

Anemia_case_s3s4_Adults_contmerged <- clarite::merge_data(Anemia_case_s3s4_Adults_cont, Anemia_case_s3s4_Adults_check, union=TRUE)
Anemia_case_s3s4_Adults_cont_final <- clarite::colfilter(d=Anemia_case_s3s4_Adults_contmerged, cols=Anemia_case_s3s4_Adults_cat_merge, exclude=T)

Anemia_case_s3s4_Adults_catmerged <- clarite::merge_data(Anemia_case_s3s4_Adults_cat, Anemia_case_s3s4_Adults_check, union=TRUE)
Anemia_case_s3s4_Adults_cat_final <- clarite::colfilter(d=Anemia_case_s3s4_Adults_catmerged, cols=Anemia_case_s3s4_Adults_cont_merge, exclude=T)

Anemia_control_s3s4_Children_contmerged <- clarite::merge_data(Anemia_control_qc_s3s4_Children_cont, Anemia_control_qc_s3s4_Children_check, union=TRUE)
Anemia_control_s3s4_Children_cont_final <- clarite::colfilter(d=Anemia_control_s3s4_Children_contmerged, cols=Anemia_control_s3s4_Children_cat_merge, exclude=T)

Anemia_control_s3s4_Children_catmerged <- clarite::merge_data(Anemia_control_qc_s3s4_Children_cat, Anemia_control_qc_s3s4_Children_check, union=TRUE)
Anemia_control_s3s4_Children_cat_final <- clarite::colfilter(d=Anemia_control_s3s4_Children_catmerged, cols=Anemia_control_s3s4_Children_cont_merge, exclude=T)

Anemia_control_s3s4_Adults_contmerged <- clarite::merge_data(Anemia_control_qc_s3s4_Adults_cont, Anemia_control_qc_s3s4_Adults_check, union=TRUE)
Anemia_control_s3s4_Adults_cont_final <- clarite::colfilter(d=Anemia_control_s3s4_Adults_contmerged, cols=Anemia_control_s3s4_Adults_cat_merge, exclude=T)

Anemia_control_s3s4_Adults_catmerged <- clarite::merge_data(Anemia_control_qc_s3s4_Adults_cat, Anemia_control_qc_s3s4_Adults_check, union=TRUE)
Anemia_control_s3s4_Adults_cat_final <- clarite::colfilter(d=Anemia_control_s3s4_Adults_catmerged, cols=Anemia_control_s3s4_Adults_cont_merge, exclude=T)


#Extract unique values and return vector from columns in data dictionary
desc_info <- unique(VarDescription[, colnames(VarDescription) %in% c("tab_desc", "module", "var", "var_desc")])

#Define functions with labels such as X, N, NNZ...etc and combine objects by rows. Return them out to finish function
get0 <- function(x){
  x <- as.numeric(as.character(x))
  N <- length(x)
  NNZ <- length(x[x>0])
  PZ <- (N-NNZ)/N
  out <- rbind(N=N, NNZ=NNZ, PZ=PZ)
  return(out)
}

#Drop >90% of the samples with get0 function. Combine columns and create data another data frame with PZ as label for dropped variables. Write to text file.
Anemia_case_s3s4_Children_cont_0 <- as.data.frame(t(sapply(Anemia_case_s3s4_Children_cont_final[, -1], get0)))
Anemia_case_s3s4_Children_cont_0 <- cbind(rownames(Anemia_case_s3s4_Children_cont_0), data.frame(Anemia_case_s3s4_Children_cont_0, row.names=NULL))
names(Anemia_case_s3s4_Children_cont_0) <- c("var", "N", "NNZ", "PZ")
Anemia_case_s3s4_Children_cont_full <- merge(Anemia_case_s3s4_Children_cont_0, desc_info, by="var")
Anemia_case_s3s4_Children_cont_full <- Anemia_case_s3s4_Children_cont_full[order(Anemia_case_s3s4_Children_cont_full$PZ, decreasing=TRUE), ]
write.table(Anemia_case_s3s4_Children_cont_full, file="Anemia_case_s3s4_Children_percent_zero_values_series1-2.txt", sep="\t", quote=FALSE, row.names=FALSE)

Anemia_case_s3s4_Adults_cont_0 <- as.data.frame(t(sapply(Anemia_case_s3s4_Adults_cont_final[, -1], get0)))
Anemia_case_s3s4_Adults_cont_0 <- cbind(rownames(Anemia_case_s3s4_Adults_cont_0), data.frame(Anemia_case_s3s4_Adults_cont_0, row.names=NULL))
names(Anemia_case_s3s4_Adults_cont_0) <- c("var", "N", "NNZ", "PZ")
Anemia_case_s3s4_Adults_cont_full <- merge(Anemia_case_s3s4_Adults_cont_0, desc_info, by="var")
Anemia_case_s3s4_Adults_cont_full <- Anemia_case_s3s4_Adults_cont_full[order(Anemia_case_s3s4_Adults_cont_full$PZ, decreasing=TRUE), ]
write.table(Anemia_case_s3s4_Adults_cont_full, file="Anemia_case_s3s4_Adults_percent_zero_values_series1-2.txt", sep="\t", quote=FALSE, row.names=FALSE)


Anemia_control_s3s4_Children_cont_0 <- as.data.frame(t(sapply(Anemia_control_s3s4_Children_cont_final[, -1], get0)))
Anemia_control_s3s4_Children_cont_0 <- cbind(rownames(Anemia_control_s3s4_Children_cont_0), data.frame(Anemia_control_s3s4_Children_cont_0, row.names=NULL))
names(Anemia_control_s3s4_Children_cont_0) <- c("var", "N", "NNZ", "PZ")
Anemia_control_s3s4_Children_cont_full <- merge(Anemia_control_s3s4_Children_cont_0, desc_info, by="var")
Anemia_control_s3s4_Children_cont_full <- Anemia_control_s3s4_Children_cont_full[order(Anemia_control_s3s4_Children_cont_full$PZ, decreasing=TRUE), ]
write.table(Anemia_control_s3s4_Children_cont_full, file="Anemia_control_s3s4_Children_percent_zero_values_series1-2.txt", sep="\t", quote=FALSE, row.names=FALSE)

Anemia_control_s3s4_Adults_cont_0 <- as.data.frame(t(sapply(Anemia_control_s3s4_Adults_cont_final[, -1], get0)))
Anemia_control_s3s4_Adults_cont_0 <- cbind(rownames(Anemia_control_s3s4_Adults_cont_0), data.frame(Anemia_control_s3s4_Adults_cont_0, row.names=NULL))
names(Anemia_control_s3s4_Adults_cont_0) <- c("var", "N", "NNZ", "PZ")
Anemia_control_s3s4_Adults_cont_full <- merge(Anemia_control_s3s4_Adults_cont_0, desc_info, by="var")
Anemia_control_s3s4_Adults_cont_full <- Anemia_control_s3s4_Adults_cont_full[order(Anemia_control_s3s4_Adults_cont_full$PZ, decreasing=TRUE), ]
write.table(Anemia_control_s3s4_Adults_cont_full, file="Anemia_control_s3s4_Adults_percent_zero_values_series1-2.txt", sep="\t", quote=FALSE, row.names=FALSE)

#Remove PZ >= 0.90
Anemia_case_Children_pz <- Anemia_case_s3s4_Children_cont_full[Anemia_case_s3s4_Children_cont_full$PZ >= 0.9, 1, drop=FALSE]
Anemia_case_Adults_pz <- Anemia_case_s3s4_Adults_cont_full[Anemia_case_s3s4_Adults_cont_full$PZ >= 0.9, 1, drop=FALSE]

Anemia_control_Children_pz <- Anemia_control_s3s4_Children_cont_full[Anemia_control_s3s4_Children_cont_full$PZ >= 0.9, 1, drop=FALSE]
Anemia_control_Adults_pz <- Anemia_control_s3s4_Adults_cont_full[Anemia_control_s3s4_Adults_cont_full$PZ >= 0.9, 1, drop=FALSE]

#Filter out the >= 0.90 samples from continuous file.
Anemia_case_s3s4_Children_final_pz <- clarite::colfilter(d=Anemia_case_s3s4_Children_cont_final, cols=Anemia_case_Children_pz, exclude = TRUE)
Anemia_case_s3s4_Adults_final_pz <- clarite::colfilter(d=Anemia_case_s3s4_Adults_cont_final, cols=Anemia_case_Adults_pz, exclude = TRUE)

Anemia_control_s3s4_Children_final_pz <- clarite::colfilter(d=Anemia_control_s3s4_Children_cont_final, cols=Anemia_control_Children_pz, exclude = TRUE)
Anemia_control_s3s4_Adults_final_pz <- clarite::colfilter(d=Anemia_control_s3s4_Adults_cont_final, cols=Anemia_control_Adults_pz, exclude = TRUE)

#Drop the Hemoglobin reading and blood related components
drop_item_Anemia <- c("LBDHDD", "LBDHDL", "LBDLDL", "LBXSTR", "LBXTC","LBXTR", "LBXSCH", "DR1TCHOL","house_type","house_age","hepa","hepb","current_past_smoking","CVDVOMAX", "CVDESVO2", "CVDS1HR", "CVDS1SY", "CVDS1DI", "CVDS2HR", "CVDS2SY", "CVDS2DI", "CVDR1HR", "CVDR1SY", "CVDR1DI", "CVDR2HR", "CVDR2SY", "CVDR2DI", "physical_activity", "SMQ120","SMQ040","SMQ150","num_months_longest_job","cigarette_smoking","SMD410","SMD090","SMD070","SMD075")
Anemia_case_s3s4_Children_final_pz_final <- clarite::colfilter(d=Anemia_case_s3s4_Children_final_pz, cols=drop_item_Anemia, exclude = TRUE)
Anemia_case_s3s4_Adults_final_pz_final <- clarite::colfilter(d=Anemia_case_s3s4_Adults_final_pz, cols=drop_item_Anemia, exclude = TRUE)

Anemia_control_s3s4_Children_final_pz_final <- clarite::colfilter(d=Anemia_control_s3s4_Children_final_pz, cols=drop_item_Anemia, exclude = TRUE)
Anemia_control_s3s4_Adults_final_pz_final <- clarite::colfilter(d=Anemia_control_s3s4_Adults_final_pz, cols=drop_item_Anemia, exclude = TRUE)

#Merge categorical and binary files (data frames)
Anemia_case_s3s4_Children_cat_bin <- clarite::merge_data(Anemia_case_s3s4_Children_cat_final, Anemia_case_s3s4_Children_bin)
Anemia_case_s3s4_Adults_cat_bin <- clarite::merge_data(Anemia_case_s3s4_Adults_cat_final, Anemia_case_s3s4_Adults_bin)
Anemia_control_s3s4_Children_cat_bin <- clarite::merge_data(Anemia_control_s3s4_Children_cat_final, Anemia_control_qc_s3s4_Children_bin)
Anemia_control_s3s4_Adults_cat_bin <- clarite::merge_data(Anemia_control_s3s4_Adults_cat_final, Anemia_control_qc_s3s4_Adults_bin)

#Drop variables <200 and rename file
skip_acc <- covar_ac[!covar_ac %in% c("BMXBMI","RIDAGEYR", "LBXCOT", "SDMVPSU")]
skip_aca <- covar_ana[!covar_ana %in% c("BMXBMI","RIDAGEYR", "LBXCOT", "SDMVPSU")]

Anemia_case_s3s4_Children_cat_final <- clarite::min_cat_n(Anemia_case_s3s4_Children_cat_bin, skip = skip_acc)
Anemia_case_s3s4_Children_cat_final <- clarite::colfilter(d=Anemia_case_s3s4_Children_cat_final, cols=drop_item_Anemia, exclude = TRUE)

Anemia_case_s3s4_Adults_cat_final <- clarite::min_cat_n(Anemia_case_s3s4_Adults_cat_bin, skip = skip_aca)
Anemia_case_s3s4_Adults_cat_final <- clarite::colfilter(d=Anemia_case_s3s4_Adults_cat_final, cols=drop_item_Anemia, exclude = TRUE)

Anemia_control_s3s4_Children_cat_final <- clarite::min_cat_n(Anemia_control_s3s4_Children_cat_bin, skip = skip_acc)
Anemia_control_s3s4_Children_cat_final <- clarite::colfilter(d=Anemia_control_s3s4_Children_cat_final, cols=drop_item_Anemia, exclude = TRUE)

Anemia_control_s3s4_Adults_cat_final <- clarite::min_cat_n(Anemia_control_s3s4_Adults_cat_bin, skip = skip_aca)
Anemia_control_s3s4_Adults_cat_final <- clarite::colfilter(d=Anemia_control_s3s4_Adults_cat_final, cols=drop_item_Anemia, exclude = TRUE)

Anemia_case_s3s4_Children_final_pz_200 <- clarite::min_n(Anemia_case_s3s4_Children_final_pz_final,150)
Anemia_case_s3s4_Adults_final_pz_200 <- clarite::min_n(Anemia_case_s3s4_Adults_final_pz_final)
Anemia_control_s3s4_Children_final_pz_200 <- clarite::min_n(Anemia_control_s3s4_Children_final_pz_final)
Anemia_control_s3s4_Adults_final_pz_200 <- clarite::min_n(Anemia_control_s3s4_Adults_final_pz_final)
```

##EWAS Preparation Discovery Group
```{r include=FALSE}
#Children
##Dataframe
anemia_case_child_final_dis <- merge(Anemia_case_s1s2_Children_cat_final, Anemia_case_s1s2_Children_final_pz_200, by="ID")
anemia_case_child_final_dis$anemia <- "1"
anemia_case_child_final_rep <- merge(Anemia_case_s3s4_Children_cat_final, Anemia_case_s3s4_Children_final_pz_200, by="ID")
anemia_case_child_final_rep$anemia <- "1"

anemia_control_child_final_dis <- merge(Anemia_control_s1s2_Children_cat_final, Anemia_control_s1s2_Children_final_pz_200, by="ID")
anemia_control_child_final_dis$anemia <- "0"
anemia_control_child_final_rep <- merge(Anemia_control_s3s4_Children_cat_final, Anemia_control_s3s4_Children_final_pz_200, by="ID")
anemia_control_child_final_rep$anemia <- "0"

##Variables between case and control
anemia_case_child_final_dis_list <- dput(names(anemia_case_child_final_dis))
anemia_control_child_final_dis_list <-dput(names(anemia_control_child_final_dis))
anemia_case_control_child_final_child_crosslist <- (intersect(anemia_case_child_final_dis_list,anemia_control_child_final_dis_list))

col.num.child.case.dis <- which(colnames(anemia_case_child_final_dis) %in% anemia_case_control_child_final_child_crosslist)
anemia_case_child_final_dis <- anemia_case_child_final_dis[,col.num.child.case.dis]

col.num.child.control.dis <- which(colnames(anemia_control_child_final_dis) %in% anemia_case_control_child_final_child_crosslist)
anemia_control_child_final_dis <- anemia_control_child_final_dis[,col.num.child.control.dis]

anemia_casctrl_child_final_dis <- rbind.data.frame(anemia_case_child_final_dis, anemia_control_child_final_dis)

anemia_case_child_final_rep_list <-dput(names(anemia_case_child_final_rep))
anemia_control_child_final_rep_list <-dput(names(anemia_control_child_final_rep))
anemia_case_control_child_final_child_crosslist <- (intersect(anemia_case_child_final_rep_list,anemia_control_child_final_rep_list))

col.num.child.case.rep <- which(colnames(anemia_case_child_final_rep) %in% anemia_case_control_child_final_child_crosslist)
anemia_case_child_final_rep <- anemia_case_child_final_rep[,col.num.child.case.rep]

col.num.child.control.rep <- which(colnames(anemia_control_child_final_rep) %in% anemia_case_control_child_final_child_crosslist)
anemia_control_child_final_rep <- anemia_control_child_final_rep[,col.num.child.control.rep]

anemia_casctrl_child_final_rep <- rbind.data.frame(anemia_case_child_final_rep, anemia_control_child_final_rep)

#Variable between discovery and replication 
anemia_casctrl_child_final_dis_list <-dput(names(anemia_casctrl_child_final_dis))
anemia_casctrl_child_final_rep_list <-dput(names(anemia_casctrl_child_final_rep))
anemia_casctrl_child_final_disrep_crosslist <- (intersect(anemia_casctrl_child_final_dis_list, anemia_casctrl_child_final_rep_list))

col.num.child.casctrl.dis <- which(colnames(anemia_casctrl_child_final_dis) %in% anemia_casctrl_child_final_disrep_crosslist)
anemia_casctrl_child_final_dis <- anemia_casctrl_child_final_dis[,col.num.child.casctrl.dis]

#Variable with Weights
anemia_casctrl_child_final_dis_final_crosslist <- (intersect(anemia_casctrl_child_final_disrep_crosslist,VarWeight$Variable))
anemia_casctrl_child_final_dis_final_crosslist_variables <- c("ID",anemia_casctrl_child_final_dis_final_crosslist,covar_ac,pheno_ac)

col.num.child.dis_varwt <- which(colnames(anemia_casctrl_child_final_dis) %in% anemia_casctrl_child_final_dis_final_crosslist_variables)
anemia_casctrl_child_final_dis <- anemia_casctrl_child_final_dis[,col.num.child.dis_varwt]

anemia_casctrl_child_final_dis_final <- merge_data(anemia_casctrl_child_final_dis, survey_design_discovery, union = FALSE)
anemia_casctrl_child_final_dis_final$anemia <- as.numeric(anemia_casctrl_child_final_dis_final$anemia)

##Co-variables
anemia_casctrl_child_final_dis_cat_vars <- dput(names(Anemia_case_s1s2_Children_cat_final))
anemia_casctrl_child_final_dis_cat_vars <- anemia_casctrl_child_final_dis_cat_vars[anemia_casctrl_child_final_dis_cat_vars %in% anemia_casctrl_child_final_dis_final_crosslist]

anemia_casctrl_child_final_dis_cont_vars <- dput(names(Anemia_case_s1s2_Children_final_pz_200))
anemia_casctrl_child_final_dis_cont_vars <- anemia_casctrl_child_final_dis_cont_vars[anemia_casctrl_child_final_dis_cont_vars %in% anemia_casctrl_child_final_dis_final_crosslist]


#Adults
##Dataframe
anemia_case_adult_final_dis <- merge(Anemia_case_s1s2_Adults_cat_final, Anemia_case_s1s2_Adults_final_pz_200, by="ID")
anemia_case_adult_final_dis$anemia <- "1"
anemia_case_adult_final_rep <- merge(Anemia_case_s3s4_Adults_cat_final, Anemia_case_s3s4_Adults_final_pz_200, by="ID")
anemia_case_adult_final_rep$anemia <- "1"

anemia_control_adult_final_dis <- merge(Anemia_control_s1s2_Adults_cat_final, Anemia_control_s1s2_Adults_final_pz_200, by="ID")
anemia_control_adult_final_dis$anemia <- "0"
anemia_control_adult_final_rep <- merge(Anemia_control_s3s4_Adults_cat_final, Anemia_control_s3s4_Adults_final_pz_200, by="ID")
anemia_control_adult_final_rep$anemia <- "0"

##Variables between case and control
anemia_case_adult_final_dis_list <-dput(names(anemia_case_adult_final_dis))
anemia_control_adult_final_dis_list <-dput(names(anemia_control_adult_final_dis))
anemia_case_control_adult_final_adult_crosslist <- (intersect(anemia_case_adult_final_dis_list,anemia_control_adult_final_dis_list))

col.num.adult.case.dis <- which(colnames(anemia_case_adult_final_dis) %in% anemia_case_control_adult_final_adult_crosslist)
anemia_case_adult_final_dis <- anemia_case_adult_final_dis[,col.num.adult.case.dis]

col.num.adult.control.dis <- which(colnames(anemia_control_adult_final_dis) %in% anemia_case_control_adult_final_adult_crosslist)
anemia_control_adult_final_dis <- anemia_control_adult_final_dis[,col.num.adult.control.dis]

anemia_casctrl_adult_final_dis <- rbind.data.frame(anemia_case_adult_final_dis, anemia_control_adult_final_dis)

anemia_case_adult_final_rep_list <-dput(names(anemia_case_adult_final_rep))
anemia_control_adult_final_rep_list <-dput(names(anemia_control_adult_final_rep))
anemia_case_control_adult_final_adult_crosslist <- (intersect(anemia_case_adult_final_rep_list,anemia_control_adult_final_rep_list))

col.num.adult.case.rep <- which(colnames(anemia_case_adult_final_rep) %in% anemia_case_control_adult_final_adult_crosslist)
anemia_case_adult_final_rep <- anemia_case_adult_final_rep[,col.num.adult.case.rep]

col.num.adult.control.rep <- which(colnames(anemia_control_adult_final_rep) %in% anemia_case_control_adult_final_adult_crosslist)
anemia_control_adult_final_rep <- anemia_control_adult_final_rep[,col.num.adult.control.rep]

anemia_casctrl_adult_final_rep <- rbind.data.frame(anemia_case_adult_final_rep, anemia_control_adult_final_rep)

#Variable between discovery and replication 
anemia_casctrl_adult_final_dis_list <-dput(names(anemia_casctrl_adult_final_dis))
anemia_casctrl_adult_final_rep_list <-dput(names(anemia_casctrl_adult_final_rep))
anemia_casctrl_adult_final_disrep_crosslist <- (intersect(anemia_casctrl_adult_final_dis_list, anemia_casctrl_adult_final_rep_list))

col.num.adult.casctrl.dis <- which(colnames(anemia_casctrl_adult_final_dis) %in% anemia_casctrl_adult_final_disrep_crosslist)
anemia_casctrl_adult_final_dis <- anemia_casctrl_adult_final_dis[,col.num.adult.casctrl.dis]

#Variable with Weights
anemia_casctrl_adult_final_dis_final_crosslist <- (intersect(anemia_casctrl_adult_final_disrep_crosslist,VarWeight$Variable))
anemia_casctrl_adult_final_dis_final_crosslist_variables <- c("ID",anemia_casctrl_adult_final_dis_final_crosslist,covar_ana,pheno_ac)

col.num.adult.dis_varwt <- which(colnames(anemia_casctrl_adult_final_dis) %in% anemia_casctrl_adult_final_dis_final_crosslist_variables)
anemia_casctrl_adult_final_dis <- anemia_casctrl_adult_final_dis[,col.num.adult.dis_varwt]

anemia_casctrl_adult_final_dis_final <- merge_data(anemia_casctrl_adult_final_dis, survey_design_discovery, union = FALSE)
anemia_casctrl_adult_final_dis_final$anemia <- as.numeric(anemia_casctrl_adult_final_dis_final$anemia)

##Co-variables
anemia_casctrl_adult_final_dis_cat_vars <- dput(names(Anemia_case_s1s2_Adults_cat_final))
anemia_casctrl_adult_final_dis_cat_vars <- anemia_casctrl_adult_final_dis_cat_vars[anemia_casctrl_adult_final_dis_cat_vars %in% anemia_casctrl_adult_final_dis_final_crosslist]

anemia_casctrl_adult_final_dis_cont_vars <- dput(names(Anemia_case_s1s2_Adults_final_pz_200))
anemia_casctrl_adult_final_dis_cont_vars <- anemia_casctrl_adult_final_dis_cont_vars[anemia_casctrl_adult_final_dis_cont_vars %in% anemia_casctrl_adult_final_dis_final_crosslist]
```

##EWAS Discovery Group
```{r}
#Children EWAS
cat_vars = c(intersect(anemia_casctrl_child_final_dis_cat_vars,covar_ac_cat),pheno_ac)
anemia_casctrl_child_final_dis_final[cat_vars] <- lapply(anemia_casctrl_child_final_dis_final[cat_vars], as.factor)
#anemia_casctrl_adult_final_dis_final[,sapply(anemia_casctrl_adult_final_dis_final, as.factor) &
#                                       colnames(anemia_casctrl_adult_final_dis_final) %in% cat_vars]





anemia_EWAS_Children_discovery_results <- ewas(d = anemia_casctrl_child_final_dis_final,
                                               cat_vars=anemia_casctrl_child_final_dis_cat_vars,
                                               cont_vars=anemia_casctrl_child_final_dis_cont_vars,
                                               y=pheno_ac,
                                               cat_covars=covar_ac_cat,
                                               cont_covars=covar_ac_cont,
                                               regression_family="binomial",
                                               allowed_nonvarying=c("female", "SDDSRVYR"),
                                               weights=weights_discovery,
                                               ids="SDMVPSU",
                                               strata="SDMVSTRA",
                                               nest=TRUE,
                                               drop_unweighted= TRUE)
write.table(anemia_EWAS_Children_discovery_results, file = "EWAS_Anemia_Children_discovery_results.txt", row.names = F)

anemia_EWAS_Children_discovery_results_adj <- ewas_pval_adjust(anemia_EWAS_Children_discovery_results)
write.table(anemia_EWAS_Children_discovery_results_adj, file = "EWAS_Anemia_Children_discovery_results_adj.txt", row.names = F)

#Adults EWAS
anemia_EWAS_Adult_discovery_results <- ewas(d = anemia_casctrl_adult_final_dis_final,
                                        cat_vars=anemia_casctrl_adult_final_dis_cat_vars,
                                        cont_vars=anemia_casctrl_adult_final_dis_cont_vars,
                                        y=pheno_ac,
                                        cat_covars=covar_ana_cat,
                                        cont_covars=covar_ana_cont,
                                        regression_family="binomial",
                                        allowed_nonvarying=c("female", "SDDSRVYR"),
                                        weights=weights_discovery,
                                        ids="SDMVPSU",
                                        strata="SDMVSTRA",
                                        nest=TRUE,
                                        drop_unweighted = TRUE)
write.table(anemia_EWAS_Adult_discovery_results, file = "EWAS_Anemia_Adult_discovery_results.txt", row.names = F)

anemia_EWAS_Adult_discovery_results_adj <- ewas_pval_adjust(anemia_EWAS_Adult_discovery_results)
write.table(anemia_EWAS_Adult_discovery_results_adj, file = "EWAS_Anemia_Adult_discovery_results_adj.txt", row.names = F)
```

##EWAS Anemia Preparation Replication Group
```{r include=FALSE}
#Adults
pvalue_fdr_rank_anemia_adult <- anemia_EWAS_Adult_discovery_results_adj[order(anemia_EWAS_Adult_discovery_results_adj$pvalue_FDR), ]
selected_variables_fdr_list_anemia_adult <- which(pvalue_fdr_rank_anemia_adult$pvalue_FDR < 0.1)
selected_variables_fdr_anemia_adult <- head(pvalue_fdr_rank_anemia_adult[,1],length(selected_variables_fdr_list_anemia_adult))

variables_fdr_anemia_adult <- c(paste(selected_variables_fdr_anemia_adult), covar_ana, pheno_ac)
all_variable_filtered_anemia_adult <- anemia_casctrl_adult_final_rep
rep_variable_anemia_adult <- colfilter(d=all_variable_filtered_anemia_adult, cols = variables_fdr_anemia_adult, exclude = FALSE)

anemia_adult_final_adult_replication_final <- merge_data(rep_variable_anemia_adult, survey_design_replication, union = FALSE)

anemia_adult_final_adult_replication_final$anemia <- as.numeric(anemia_adult_final_adult_replication_final$anemia)

##Variables
anemia_adult_final_rep_cat_vars <- dput(names(Anemia_control_s3s4_Adults_cat_final))
anemia_adult_final_rep_cat_vars_finallist <- dput(names(anemia_adult_final_adult_replication_final))
anemia_adult_final_rep_cat_vars <- intersect(anemia_adult_final_rep_cat_vars,anemia_adult_final_rep_cat_vars_finallist)
anemia_adult_final_rep_cat_vars <- anemia_adult_final_rep_cat_vars[!anemia_adult_final_rep_cat_vars %in% c(covar_ana, "ID", pheno_ac)]

anemia_adult_final_rep_cont_vars <- dput(names(Anemia_control_s3s4_Adults_final_pz_200))
anemia_adult_final_rep_cont_vars_finallist <- dput(names(anemia_adult_final_adult_replication_final))
anemia_adult_final_rep_cont_vars <-anemia_adult_final_rep_cont_vars[anemia_adult_final_rep_cont_vars %in% anemia_adult_final_rep_cont_vars_finallist]
anemia_adult_final_rep_cont_vars <- anemia_adult_final_rep_cont_vars[!anemia_adult_final_rep_cont_vars %in% c(covar_ana, "ID", pheno_ac)]

#Children
pvalue_fdr_rank_anemia_child <- anemia_EWAS_Children_discovery_results_adj[order(anemia_EWAS_Children_discovery_results_adj$pvalue_FDR), ]
selected_variables_fdr_list_anemia_child <- which(pvalue_fdr_rank_anemia_child$pvalue_FDR < 0.1)
selected_variables_fdr_anemia_child <- head(pvalue_fdr_rank_anemia_child[,1],length(selected_variables_fdr_list_anemia_child))

variables_fdr_anemia_child <- c(paste(selected_variables_fdr_anemia_child), covar_ac, pheno_ac)
all_variable_filtered_anemia_child <- anemia_casctrl_child_final_rep
rep_variable_anemia_child <- colfilter(d=all_variable_filtered_anemia_child, cols = variables_fdr_anemia_child, exclude = FALSE)

anemia_child_final_child_replication_final <- merge_data(rep_variable_anemia_child, survey_design_replication, union = FALSE)

anemia_child_final_child_replication_final$anemia <- as.numeric(anemia_child_final_child_replication_final$anemia)

##Variables
anemia_child_final_rep_cat_vars <- dput(names(Anemia_control_s3s4_Children_cat_final))
anemia_child_final_rep_cat_vars_finallist <- dput(names(anemia_child_final_child_replication_final))
anemia_child_final_rep_cat_vars <- intersect(anemia_child_final_rep_cat_vars,anemia_child_final_rep_cat_vars_finallist)
anemia_child_final_rep_cat_vars <- anemia_child_final_rep_cat_vars[!anemia_child_final_rep_cat_vars %in% c(covar_ac, "ID", pheno_ac)]

anemia_child_final_rep_cont_vars <- dput(names(Anemia_control_s3s4_Children_final_pz_200))
anemia_child_final_rep_cont_vars_finallist <- dput(names(anemia_child_final_child_replication_final))
anemia_child_final_rep_cont_vars <- anemia_child_final_rep_cont_vars[anemia_child_final_rep_cont_vars %in% anemia_child_final_rep_cont_vars_finallist]
anemia_child_final_rep_cont_vars <- anemia_child_final_rep_cont_vars[!anemia_child_final_rep_cont_vars %in% c(covar_ac, "ID", pheno_ac)]
```

##EWAS Anemia Replication Group
```{r}
# Adults
anemia_EWAS_adult_replication_results <- ewas(d = anemia_adult_final_adult_replication_final,
                                       cat_vars=anemia_adult_final_rep_cat_vars,
                                       cont_vars=anemia_adult_final_rep_cont_vars,
                                       y=pheno_ac,
                                       cat_covars=covar_ana_cat,
                                       cont_covars=covar_ana_cont,
                                       regression_family="binomial",
                                       allowed_nonvarying=c("female", "SDDSRVYR"),
                                       weights=weights_replication,
                                       ids="SDMVPSU",
                                       strata="SDMVSTRA",
                                       nest=TRUE,
                                       drop_unweighted = TRUE)
write.table(anemia_EWAS_adult_replication_results, file = "EWAS_Anemia_Adult_replication_results.txt", row.names = F)


anemia_EWAS_adult_replication_results_adj <- ewas_pval_adjust(anemia_EWAS_adult_replication_results)
write.table(anemia_EWAS_adult_replication_results_adj, file = "EWAS_anemia_case_adult_replication_results_adj.txt", row.names = F)

# Children
anemia_EWAS_Children_replication_results <- ewas(d = anemia_child_final_child_replication_final,
                                          cat_vars=anemia_child_final_rep_cat_vars,
                                          cont_vars=anemia_child_final_rep_cont_vars,
                                          y=pheno_ac,
                                          cat_covars=covar_ac_cat,
                                          cont_covars=covar_ac_cont,
                                          regression_family="binomial",
                                          allowed_nonvarying=c("female", "SDDSRVYR"),
                                          weights=weights_replication,
                                          ids="SDMVPSU",
                                          strata="SDMVSTRA",
                                          nest=TRUE,
                                          drop_unweighted = TRUE)
write.table(anemia_EWAS_Children_replication_results, file = "EWAS_Anemia_Children_replication_results.txt", row.names = F)


anemia_EWAS_Children_replication_results_adj <- ewas_pval_adjust(anemia_EWAS_Children_replication_results)
write.table(anemia_EWAS_Children_replication_results_adj, file = "EWAS_anemia_case_Children_replication_results_adj.txt", row.names = F)
```

##EWAS Anemia Manhattan Plot
```{r}
#Adults
##Extract the variables and p-values
ewas_anemia_adult_dis_crt <- anemia_EWAS_Adult_discovery_results_adj[,c(1,14)]
ewas_anemia_adult_rep_crt <- anemia_EWAS_adult_replication_results_adj[,c(1,13)]

##Add group
ewas_anemia_adult_dis_crt$Shape <- rep("Discovery", nrow(ewas_anemia_adult_dis_crt))
ewas_anemia_adult_rep_crt$Shape <- rep("Replication", nrow(ewas_anemia_adult_rep_crt))
colnames(ewas_anemia_adult_dis_crt)[2] <- "pvalue"
colnames(ewas_anemia_adult_rep_crt)[2] <- "pvalue"

##Combine groups
ewas_anemia_adult_all_crt <- rbind(ewas_anemia_adult_dis_crt,ewas_anemia_adult_rep_crt)
colnames(ewas_anemia_adult_all_crt)[1] <- "Variable"
colnames(ewas_anemia_adult_all_crt)[2] <- "pvalue"
ewas_anemia_adult_all_crt$pvalue = as.numeric(ewas_anemia_adult_all_crt$pvalue)

##Manhattan Plot
VarCat_nopf <- read.delim("/Users/Nicen/Desktop/Anemia/Data/VarCat_nopf.txt")
anemia_ewas_mplot_adult <- eman(ewas_anemia_adult_all_crt, ewas = FALSE, groups = VarCat_nopf, file = "M-Plot Anemia vs Non-Anemia Adults", morecolors = FALSE, hgt = 7, wi = 12, res = 300)

ggsave(file = "M-Plot Anemia vs Non-Anemia Adults.png", plot = anemia_ewas_mplot_adult, device = "png",path = "/Users/Nicen/Desktop/Anemia/Figures/Original Figures", width = 12, height = 7, dpi = 300)

#Children
##Extract the variables and p-values
ewas_anemia_child_dis_crt <- anemia_EWAS_Children_discovery_results_adj[,c(1,14)]
ewas_anemia_child_rep_crt <- anemia_EWAS_Children_replication_results_adj[,c(1,13)]

##Add group
ewas_anemia_child_dis_crt$Shape <- rep("Discovery", nrow(ewas_anemia_child_dis_crt))
ewas_anemia_child_rep_crt$Shape <- rep("Replication", nrow(ewas_anemia_child_rep_crt))
colnames(ewas_anemia_child_dis_crt)[2] <- "pvalue"
colnames(ewas_anemia_child_rep_crt)[2] <- "pvalue"

##Combine groups
ewas_anemia_child_all_crt <- rbind(ewas_anemia_child_dis_crt,ewas_anemia_child_rep_crt)
colnames(ewas_anemia_child_all_crt)[1] <- "Variable"
colnames(ewas_anemia_child_all_crt)[2] <- "pvalue"

##Manhattan Plot
VarCat_nopf <- read.delim("/Users/Nicen/Desktop/Anemia/Data/VarCat_nopf.txt")
anemia_ewas_mplot_child <- eman(ewas_anemia_child_all_crt, ewas = FALSE, groups = VarCat_nopf, file = "M-Plot Anemia vs Non-Anemia Children", morecolors = FALSE, hgt = 7, wi = 12, res = 300)

ggsave(file = "M-Plot Anemia vs Non-Anemia Children.png", plot = anemia_ewas_mplot_child, device = "png",path = "/Users/Nicen/Desktop/Anemia/Figures/Original Figures", width = 12, height = 7, dpi = 300)
```

#Logistic Regressions for people with IDA vs people without Anemia
* Adults Female ONLY, since children=58D, 29R, no male in replication 

##IDA vs No-anemia - Discovery
```{r include=FALSE}
Anemia_case_IDA_Distinct_s1s2 <- Anemia_case_IDA_Distinct[Anemia_case_IDA_Distinct$SDDSRVYR==2 | Anemia_case_IDA_Distinct$SDDSRVYR==1, ]

colnames(Anemia_case_IDA_Distinct_s1s2)[1] <- "ID"
keepvar <- dput(names(MainTable_keepvar_over18))
keepvar <- c(paste(keepvar),"SDDSRVYR","URXPREG")
IDA_case_s1s2_keepvar <- clarite::colfilter(d=Anemia_case_IDA_Distinct_s1s2, cols=keepvar, exclude=F)

length(which(IDA_case_s1s2_keepvar$female == "0" & IDA_case_s1s2_keepvar$RIDAGEYR >= 15))
length(which(IDA_case_s1s2_keepvar$female == "1" & IDA_case_s1s2_keepvar$RIDAGEYR >= 15))

IDA_case_s1s2_Adults <- IDA_case_s1s2_keepvar[IDA_case_s1s2_keepvar$RIDAGEYR >= 15,]
IDA_case_s1s2_Adults$URXPREG[IDA_case_s1s2_Adults$URXPREG==0]<-2 
IDA_case_s1s2_Adults$URXPREG[IDA_case_s1s2_Adults$URXPREG==3]<-2
IDA_case_s1s2_Adults$URXPREG[is.na(IDA_case_s1s2_Adults$URXPREG)] <- 2

#Covariates and phenotype
covar_IDA <- c("female", "black", "mexican", "other_hispanic", "other_eth", "BMXBMI", "SES_LEVEL", "RIDAGEYR", "SDDSRVYR", "LBXCOT","URXPREG")
covar_IDA_cat <- c("female", "black", "mexican", "other_hispanic", "other_eth", "SES_LEVEL", "SDDSRVYR", "URXPREG")
covar_IDA_cont <- c("BMXBMI", "RIDAGEYR", "LBXCOT")
pheno_IDA <- c("anemia")

IDA_case_s1s2_Adults <- remove_incomplete_obs(IDA_case_s1s2_Adults, c(covar_IDA))

IDA_case_s1s2_Adults_male <- IDA_case_s1s2_Adults[IDA_case_s1s2_Adults$female == 0,]
IDA_case_s1s2_Adults_female <- IDA_case_s1s2_Adults[IDA_case_s1s2_Adults$female == 1,]
IDA_case_s1s2_Adults <- IDA_case_s1s2_Adults_female


##Split into data type
#Get binary varibales into a separate file
IDA_case_s1s2_Adults_bin <- clarite::get_binary(IDA_case_s1s2_Adults)

#Get categorical variables into a separate file
IDA_case_s1s2_Adults_cat <- clarite::get_categorical(IDA_case_s1s2_Adults)

#Changes values 7 and 9 using a pipeline format to NA. Cannot decipher meaning of values so make NA.
IDA_case_s1s2_Adults_cat$SMQ077 <- ifelse(IDA_case_s1s2_Adults_cat$SMQ077==7 | IDA_case_s1s2_Adults_cat$SMQ077==9, NA, IDA_case_s1s2_Adults_cat$SMQ077)

#Get continuous variables into a separate file
IDA_case_s1s2_Adults_cont <- clarite::get_continuous(IDA_case_s1s2_Adults)

#Get ambiguous variables into a separate file
IDA_case_s1s2_Adults_check <- clarite::get_check(IDA_case_s1s2_Adults)

IDA_case_s1s2_Adults_cont_merge <- c("LBXVCT", "LBXVTC", "LBXIHG", "LBXPFNA", "LBXPFSA", "URXMCP", 
"URXMOP", "LBX157", "LBX128", "LBX177", "URXP11", "URXP12", "URXP14", 
"URXP15", "LBXRST", "URX25T", "quantity_drink_per_day", 
"total_days_5drink_year", "RHQ556", "how_long_estrogen", "SMD100TR", 
"SMD100NI", "SMD100CO", "SMD090", "SMD075", "SMD070", "SMD057", 
"number_close_friends", "DRD350HQ", "DRD370BQ", "supplement_count", 
"DSDCOUNT", "PHOSPHORUS_mg", "POTASSIUM_mg", "SODIUM_mg", "LBX196", 
"LBD199", "LBX206", "URXP20", "URXP21")
IDA_case_s1s2_Adults_cat_merge <- c("house_age")

#Remove columns and rename data frame then merge data from ambiguous file into continuous file
IDA_case_s1s2_Adults_contmerged <- clarite::merge_data(IDA_case_s1s2_Adults_cont, IDA_case_s1s2_Adults_check, union=TRUE)
IDA_case_s1s2_Adults_cont_final <- clarite::colfilter(d=IDA_case_s1s2_Adults_contmerged, cols=IDA_case_s1s2_Adults_cat_merge, exclude=T)

IDA_case_s1s2_Adults_catmerged <- clarite::merge_data(IDA_case_s1s2_Adults_cat, IDA_case_s1s2_Adults_check, union=TRUE)
IDA_case_s1s2_Adults_cat_final <- clarite::colfilter(d=IDA_case_s1s2_Adults_catmerged, cols=IDA_case_s1s2_Adults_cont_merge, exclude=T)

#Extract unique values and return vector from columns in data dictionary
desc_info <- unique(VarDescription[, colnames(VarDescription) %in% c("tab_desc", "module", "var", "var_desc")])

#Define functions with labels such as X, N, NNZ...etc and combine objects by rows. Return them out to finish function
get0 <- function(x){
  x <- as.numeric(as.character(x))
  N <- length(x)
  NNZ <- length(x[x>0])
  PZ <- (N-NNZ)/N
  out <- rbind(N=N, NNZ=NNZ, PZ=PZ)
  return(out)
}

#Drop >90% of the samples with get0 function. Combine columns and create data another data frame with PZ as label for dropped variables. Write to text file.

IDA_case_s1s2_Adults_cont_0 <- as.data.frame(t(sapply(IDA_case_s1s2_Adults_cont_final[, -1], get0)))
IDA_case_s1s2_Adults_cont_0 <- cbind(rownames(IDA_case_s1s2_Adults_cont_0), data.frame(IDA_case_s1s2_Adults_cont_0, row.names=NULL))
names(IDA_case_s1s2_Adults_cont_0) <- c("var", "N", "NNZ", "PZ")
IDA_case_s1s2_Adults_cont_full <- merge(IDA_case_s1s2_Adults_cont_0, desc_info, by="var")
IDA_case_s1s2_Adults_cont_full <- IDA_case_s1s2_Adults_cont_full[order(IDA_case_s1s2_Adults_cont_full$PZ, decreasing=TRUE), ]
write.table(IDA_case_s1s2_Adults_cont_full, file="IDA_case_s1s2_Adults_percent_zero_values_series1-2.txt", sep="\t", quote=FALSE, row.names=FALSE)

#Remove PZ >= 0.90
IDA_case_Adults_pz <- IDA_case_s1s2_Adults_cont_full[IDA_case_s1s2_Adults_cont_full$PZ >= 0.9, 1, drop=FALSE]

#Filter out the >= 0.90 samples from continuous file.
IDA_case_s1s2_Adults_final_pz <- clarite::colfilter(d=IDA_case_s1s2_Adults_cont_final, cols=IDA_case_Adults_pz, exclude = TRUE)

#Drop the Hemoglobin reading and blood related components
drop_item_Anemia <- c("LBDHDD", "LBDHDL", "LBDLDL", "LBXSTR", "LBXTC","LBXTR", "LBXSCH", "DR1TCHOL","house_type","house_age","hepa","hepb","current_past_smoking","CVDVOMAX", "CVDESVO2", "CVDS1HR", "CVDS1SY", "CVDS1DI", "CVDS2HR", "CVDS2SY", "CVDS2DI", "CVDR1HR", "CVDR1SY", "CVDR1DI", "CVDR2HR", "CVDR2SY", "CVDR2DI", "physical_activity", "SMQ120","SMQ040","SMQ150","num_months_longest_job","cigarette_smoking","SMD410","SMD090","SMD070","SMD075")
IDA_case_s1s2_Adults_final_pz_final <- clarite::colfilter(d=IDA_case_s1s2_Adults_final_pz, cols=drop_item_Anemia, exclude = TRUE)

#Merge categorical and binary files (data frames)
IDA_case_s1s2_Adults_cat_bin <- clarite::merge_data(IDA_case_s1s2_Adults_cat_final, IDA_case_s1s2_Adults_bin)

#Drop variables <200 and rename file
skip <- covar_IDA[!covar_IDA %in% c("BMXBMI","RIDAGEYR", "LBXCOT", "SDMVPSU","female")]

IDA_case_s1s2_Adults_final <- clarite::min_cat_n(IDA_case_s1s2_Adults_cat_bin, skip = skip)
IDA_case_s1s2_Adults_final <- clarite::colfilter(d=IDA_case_s1s2_Adults_final, cols=drop_item_Anemia, exclude = TRUE)
IDA_case_s1s2_Adults_final$female <- "1"
IDA_case_s1s2_Adults_final$female <-as.numeric(IDA_case_s1s2_Adults_final$female)

IDA_case_s1s2_Adults_final_pz_200 <- clarite::min_n(IDA_case_s1s2_Adults_final_pz_final)
```

#IDA and Control - Replication Group
```{r}
Anemia_case_IDA_Distinct_s3s4 <- Anemia_case_IDA_Distinct[Anemia_case_IDA_Distinct$SDDSRVYR==4 | Anemia_case_IDA_Distinct$SDDSRVYR==3, ]
colnames(Anemia_case_IDA_Distinct_s3s4)[1] <- "ID"
IDA_case_s3s4_keepvar <- clarite::colfilter(d=Anemia_case_IDA_Distinct_s3s4, cols=keepvar, exclude=F)
IDA_case_s3s4_Adults <- IDA_case_s3s4_keepvar[IDA_case_s3s4_keepvar$RIDAGEYR >= 15,]
IDA_case_s3s4_Adults$URXPREG[IDA_case_s3s4_Adults$URXPREG==0]<-2 
IDA_case_s3s4_Adults$URXPREG[IDA_case_s3s4_Adults$URXPREG==3]<-2
IDA_case_s3s4_Adults$URXPREG[IDA_case_s3s4_Adults$URXPREG==4]<-2
IDA_case_s3s4_Adults$URXPREG[is.na(IDA_case_s3s4_Adults$URXPREG)] <- 2

IDA_case_s3s4_Adults <- remove_incomplete_obs(IDA_case_s3s4_Adults, c(covar_IDA))

##Split into data type
#Get binary varibales into a separate file
IDA_case_s3s4_Adults_bin <- clarite::get_binary(IDA_case_s3s4_Adults)

#Get categorical variables into a separate file
IDA_case_s3s4_Adults_cat <- clarite::get_categorical(IDA_case_s3s4_Adults)

#Changes values 7 and 9 using a pipeline format to NA. Cannot decipher meaning of values so make NA.
IDA_case_s3s4_Adults_cat$SMQ077 <- ifelse(IDA_case_s3s4_Adults_cat$SMQ077==7 | IDA_case_s3s4_Adults_cat$SMQ077==9, NA, IDA_case_s3s4_Adults_cat$SMQ077)

#Get continuous variables into a separate file
IDA_case_s3s4_Adults_cont <- clarite::get_continuous(IDA_case_s3s4_Adults)

#Get ambiguous variables into a separate file
IDA_case_s3s4_Adults_check <- clarite::get_check(IDA_case_s3s4_Adults)

IDA_case_s3s4_Adults_cont_merge <- c("LBXWME", "LBXTO1", "LBXMPAH", "LBXPFDE", "LBXPFUA", 
"URXMNP", "LBX128", "LBXMIR", "URXP14", "URX1TB", "URX3TB", "URXPCP", 
"URXOPP", "quantity_drink_per_day", "total_days_5drink_year", 
"SMQ050", "SMD100TR", "SMD100NI", "SMD100CO", "SMD090", "SMD080", 
"SMD075", "SMD070", "SMD057", "number_close_friends", "DRD350BQ", 
"DRD350HQ", "DRD370BQ", "PHOSPHORUS_mg", "POTASSIUM_mg", "URXUAS3", 
"LBXBR9", "LBXBR66", "LBXIE1", "LBXF13", "LBXIT3", "LBXIM3", 
"DUQ210", "DUQ260", "last_time_used_cocaine", "DED038Q", "SMD650", 
"SMD641", "DR1TATOA")
IDA_case_s3s4_Adults_cat_merge <- NULL

#Remove columns and rename data frame then merge data from ambiguous file into continuous file
IDA_case_s3s4_Adults_contmerged <- clarite::merge_data(IDA_case_s3s4_Adults_cont, IDA_case_s3s4_Adults_check, union=TRUE)
IDA_case_s3s4_Adults_cont_final <- clarite::colfilter(d=IDA_case_s3s4_Adults_contmerged, cols=IDA_case_s3s4_Adults_cat_merge, exclude=T)

IDA_case_s3s4_Adults_catmerged <- clarite::merge_data(IDA_case_s3s4_Adults_cat, IDA_case_s3s4_Adults_check, union=TRUE)
IDA_case_s3s4_Adults_cat_final <- clarite::colfilter(d=IDA_case_s3s4_Adults_catmerged, cols=IDA_case_s3s4_Adults_cont_merge, exclude=T)

#Extract unique values and return vector from columns in data dictionary
desc_info <- unique(VarDescription[, colnames(VarDescription) %in% c("tab_desc", "module", "var", "var_desc")])

#Define functions with labels such as X, N, NNZ...etc and combine objects by rows. Return them out to finish function
get0 <- function(x){
  x <- as.numeric(as.character(x))
  N <- length(x)
  NNZ <- length(x[x>0])
  PZ <- (N-NNZ)/N
  out <- rbind(N=N, NNZ=NNZ, PZ=PZ)
  return(out)
}

#Drop >90% of the samples with get0 function. Combine columns and create data another data frame with PZ as label for dropped variables. Write to text file.
IDA_case_s3s4_Adults_cont_0 <- as.data.frame(t(sapply(IDA_case_s3s4_Adults_cont_final[, -1], get0)))
IDA_case_s3s4_Adults_cont_0 <- cbind(rownames(IDA_case_s3s4_Adults_cont_0), data.frame(IDA_case_s3s4_Adults_cont_0, row.names=NULL))
names(IDA_case_s3s4_Adults_cont_0) <- c("var", "N", "NNZ", "PZ")
IDA_case_s3s4_Adults_cont_full <- merge(IDA_case_s3s4_Adults_cont_0, desc_info, by="var")
IDA_case_s3s4_Adults_cont_full <- IDA_case_s3s4_Adults_cont_full[order(IDA_case_s3s4_Adults_cont_full$PZ, decreasing=TRUE), ]
write.table(IDA_case_s3s4_Adults_cont_full, file="IDA_case_s3s4_Adults_percent_zero_values_series1-2.txt", sep="\t", quote=FALSE, row.names=FALSE)

#Remove PZ >= 0.90
IDA_case_Adults_pz <- IDA_case_s3s4_Adults_cont_full[IDA_case_s3s4_Adults_cont_full$PZ >= 0.9, 1, drop=FALSE]

#Filter out the >= 0.90 samples from continuous file.
IDA_case_s3s4_Adults_final_pz <- clarite::colfilter(d=IDA_case_s3s4_Adults_cont_final, cols=IDA_case_Adults_pz, exclude = TRUE)

#Drop the Hemoglobin reading and blood related components
drop_item_Anemia <- c("LBDHDD", "LBDHDL", "LBDLDL", "LBXSTR", "LBXTC","LBXTR", "LBXSCH", "DR1TCHOL","house_type","house_age","hepa","hepb","current_past_smoking","CVDVOMAX", "CVDESVO2", "CVDS1HR", "CVDS1SY", "CVDS1DI", "CVDS2HR", "CVDS2SY", "CVDS2DI", "CVDR1HR", "CVDR1SY", "CVDR1DI", "CVDR2HR", "CVDR2SY", "CVDR2DI", "physical_activity", "SMQ120","SMQ040","SMQ150","num_months_longest_job","cigarette_smoking","SMD410","SMD090","SMD070","SMD075")
IDA_case_s3s4_Adults_final_pz_final <- clarite::colfilter(d=IDA_case_s3s4_Adults_final_pz, cols=drop_item_Anemia, exclude = TRUE)

#Merge categorical and binary files (data frames)
IDA_case_s3s4_Adults_cat_bin <- clarite::merge_data(IDA_case_s3s4_Adults_cat_final, IDA_case_s3s4_Adults_bin)

#Drop variables <200 and rename file
skip <- covar_IDA[!covar_IDA %in% c("BMXBMI","RIDAGEYR", "LBXCOT", "SDMVPSU", "female")]

IDA_case_s3s4_Adults_final <- clarite::min_cat_n(IDA_case_s3s4_Adults_cat_bin, skip = skip)
IDA_case_s3s4_Adults_final <- clarite::colfilter(d=IDA_case_s3s4_Adults_final, cols=drop_item_Anemia, exclude = TRUE)

#Add female back
IDA_case_s3s4_Adults_final$female <- "1"
IDA_case_s3s4_Adults_final$female <- as.numeric(IDA_case_s3s4_Adults_final$female)

IDA_case_s3s4_Adults_final_pz_200 <- clarite::min_n(IDA_case_s3s4_Adults_final_pz_final)
```

##EWAS Preparation Discovery Group
```{r include=FALSE}
#Adults
##Dataframe
IDA_case_adult_final_dis <- merge(IDA_case_s1s2_Adults_final, IDA_case_s1s2_Adults_final_pz_200, by="ID")
IDA_case_adult_final_dis$anemia <- "1"
IDA_case_adult_final_rep <- merge(IDA_case_s3s4_Adults_final, IDA_case_s3s4_Adults_final_pz_200, by="ID")
IDA_case_adult_final_rep$anemia <- "1"

anemia_control_adult_final_dis <- merge(Anemia_control_s1s2_Adults_cat_final, Anemia_control_s1s2_Adults_final_pz_200, by="ID")
UXPREG_table <- cbind.data.frame(Main_table$ID, Main_table$URXPREG)
colnames(UXPREG_table)[1] = "ID"
colnames(UXPREG_table)[2] = "URXPREG"
anemia_control_adult_final_dis <- merge(anemia_control_adult_final_dis, UXPREG_table, by="ID")
anemia_control_adult_final_dis <- anemia_control_adult_final_dis[anemia_control_adult_final_dis$female == 1, ]
anemia_control_adult_final_dis$URXPREG[anemia_control_adult_final_dis$URXPREG==0]<-2 
anemia_control_adult_final_dis$URXPREG[anemia_control_adult_final_dis$URXPREG==3]<-2
anemia_control_adult_final_dis$URXPREG[anemia_control_adult_final_dis$URXPREG==4]<-2
anemia_control_adult_final_dis$URXPREG[is.na(anemia_control_adult_final_dis$URXPREG)]<-2
anemia_control_adult_final_dis$anemia <- "0"

anemia_control_adult_final_rep <- merge(Anemia_control_s3s4_Adults_cat_final, Anemia_control_s3s4_Adults_final_pz_200, by="ID")
anemia_control_adult_final_rep <- merge(anemia_control_adult_final_rep, UXPREG_table, by="ID")
anemia_control_adult_final_rep <- anemia_control_adult_final_rep[anemia_control_adult_final_rep$female == 1, ]
anemia_control_adult_final_rep$URXPREG[anemia_control_adult_final_rep$URXPREG==0]<-2 
anemia_control_adult_final_rep$URXPREG[anemia_control_adult_final_rep$URXPREG==3]<-2
anemia_control_adult_final_rep$URXPREG[anemia_control_adult_final_rep$URXPREG==4]<-2
anemia_control_adult_final_rep$URXPREG[is.na(anemia_control_adult_final_rep$URXPREG)]<-2
anemia_control_adult_final_rep$anemia <- "0"

##Variables between case and control
IDA_case_adult_final_dis_list <-dput(names(IDA_case_adult_final_dis))
IDA_case_control_adult_final_adult_crosslist <- (intersect(IDA_case_adult_final_dis_list,anemia_control_adult_final_dis_list))
IDA_case_control_adult_final_adult_crosslist <- c(IDA_case_control_adult_final_adult_crosslist,"URXPREG")

col.num.adult.case.dis.ida <- which(colnames(IDA_case_adult_final_dis) %in% IDA_case_control_adult_final_adult_crosslist)
IDA_case_adult_final_dis <- IDA_case_adult_final_dis[,col.num.adult.case.dis.ida]

col.num.adult.control.dis.ida <- which(colnames(anemia_control_adult_final_dis) %in% IDA_case_control_adult_final_adult_crosslist)
IDA_control_adult_final_dis <- anemia_control_adult_final_dis[,col.num.adult.control.dis.ida]

IDA_casctrl_adult_final_dis <- rbind.data.frame(IDA_case_adult_final_dis, IDA_control_adult_final_dis)

IDA_case_adult_final_rep_list <-dput(names(IDA_case_adult_final_rep))
IDA_case_control_adult_final_adult_crosslist <- (intersect(IDA_case_adult_final_rep_list,anemia_control_adult_final_rep_list))
IDA_case_control_adult_final_adult_crosslist <- c(IDA_case_control_adult_final_adult_crosslist, "URXPREG")

col.num.adult.case.rep.ida <- which(colnames(IDA_case_adult_final_rep) %in% IDA_case_control_adult_final_adult_crosslist)
IDA_case_adult_final_rep <- IDA_case_adult_final_rep[,col.num.adult.case.rep.ida]

col.num.adult.control.rep.ida <- which(colnames(anemia_control_adult_final_rep) %in% IDA_case_control_adult_final_adult_crosslist)
IDA_control_adult_final_rep <- anemia_control_adult_final_rep[,col.num.adult.control.rep.ida]

IDA_casctrl_adult_final_rep <- rbind.data.frame(IDA_case_adult_final_rep, IDA_control_adult_final_rep)

#Variable between discovery and replication 
IDA_casctrl_adult_final_dis_list <-dput(names(IDA_casctrl_adult_final_dis))
IDA_casctrl_adult_final_rep_list <-dput(names(IDA_casctrl_adult_final_rep))
IDA_casctrl_adult_final_disrep_crosslist <- (intersect(IDA_casctrl_adult_final_dis_list, IDA_casctrl_adult_final_rep_list))

col.num.adult.casctrl.dis.ida <- which(colnames(IDA_casctrl_adult_final_dis) %in% IDA_casctrl_adult_final_disrep_crosslist)
IDA_casctrl_adult_final_dis <- IDA_casctrl_adult_final_dis[,col.num.adult.casctrl.dis.ida]

#Variable with Weights
IDA_casctrl_adult_final_dis_final_crosslist <- (intersect(IDA_casctrl_adult_final_disrep_crosslist,VarWeight$Variable))
IDA_casctrl_adult_final_dis_final_crosslist_variables <- c("ID",IDA_casctrl_adult_final_dis_final_crosslist,covar_IDA,pheno_IDA)

col.num.adult.dis_varwt.ida <- which(colnames(IDA_casctrl_adult_final_dis) %in% IDA_casctrl_adult_final_dis_final_crosslist_variables)
IDA_casctrl_adult_final_dis <- IDA_casctrl_adult_final_dis[,col.num.adult.dis_varwt.ida]

IDA_casctrl_adult_final_dis_final <- merge_data(IDA_casctrl_adult_final_dis, survey_design_discovery, union = FALSE)
IDA_casctrl_adult_final_dis_final$anemia <- as.numeric(IDA_casctrl_adult_final_dis_final$anemia)

##Co-variables
IDA_casctrl_adult_final_dis_cat_vars <- dput(names(IDA_case_s1s2_Adults_cat_final))
IDA_casctrl_adult_final_dis_cat_vars <- IDA_casctrl_adult_final_dis_cat_vars[IDA_casctrl_adult_final_dis_cat_vars %in% IDA_casctrl_adult_final_dis_final_crosslist]

IDA_casctrl_adult_final_dis_cont_vars <- dput(names(IDA_case_s1s2_Adults_final_pz_200))
IDA_casctrl_adult_final_dis_cont_vars <- IDA_casctrl_adult_final_dis_cont_vars[IDA_casctrl_adult_final_dis_cont_vars %in% IDA_casctrl_adult_final_dis_final_crosslist]
```

##EWAS Discovery Group
```{r}
#Adults EWAS
IDA_EWAS_Adult_discovery_results <- ewas(d = IDA_casctrl_adult_final_dis_final,
                                        cat_vars=IDA_casctrl_adult_final_dis_cat_vars,
                                        cont_vars=IDA_casctrl_adult_final_dis_cont_vars,
                                        y=pheno_IDA,
                                        cat_covars=covar_IDA_cat,
                                        cont_covars=covar_IDA_cont,
                                        regression_family="binomial",
                                        allowed_nonvarying=c("female", "SDDSRVYR"),
                                        weights=weights_discovery,
                                        ids="SDMVPSU",
                                        strata="SDMVSTRA",
                                        nest=TRUE,
                                        drop_unweighted = TRUE)
write.table(IDA_EWAS_Adult_discovery_results, file = "EWAS_IDA_Adult_discovery_results.txt", row.names = F)

IDA_EWAS_Adult_discovery_results_adj <- ewas_pval_adjust(IDA_EWAS_Adult_discovery_results)
write.table(IDA_EWAS_Adult_discovery_results_adj, file = "EWAS_IDA_Adult_discovery_results_adj.txt", row.names = F)
```

##EWAS IDA Preparation Replication Group
```{r include=FALSE}
#Adults
pvalue_fdr_rank_IDA_adult <- IDA_EWAS_Adult_discovery_results_adj[order(IDA_EWAS_Adult_discovery_results_adj$pvalue_FDR), ]
selected_variables_fdr_list_IDA_adult <- which(pvalue_fdr_rank_IDA_adult$pvalue_FDR < 0.1)
selected_variables_fdr_IDA_adult <- head(pvalue_fdr_rank_IDA_adult[,1],length(selected_variables_fdr_list_IDA_adult))

variables_fdr_IDA_adult <- c(paste(selected_variables_fdr_IDA_adult), covar_IDA, pheno_IDA)
all_variable_filtered_IDA_adult <- IDA_casctrl_adult_final_rep
rep_variable_IDA_adult <- colfilter(d=all_variable_filtered_IDA_adult, cols = variables_fdr_IDA_adult, exclude = FALSE)

IDA_adult_final_adult_replication_final <- merge_data(rep_variable_IDA_adult, survey_design_replication, union = FALSE)

IDA_adult_final_adult_replication_final$anemia <- as.numeric(IDA_adult_final_adult_replication_final$anemia)

##Variables
IDA_adult_final_rep_cat_vars <- dput(names(Anemia_control_s3s4_Adults_cat_final))
IDA_adult_final_rep_cat_vars_finallist <- dput(names(IDA_adult_final_adult_replication_final))
IDA_adult_final_rep_cat_vars <- intersect(IDA_adult_final_rep_cat_vars,IDA_adult_final_rep_cat_vars_finallist)
IDA_adult_final_rep_cat_vars <- IDA_adult_final_rep_cat_vars[!IDA_adult_final_rep_cat_vars %in% c(covar_IDA, "ID", pheno_ac)]

IDA_adult_final_rep_cont_vars <- dput(names(Anemia_control_s3s4_Adults_final_pz_200))
IDA_adult_final_rep_cont_vars_finallist <- dput(names(IDA_adult_final_adult_replication_final))
IDA_adult_final_rep_cont_vars <-IDA_adult_final_rep_cont_vars[IDA_adult_final_rep_cont_vars %in% IDA_adult_final_rep_cont_vars_finallist]
IDA_adult_final_rep_cont_vars <- IDA_adult_final_rep_cont_vars[!IDA_adult_final_rep_cont_vars %in% c(covar_IDA, "ID", pheno_ac)]
```

##EWAS IDA Replication Group
```{r}
# Adults
IDA_EWAS_adult_replication_results <- ewas(d = IDA_adult_final_adult_replication_final,
                                       cat_vars=IDA_adult_final_rep_cat_vars,
                                       cont_vars=IDA_adult_final_rep_cont_vars,
                                       y=pheno_IDA,
                                       cat_covars=covar_IDA_cat,
                                       cont_covars=covar_IDA_cont,
                                       regression_family="binomial",
                                       allowed_nonvarying=c("female", "SDDSRVYR"),
                                       weights=weights_replication,
                                       ids="SDMVPSU",
                                       strata="SDMVSTRA",
                                       nest=TRUE,
                                       drop_unweighted = TRUE)
write.table(IDA_EWAS_adult_replication_results, file = "EWAS_IDA_Adult_replication_results.txt", row.names = F)


IDA_EWAS_adult_replication_results_adj <- ewas_pval_adjust(IDA_EWAS_adult_replication_results)
write.table(IDA_EWAS_adult_replication_results_adj, file = "EWAS_IDA_case_adult_replication_results_adj.txt", row.names = F)
```

##EWAS IDA Manhattan Plot
```{r}
#Adults
##Extract the variables and p-values
ewas_IDA_adult_dis_crt <- IDA_EWAS_Adult_discovery_results_adj[,c(1,14)]
ewas_IDA_adult_rep_crt <- IDA_EWAS_adult_replication_results_adj[,c(1,13)]

##Add group
ewas_IDA_adult_dis_crt$Shape <- rep("Discovery", nrow(ewas_IDA_adult_dis_crt))
ewas_IDA_adult_rep_crt$Shape <- rep("Replication", nrow(ewas_IDA_adult_rep_crt))
colnames(ewas_IDA_adult_dis_crt)[2] <- "pvalue"
colnames(ewas_IDA_adult_rep_crt)[2] <- "pvalue"

##Combine groups
ewas_IDA_adult_all_crt <- rbind(ewas_IDA_adult_dis_crt,ewas_IDA_adult_rep_crt)
colnames(ewas_IDA_adult_all_crt)[1] <- "Variable"
colnames(ewas_IDA_adult_all_crt)[2] <- "pvalue"

##Manhattan Plot
VarCat_nopf <- read.delim("/Users/Nicen/Desktop/Anemia/Data/VarCat_nopf.txt")
IDA_ewas_mplot_adult <- eman(ewas_IDA_adult_all_crt, ewas = FALSE, groups = VarCat_nopf, file = "M-Plot IDA vs Non-Anemia Adults", morecolors = FALSE, hgt = 7, wi = 12, res = 300)

ggsave(file = "M-Plot IDA vs Non-Anemia Adults.png", plot = IDA_ewas_mplot_adult, device = "png",path = "/Users/Nicen/Desktop/Anemia/Figures/Original Figures", width = 12, height = 7, dpi = 300)
```

##Logistic Regressions for Chronic Renal/Kidney Disease relates Anemia and Control
##CKDA
* Adults ONLY, # of children = 0
* NO replication

```{r}
Anemia_case_CKDA <- CKDA

colnames(Main_table)[1] <- "ID"
CKDA_case_keepvar <- clarite::colfilter(d=Anemia_case_CKDA, cols=keepvar, exclude=F)

CKDA_case_Adults <- CKDA_case_keepvar[CKDA_case_keepvar$RIDAGEYR >= 15,]
CKDA_case_Adults <- remove_incomplete_obs(CKDA_case_Adults,covar_ana)

##Split into data type
#Get binary varibales into a separate file
CKDA_case_Adults_bin <- clarite::get_binary(CKDA_case_Adults)

#Get categorical variables into a separate file
CKDA_case_Adults_cat <- clarite::get_categorical(CKDA_case_Adults)

#Changes values 7 and 9 using a pipeline format to NA. Cannot decipher meaning of values so make NA.
CKDA_case_Adults_cat$SMQ077 <- ifelse(CKDA_case_Adults_cat$SMQ077==7 | CKDA_case_Adults_cat$SMQ077==9, NA, CKDA_case_Adults_cat$SMQ077)

#Get continuous variables into a separate file
CKDA_case_Adults_cont <- clarite::get_continuous(CKDA_case_Adults)

#Get ambiguous variables into a separate file
CKDA_case_Adults_check <- clarite::get_check(CKDA_case_Adults)

CKDA_case_Adults_cont_merge <- c("LBXV4C", "LBXVST", "URXUBE", "LBXME", "LBDRUIU", "LBXVAR", 
"LBXEPAH", "LBXPFDE", "LBXPFSA", "LBXPFUA", "URXMOP", "URXOP5", 
"LBXGHC", "URXP08", "URXP11", "URXP13", "URXP15", "URXP16", "URX1TB", 
"URXPCP", "URXOPP", "URXOPM", "URXP09", "total_days_5drink_year", 
"SMD160", "SMD130", "SMD100TR", "SMD100NI", "SMD100CO", "SMD090", 
"SMD075", "SMD070", "supplement_count", "DSDCOUNT", "COPPER_mg", 
"SODIUM_mg", "URXUMMA", "URX4TO", "LBXALD", "LBXBR4", "LBXBR8", 
"LBXBR9", "LBXBR66", "URXP20", "URXP22", "URXP24", "LBXID2", 
"LBXID1", "LBXIE1", "LBXIE5", "LBXII6", "LBXIM6", "LBXIF1", "LBXIW1", 
"LBXIG5", "LBXIG2", "LBXIM3", "URXP18", "URXBUP", "URXEPB", "SMD650")
CKDA_case_Adults_cat_merge <- NULL

#Remove columns and rename data frame then merge data from ambiguous file into continuous file
CKDA_case_Adults_contmerged <- clarite::merge_data(CKDA_case_Adults_cont, CKDA_case_Adults_check, union=TRUE)
CKDA_case_Adults_cont_final <- clarite::colfilter(d=CKDA_case_Adults_contmerged, cols=CKDA_case_Adults_cat_merge, exclude=T)

CKDA_case_Adults_catmerged <- clarite::merge_data(CKDA_case_Adults_cat, CKDA_case_Adults_check, union=TRUE)
CKDA_case_Adults_cat_final <- clarite::colfilter(d=CKDA_case_Adults_catmerged, cols=CKDA_case_Adults_cont_merge, exclude=T)

#Extract unique values and return vector from columns in data dictionary
desc_info <- unique(VarDescription[, colnames(VarDescription) %in% c("tab_desc", "module", "var", "var_desc")])

#Define functions with labels such as X, N, NNZ...etc and combine objects by rows. Return them out to finish function
get0 <- function(x){
  x <- as.numeric(as.character(x))
  N <- length(x)
  NNZ <- length(x[x>0])
  PZ <- (N-NNZ)/N
  out <- rbind(N=N, NNZ=NNZ, PZ=PZ)
  return(out)
}

#Drop >90% of the samples with get0 function. Combine columns and create data another data frame with PZ as label for dropped variables. Write to text file.
CKDA_case_Adults_cont_0 <- as.data.frame(t(sapply(CKDA_case_Adults_cont_final[, -1], get0)))
CKDA_case_Adults_cont_0 <- cbind(rownames(CKDA_case_Adults_cont_0), data.frame(CKDA_case_Adults_cont_0, row.names=NULL))
names(CKDA_case_Adults_cont_0) <- c("var", "N", "NNZ", "PZ")
CKDA_case_Adults_cont_full <- merge(CKDA_case_Adults_cont_0, desc_info, by="var")
CKDA_case_Adults_cont_full <- CKDA_case_Adults_cont_full[order(CKDA_case_Adults_cont_full$PZ, decreasing=TRUE), ]
write.table(CKDA_case_Adults_cont_full, file="CKDA_case_Adults_percent_zero_values_series1-2.txt", sep="\t", quote=FALSE, row.names=FALSE)

#Remove PZ >= 0.90
CKDA_case_Adults_pz <- CKDA_case_Adults_cont_full[CKDA_case_Adults_cont_full$PZ >= 0.9, 1, drop=FALSE]

#Filter out the >= 0.90 samples from continuous file.
CKDA_case_Adults_final_pz <- clarite::colfilter(d=CKDA_case_Adults_cont_final, cols=IDA_case_Adults_pz, exclude = TRUE)

#Drop the Hemoglobin reading and blood related components
drop_item_Anemia <- c("LBDHDD", "LBDHDL", "LBDLDL", "LBXSTR", "LBXTC","LBXTR", "LBXSCH", "DR1TCHOL","house_type","house_age","hepa","hepb","current_past_smoking","CVDVOMAX", "CVDESVO2", "CVDS1HR", "CVDS1SY", "CVDS1DI", "CVDS2HR", "CVDS2SY", "CVDS2DI", "CVDR1HR", "CVDR1SY", "CVDR1DI", "CVDR2HR", "CVDR2SY", "CVDR2DI", "physical_activity", "SMQ120","SMQ040","SMQ150","num_months_longest_job","cigarette_smoking","SMD410","SMD090","SMD070","SMD075")
CKDA_case_Adults_final_pz_final <- clarite::colfilter(d=CKDA_case_Adults_final_pz, cols=drop_item_Anemia, exclude = TRUE)

#Merge categorical and binary files (data frames)
CKDA_case_Adults_cat_bin <- clarite::merge_data(CKDA_case_Adults_cat_final, CKDA_case_Adults_bin)

#Drop variables <200 and rename file
skip <- covar_ana[!covar_ana %in% c("BMXBMI","RIDAGEYR", "LBXCOT", "SDMVPSU")]
CKDA_case_Adults_final <- clarite::min_cat_n(CKDA_case_Adults_cat_bin, skip = skip)
CKDA_case_Adults_final <- clarite::colfilter(d=CKDA_case_Adults_final, cols=drop_item_Anemia, exclude = TRUE)

CKDA_case_Adults_final_pz_200 <- clarite::min_n(CKDA_case_Adults_final_pz_final)
```

##EWAS Preparation Discovery Group
```{r include=FALSE}
#Adults
##Dataframe
CKDA_case_adult_final_dis <- merge(CKDA_case_Adults_final, CKDA_case_Adults_final_pz_200, by="ID")
CKDA_case_adult_final_dis$anemia <- "1"

anemia_control_adult_final_dis <- merge(Anemia_control_s1s2_Adults_cat_final, Anemia_control_s1s2_Adults_final_pz_200, by="ID")
anemia_control_adult_final_dis$anemia <- "0"
anemia_control_adult_final_rep <- merge(Anemia_control_s3s4_Adults_cat_final, Anemia_control_s3s4_Adults_final_pz_200, by="ID")
anemia_control_adult_final_rep$anemia <- "0"

##Variables between controls
alist <- dput(names(anemia_control_adult_final_dis))
blist <- dput(names(anemia_control_adult_final_rep))
anemia_control_adult_final_list <- intersect(alist, blist)

col.num.adult.control.dis.final <- which(colnames(anemia_control_adult_final_dis) %in% anemia_control_adult_final_list)
anemia_control_adult_final_dis <- anemia_control_adult_final_dis[,col.num.adult.control.dis.final]

col.num.adult.control.rep.final <- which(colnames(anemia_control_adult_final_rep) %in% anemia_control_adult_final_list)
anemia_control_adult_final_rep <- anemia_control_adult_final_rep[,col.num.adult.control.rep.final]

anemia_control_adult_final <- rbind.data.frame(anemia_control_adult_final_dis, anemia_control_adult_final_rep)

##Variables between case and control
CKDA_case_adult_final_dis_list <-dput(names(CKDA_case_adult_final_dis))
CKDA_case_control_adult_final_adult_crosslist <- (intersect(CKDA_case_adult_final_dis_list,anemia_control_adult_final_list))

col.num.adult.case.dis.CKDA <- which(colnames(CKDA_case_adult_final_dis) %in% CKDA_case_control_adult_final_adult_crosslist)
CKDA_case_adult_final_dis <- CKDA_case_adult_final_dis[,col.num.adult.case.dis.CKDA]

col.num.adult.control.dis.CKDA <- which(colnames(anemia_control_adult_final) %in% CKDA_case_control_adult_final_adult_crosslist)
CKDA_control_adult_final_dis <- anemia_control_adult_final[,col.num.adult.control.dis.CKDA]

CKDA_casctrl_adult_final_dis <- rbind.data.frame(CKDA_case_adult_final_dis, CKDA_control_adult_final_dis)

#Variable with Weights
CKDA_casctrl_adult_final_disonly_finallist <- dput(names(CKDA_casctrl_adult_final_dis))
CKDA_casctrl_adult_final_dis_final_crosslist <- (intersect(CKDA_casctrl_adult_final_disonly_finallist,VarWeight_8$Variable))
CKDA_casctrl_adult_final_dis_final_crosslist_variables <- c("ID",CKDA_casctrl_adult_final_dis_final_crosslist,covar_ana,pheno_ac)

col.num.adult.dis_varwt.CKDA <- which(colnames(CKDA_casctrl_adult_final_dis) %in% CKDA_casctrl_adult_final_dis_final_crosslist_variables)
CKDA_casctrl_adult_final_dis <- CKDA_casctrl_adult_final_dis[,col.num.adult.dis_varwt.CKDA]

CKDA_casctrl_adult_final_dis_final <- merge_data(CKDA_casctrl_adult_final_dis, survey_design_8yrs, union = FALSE)
CKDA_casctrl_adult_final_dis_final$anemia <- as.numeric(CKDA_casctrl_adult_final_dis_final$anemia)

##Co-variables
CKDA_casctrl_adult_final_dis_cat_vars <- dput(names(CKDA_case_Adults_final))
CKDA_casctrl_adult_final_dis_cat_vars <- CKDA_casctrl_adult_final_dis_cat_vars[CKDA_casctrl_adult_final_dis_cat_vars %in% CKDA_casctrl_adult_final_dis_final_crosslist]

CKDA_casctrl_adult_final_dis_cont_vars <- dput(names(CKDA_case_Adults_final_pz_200))
CKDA_casctrl_adult_final_dis_cont_vars <- CKDA_casctrl_adult_final_dis_cont_vars[CKDA_casctrl_adult_final_dis_cont_vars %in% CKDA_casctrl_adult_final_dis_final_crosslist]
```

##EWAS Discovery Group
```{r}
#Adults EWAS
CKDA_EWAS_Adult_discovery_results <- ewas(d = CKDA_casctrl_adult_final_dis_final,
                                        cat_vars=CKDA_casctrl_adult_final_dis_cat_vars,
                                        cont_vars=CKDA_casctrl_adult_final_dis_cont_vars,
                                        y=pheno_ac,
                                        cat_covars=covar_ana_cat,
                                        cont_covars=covar_ana_cont,
                                        regression_family="binomial",
                                        allowed_nonvarying=c("female", "SDDSRVYR"),
                                        weights=weights_8yrs,
                                        ids="SDMVPSU",
                                        strata="SDMVSTRA",
                                        nest=TRUE,
                                        drop_unweighted = TRUE)
write.table(CKDA_EWAS_Adult_discovery_results, file = "EWAS_CKDA_Adult_discovery_results.txt", row.names = F)

CKDA_EWAS_Adult_discovery_results_adj <- ewas_pval_adjust(CKDA_EWAS_Adult_discovery_results)
write.table(CKDA_EWAS_Adult_discovery_results_adj, file = "EWAS_CKDA_Adult_discovery_results_adj.txt", row.names = F)
```

##EWAS CKDA Manhattan Plot
```{r}
#Adults
##Extract the variables and p-values
ewas_CKDA_adult_dis_crt <- CKDA_EWAS_Adult_discovery_results_adj[,c(1,13)]

##Add group
ewas_CKDA_adult_dis_crt$Shape <- rep("Discovery", nrow(ewas_CKDA_adult_dis_crt))

##Combine groups
ewas_CKDA_adult_all_crt <- ewas_CKDA_adult_dis_crt
colnames(ewas_CKDA_adult_all_crt)[1] <- "Variable"
colnames(ewas_CKDA_adult_all_crt)[2] <- "pvalue"

##Manhattan Plot
VarCat_nopf <- read.delim("/Users/Nicen/Desktop/Anemia/Data/VarCat_nopf.txt")
CKDA_ewas_mplot_adult <- eman_o(ewas_CKDA_adult_all_crt, ewas = FALSE, groups = VarCat_nopf, file = "M-Plot CKDA vs Non-Anemia Adults", morecolors = FALSE, hgt = 7, wi = 12, res = 300)

ggsave(file = "M-Plot CKDA vs Non-Anemia Adults.png", plot = CKDA_ewas_mplot_adult, device = "png",path = "/Users/Nicen/Desktop/Anemia/Figures/Original Figures", width = 12, height = 7, dpi = 300)
```


#Logistic Regression between Unexplained Anemia (UA) and Control
* No replicaition for children group

##Unexplained Anemia (UA) and Control as Discovery Group
```{r}
Unexplained_Anemia_s1s2 <- Unexplained_Anemia[Unexplained_Anemia$SDDSRVYR==2 | Unexplained_Anemia$SDDSRVYR==1, ]
UA_case_s1s2_keepvar <- clarite::colfilter(d=Unexplained_Anemia_s1s2, cols=keepvar, exclude=F)

Unexplained_Anemia_s3s4 <- Unexplained_Anemia[Unexplained_Anemia$SDDSRVYR==4 | Unexplained_Anemia$SDDSRVYR==3, ]

UA_case_s3s4_keepvar <- clarite::colfilter(d=Unexplained_Anemia_s3s4, cols=keepvar, exclude=F)

UA_case_s1s2_Children <- UA_case_s1s2_keepvar[UA_case_s1s2_keepvar$RIDAGEYR < 15,]
UA_case_s3s4_Children <- UA_case_s3s4_keepvar[UA_case_s3s4_keepvar$RIDAGEYR < 15,]
UA_case_Children <- rbind.data.frame(UA_case_s1s2_Children,UA_case_s3s4_Children)
UA_case_s1s2_Adults <- UA_case_s1s2_keepvar[UA_case_s1s2_keepvar$RIDAGEYR >= 15,]
UA_case_Children <- remove_incomplete_obs(UA_case_Children, c(covar_ac))
UA_case_s1s2_Adults <- remove_incomplete_obs(UA_case_s1s2_Adults, c(covar_ana))


##Split into data type
#Get binary varibales into a separate file
UA_case_Children_bin <- clarite::get_binary(UA_case_Children)
UA_case_s1s2_Adults_bin <- clarite::get_binary(UA_case_s1s2_Adults)

#Get categorical variables into a separate file
UA_case_Children_cat <- clarite::get_categorical(UA_case_Children)
UA_case_s1s2_Adults_cat <- clarite::get_categorical(UA_case_s1s2_Adults)

#Changes values 7 and 9 using a pipeline format to NA. Cannot decipher meaning of values so make NA.
UA_case_s1s2_Adults_cat$SMQ077 <- ifelse(UA_case_s1s2_Adults_cat$SMQ077==7 | UA_case_s1s2_Adults_cat$SMQ077==9, NA, UA_case_s1s2_Adults_cat$SMQ077)

#Get continuous variables into a separate file
UA_case_Children_cont <- clarite::get_continuous(UA_case_Children)
UA_case_s1s2_Adults_cont <- clarite::get_continuous(UA_case_s1s2_Adults)

#Get ambiguous variables into a separate file
UA_case_Children_check <- clarite::get_check(UA_case_Children)
UA_case_s1s2_Adults_check <- clarite::get_check(UA_case_s1s2_Adults)

UA_case_Children_cont_merge <- c("RIDAGEYR", "LBXWBF", "LBXWCF", "LBXWBM", "LBXWCM", "LBXV4C", 
"LBXVCF", "LBXVME", "LBXVOX", "LBXVTO", "LBXVXY", "LBXBCD", "LBXIHG", 
"LBXTO1", "LBXTO2", "LBXEPAH", "LBXMPAH", "LBXPFHP", "LBXPFNA", 
"LBXPFSA", "URXMCP", "URXMNP", "URXMOP", "URXOP6", "LBX028", 
"LBX105", "LBX156", "LBX157", "LBX167", "LBXD01", "LBXD03", "LBXD04", 
"LBXD05", "LBXD07", "LBXF01", "LBXF02", "LBXF03", "LBXF04", "LBXF05", 
"LBXF06", "LBXF07", "LBXF08", "LBXF10", "LBXPCB", "LBXTC2", "LBXHXC", 
"LBXTCD", "LBX052", "LBX099", "LBX128", "LBX146", "LBX170", "LBX172", 
"LBX177", "LBX178", "LBX183", "LBX187", "LBXHCB", "LBXBHC", "LBXGHC", 
"LBXPDT", "LBXODT", "LBXOXY", "LBXTNA", "LBXHPE", "LBXMIR", "URXP08", 
"URXP11", "URXP12", "URXP13", "URX1TB", "URX25T", "URXP09", "HRDHG", 
"HRXHG","DR1TALCO", "DRD350HQ", "CALCIUM_mg", "COPPER_mg", 
"MAGNESIUM_mg", "PHOSPHORUS_mg", "SODIUM_mg", "TOTAL_CARBOHYDRATE_gm", 
"URXUMMA", "URX4TO", "LBXD02", "LBXF09", "LBX044", "LBX049", 
"LBX087", "LBX110", "LBX149", "LBX151", "LBX195", "LBX196", "LBX206", 
"LBX209", "URXP20", "URXP24", "LBXDTC", "LBXID2", "LBXID1", "LBXIM6", 
"LBXF13", "LBXIF2", "LBXIW1", "LBXIG5", "URXP18", "LBXWIO", "LBXWP8")
UA_case_Children_cat_merge <- c("house_age")
UA_case_s1s2_Adults_cont_merge <- c("LBXVCT", "LBXVTC", "LBXTO2", "LBXEPAH", "LBXPFDE", "LBXPFSA", 
"LBXPFUA", "URXMNP", "URXMOP", "URXP12", "URXP14", "URXP15", 
"URXP16", "URX25T", "LBXZMB", "LBXZDB", "LBXZXY", "LBXZOX", "LBXZTI", 
"LBXZTO", "LBXZTE", "LBXZEB", "LBXZCF", "LBXZBZ", 
"quantity_drink_per_day", "DUQ110", "SMD220", "SMD130", "SMD100TR", 
"SMD100NI", "SMD100CO", "SMD090", "SMD080", "SMD075", "SMD070", 
"SMD057", "DRD370BQ", "DRD370DQ", "DRD370TQ", "supplement_count", 
"DSDCOUNT", "SODIUM_mg", "TOTAL_CARBOHYDRATE_gm", "LBX206", "URXP21")
UA_case_s1s2_Adults_cat_merge <- c("house_age")

#Remove columns and rename data frame then merge data from ambiguous file into continuous file
UA_case_Children_contmerged <- clarite::merge_data(UA_case_Children_cont, UA_case_Children_check, union=TRUE)
UA_case_Children_cont_final <- clarite::colfilter(d=UA_case_Children_contmerged, cols=UA_case_Children_cat_merge, exclude=T)

UA_case_Children_catmerged <- clarite::merge_data(UA_case_Children_cat, UA_case_Children_check, union=TRUE)
UA_case_Children_cat_final <- clarite::colfilter(d=UA_case_Children_catmerged, cols=UA_case_Children_cont_merge, exclude=T)

UA_case_s1s2_Adults_contmerged <- clarite::merge_data(UA_case_s1s2_Adults_cont, UA_case_s1s2_Adults_check, union=TRUE)
UA_case_s1s2_Adults_cont_final <- clarite::colfilter(d=UA_case_s1s2_Adults_contmerged, cols=UA_case_s1s2_Adults_cat_merge, exclude=T)

UA_case_s1s2_Adults_catmerged <- clarite::merge_data(UA_case_s1s2_Adults_cat, UA_case_s1s2_Adults_check, union=TRUE)
UA_case_s1s2_Adults_cat_final <- clarite::colfilter(d=UA_case_s1s2_Adults_catmerged, cols=UA_case_s1s2_Adults_cont_merge, exclude=T)

#Extract unique values and return vector from columns in data dictionary
desc_info <- unique(VarDescription[, colnames(VarDescription) %in% c("tab_desc", "module", "var", "var_desc")])

#Define functions with labels such as X, N, NNZ...etc and combine objects by rows. Return them out to finish function
get0 <- function(x){
  x <- as.numeric(as.character(x))
  N <- length(x)
  NNZ <- length(x[x>0])
  PZ <- (N-NNZ)/N
  out <- rbind(N=N, NNZ=NNZ, PZ=PZ)
  return(out)
}

#Drop >90% of the samples with get0 function. Combine columns and create data another data frame with PZ as label for dropped variables. Write to text file.
UA_case_Children_cont_0 <- as.data.frame(t(sapply(UA_case_Children_cont_final[, -1], get0)))
UA_case_Children_cont_0 <- cbind(rownames(UA_case_Children_cont_0), data.frame(UA_case_Children_cont_0, row.names=NULL))
names(UA_case_Children_cont_0) <- c("var", "N", "NNZ", "PZ")
UA_case_Children_cont_full <- merge(UA_case_Children_cont_0, desc_info, by="var")
UA_case_Children_cont_full <- UA_case_Children_cont_full[order(UA_case_Children_cont_full$PZ, decreasing=TRUE), ]
write.table(UA_case_Children_cont_full, file="UA_case_Children_percent_zero_values_series1-2.txt", sep="\t", quote=FALSE, row.names=FALSE)

UA_case_s1s2_Adults_cont_0 <- as.data.frame(t(sapply(UA_case_s1s2_Adults_cont_final[, -1], get0)))
UA_case_s1s2_Adults_cont_0 <- cbind(rownames(UA_case_s1s2_Adults_cont_0), data.frame(UA_case_s1s2_Adults_cont_0, row.names=NULL))
names(UA_case_s1s2_Adults_cont_0) <- c("var", "N", "NNZ", "PZ")
UA_case_s1s2_Adults_cont_full <- merge(UA_case_s1s2_Adults_cont_0, desc_info, by="var")
UA_case_s1s2_Adults_cont_full <- UA_case_s1s2_Adults_cont_full[order(UA_case_s1s2_Adults_cont_full$PZ, decreasing=TRUE), ]
write.table(UA_case_s1s2_Adults_cont_full, file="UA_case_s1s2_Adults_percent_zero_values_series1-2.txt", sep="\t", quote=FALSE, row.names=FALSE)

#Remove PZ >= 0.90
UA_case_Children_pz <- UA_case_Children_cont_full[UA_case_Children_cont_full$PZ >= 0.9, 1, drop=FALSE]
UA_case_Adults_pz <- UA_case_s1s2_Adults_cont_full[UA_case_s1s2_Adults_cont_full$PZ >= 0.9, 1, drop=FALSE]

#Filter out the >= 0.90 samples from continuous file.
UA_case_Children_final_pz <- clarite::colfilter(d=UA_case_Children_cont_final, cols=UA_case_Children_pz, exclude = TRUE)
UA_case_s1s2_Adults_final_pz <- clarite::colfilter(d=UA_case_s1s2_Adults_cont_final, cols=UA_case_Adults_pz, exclude = TRUE)

#Drop the Hemoglobin reading and blood related components
drop_item_Anemia <- c("LBDHDD", "LBDHDL", "LBDLDL", "LBXSTR", "LBXTC","LBXTR", "LBXSCH", "DR1TCHOL","house_type","house_age","hepa","hepb","current_past_smoking","CVDVOMAX", "CVDESVO2", "CVDS1HR", "CVDS1SY", "CVDS1DI", "CVDS2HR", "CVDS2SY", "CVDS2DI", "CVDR1HR", "CVDR1SY", "CVDR1DI", "CVDR2HR", "CVDR2SY", "CVDR2DI", "physical_activity", "SMQ120","SMQ040","SMQ150","num_months_longest_job","cigarette_smoking","SMD410","SMD090","SMD070","SMD075")
UA_case_Children_final_pz_final <- clarite::colfilter(d=UA_case_Children_final_pz, cols=drop_item_Anemia, exclude = TRUE)
UA_case_s1s2_Adults_final_pz_final <- clarite::colfilter(d=UA_case_s1s2_Adults_final_pz, cols=drop_item_Anemia, exclude = TRUE)

#Merge categorical and binary files (data frames)
UA_case_Children_cat_bin <- clarite::merge_data(UA_case_Children_cat_final, UA_case_Children_bin)
UA_case_s1s2_Adults_cat_bin <- clarite::merge_data(UA_case_s1s2_Adults_cat_final, UA_case_s1s2_Adults_bin)

#Drop variables <200 and rename file
skip_acc <- covar_ac[!covar_ac %in% c("BMXBMI","RIDAGEYR", "LBXCOT", "SDMVPSU")]
skip_aca <- covar_ana[!covar_ana %in% c("BMXBMI","RIDAGEYR", "LBXCOT", "SDMVPSU")]
UA_case_Children_cat_final <- clarite::min_cat_n(UA_case_Children_cat_bin, skip = skip_acc)
UA_case_Children_cat_final <- clarite::colfilter(d=UA_case_Children_cat_final, cols=drop_item_Anemia, exclude = TRUE)

UA_case_s1s2_Adults_final <- clarite::min_cat_n(UA_case_s1s2_Adults_cat_bin, skip = skip_aca)
UA_case_s1s2_Adults_final <- clarite::colfilter(d=UA_case_s1s2_Adults_final, cols=drop_item_Anemia, exclude = TRUE)

UA_case_Children_final_pz_200 <- clarite::min_n(UA_case_Children_final_pz_final)
UA_case_s1s2_Adults_final_pz_200 <- clarite::min_n(UA_case_s1s2_Adults_final_pz_final)
```

##UA Replication group
```{r}
Unexplained_Anemia_s3s4 <- Unexplained_Anemia[Unexplained_Anemia$SDDSRVYR==4 | Unexplained_Anemia$SDDSRVYR==3, ]

UA_case_s3s4_keepvar <- clarite::colfilter(d=Unexplained_Anemia_s3s4, cols=keepvar, exclude=F)

length(which(UA_case_s3s4_keepvar$female == "0"))
length(which(UA_case_s3s4_keepvar$female == "1"))

UA_case_s3s4_Adults <- UA_case_s3s4_keepvar[UA_case_s3s4_keepvar$RIDAGEYR >= 15,]
UA_case_s3s4_Adults <- remove_incomplete_obs(UA_case_s3s4_Adults, c(covar_ana))


##Split into data type
#Get binary varibales into a separate file
UA_case_s3s4_Adults_bin <- clarite::get_binary(UA_case_s3s4_Adults)

#Get categorical variables into a separate file
UA_case_s3s4_Adults_cat <- clarite::get_categorical(UA_case_s3s4_Adults)

#Changes values 7 and 9 using a pipeline format to NA. Cannot decipher meaning of values so make NA.
UA_case_s3s4_Adults_cat$SMQ077 <- ifelse(UA_case_s3s4_Adults_cat$SMQ077==7 | UA_case_s3s4_Adults_cat$SMQ077==9, NA, UA_case_s3s4_Adults_cat$SMQ077)

#Get continuous variables into a separate file
UA_case_s3s4_Adults_cont <- clarite::get_continuous(UA_case_s3s4_Adults)

#Get ambiguous variables into a separate file
UA_case_s3s4_Adults_check <- clarite::get_check(UA_case_s3s4_Adults)

UA_case_s3s4_Adults_cont_merge <- c("URXUPT", "LBXEPAH", "LBXPFHP", "LBXPFSA", "URXMCP", 
"URXMNP", "URXOP6", "LBX128", "URXP08", "URXP13", "URX1TB", "URXOPP", 
"quantity_drink_per_day", "total_days_5drink_year", "SMD100TR", 
"SMD100NI", "SMD100CO", "SMD080", "SMD070", "DRD350HQ", "DRD370BQ", 
"DRD370DQ", "DRD370MQ", "DRD370TQ", "supplement_count", "DSDCOUNT", 
"TOTAL_CARBOHYDRATE_gm", "LBXEND", "LBXBR9", "LBXBR66", "URXP20", 
"URXP24", "LBXIE1", "LBXIM6", "LBXIT3", "LBXIM3", "DUQ210", "SMD641", 
"DR1CWATR")
UA_case_s3s4_Adults_cat_merge <- NULL

#Remove columns and rename data frame then merge data from ambiguous file into continuous file
UA_case_s3s4_Adults_contmerged <- clarite::merge_data(UA_case_s3s4_Adults_cont, UA_case_s3s4_Adults_check, union=TRUE)
UA_case_s3s4_Adults_cont_final <- clarite::colfilter(d=UA_case_s3s4_Adults_contmerged, cols=UA_case_s3s4_Adults_cat_merge, exclude=T)

UA_case_s3s4_Adults_catmerged <- clarite::merge_data(UA_case_s3s4_Adults_cat, UA_case_s3s4_Adults_check, union=TRUE)
UA_case_s3s4_Adults_cat_final <- clarite::colfilter(d=UA_case_s3s4_Adults_catmerged, cols=UA_case_s3s4_Adults_cont_merge, exclude=T)

#Extract unique values and return vector from columns in data dictionary
desc_info <- unique(VarDescription[, colnames(VarDescription) %in% c("tab_desc", "module", "var", "var_desc")])

#Define functions with labels such as X, N, NNZ...etc and combine objects by rows. Return them out to finish function
get0 <- function(x){
  x <- as.numeric(as.character(x))
  N <- length(x)
  NNZ <- length(x[x>0])
  PZ <- (N-NNZ)/N
  out <- rbind(N=N, NNZ=NNZ, PZ=PZ)
  return(out)
}

#Drop >90% of the samples with get0 function. Combine columns and create data another data frame with PZ as label for dropped variables. Write to text file.
UA_case_s3s4_Adults_cont_0 <- as.data.frame(t(sapply(UA_case_s3s4_Adults_cont_final[, -1], get0)))
UA_case_s3s4_Adults_cont_0 <- cbind(rownames(UA_case_s3s4_Adults_cont_0), data.frame(UA_case_s3s4_Adults_cont_0, row.names=NULL))
names(UA_case_s3s4_Adults_cont_0) <- c("var", "N", "NNZ", "PZ")
UA_case_s3s4_Adults_cont_full <- merge(UA_case_s3s4_Adults_cont_0, desc_info, by="var")
UA_case_s3s4_Adults_cont_full <- UA_case_s3s4_Adults_cont_full[order(UA_case_s3s4_Adults_cont_full$PZ, decreasing=TRUE), ]
write.table(UA_case_s3s4_Adults_cont_full, file="UA_case_s3s4_Adults_percent_zero_values_series1-2.txt", sep="\t", quote=FALSE, row.names=FALSE)

#Remove PZ >= 0.90
UA_case_Adults_pz <- UA_case_s3s4_Adults_cont_full[UA_case_s3s4_Adults_cont_full$PZ >= 0.9, 1, drop=FALSE]

#Filter out the >= 0.90 samples from continuous file.
UA_case_s3s4_Adults_final_pz <- clarite::colfilter(d=UA_case_s3s4_Adults_cont_final, cols=UA_case_Adults_pz, exclude = TRUE)

#Drop the Hemoglobin reading and blood related components
drop_item_Anemia <- c("LBDHDD", "LBDHDL", "LBDLDL", "LBXSTR", "LBXTC","LBXTR", "LBXSCH", "DR1TCHOL","house_type","house_age","hepa","hepb","current_past_smoking","CVDVOMAX", "CVDESVO2", "CVDS1HR", "CVDS1SY", "CVDS1DI", "CVDS2HR", "CVDS2SY", "CVDS2DI", "CVDR1HR", "CVDR1SY", "CVDR1DI", "CVDR2HR", "CVDR2SY", "CVDR2DI", "physical_activity", "SMQ120","SMQ040","SMQ150","num_months_longest_job","cigarette_smoking","SMD410","SMD090","SMD070","SMD075")
UA_case_s3s4_Adults_final_pz_final <- clarite::colfilter(d=UA_case_s3s4_Adults_final_pz, cols=drop_item_Anemia, exclude = TRUE)

#Merge categorical and binary files (data frames)
UA_case_s3s4_Adults_cat_bin <- clarite::merge_data(UA_case_s3s4_Adults_cat_final, UA_case_s3s4_Adults_bin)

#Drop variables <200 and rename file
skip_aca <- covar_ana[!covar_ana %in% c("BMXBMI","RIDAGEYR", "LBXCOT", "SDMVPSU")]
UA_case_s3s4_Adults_final <- clarite::min_cat_n(UA_case_s3s4_Adults_cat_bin, skip = skip_aca)
UA_case_s3s4_Adults_final <- clarite::colfilter(d=UA_case_s3s4_Adults_final, cols=drop_item_Anemia, exclude = TRUE)

UA_case_s3s4_Adults_final_pz_200 <- clarite::min_n(UA_case_s3s4_Adults_final_pz_final)
```

##EWAS UA Preparation Discovery Group
```{r include=FALSE}
#Adults
##Dataframe
UA_case_adult_final_dis <- merge(UA_case_s1s2_Adults_final, UA_case_s1s2_Adults_final_pz_200, by="ID")
UA_case_adult_final_dis$anemia <- "1"
UA_case_adult_final_rep <- merge(UA_case_s3s4_Adults_final, UA_case_s3s4_Adults_final_pz_200, by="ID")
UA_case_adult_final_rep$anemia <- "1"

anemia_control_adult_final_dis <- merge(Anemia_control_s1s2_Adults_cat_final, Anemia_control_s1s2_Adults_final_pz_200, by="ID")
anemia_control_adult_final_dis$anemia <- "0"
anemia_control_adult_final_rep <- merge(Anemia_control_s3s4_Adults_cat_final, Anemia_control_s3s4_Adults_final_pz_200, by="ID")
anemia_control_adult_final_rep$anemia <- "0"

##Variables between case and control
UA_case_adult_final_dis_list <-dput(names(UA_case_adult_final_dis))
UA_case_control_adult_final_adult_crosslist <- (intersect(UA_case_adult_final_dis_list,anemia_control_adult_final_dis_list))

col.num.adult.case.dis.UA <- which(colnames(UA_case_adult_final_dis) %in% UA_case_control_adult_final_adult_crosslist)
UA_case_adult_final_dis <- UA_case_adult_final_dis[,col.num.adult.case.dis.UA]

col.num.adult.control.dis.UA <- which(colnames(anemia_control_adult_final_dis) %in% UA_case_control_adult_final_adult_crosslist)
UA_control_adult_final_dis <- anemia_control_adult_final_dis[,col.num.adult.control.dis.UA]

UA_casctrl_adult_final_dis <- rbind.data.frame(UA_case_adult_final_dis, UA_control_adult_final_dis)

UA_case_adult_final_rep_list <-dput(names(UA_case_adult_final_rep))
UA_case_control_adult_final_adult_crosslist <- (intersect(UA_case_adult_final_rep_list,anemia_control_adult_final_rep_list))

col.num.adult.case.rep.UA <- which(colnames(UA_case_adult_final_rep) %in% UA_case_control_adult_final_adult_crosslist)
UA_case_adult_final_rep <- UA_case_adult_final_rep[,col.num.adult.case.rep.UA]

col.num.adult.control.rep.UA <- which(colnames(anemia_control_adult_final_rep) %in% UA_case_control_adult_final_adult_crosslist)
UA_control_adult_final_rep <- anemia_control_adult_final_rep[,col.num.adult.control.rep.UA]

UA_casctrl_adult_final_rep <- rbind.data.frame(UA_case_adult_final_rep, UA_control_adult_final_rep)

#Variable between discovery and replication 
UA_casctrl_adult_final_dis_list <-dput(names(UA_casctrl_adult_final_dis))
UA_casctrl_adult_final_rep_list <-dput(names(UA_casctrl_adult_final_rep))
UA_casctrl_adult_final_disrep_crosslist <- (intersect(UA_casctrl_adult_final_dis_list, UA_casctrl_adult_final_rep_list))

col.num.adult.casctrl.dis.UA <- which(colnames(UA_casctrl_adult_final_dis) %in% UA_casctrl_adult_final_disrep_crosslist)
UA_casctrl_adult_final_dis <- UA_casctrl_adult_final_dis[,col.num.adult.casctrl.dis.UA]

#Variable with Weights
UA_casctrl_adult_final_dis_final_crosslist <- (intersect(UA_casctrl_adult_final_disrep_crosslist,VarWeight$Variable))
UA_casctrl_adult_final_dis_final_crosslist_variables <- c("ID",UA_casctrl_adult_final_dis_final_crosslist,covar_ana,pheno_IDA)

col.num.adult.dis_varwt.UA <- which(colnames(UA_casctrl_adult_final_dis) %in% UA_casctrl_adult_final_dis_final_crosslist_variables)
UA_casctrl_adult_final_dis <- UA_casctrl_adult_final_dis[,col.num.adult.dis_varwt.UA]

UA_casctrl_adult_final_dis_final <- merge_data(UA_casctrl_adult_final_dis, survey_design_discovery, union = FALSE)
UA_casctrl_adult_final_dis_final$anemia <- as.numeric(UA_casctrl_adult_final_dis_final$anemia)

##Co-variables
UA_casctrl_adult_final_dis_cat_vars <- dput(names(UA_case_s1s2_Adults_final))
UA_casctrl_adult_final_dis_cat_vars <- UA_casctrl_adult_final_dis_cat_vars[UA_casctrl_adult_final_dis_cat_vars %in% UA_casctrl_adult_final_dis_final_crosslist]

UA_casctrl_adult_final_dis_cont_vars <- dput(names(UA_case_s1s2_Adults_final_pz_200))
UA_casctrl_adult_final_dis_cont_vars <- UA_casctrl_adult_final_dis_cont_vars[UA_casctrl_adult_final_dis_cont_vars %in% UA_casctrl_adult_final_dis_final_crosslist]

#children
##Dataframe
UA_case_child_final <- merge(UA_case_Children_final_pz_200, UA_case_Children_cat_final, by="ID")
UA_case_child_final$anemia <- "1"

anemia_control_child_final_dis <- merge(Anemia_control_s1s2_Children_cat_final, Anemia_control_s1s2_Children_final_pz_200, by="ID")
anemia_control_child_final_dis$anemia <- "0"
anemia_control_child_final_rep <- merge(Anemia_control_s3s4_Children_cat_final, Anemia_control_s3s4_Children_final_pz_200, by="ID")
anemia_control_child_final_rep$anemia <- "0"

##Variables between controls
calist <- dput(names(anemia_control_child_final_dis))
cblist <- dput(names(anemia_control_child_final_rep))
anemia_control_child_final_list <- intersect(calist, cblist)

col.num.child.control.dis.final <- which(colnames(anemia_control_child_final_dis) %in% anemia_control_child_final_list)
anemia_control_child_final_dis <- anemia_control_child_final_dis[,col.num.child.control.dis.final]

col.num.child.control.rep.final <- which(colnames(anemia_control_child_final_rep) %in% anemia_control_child_final_list)
anemia_control_child_final_rep <- anemia_control_child_final_rep[,col.num.child.control.rep.final]

anemia_control_child_final <- rbind.data.frame(anemia_control_child_final_dis, anemia_control_child_final_rep)

##Variables between case and control
UA_case_child_final_list <- dput(names(UA_case_child_final))
UA_case_control_child_final_child_crosslist <- (intersect(UA_case_child_final_list,anemia_control_child_final_list))

col.num.child.case.dis.UA <- which(colnames(UA_case_child_final) %in% UA_case_control_child_final_child_crosslist)
UA_case_child_final <- UA_case_child_final[,col.num.child.case.dis.UA]

col.num.child.control.dis.UA <- which(colnames(anemia_control_child_final) %in% UA_case_control_child_final_child_crosslist)
anemia_control_child_final <- anemia_control_child_final[,col.num.child.control.dis.UA]

UA_casctrl_child_final <- rbind.data.frame(UA_case_child_final, anemia_control_child_final)

#Variable with Weights
UA_casctrl_child_finalrep_crosslist <-dput(names(UA_casctrl_child_final))
UA_casctrl_child_final_final_crosslist <- (intersect(UA_casctrl_child_finalrep_crosslist,VarWeight_8$Variable))
UA_casctrl_child_final_final_crosslist_variables <- c("ID",UA_casctrl_child_final_final_crosslist,covar_ac,pheno_IDA)

col.num.child.dis_varwt.UA <- which(colnames(UA_casctrl_child_final) %in% UA_casctrl_child_final_final_crosslist_variables)
UA_casctrl_child_final <- UA_casctrl_child_final[,col.num.child.dis_varwt.UA]

UA_casctrl_child_final_final <- merge_data(UA_casctrl_child_final, survey_design_8yrs, union = FALSE)
UA_casctrl_child_final_final$anemia <- as.numeric(UA_casctrl_child_final_final$anemia)

##Co-variables
UA_casctrl_child_final_cat_vars <- dput(names(UA_case_Children_cat_final))
UA_casctrl_child_final_cat_vars <- UA_casctrl_child_final_cat_vars[UA_casctrl_child_final_cat_vars %in% UA_casctrl_child_final_final_crosslist]

UA_casctrl_child_final_cont_vars <- dput(names(UA_case_Children_final_pz_200))
UA_casctrl_child_final_cont_vars <- UA_casctrl_child_final_cont_vars[UA_casctrl_child_final_cont_vars %in% UA_casctrl_child_final_final_crosslist]
```

##EWAS Discovery Group
```{r}
#Adults EWAS
UA_EWAS_Adult_discovery_results <- ewas(d = UA_casctrl_adult_final_dis_final,
                                        cat_vars=UA_casctrl_adult_final_dis_cat_vars,
                                        cont_vars=UA_casctrl_adult_final_dis_cont_vars,
                                        y=pheno_ac,
                                        cat_covars=covar_ana_cat,
                                        cont_covars=covar_ana_cont,
                                        regression_family="binomial",
                                        allowed_nonvarying=c("female", "SDDSRVYR"),
                                        weights=weights_discovery,
                                        ids="SDMVPSU",
                                        strata="SDMVSTRA",
                                        nest=TRUE,
                                        drop_unweighted = TRUE)
write.table(UA_EWAS_Adult_discovery_results, file = "EWAS_UA_Adult_discovery_results.txt", row.names = F)

UA_EWAS_Adult_discovery_results_adj <- ewas_pval_adjust(UA_EWAS_Adult_discovery_results)
write.table(UA_EWAS_Adult_discovery_results_adj, file = "EWAS_UA_Adult_discovery_results_adj.txt", row.names = F)

#Children EWAS
UA_EWAS_Children_discovery_results <- ewas(d = UA_casctrl_child_final_final,
                                        cat_vars=UA_casctrl_child_final_cat_vars,
                                        cont_vars=UA_casctrl_child_final_cont_vars,
                                        y=pheno_ac,
                                        cat_covars=covar_ac_cat,
                                        cont_covars=covar_ac_cont,
                                        regression_family="binomial",
                                        allowed_nonvarying=c("female", "SDDSRVYR"),
                                        weights=weights_8yrs,
                                        ids="SDMVPSU",
                                        strata="SDMVSTRA",
                                        nest=TRUE,
                                        drop_unweighted = TRUE)
write.table(UA_EWAS_Children_discovery_results, file = "EWAS_UA_Children_discovery_results.txt", row.names = F)

UA_EWAS_Children_discovery_results_adj <- ewas_pval_adjust(UA_EWAS_Children_discovery_results)
write.table(UA_EWAS_Children_discovery_results_adj, file = "EWAS_UA_Children_discovery_results_adj.txt", row.names = F)
```

##EWAS UA Preparation Replication Group
```{r include=FALSE}
#Adults
pvalue_fdr_rank_UA_adult <- UA_EWAS_Adult_discovery_results_adj[order(UA_EWAS_Adult_discovery_results_adj$pvalue_FDR), ]
selected_variables_fdr_list_UA_adult <- which(pvalue_fdr_rank_UA_adult$pvalue_FDR < 0.1)
selected_variables_fdr_UA_adult <- head(pvalue_fdr_rank_UA_adult[,1],length(selected_variables_fdr_list_UA_adult))

variables_fdr_UA_adult <- c(paste(selected_variables_fdr_UA_adult), covar_ana, pheno_ac)
all_variable_filtered_UA_adult <- UA_casctrl_adult_final_rep
rep_variable_UA_adult <- colfilter(d=all_variable_filtered_UA_adult, cols = variables_fdr_UA_adult, exclude = FALSE)

UA_adult_final_adult_replication_final <- merge_data(rep_variable_UA_adult, survey_design_replication, union = FALSE)

UA_adult_final_adult_replication_final$anemia <- as.numeric(UA_adult_final_adult_replication_final$anemia)

##Variables
UA_adult_final_rep_cat_vars <- dput(names(Anemia_control_s3s4_Adults_cat_final))
UA_adult_final_rep_cat_vars_finallist <- dput(names(UA_adult_final_adult_replication_final))
UA_adult_final_rep_cat_vars <- intersect(UA_adult_final_rep_cat_vars,UA_adult_final_rep_cat_vars_finallist)
UA_adult_final_rep_cat_vars <- UA_adult_final_rep_cat_vars[!UA_adult_final_rep_cat_vars %in% c(covar_ana, "ID", pheno_ac)]

UA_adult_final_rep_cont_vars <- dput(names(Anemia_control_s3s4_Adults_final_pz_200))
UA_adult_final_rep_cont_vars_finallist <- dput(names(UA_adult_final_adult_replication_final))
UA_adult_final_rep_cont_vars <-UA_adult_final_rep_cont_vars[UA_adult_final_rep_cont_vars %in% UA_adult_final_rep_cont_vars_finallist]
UA_adult_final_rep_cont_vars <- UA_adult_final_rep_cont_vars[!UA_adult_final_rep_cont_vars %in% c(covar_ana, "ID", pheno_ac)]
```

##EWAS UA Replication Group
```{r}
# Adults
UA_EWAS_adult_replication_results <- ewas(d = UA_adult_final_adult_replication_final,
                                       cat_vars=UA_adult_final_rep_cat_vars,
                                       cont_vars=UA_adult_final_rep_cont_vars,
                                       y=pheno_ac,
                                       cat_covars=covar_ana_cat,
                                       cont_covars=covar_ana_cont,
                                       regression_family="binomial",
                                       allowed_nonvarying=c("female", "SDDSRVYR"),
                                       weights=weights_replication,
                                       ids="SDMVPSU",
                                       strata="SDMVSTRA",
                                       nest=TRUE,
                                       drop_unweighted = TRUE)
write.table(UA_EWAS_adult_replication_results, file = "EWAS_UA_Adult_replication_results.txt", row.names = F)

UA_EWAS_adult_replication_results_adj <- ewas_pval_adjust(UA_EWAS_adult_replication_results)
write.table(UA_EWAS_adult_replication_results_adj, file = "EWAS_UA_case_adult_replication_results_adj.txt", row.names = F)
```

##EWAS UA Manhattan Plot
```{r}
#Adults
##Extract the variables and p-values
ewas_UA_adult_dis_crt <- UA_EWAS_Adult_discovery_results_adj[,c(1,14)]
ewas_UA_adult_rep_crt <- UA_EWAS_adult_replication_results_adj[,c(1,13)]

##Add group
ewas_UA_adult_dis_crt$Shape <- rep("Discovery", nrow(ewas_UA_adult_dis_crt))
ewas_UA_adult_rep_crt$Shape <- rep("Replication", nrow(ewas_UA_adult_rep_crt))
colnames(ewas_UA_adult_dis_crt)[2] <- "pvalue"
colnames(ewas_UA_adult_rep_crt)[2] <- "pvalue"

##Combine groups
ewas_UA_adult_all_crt <- rbind(ewas_UA_adult_dis_crt,ewas_UA_adult_rep_crt)
colnames(ewas_UA_adult_all_crt)[1] <- "Variable"
colnames(ewas_UA_adult_all_crt)[2] <- "pvalue"

##Manhattan Plot
VarCat_nopf <- read.delim("/Users/Nicen/Desktop/Anemia/Data/VarCat_nopf.txt")
UA_ewas_mplot_adult <- eman(ewas_UA_adult_all_crt, ewas = FALSE, groups = VarCat_nopf, file = "M-Plot UA vs Non-Anemia Adults", morecolors = FALSE, hgt = 7, wi = 12, res = 300)

ggsave(file = "M-Plot UA vs Non-Anemia Adults.png", plot = UA_ewas_mplot_adult, device = "png",path = "/Users/Nicen/Desktop/Anemia/Figures/Original Figures", width = 12, height = 7, dpi = 300)

#Children
##Extract the variables and p-values
ewas_UA_child_dis_crt <- UA_EWAS_Children_discovery_results_adj[,c(1,13)]

##Add group
ewas_UA_child_dis_crt$Shape <- rep("Discovery", nrow(ewas_UA_child_dis_crt))

##Combine groups
ewas_UA_child_all_crt <- ewas_UA_child_dis_crt
colnames(ewas_UA_child_all_crt)[1] <- "Variable"
colnames(ewas_UA_child_all_crt)[2] <- "pvalue"

##Manhattan Plot
VarCat_nopf <- read.delim("/Users/Nicen/Desktop/Anemia/Data/VarCat_nopf.txt")
UA_ewas_mplot_child <- eman_o(ewas_UA_child_all_crt, ewas = FALSE, groups = VarCat_nopf, file = "M-Plot UA vs Non-Anemia children", morecolors = FALSE, hgt = 7, wi = 12, res = 300)

ggsave(file = "M-Plot UA vs Non-Anemia children.png", plot = UA_ewas_mplot_child, device = "png",path = "/Users/Nicen/Desktop/Anemia/Figures/Original Figures", width = 12, height = 7, dpi = 300)
```

***

#Linear Regressions for single phenotype
* Hemoglobin
* Vitamin B12
* Folate RBC
* Iron

#Hemoglobin Level
##Discovery Group Quality Control
```{r}
##Divide population by ages
colnames(Main_table)[1] <- "ID"
MainTable_keepvar_over18 <- read.delim("~/Desktop/Anemia/Data/MainTable_keepvar_over18.tsv")
keepvar <- dput(names(MainTable_keepvar_over18))
keepvar <- c(paste(keepvar),"SDDSRVYR", "LBXHGB")
MainTable_keepvar <- clarite::colfilter(d=Main_table, cols=keepvar, exclude=F)
Children <- MainTable_keepvar[MainTable_keepvar$RIDAGEYR < 15,]
Adults <- MainTable_keepvar[MainTable_keepvar$RIDAGEYR >= 15,]

##Filter complete.cases for each pheno + covars
covars_a <- c("female", "black", "mexican", "other_hispanic", "other_eth", "SDDSRVYR", "BMXBMI", "SES_LEVEL", "RIDAGEYR", "LBXCOT", "IRON_mg")
covars_c <- c("female", "black", "mexican", "other_hispanic", "other_eth", "SDDSRVYR", "BMXBMI", "SES_LEVEL", "RIDAGEYR", "LBXCOT", "IRON_mg")
pheno_hemoglobin <- c("LBXHGB")
hemo_childid <- na.omit(clarite::colfilter(Children, cols=c(covars_c, "LBXHGB")))[, 1, drop=FALSE]
hemo_child <- clarite::merge_data(hemo_childid, Children, union = FALSE)
hemo_adultid <- na.omit(clarite::colfilter(Adults, cols=c(covars_a, "LBXHGB")))[, 1, drop=FALSE]
hemo_adult <- clarite::merge_data(hemo_adultid, Adults, union = FALSE)

##Filter by series 1&2
hemo_child_s1s2 <- hemo_child[hemo_child$SDDSRVYR==2 | hemo_child$SDDSRVYR==1, ]
hemo_adult_s1s2 <- hemo_adult[hemo_adult$SDDSRVYR==2 | hemo_adult$SDDSRVYR==1, ]

##Split into data type
#Get binary varibales into a separate file
hemo_child_s1s2_200_bin <- clarite::get_binary(hemo_child_s1s2)
hemo_adult_s1s2_200_bin <- clarite::get_binary(hemo_adult_s1s2)

#Get categorical variables into a separate file
hemo_child_s1s2_200_cat <- clarite::get_categorical(hemo_child_s1s2)
hemo_adult_s1s2_200_cat <- clarite::get_categorical(hemo_adult_s1s2)

#Get continuous variables into a separate file
hemo_child_s1s2_200_cont <- clarite::get_continuous(hemo_child_s1s2)
hemo_adult_s1s2_200_cont <- clarite::get_continuous(hemo_adult_s1s2)

#Get ambiguous variables into a separate file
hemo_child_s1s2_200_check <- clarite::get_check(hemo_child_s1s2)
hemo_adult_s1s2_200_check <- clarite::get_check(hemo_adult_s1s2)

#Make vectors and label to remove or merge varibales to appropriate files
child_cont_merge <- c("RIDAGEYR", "LBXIHG", "URXUBE", "URXUPT", "LBXPFHP", 
"LBXTO3", "DRD350BQ", "DRD350HQ", "DRD370AQ", "DRD370BQ", 
"DRD370DQ", "DRD370MQ", "DRD370TQ", "DRD370UQ", "supplement_count", 
"DSDCOUNT", "LBX194", "LBX196", "LBD199", "LBXDIE")
child_cat_merge <- c("house_age")
adult_cont_merge <- c("URXUBE", "URXUPT", "LBXTO3", "DUQ130", 
"DRD350BQ", "DRD350FQ", "DRD350IQ", "DRD370AQ", "DRD370DQ", "DRD370EQ", 
"DRD370FQ", "DRD370IQ", "DRD370KQ", "DRD370NQ", "DRD370UQ", "OMEGA_3_FATTY_ACIDS_mg", 
"ALANINE_mg", "ARGININE_mg", "BETA_CAROTENE_IU", "BETA_CAROTENE_mg", 
"CAFFEINE_mg", "CYSTINE_mg", "HISTIDINE_mg", "ISOLEUCINE_mg", 
"LYSINE_mg", "PROLINE_mg", "SERINE_mg", "THREONINE_mg", "TRYPTOPHAN_mg", 
"TYROSINE_mg", "LBDSY3", "OTHER_FATTY_ACIDS_mg")
adult_cat_merge <- c("house_age")

#Remove columns and rename data frame then merge data from ambiguous file into continuous file
hemo_child_s1s2_200_contmerged <- clarite::merge_data(hemo_child_s1s2_200_cont, hemo_child_s1s2_200_check, union=TRUE)
hemo_child_s1s2_200_cont_final <- clarite::colfilter(d=hemo_child_s1s2_200_contmerged, cols=child_cat_merge, exclude=T)

hemo_adult_s1s2_200_contmerged <- clarite::merge_data(hemo_adult_s1s2_200_cont, hemo_adult_s1s2_200_check, union=TRUE)
hemo_adult_s1s2_200_cont_final <- clarite::colfilter(d=hemo_adult_s1s2_200_contmerged, cols=adult_cat_merge, exclude=T)

hemo_child_s1s2_200_catmerged <- clarite::merge_data(hemo_child_s1s2_200_cat, hemo_child_s1s2_200_check, union=TRUE)
hemo_child_s1s2_200_cat_final <- clarite::colfilter(d=hemo_child_s1s2_200_catmerged, cols=child_cont_merge, exclude=T)

hemo_adult_s1s2_200_catmerged <- clarite::merge_data(hemo_adult_s1s2_200_cat, hemo_adult_s1s2_200_check, union=TRUE)
hemo_adult_s1s2_200_cat_final <- clarite::colfilter(d=hemo_adult_s1s2_200_catmerged, cols=adult_cont_merge, exclude=T)

#Some categorical have 77, 99 as "Don't Know" so replace with missing in variables that would not otherwise be dropped
hemo_child_s1s2_200_cat_final$house_age <- ifelse(hemo_child_s1s2_200_cat_final$house_age==77 | hemo_child_s1s2_200_cat_final$house_age==99, NA, hemo_child_s1s2_200_cat_final$house_age)
hemo_adult_s1s2_200_cat_final$house_age <- ifelse(hemo_adult_s1s2_200_cat_final$house_age==77 | hemo_adult_s1s2_200_cat_final$house_age==99, NA, hemo_adult_s1s2_200_cat_final$house_age)

#Extract unique values and return vector from columns in data dictionary
desc_info <- unique(VarDescription[, colnames(VarDescription) %in% c("tab_desc", "module", "var", "var_desc")])

#Define functions with labels such as X, N, NNZ...etc and combine objects by rows. Return them out to finish function
get0 <- function(x){
  x <- as.numeric(as.character(x))
  N <- length(x)
  NNZ <- length(x[x>0])
  PZ <- (N-NNZ)/N
  out <- rbind(N=N, NNZ=NNZ, PZ=PZ)
  return(out)
}

#Drop >90% of the samples with get0 function. Combine columns and create data another data frame with PZ as label for dropped variables. Write to text file.
hemo_child_s1s2_200_cont_0 <- as.data.frame(t(sapply(hemo_child_s1s2_200_cont_final[, -1], get0)))
hemo_child_s1s2_200_cont_0 <- cbind(rownames(hemo_child_s1s2_200_cont_0), data.frame(hemo_child_s1s2_200_cont_0, row.names=NULL))
names(hemo_child_s1s2_200_cont_0) <- c("var", "N", "NNZ", "PZ")
hemo_child_s1s2_200_cont_full <- merge(hemo_child_s1s2_200_cont_0, desc_info, by="var")
hemo_child_s1s2_200_cont_full <- hemo_child_s1s2_200_cont_full[order(hemo_child_s1s2_200_cont_full$PZ, decreasing=TRUE), ]
write.table(hemo_child_s1s2_200_cont_full, file="hemo_children_percent_zero_values_series1-2.txt", sep="\t", quote=FALSE, row.names=FALSE)

hemo_adult_s1s2_200_cont_0 <- as.data.frame(t(sapply(hemo_adult_s1s2_200_cont_final[, -1], get0)))
hemo_adult_s1s2_200_cont_0 <- cbind(rownames(hemo_adult_s1s2_200_cont_0), data.frame(hemo_adult_s1s2_200_cont_0, row.names=NULL))
names(hemo_adult_s1s2_200_cont_0) <- c("var", "N", "NNZ", "PZ")
hemo_adult_s1s2_200_cont_full <- merge(hemo_adult_s1s2_200_cont_0, desc_info, by="var")
hemo_adult_s1s2_200_cont_full <- hemo_adult_s1s2_200_cont_full[order(hemo_adult_s1s2_200_cont_full$PZ, decreasing=TRUE), ]
write.table(hemo_adult_s1s2_200_cont_full, file="hemo_adult_percent_zero_values_series1-2.txt", sep="\t", quote=FALSE, row.names=FALSE)

#Remove PZ >= 0.90
hemo_child_pz <- hemo_child_s1s2_200_cont_full[hemo_child_s1s2_200_cont_full$PZ >= 0.9, 1, drop=FALSE]
hemo_adult_pz <- hemo_adult_s1s2_200_cont_full[hemo_adult_s1s2_200_cont_full$PZ >= 0.9, 1, drop=FALSE]

#Filter out the >= 0.90 samples from continuous file.
hemo_child_s1s2_200_final_pz <- clarite::colfilter(d=hemo_child_s1s2_200_cont_final, cols=hemo_child_pz, exclude = TRUE)
hemo_adult_s1s2_200_final_pz <- clarite::colfilter(d=hemo_adult_s1s2_200_cont_final, cols=hemo_adult_pz, exclude = TRUE)

##Make plot to visualize phenotype.
#If skewness is less than -1 or greater than 1, the distribution is highly skewed.
#If skewness is between -1 and -0.5 or between 0.5 and 1, the distribution is moderately skewed.
#If skewness is between -0.5 and 0.5, the distribution is approximately symmetric.

hist(hemo_child_s1s2_200_cont_final$LBXHGB, breaks = 100, main = "Hemoglobin level for children", xlab = "Hemoglobin")
hist(hemo_adult_s1s2_200_cont_final$LBXHGB, breaks = 100, main = "Hemoglobin level for adults", xlab = "Hemoglobin")

library (moments)
skewness(hemo_child_s1s2_200_cont_final$LBXHGB)
skewness(hemo_adult_s1s2_200_cont_final$LBXHGB)

#Drop the Hemoglobin reading and blood related components
drop_item_hemo_child <- c("LBDHDD", "LBDHDL", "LBDLDL", "LBXSTR", "LBXTC","LBXTR", "LBXSCH", "DR1TCHOL","house_type","house_age","hepa","hepb","current_past_smoking","CVDVOMAX", "CVDESVO2", "CVDS1HR", "CVDS1SY", "CVDS1DI", "CVDS2HR", "CVDS2SY", "CVDS2DI", "CVDR1HR", "CVDR1SY", "CVDR1DI", "CVDR2HR", "CVDR2SY", "CVDR2DI", "physical_activity")
drop_item_hemo_adult <- c("LBDHDD", "LBDHDL", "LBDLDL", "LBXSTR", "LBXTC","LBXTR", "LBXSCH", "DR1TCHOL","house_type","house_age","hepa","hepb","current_past_smoking","CVDVOMAX", "CVDESVO2", "CVDS1HR", "CVDS1SY", "CVDS1DI", "CVDS2HR", "CVDS2SY", "CVDS2DI", "CVDR1HR", "CVDR1SY", "CVDR1DI", "CVDR2HR", "CVDR2SY", "CVDR2DI", "physical_activity", "SMQ120","SMQ040","SMQ150","num_months_longest_job","cigarette_smoking","SMD410","SMD090","SMD070","SMD075")
hemo_child_s1s2_200_final_pz_final <- clarite::colfilter(d=hemo_child_s1s2_200_final_pz, cols=drop_item_hemo_child, exclude = TRUE)
hemo_adult_s1s2_200_final_pz_final <- clarite::colfilter(d=hemo_adult_s1s2_200_final_pz, cols=drop_item_hemo_adult, exclude = TRUE)

#Merge categorical and binary files (data frames)
hemo_child_s1s2_200_cat_bin <- clarite::merge_data(hemo_child_s1s2_200_cat_final, hemo_child_s1s2_200_bin)
hemo_adult_s1s2_200_cat_bin <- clarite::merge_data(hemo_adult_s1s2_200_cat_final, hemo_adult_s1s2_200_bin)

#Drop variables <200 and rename file
skip_c <- covars_c[!covars_c %in% c("BMXBMI", "RIDAGEYR", "LBXCOT", "SDMVPSU", "IRON_mg")]
hemo_child_cat_final <- clarite::min_cat_n(hemo_child_s1s2_200_cat_bin, skip = skip_c)
hemo_child_cat_final <- clarite::colfilter(d=hemo_child_cat_final, cols=drop_item_hemo_child, exclude = TRUE)
hemo_adult_cat_final <- clarite::min_cat_n(hemo_adult_s1s2_200_cat_bin)
hemo_adult_cat_final <- clarite::colfilter(d=hemo_adult_cat_final, cols=drop_item_hemo_adult, exclude = TRUE)

hemo_child_s1s2_200_final_pz_200 <- clarite::min_n(hemo_child_s1s2_200_final_pz_final)
hemo_adult_s1s2_200_final_pz_200 <- clarite::min_n(hemo_adult_s1s2_200_final_pz_final)
```

##Replication Group Quality Control
```{r}
##Filter by series 3&4
hemo_child_s3s4 <- hemo_child[hemo_child$SDDSRVYR==3 | hemo_child$SDDSRVYR==4, ]
hemo_adult_s3s4 <- hemo_adult[hemo_adult$SDDSRVYR==3 | hemo_adult$SDDSRVYR==4, ]

##Split into data type
#Get binary varibales into a separate file
hemo_child_s3s4_200_bin <- clarite::get_binary(hemo_child_s3s4)
hemo_adult_s3s4_200_bin <- clarite::get_binary(hemo_adult_s3s4)

#Get categorical variables into a separate file
hemo_child_s3s4_200_cat <- clarite::get_categorical(hemo_child_s3s4)
hemo_adult_s3s4_200_cat <- clarite::get_categorical(hemo_adult_s3s4)

#Changes values 7 and 9 using a pipeline format to NA. Cannot decipher meaning of values so make NA.
hemo_adult_s3s4_200_cat$SMQ077 <- ifelse(hemo_adult_s3s4_200_cat$SMQ077==7 | hemo_adult_s3s4_200_cat$SMQ077==9, NA, hemo_adult_s3s4_200_cat$SMQ077)

#Get continuous variables into a separate file
hemo_child_s3s4_200_cont <- clarite::get_continuous(hemo_child_s3s4)
hemo_adult_s3s4_200_cont <- clarite::get_continuous(hemo_adult_s3s4)

#Get ambiguous variables into a separate file
hemo_child_s3s4_200_check <- clarite::get_check(hemo_child_s3s4)
hemo_adult_s3s4_200_check <- clarite::get_check(hemo_adult_s3s4)

#Make vectors and label to remove or merge varibales to appropriate files
child_cont_merge <- c("RIDAGEYR", "LBXTO2", "LBXEPAH", "LBXPFSA", "LBXPFUA", 
"URXMOP", "SMD080", "DRD350GQ", "DRD350HQ", "DRD370AQ", 
"DRD370BQ", "DRD370DQ", "DRD370FQ", "DRD370MQ", "DRD370RQ", "DRD370TQ", 
"DRD370UQ", "DSDCOUNT", "LBX2DF", "URXUAC", "URXP21", "SMD641")
child_cat_merge <- c("house_age")
adult_cont_merge <- c("LBXVCT", "LBXV3A", "URXUBE", "LBXTO2", "LBXPFDO",
"RHQ598", "how_long_estrogen_progestin_patch", "DRD350AQ", "DRD350BQ", 
"DRD350CQ", "DRD350DQ", "DRD350EQ", "DRD350FQ", "DRD350GQ", "DRD350HQ", 
"DRD350IQ", "DRD370AQ", "DRD370CQ", "DRD370DQ", "DRD370EQ", "DRD370FQ", 
"DRD370GQ", "DRD370HQ", "DRD370IQ", "DRD370KQ", "DRD370NQ", "DRD370RQ", 
"DRD370SQ", "DRD370UQ", "ALANINE_mg", "ARGININE_mg", "BETA_CAROTENE_mg", 
"CAFFEINE_mg", "CYSTINE_mg", "HISTIDINE_mg", "ISOLEUCINE_mg", 
"LEUCINE_mg", "LYSINE_mg", "PHENYLALANINE_mg", "PROLINE_mg", 
"SERINE_mg", "THREONINE_mg", "TRYPTOPHAN_mg", "TYROSINE_mg", 
"VALINE_mg", "LBXV2T", "LBXV4T", "LBXVDM", "URXUTM", "LBXPFBS", 
"DUQ280", "DUQ360")
adult_cat_merge <- c("house_age")

#Remove columns and rename data frame then merge data from ambiguous file into continuous file
hemo_child_s3s4_200_contmerged <- clarite::merge_data(hemo_child_s3s4_200_cont, hemo_child_s3s4_200_check, union=TRUE)
hemo_child_s3s4_200_cont_final <- clarite::colfilter(d=hemo_child_s3s4_200_contmerged, cols=child_cat_merge, exclude=T)

hemo_adult_s3s4_200_contmerged <- clarite::merge_data(hemo_adult_s3s4_200_cont, hemo_adult_s3s4_200_check, union=TRUE)
hemo_adult_s3s4_200_cont_final <- clarite::colfilter(d=hemo_adult_s3s4_200_contmerged, cols=adult_cat_merge, exclude=T)

hemo_child_s3s4_200_catmerged <- clarite::merge_data(hemo_child_s3s4_200_cat, hemo_child_s3s4_200_check, union=TRUE)
hemo_child_s3s4_200_cat_final <- clarite::colfilter(d=hemo_child_s3s4_200_catmerged, cols=child_cont_merge, exclude=T)

hemo_adult_s3s4_200_catmerged <- clarite::merge_data(hemo_adult_s3s4_200_cat, hemo_adult_s3s4_200_check, union=TRUE)
hemo_adult_s3s4_200_cat_final <- clarite::colfilter(d=hemo_adult_s3s4_200_catmerged, cols=adult_cont_merge, exclude=T)

#Extract unique values and return vector from columns in data dictionary
desc_info <- unique(VarDescription[, colnames(VarDescription) %in% c("tab_desc", "module", "var", "var_desc")])

#Define functions with labels such as X, N, NNZ...etc and combine objects by rows. Return them out to finish function
get0 <- function(x){
  x <- as.numeric(as.character(x))
  N <- length(x)
  NNZ <- length(x[x>0])
  PZ <- (N-NNZ)/N
  out <- rbind(N=N, NNZ=NNZ, PZ=PZ)
  return(out)
}

#Drop >90% of the samples with get0 function. Combine columns and create data another data frame with PZ as label for dropped variables. Write to text file.
hemo_child_s3s4_200_cont_0 <- as.data.frame(t(sapply(hemo_child_s3s4_200_cont_final[, -1], get0)))
hemo_child_s3s4_200_cont_0 <- cbind(rownames(hemo_child_s3s4_200_cont_0), data.frame(hemo_child_s3s4_200_cont_0, row.names=NULL))
names(hemo_child_s3s4_200_cont_0) <- c("var", "N", "NNZ", "PZ")
hemo_child_s3s4_200_cont_full <- merge(hemo_child_s3s4_200_cont_0, desc_info, by="var")
hemo_child_s3s4_200_cont_full <- hemo_child_s3s4_200_cont_full[order(hemo_child_s3s4_200_cont_full$PZ, decreasing=TRUE), ]
write.table(hemo_child_s3s4_200_cont_full, file="hemo_children_percent_zero_values_series1-2.txt", sep="\t", quote=FALSE, row.names=FALSE)

hemo_adult_s3s4_200_cont_0 <- as.data.frame(t(sapply(hemo_adult_s3s4_200_cont_final[, -1], get0)))
hemo_adult_s3s4_200_cont_0 <- cbind(rownames(hemo_adult_s3s4_200_cont_0), data.frame(hemo_adult_s3s4_200_cont_0, row.names=NULL))
names(hemo_adult_s3s4_200_cont_0) <- c("var", "N", "NNZ", "PZ")
hemo_adult_s3s4_200_cont_full <- merge(hemo_adult_s3s4_200_cont_0, desc_info, by="var")
hemo_adult_s3s4_200_cont_full <- hemo_adult_s3s4_200_cont_full[order(hemo_adult_s3s4_200_cont_full$PZ, decreasing=TRUE), ]
write.table(hemo_adult_s3s4_200_cont_full, file="hemo_adult_percent_zero_values_series1-2.txt", sep="\t", quote=FALSE, row.names=FALSE)

#Remove PZ >= 0.90
hemo_child_pz <- hemo_child_s3s4_200_cont_full[hemo_child_s3s4_200_cont_full$PZ >= 0.9, 1, drop=FALSE]
hemo_adult_pz <- hemo_adult_s3s4_200_cont_full[hemo_adult_s3s4_200_cont_full$PZ >= 0.9, 1, drop=FALSE]

#Filter out the >= 0.90 samples from continuous file.
hemo_child_s3s4_200_final_pz <- clarite::colfilter(d=hemo_child_s3s4_200_cont_final, cols=hemo_child_pz, exclude = TRUE)
hemo_adult_s3s4_200_final_pz <- clarite::colfilter(d=hemo_adult_s3s4_200_cont_final, cols=hemo_adult_pz, exclude = TRUE)

##Make plot to visualize phenotype.
#If skewness is less than -1 or greater than 1, the distribution is highly skewed.
#If skewness is between -1 and -0.5 or between 0.5 and 1, the distribution is moderately skewed.
#If skewness is between -0.5 and 0.5, the distribution is approximately symmetric.

hist(hemo_child_s3s4_200_cont_final$LBXHGB, breaks = 100, main = "Hemoglobin level for children", xlab = "Hemoglobin")
hist(hemo_adult_s3s4_200_cont_final$LBXHGB, breaks = 100, main = "Hemoglobin level for adults", xlab = "Hemoglobin")

library (moments)
skewness(hemo_child_s3s4_200_cont_final$LBXHGB)
skewness(hemo_adult_s3s4_200_cont_final$LBXHGB)

#Drop the Hemoglobin reading and blood related components
drop_item_hemo_child <- c("LBDHDD", "LBDHDL", "LBDLDL", "LBXSTR", "LBXTC","LBXTR", "LBXSCH", "DR1TCHOL","house_type","house_age","hepa","hepb","current_past_smoking","CVDVOMAX", "CVDESVO2", "CVDS1HR", "CVDS1SY", "CVDS1DI", "CVDS2HR", "CVDS2SY", "CVDS2DI", "CVDR1HR", "CVDR1SY", "CVDR1DI", "CVDR2HR", "CVDR2SY", "CVDR2DI", "physical_activity")
drop_item_hemo_adult <- c("LBDHDD", "LBDHDL", "LBDLDL", "LBXSTR", "LBXTC","LBXTR", "LBXSCH", "DR1TCHOL","house_type","house_age","hepa","hepb","current_past_smoking","CVDVOMAX", "CVDESVO2", "CVDS1HR", "CVDS1SY", "CVDS1DI", "CVDS2HR", "CVDS2SY", "CVDS2DI", "CVDR1HR", "CVDR1SY", "CVDR1DI", "CVDR2HR", "CVDR2SY", "CVDR2DI", "physical_activity", "SMQ120","SMQ040","SMQ150","num_months_longest_job","cigarette_smoking","SMD410","SMD090","SMD070","SMD075")
hemo_child_s3s4_200_final_pz_final <- clarite::colfilter(d=hemo_child_s3s4_200_final_pz, cols=drop_item_hemo_child, exclude = TRUE)
hemo_adult_s3s4_200_final_pz_final <- clarite::colfilter(d=hemo_adult_s3s4_200_final_pz, cols=drop_item_hemo_adult, exclude = TRUE)

#Merge categorical and binary files (data frames)
hemo_child_s3s4_200_cat_bin <- clarite::merge_data(hemo_child_s3s4_200_cat_final, hemo_child_s3s4_200_bin)
hemo_adult_s3s4_200_cat_bin <- clarite::merge_data(hemo_adult_s3s4_200_cat_final, hemo_adult_s3s4_200_bin)

#Drop variables <200 and rename file
skip_c <- covars_c[!covars_c %in% c("BMXBMI", "RIDAGEYR", "LBXCOT", "SDMVPSU","IRON_mg")]
hemo_child_cat_final_rep <- clarite::min_cat_n(hemo_child_s3s4_200_cat_bin, skip = skip_c)
hemo_child_cat_final_rep <- clarite::colfilter(d=hemo_child_cat_final_rep, cols=drop_item_hemo_child, exclude = TRUE)
hemo_adult_cat_final_rep <- clarite::min_cat_n(hemo_adult_s3s4_200_cat_bin)
hemo_adult_cat_final_rep <- clarite::colfilter(d=hemo_adult_cat_final_rep, cols=drop_item_hemo_adult, exclude = TRUE)

hemo_child_s3s4_200_final_pz_200 <- clarite::min_n(hemo_child_s3s4_200_final_pz_final)
hemo_adult_s3s4_200_final_pz_200 <- clarite::min_n(hemo_adult_s3s4_200_final_pz_final)
```

#EWAS Preparation Discovery Group
```{r include=FALSE}
#Children
##Dataframe
hemo_child_final_dis <- merge(hemo_child_cat_final,hemo_child_s1s2_200_final_pz_200)
hemo_child_final_rep <- merge(hemo_child_cat_final_rep,hemo_child_s3s4_200_final_pz_200)

covars_c_cat <- c("female", "black", "mexican", "other_hispanic", "other_eth", "SES_LEVEL", "SDDSRVYR")
covars_c_cont <- c("BMXBMI","RIDAGEYR", "LBXCOT")

hemo_child_final_dis_list <-dput(names(hemo_child_final_dis))
hemo_child_final_rep_list <-dput(names(hemo_child_final_rep))
hemo_child_final_child_crosslist <- (intersect(hemo_child_final_dis_list,hemo_child_final_rep_list))
hemo_child_final_child_crosslist <- (intersect(hemo_child_final_child_crosslist,VarWeight$Variable))
hemo_child_final_child_crosslist_variables <- c("ID",hemo_child_final_child_crosslist,covars_c)

col.num.child.dis <- which(colnames(hemo_child_final_dis) %in% hemo_child_final_child_crosslist_variables)
hemo_child_final_dis <- hemo_child_final_dis[,col.num.child.dis]

hemo_child_final_child_discovery_final <- merge_data(hemo_child_final_dis, survey_design_discovery, union = FALSE)

##Co-variables
hemo_child_final_dis_cat_vars <- dput(names(hemo_child_cat_final))
hemo_child_final_dis_cat_vars <- hemo_child_final_dis_cat_vars[hemo_child_final_dis_cat_vars %in% hemo_child_final_child_crosslist]

hemo_child_final_dis_cont_vars <- dput(names(hemo_child_s1s2_200_final_pz_200))
hemo_child_final_dis_cont_vars <- hemo_child_final_dis_cont_vars[hemo_child_final_dis_cont_vars %in% hemo_child_final_child_crosslist]

#Adults
##Dataframe
hemo_adult_final_dis <- merge(hemo_adult_cat_final,hemo_adult_s1s2_200_final_pz_200)
hemo_adult_final_rep <- merge(hemo_adult_cat_final_rep,hemo_adult_s3s4_200_final_pz_200)

covars_a_cat <- c("female", "black", "mexican", "other_hispanic", "other_eth", "SES_LEVEL", "SDDSRVYR")
covars_a_cont <- c("BMXBMI","RIDAGEYR", "LBXCOT", "IRON_mg")

hemo_adult_final_dis_list <- dput(names(hemo_adult_final_dis))
hemo_adult_final_rep_list <- dput(names(hemo_adult_final_rep))
hemo_adult_final_adult_crosslist <- (intersect(hemo_adult_final_dis_list,hemo_adult_final_rep_list))
hemo_adult_final_adult_crosslist <- (intersect(hemo_adult_final_adult_crosslist,VarWeight$Variable))
hemo_adult_final_adult_crosslist_variables <- c("ID",hemo_adult_final_adult_crosslist,covars_c)

col.num.adult.dis <- which(colnames(hemo_adult_final_dis) %in% hemo_adult_final_adult_crosslist_variables)
hemo_adult_final_dis <- hemo_adult_final_dis[,col.num.adult.dis]

hemo_adult_final_adult_discovery_final <- merge_data(hemo_adult_final_dis, survey_design_discovery, union = FALSE)

##Variables
hemo_adult_final_dis_cat_vars <- dput(names(hemo_adult_cat_final))
hemo_adult_final_dis_cat_vars <- hemo_adult_final_dis_cat_vars[hemo_adult_final_dis_cat_vars %in% hemo_adult_final_adult_crosslist]

hemo_adult_final_dis_cont_vars <- dput(names(hemo_adult_s1s2_200_final_pz_200))
hemo_adult_final_dis_cont_vars <- hemo_adult_final_dis_cont_vars[hemo_adult_final_dis_cont_vars %in% hemo_adult_final_adult_crosslist]
```

#EWAS Discovery Group
```{r}
#Children EWAS
EWAS_Children_discovery_results <- ewas(d = hemo_child_final_child_discovery_final,
                          cat_vars=hemo_child_final_dis_cat_vars,
                          cont_vars=hemo_child_final_dis_cont_vars,
                          y=pheno_hemoglobin,
                          cat_covars=covars_c_cat,
                          cont_covars=covars_c_cont,
                          regression_family="gaussian",
                          allowed_nonvarying=c("female", "SDDSRVYR"),
                          weights=weights_discovery,
                          ids="SDMVPSU",
                          strata="SDMVSTRA",
                          nest=TRUE,
                          drop_unweighted = TRUE)
write.table(EWAS_Children_discovery_results, file = "EWAS_hemo_Children_discovery_results.txt", row.names = F)

EWAS_Children_discovery_results_adj <- ewas_pval_adjust(EWAS_Children_discovery_results)
write.table(EWAS_Children_discovery_results_adj, file = "EWAS_hemo_Children_discovery_results_adj.txt", row.names = F)

#Adults EWAS
EWAS_adult_discovery_results <- ewas(d = hemo_adult_final_adult_discovery_final,
                          cat_vars=hemo_adult_final_dis_cat_vars,
                          cont_vars=hemo_adult_final_dis_cont_vars,
                          y=pheno_hemoglobin,
                          cat_covars=covars_a_cat,
                          cont_covars=covars_a_cont,
                          regression_family="gaussian",
                          allowed_nonvarying=c("female", "SDDSRVYR"),
                          weights=weights_discovery,
                          ids="SDMVPSU",
                          strata="SDMVSTRA",
                          nest=TRUE,
                          drop_unweighted = TRUE)
write.table(EWAS_adult_discovery_results, file = "EWAS_hemo_adult_discovery_results.txt", row.names = F)

EWAS_adult_discovery_results_adj <- ewas_pval_adjust(EWAS_adult_discovery_results)
write.table(EWAS_adult_discovery_results_adj, file = "EWAS_hemo_adult_discovery_results_adj.txt", row.names = F)
```

#EWAS Hemoglobin Preparation Replication Group
```{r include=FALSE}
#Adults
pvalue_fdr_rank_hemo_adult <- EWAS_adult_discovery_results_adj[order(EWAS_adult_discovery_results_adj$pvalue_FDR), ]
selected_variables_fdr_list_hemo_adult <- which(pvalue_fdr_rank_hemo_adult$pvalue_FDR < 0.1)
selected_variables_fdr_hemo_adult <- head(pvalue_fdr_rank_hemo_adult[,1],length(selected_variables_fdr_list_hemo_adult))

variables_fdr_hemo_adult <- c(paste(selected_variables_fdr_hemo_adult), covars_a, pheno_hemoglobin)
all_variable_filtered_hemo_adult <- hemo_adult_final_rep
rep_variable_hemo_adult <- colfilter(d=all_variable_filtered_hemo_adult, cols = variables_fdr_hemo_adult, exclude = FALSE)

hemo_adult_final_adult_replication_final <- merge_data(rep_variable_hemo_adult, survey_design_replication, union = FALSE)

##Variables
hemo_adult_final_rep_cat_vars <- dput(names(hemo_adult_cat_final_rep))
hemo_adult_final_rep_cat_vars_finallist <- dput(names(hemo_adult_final_adult_replication_final))
hemo_adult_final_rep_cat_vars <- intersect(hemo_adult_final_rep_cat_vars,hemo_adult_final_rep_cat_vars_finallist)
hemo_adult_final_rep_cat_vars <- hemo_adult_final_rep_cat_vars[!hemo_adult_final_rep_cat_vars %in% c(covars_a, "ID")]

hemo_adult_final_rep_cont_vars <- dput(names(hemo_adult_s3s4_200_final_pz_200))
hemo_adult_final_rep_cont_vars_finallist <- dput(names(hemo_adult_final_adult_replication_final))
hemo_adult_final_rep_cont_vars <-hemo_adult_final_rep_cont_vars[hemo_adult_final_rep_cont_vars %in% hemo_adult_final_rep_cont_vars_finallist]
hemo_adult_final_rep_cont_vars <- hemo_adult_final_rep_cont_vars[!hemo_adult_final_rep_cont_vars %in% c(covars_a, "ID", pheno_hemoglobin)]

#Children
pvalue_fdr_rank_hemo_child <- EWAS_Children_discovery_results_adj[order(EWAS_Children_discovery_results_adj$pvalue_FDR), ]
selected_variables_fdr_list_hemo_child <- which(pvalue_fdr_rank_hemo_child$pvalue_FDR < 0.1)
selected_variables_fdr_hemo_child <- head(pvalue_fdr_rank_hemo_child[,1],length(selected_variables_fdr_list_hemo_child))

variables_fdr_hemo_child <- c(paste(selected_variables_fdr_hemo_child), covars_a, pheno_hemoglobin)
all_variable_filtered_hemo_child <- hemo_child_final_rep
rep_variable_hemo_child <- colfilter(d=all_variable_filtered_hemo_child, cols = variables_fdr_hemo_child, exclude = FALSE)

hemo_child_final_child_replication_final <- merge_data(rep_variable_hemo_child, survey_design_replication, union = FALSE)

##Variables
hemo_child_final_rep_cat_vars <- dput(names(hemo_child_cat_final_rep))
hemo_child_final_rep_cat_vars_finallist <- dput(names(hemo_child_final_child_replication_final))
hemo_child_final_rep_cat_vars <- intersect(hemo_child_final_rep_cat_vars,hemo_child_final_rep_cat_vars_finallist)
hemo_child_final_rep_cat_vars <- hemo_child_final_rep_cat_vars[!hemo_child_final_rep_cat_vars %in% c(covars_c, "ID")]

hemo_child_final_rep_cont_vars <- dput(names(hemo_child_s3s4_200_final_pz_200))
hemo_child_final_rep_cont_vars_finallist <- dput(names(hemo_child_final_child_replication_final))
hemo_child_final_rep_cont_vars <-hemo_child_final_rep_cont_vars[hemo_child_final_rep_cont_vars %in% hemo_child_final_rep_cont_vars_finallist]
hemo_child_final_rep_cont_vars <- hemo_child_final_rep_cont_vars[!hemo_child_final_rep_cont_vars %in% c(covars_c, "ID", pheno_hemoglobin)]
```

#EWAS Hemoglobin Replication Group
```{r}
# Adults
EWAS_adult_replication_results <- ewas(d = hemo_adult_final_adult_replication_final,
                            cat_vars=hemo_adult_final_rep_cat_vars,
                            cont_vars=hemo_adult_final_rep_cont_vars,
                            y=pheno_hemoglobin,
                            cat_covars=covars_a_cat,
                            cont_covars=covars_a_cont,
                            regression_family="gaussian",
                            allowed_nonvarying=c("female", "SDDSRVYR"),
                            weights=weights_replication,
                            ids="SDMVPSU",
                            strata="SDMVSTRA",
                            nest=TRUE,
                            drop_unweighted = TRUE)
write.table(EWAS_adult_replication_results, file = "EWAS_hemo_adult_replication_results.txt", row.names = F)


EWAS_adult_replication_results_adj <- ewas_pval_adjust(EWAS_adult_replication_results)
write.table(EWAS_adult_replication_results_adj, file = "EWAS_hemo_adult_replication_results_adj.txt", row.names = F)

# Children
EWAS_Children_replication_results <- ewas(d = hemo_child_final_child_replication_final,
                            cat_vars=hemo_child_final_rep_cat_vars,
                            cont_vars=hemo_child_final_rep_cont_vars,
                            y=pheno_hemoglobin,
                            cat_covars=covars_c_cat,
                            cont_covars=covars_c_cont,
                            regression_family="gaussian",
                            allowed_nonvarying=c("female", "SDDSRVYR"),
                            weights=weights_replication,
                            ids="SDMVPSU",
                            strata="SDMVSTRA",
                            nest=TRUE,
                            drop_unweighted = TRUE)
write.table(EWAS_Children_replication_results, file = "EWAS_hemo_Children_replication_results.txt", row.names = F)


EWAS_Children_replication_results_adj <- ewas_pval_adjust(EWAS_Children_replication_results)
write.table(EWAS_Children_replication_results_adj, file = "EWAS_hemo_Children_replication_results_adj.txt", row.names = F)
```

#EWAS Hemoglobin Manhattan Plot
```{r}
#Adults
##Extract the variables and p-values
ewas_hemo_adult_dis_crt <- EWAS_adult_discovery_results_adj[,c(1,14)]
ewas_hemo_adult_rep_crt <- EWAS_adult_replication_results_adj[,c(1,13)]

##Add group
ewas_hemo_adult_dis_crt$Shape <- rep("Discovery", nrow(ewas_hemo_adult_dis_crt))
ewas_hemo_adult_rep_crt$Shape <- rep("Replication", nrow(ewas_hemo_adult_rep_crt))
colnames(ewas_hemo_adult_dis_crt)[2] <- "pvalue"
colnames(ewas_hemo_adult_rep_crt)[2] <- "pvalue"

##Combine groups
ewas_hemo_adult_all_crt <- rbind(ewas_hemo_adult_dis_crt,ewas_hemo_adult_rep_crt)
colnames(ewas_hemo_adult_all_crt)[1] <- "Variable"
colnames(ewas_hemo_adult_all_crt)[2] <- "pvalue"

##Manhattan Plot
ewas_hemo_adult_all_crt$pvalue = as.numeric(ewas_hemo_adult_all_crt$pvalue)
VarCat_nopf <- read.delim("/Users/Nicen/Desktop/Anemia/Data/VarCat_nopf.txt")
hemo_ewas_mplot_adult <- eman(ewas_hemo_adult_all_crt, ewas = FALSE, groups = VarCat_nopf, file = "M-Plot Hemoglobin Adults", morecolors = FALSE, hgt = 7, wi = 12, res = 300)

ggsave(file = "M-Plot Hemoglobin Adults.png", plot = hemo_ewas_mplot_adult, device = "png",path = "/Users/Nicen/Desktop/Anemia/Figures/Original Figures", width = 12, height = 7, dpi = 300)

#Children
##Extract the variables and p-values
ewas_hemo_child_dis_crt <- EWAS_Children_discovery_results_adj[,c(1,14)]
ewas_hemo_child_rep_crt <- EWAS_Children_replication_results_adj[,c(1,13)]

##Add group
ewas_hemo_child_dis_crt$Shape <- rep("Discovery", nrow(ewas_hemo_child_dis_crt))
ewas_hemo_child_rep_crt$Shape <- rep("Replication", nrow(ewas_hemo_child_rep_crt))
colnames(ewas_hemo_child_dis_crt)[2] <- "pvalue"
colnames(ewas_hemo_child_rep_crt)[2] <- "pvalue"

##Combine groups
ewas_hemo_child_all_crt <- rbind(ewas_hemo_child_dis_crt,ewas_hemo_child_rep_crt)
colnames(ewas_hemo_child_all_crt)[1] <- "Variable"
colnames(ewas_hemo_child_all_crt)[2] <- "pvalue"
ewas_hemo_child_all_crt$pvalue = as.numeric(ewas_hemo_child_all_crt$pvalue)

##Manhattan Plot
VarCat_nopf <- read.delim("/Users/Nicen/Desktop/Anemia/Data/VarCat_nopf.txt")
hemo_ewas_mplot_child <- eman(ewas_hemo_child_all_crt, ewas = FALSE, groups = VarCat_nopf, file = "M-Plot Hemoglobin Children", morecolors = FALSE, hgt = 7, wi = 12, res = 300)

ggsave(file = "M-Plot Hemoglobin Children.png", plot = hemo_ewas_mplot_child, device = "png",path = "/Users/Nicen/Desktop/Anemia/Figures/Original Figures", width = 12, height = 7, dpi = 300)
```

***

#Vitamin B12
##Discovery Group Quality Control
```{r}
colnames(Main_table)[1] <- "ID"
MainTable_keepvar_over18 <- read.delim("~/Desktop/Anemia/Data/MainTable_keepvar_over18.tsv")
keepvar <- dput(names(MainTable_keepvar_over18))
keepvar <- c(paste(keepvar),"SDDSRVYR", "LBXB12")
MainTable_keepvar <- clarite::colfilter(d=Main_table, cols=keepvar, exclude=F)
Children <- MainTable_keepvar[MainTable_keepvar$RIDAGEYR < 15,]
Adults <- MainTable_keepvar[MainTable_keepvar$RIDAGEYR >= 15,]

##Filter complete.cases for each pheno + covars
vb_covars_a <- c("female", "black", "mexican", "other_hispanic", "other_eth", "SDDSRVYR", "BMXBMI", "SES_LEVEL", "RIDAGEYR", "DR1TVB12", "VITAMIN_B_12_mcg")
vb_covars_c <- c("female", "black", "mexican", "other_hispanic", "other_eth", "SDDSRVYR", "BMXBMI", "SES_LEVEL", "RIDAGEYR", "DR1TVB12", "VITAMIN_B_12_mcg")
pheno_vb12 <- c("LBXB12")
vb12_childid <- na.omit(clarite::colfilter(Children, cols=c(vb_covars_c, "LBXB12")))[, 1, drop=FALSE]
vb12_child <- clarite::merge_data(vb12_childid, Children, union = FALSE)
vb12_adultid <- na.omit(clarite::colfilter(Adults, cols=c(vb_covars_a, "LBXB12")))[, 1, drop=FALSE]
vb12_adult <- clarite::merge_data(vb12_adultid, Adults, union = FALSE)

##Filter by series 1&2
vb12_child_s1s2 <- vb12_child[vb12_child$SDDSRVYR==2 | vb12_child$SDDSRVYR==1, ]
vb12_adult_s1s2 <- vb12_adult[vb12_adult$SDDSRVYR==2 | vb12_adult$SDDSRVYR==1, ]

##Split into data type
#Get binary varibales into a separate file
vb12_child_s1s2_200_bin <- clarite::get_binary(vb12_child_s1s2)
vb12_adult_s1s2_200_bin <- clarite::get_binary(vb12_adult_s1s2)

#Get categorical variables into a separate file
vb12_child_s1s2_200_cat <- clarite::get_categorical(vb12_child_s1s2)
vb12_adult_s1s2_200_cat <- clarite::get_categorical(vb12_adult_s1s2)

#Changes values 7 and 9 using a pipeline format to NA. Cannot decipher meaning of values so make NA.
vb12_adult_s1s2_200_cat$SMQ077 <- ifelse(vb12_adult_s1s2_200_cat$SMQ077==7 | vb12_adult_s1s2_200_cat$SMQ077==9, NA, vb12_adult_s1s2_200_cat$SMQ077)

#Get continuous variables into a separate file
vb12_child_s1s2_200_cont <- clarite::get_continuous(vb12_child_s1s2)
vb12_adult_s1s2_200_cont <- clarite::get_continuous(vb12_adult_s1s2)

#Get ambiguous variables into a separate file
vb12_child_s1s2_200_check <- clarite::get_check(vb12_child_s1s2)
vb12_adult_s1s2_200_check <- clarite::get_check(vb12_adult_s1s2)

#Make vectors and label to remove or merge varibales to appropriate files
child_cont_merge <- c("RIDAGEYR", "LBXIHG", "URXUBE", "URXUPT", "LBXTO3",
"DRD350BQ", "DRD350HQ", "DRD370AQ", "DRD370BQ", "DRD370DQ", "DRD370MQ", 
"DRD370TQ", "DRD370UQ", "supplement_count", "DSDCOUNT", "LBX194", 
"LBX196", "LBD199", "LBXDIE")
child_cat_merge <- c("house_age")
adult_cont_merge <- c("URXUBE", "URXUPT", "LBXTO3", "DUQ130", 
"DRD350BQ", "DRD350FQ", "DRD350IQ", "DRD370AQ", "DRD370DQ", "DRD370EQ", 
"DRD370FQ", "DRD370IQ", "DRD370KQ", "DRD370NQ", "DRD370UQ", "OMEGA_3_FATTY_ACIDS_mg", 
"ALANINE_mg", "ARGININE_mg", "BETA_CAROTENE_IU", "BETA_CAROTENE_mg", 
"CAFFEINE_mg", "CYSTINE_mg", "HISTIDINE_mg", "ISOLEUCINE_mg", 
"LYSINE_mg", "PROLINE_mg", "SERINE_mg", "THREONINE_mg", "TRYPTOPHAN_mg", 
"TYROSINE_mg", "LBDSY3", "OTHER_FATTY_ACIDS_mg")
adult_cat_merge <- c("house_age")

#Remove columns and rename data frame then merge data from ambiguous file into continuous file
vb12_child_s1s2_200_contmerged <- clarite::merge_data(vb12_child_s1s2_200_cont, vb12_child_s1s2_200_check, union=TRUE)
vb12_child_s1s2_200_cont_final <- clarite::colfilter(d=vb12_child_s1s2_200_contmerged, cols=child_cat_merge, exclude=T)

vb12_adult_s1s2_200_contmerged <- clarite::merge_data(vb12_adult_s1s2_200_cont, vb12_adult_s1s2_200_check, union=TRUE)
vb12_adult_s1s2_200_cont_final <- clarite::colfilter(d=vb12_adult_s1s2_200_contmerged, cols=adult_cat_merge, exclude=T)

vb12_child_s1s2_200_catmerged <- clarite::merge_data(vb12_child_s1s2_200_cat, vb12_child_s1s2_200_check, union=TRUE)
vb12_child_s1s2_200_cat_final <- clarite::colfilter(d=vb12_child_s1s2_200_catmerged, cols=child_cont_merge, exclude=T)

vb12_adult_s1s2_200_catmerged <- clarite::merge_data(vb12_adult_s1s2_200_cat, vb12_adult_s1s2_200_check, union=TRUE)
vb12_adult_s1s2_200_cat_final <- clarite::colfilter(d=vb12_adult_s1s2_200_catmerged, cols=adult_cont_merge, exclude=T)

#Some categorical have 77, 99 as "Don't Know" so replace with missing in variables that would not otherwise be dropped
vb12_child_s1s2_200_cat_final$house_age <- ifelse(vb12_child_s1s2_200_cat_final$house_age==77 | vb12_child_s1s2_200_cat_final$house_age==99, NA, vb12_child_s1s2_200_cat_final$house_age)
vb12_adult_s1s2_200_cat_final$house_age <- ifelse(vb12_adult_s1s2_200_cat_final$house_age==77 | vb12_adult_s1s2_200_cat_final$house_age==99, NA, vb12_adult_s1s2_200_cat_final$house_age)

#Extract unique values and return vector from columns in data dictionary
desc_info <- unique(VarDescription[, colnames(VarDescription) %in% c("tab_desc", "module", "var", "var_desc")])

#Define functions with labels such as X, N, NNZ...etc and combine objects by rows. Return them out to finish function
get0 <- function(x){
  x <- as.numeric(as.character(x))
  N <- length(x)
  NNZ <- length(x[x>0])
  PZ <- (N-NNZ)/N
  out <- rbind(N=N, NNZ=NNZ, PZ=PZ)
  return(out)
}

#Drop >90% of the samples with get0 function. Combine columns and create data another data frame with PZ as label for dropped variables. Write to text file.
vb12_child_s1s2_200_cont_0 <- as.data.frame(t(sapply(vb12_child_s1s2_200_cont_final[, -1], get0)))
vb12_child_s1s2_200_cont_0 <- cbind(rownames(vb12_child_s1s2_200_cont_0), data.frame(vb12_child_s1s2_200_cont_0, row.names=NULL))
names(vb12_child_s1s2_200_cont_0) <- c("var", "N", "NNZ", "PZ")
vb12_child_s1s2_200_cont_full <- merge(vb12_child_s1s2_200_cont_0, desc_info, by="var")
vb12_child_s1s2_200_cont_full <- vb12_child_s1s2_200_cont_full[order(vb12_child_s1s2_200_cont_full$PZ, decreasing=TRUE), ]
write.table(vb12_child_s1s2_200_cont_full, file="vb12_children_percent_zero_values_series1-2.txt", sep="\t", quote=FALSE, row.names=FALSE)

vb12_adult_s1s2_200_cont_0 <- as.data.frame(t(sapply(vb12_adult_s1s2_200_cont_final[, -1], get0)))
vb12_adult_s1s2_200_cont_0 <- cbind(rownames(vb12_adult_s1s2_200_cont_0), data.frame(vb12_adult_s1s2_200_cont_0, row.names=NULL))
names(vb12_adult_s1s2_200_cont_0) <- c("var", "N", "NNZ", "PZ")
vb12_adult_s1s2_200_cont_full <- merge(vb12_adult_s1s2_200_cont_0, desc_info, by="var")
vb12_adult_s1s2_200_cont_full <- vb12_adult_s1s2_200_cont_full[order(vb12_adult_s1s2_200_cont_full$PZ, decreasing=TRUE), ]
write.table(vb12_adult_s1s2_200_cont_full, file="vb12_adult_percent_zero_values_series1-2.txt", sep="\t", quote=FALSE, row.names=FALSE)

#Remove PZ >= 0.90
vb12_child_pz <- vb12_child_s1s2_200_cont_full[vb12_child_s1s2_200_cont_full$PZ >= 0.9, 1, drop=FALSE]
vb12_adult_pz <- vb12_adult_s1s2_200_cont_full[vb12_adult_s1s2_200_cont_full$PZ >= 0.9, 1, drop=FALSE]

#Filter out the >= 0.90 samples from continuous file.
vb12_child_s1s2_200_final_pz <- clarite::colfilter(d=vb12_child_s1s2_200_cont_final, cols=vb12_child_pz, exclude = TRUE)
vb12_adult_s1s2_200_final_pz <- clarite::colfilter(d=vb12_adult_s1s2_200_cont_final, cols=vb12_adult_pz, exclude = TRUE)

##Make plot to visualize phenotype.
#If skewness is less than -1 or greater than 1, the distribution is highly skewed.
#If skewness is between -1 and -0.5 or between 0.5 and 1, the distribution is moderately skewed.
#If skewness is between -0.5 and 0.5, the distribution is approximately symmetric.

hist(vb12_child_s1s2_200_cont_final$LBXB12, breaks = 100 ,main = "VB12 (LBXB12) for children", xlab = "LBXB12")
hist(vb12_adult_s1s2_200_cont_final$LBXB12, breaks = 100, main = "VB12 (LBXB12) for adults", xlab = "LBXB12")

library (moments)
skewness(vb12_child_s1s2_200_cont_final$LBXB12)
skewness(vb12_adult_s1s2_200_cont_final$LBXB12)

transvb12_c <- log1p(vb12_child_s1s2_200_cont_final$LBXB12)
hist(transvb12_c, breaks = 100, main = "Log transformed VB12 (log LBXB12) for children", xlab = "log LBXB12")
skewness(transvb12_c)

transvb12_a <- log1p(vb12_adult_s1s2_200_cont_final$LBXB12)
hist(transvb12_a, breaks = 100, main = "Log transformed VB12 (log LBXB12) for adults", xlab = "log LBXB12")
skewness(transvb12_a)

#Log transform VB12 and name log transform column logVB12
vb12_child_s1s2_200_final_pz$logLBXB12 <- log1p(vb12_child_s1s2_200_cont_final$LBXB12)
vb12_child_s1s2_200_final_pz_log <- vb12_child_s1s2_200_final_pz

vb12_adult_s1s2_200_final_pz$logLBXB12 <- log1p(vb12_adult_s1s2_200_final_pz$LBXB12)
vb12_adult_s1s2_200_final_pz_log <- vb12_adult_s1s2_200_final_pz

#Drop the VB12 reading and related-variables
drop_item_VB12_child <- c("LBDHDD", "LBDHDL", "LBDLDL", "LBXSTR", "LBXTC","LBXTR", "LBXSCH", "DR1TCHOL","house_type","house_age","hepa","hepb","current_past_smoking","CVDVOMAX", "CVDESVO2", "CVDS1HR", "CVDS1SY", "CVDS1DI", "CVDS2HR", "CVDS2SY", "CVDS2DI", "CVDR1HR", "CVDR1SY", "CVDR1DI", "CVDR2HR", "CVDR2SY", "CVDR2DI", "physical_activity","LBXB12")
drop_item_VB12_adult <- c("LBDHDD", "LBDHDL", "LBDLDL", "LBXSTR", "LBXTC","LBXTR", "LBXSCH", "DR1TCHOL","house_type","house_age","hepa","hepb","current_past_smoking","CVDVOMAX", "CVDESVO2", "CVDS1HR", "CVDS1SY", "CVDS1DI", "CVDS2HR", "CVDS2SY", "CVDS2DI", "CVDR1HR", "CVDR1SY", "CVDR1DI", "CVDR2HR", "CVDR2SY", "CVDR2DI", "physical_activity","LBXB12")
vb12_child_s1s2_200_final_pz_final <- clarite::colfilter(d=vb12_child_s1s2_200_final_pz_log, cols=drop_item_VB12_child, exclude = TRUE)
vb12_adult_s1s2_200_final_pz_final <- clarite::colfilter(d=vb12_adult_s1s2_200_final_pz_log, cols=drop_item_VB12_adult, exclude = TRUE)

#Merge categorical and binary files (data frames)
vb12_child_s1s2_200_cat_bin <- clarite::merge_data(vb12_child_s1s2_200_cat_final, vb12_child_s1s2_200_bin)
vb12_adult_s1s2_200_cat_bin <- clarite::merge_data(vb12_adult_s1s2_200_cat_final, vb12_adult_s1s2_200_bin)

#Drop variables <200 and rename file
vb12_child_cat_final <- clarite::min_cat_n(vb12_child_s1s2_200_cat_bin, skip = c("other_hispanic", "other_eth"))
vb12_child_cat_final <- clarite::colfilter(d=vb12_child_cat_final, cols=drop_item_VB12_child, exclude = TRUE)
vb12_adult_cat_final <- clarite::min_cat_n(vb12_adult_s1s2_200_cat_bin)
vb12_adult_cat_final <- clarite::colfilter(d=vb12_adult_cat_final, cols=drop_item_VB12_adult, exclude = TRUE)

vb12_child_s1s2_200_final_pz_200 <- clarite::min_n(vb12_child_s1s2_200_final_pz_final)
vb12_adult_s1s2_200_final_pz_200 <- clarite::min_n(vb12_adult_s1s2_200_final_pz_final)
```

##Replication Group Quality Control
```{r}
##Filter by series 3&4
vb12_child_s3s4 <- vb12_child[vb12_child$SDDSRVYR==3 | vb12_child$SDDSRVYR==4, ]
vb12_adult_s3s4 <- vb12_adult[vb12_adult$SDDSRVYR==3 | vb12_adult$SDDSRVYR==4, ]

##Split into data type
#Get binary varibales into a separate file
vb12_child_s3s4_200_bin <- clarite::get_binary(vb12_child_s3s4)
vb12_adult_s3s4_200_bin <- clarite::get_binary(vb12_adult_s3s4)

#Get categorical variables into a separate file
vb12_child_s3s4_200_cat <- clarite::get_categorical(vb12_child_s3s4)
vb12_adult_s3s4_200_cat <- clarite::get_categorical(vb12_adult_s3s4)

#Changes values 7 and 9 using a pipeline format to NA. Cannot decipher meaning of values so make NA.
vb12_adult_s3s4_200_cat$SMQ077 <- ifelse(vb12_adult_s3s4_200_cat$SMQ077==7 | vb12_adult_s3s4_200_cat$SMQ077==9, NA, vb12_adult_s3s4_200_cat$SMQ077)

#Get continuous variables into a separate file
vb12_child_s3s4_200_cont <- clarite::get_continuous(vb12_child_s3s4)
vb12_adult_s3s4_200_cont <- clarite::get_continuous(vb12_adult_s3s4)

#Get ambiguous variables into a separate file
vb12_child_s3s4_200_check <- clarite::get_check(vb12_child_s3s4)
vb12_adult_s3s4_200_check <- clarite::get_check(vb12_adult_s3s4)

#Make vectors and label to remove or merge varibales to appropriate files
child_cont_merge <- c("RIDAGEYR", "LBXTO2", "LBXEPAH", "LBXPFSA", "LBXPFUA", 
"URXMOP", "SMD080", "DRD350AQ", "DRD350GQ", "DRD350HQ", 
"DRD370AQ", "DRD370DQ", "DRD370FQ", "DRD370MQ", "DRD370RQ", "DRD370TQ", 
"DRD370UQ", "DSDCOUNT", "LBX2DF", "URXUAC", "URXP21", "SMD641")
child_cat_merge <- c("house_age")
adult_cont_merge <- c("LBXVCT", "LBXV3A", "URXUBE", "LBXTO2", "LBXPFDO", 
"RHQ598", "how_long_estrogen_progestin_patch", "DRD350AQ", "DRD350BQ", 
"DRD350CQ", "DRD350DQ", "DRD350EQ", "DRD350FQ", "DRD350GQ", "DRD350HQ", 
"DRD350IQ", "DRD370AQ", "DRD370CQ", "DRD370DQ", "DRD370EQ", "DRD370FQ", 
"DRD370GQ", "DRD370HQ", "DRD370IQ", "DRD370KQ", "DRD370NQ", "DRD370RQ", 
"DRD370SQ", "DRD370UQ", "ALANINE_mg", "ARGININE_mg", "BETA_CAROTENE_mg", 
"CAFFEINE_mg", "CYSTINE_mg", "HISTIDINE_mg", "ISOLEUCINE_mg", 
"LEUCINE_mg", "LYSINE_mg", "PHENYLALANINE_mg", "PROLINE_mg", 
"SERINE_mg", "THREONINE_mg", "TRYPTOPHAN_mg", "TYROSINE_mg", 
"VALINE_mg", "LBXV2T", "LBXV4T", "LBXVDM", "URXUTM", "LBXPFBS", 
"DUQ280", "DUQ360")
adult_cat_merge <- c("house_age")

#Remove columns and rename data frame then merge data from ambiguous file into continuous file
vb12_child_s3s4_200_contmerged <- clarite::merge_data(vb12_child_s3s4_200_cont, vb12_child_s3s4_200_check, union=TRUE)
vb12_child_s3s4_200_cont_final <- clarite::colfilter(d=vb12_child_s3s4_200_contmerged, cols=child_cat_merge, exclude=T)

vb12_adult_s3s4_200_contmerged <- clarite::merge_data(vb12_adult_s3s4_200_cont, vb12_adult_s3s4_200_check, union=TRUE)
vb12_adult_s3s4_200_cont_final <- clarite::colfilter(d=vb12_adult_s3s4_200_contmerged, cols=adult_cat_merge, exclude=T)

vb12_child_s3s4_200_catmerged <- clarite::merge_data(vb12_child_s3s4_200_cat, vb12_child_s3s4_200_check, union=TRUE)
vb12_child_s3s4_200_cat_final <- clarite::colfilter(d=vb12_child_s3s4_200_catmerged, cols=child_cont_merge, exclude=T)

vb12_adult_s3s4_200_catmerged <- clarite::merge_data(vb12_adult_s3s4_200_cat, vb12_adult_s3s4_200_check, union=TRUE)
vb12_adult_s3s4_200_cat_final <- clarite::colfilter(d=vb12_adult_s3s4_200_catmerged, cols=adult_cont_merge, exclude=T)

#Some categorical have 77, 99 as "Don't Know" so replace with missing in variables that would not otherwise be dropped
vb12_child_s3s4_200_cat_final$house_age <- ifelse(vb12_child_s3s4_200_cat_final$house_age==77 | vb12_child_s3s4_200_cat_final$house_age==99, NA, vb12_child_s3s4_200_cat_final$house_age)
vb12_adult_s3s4_200_cat_final$house_age <- ifelse(vb12_adult_s3s4_200_cat_final$house_age==77 | vb12_adult_s3s4_200_cat_final$house_age==99, NA, vb12_adult_s3s4_200_cat_final$house_age)

#Extract unique values and return vector from columns in data dictionary
desc_info <- unique(VarDescription[, colnames(VarDescription) %in% c("tab_desc", "module", "var", "var_desc")])

#Define functions with labels such as X, N, NNZ...etc and combine objects by rows. Return them out to finish function
get0 <- function(x){
  x <- as.numeric(as.character(x))
  N <- length(x)
  NNZ <- length(x[x>0])
  PZ <- (N-NNZ)/N
  out <- rbind(N=N, NNZ=NNZ, PZ=PZ)
  return(out)
}

#Drop >90% of the samples with get0 function. Combine columns and create data another data frame with PZ as label for dropped variables. Write to text file.
vb12_child_s3s4_200_cont_0 <- as.data.frame(t(sapply(vb12_child_s3s4_200_cont_final[, -1], get0)))
vb12_child_s3s4_200_cont_0 <- cbind(rownames(vb12_child_s3s4_200_cont_0), data.frame(vb12_child_s3s4_200_cont_0, row.names=NULL))
names(vb12_child_s3s4_200_cont_0) <- c("var", "N", "NNZ", "PZ")
vb12_child_s3s4_200_cont_full <- merge(vb12_child_s3s4_200_cont_0, desc_info, by="var")
vb12_child_s3s4_200_cont_full <- vb12_child_s3s4_200_cont_full[order(vb12_child_s3s4_200_cont_full$PZ, decreasing=TRUE), ]
write.table(vb12_child_s3s4_200_cont_full, file="vb12_children_percent_zero_values_series1-2.txt", sep="\t", quote=FALSE, row.names=FALSE)

vb12_adult_s3s4_200_cont_0 <- as.data.frame(t(sapply(vb12_adult_s3s4_200_cont_final[, -1], get0)))
vb12_adult_s3s4_200_cont_0 <- cbind(rownames(vb12_adult_s3s4_200_cont_0), data.frame(vb12_adult_s3s4_200_cont_0, row.names=NULL))
names(vb12_adult_s3s4_200_cont_0) <- c("var", "N", "NNZ", "PZ")
vb12_adult_s3s4_200_cont_full <- merge(vb12_adult_s3s4_200_cont_0, desc_info, by="var")
vb12_adult_s3s4_200_cont_full <- vb12_adult_s3s4_200_cont_full[order(vb12_adult_s3s4_200_cont_full$PZ, decreasing=TRUE), ]
write.table(vb12_adult_s3s4_200_cont_full, file="vb12_adult_percent_zero_values_series1-2.txt", sep="\t", quote=FALSE, row.names=FALSE)

#Remove PZ >= 0.90
vb12_child_pz <- vb12_child_s3s4_200_cont_full[vb12_child_s3s4_200_cont_full$PZ >= 0.9, 1, drop=FALSE]
vb12_adult_pz <- vb12_adult_s3s4_200_cont_full[vb12_adult_s3s4_200_cont_full$PZ >= 0.9, 1, drop=FALSE]

#Filter out the >= 0.90 samples from continuous file.
vb12_child_s3s4_200_final_pz <- clarite::colfilter(d=vb12_child_s3s4_200_cont_final, cols=vb12_child_pz, exclude = TRUE)
vb12_adult_s3s4_200_final_pz <- clarite::colfilter(d=vb12_adult_s3s4_200_cont_final, cols=vb12_adult_pz, exclude = TRUE)

##Make plot to visualize phenotype.
#If skewness is less than -1 or greater than 1, the distribution is highly skewed.
#If skewness is between -1 and -0.5 or between 0.5 and 1, the distribution is moderately skewed.
#If skewness is between -0.5 and 0.5, the distribution is approximately symmetric.

hist(vb12_child_s3s4_200_cont_final$LBXB12, breaks = 100 ,main = "VB12 (LBXB12) for children", xlab = "LBXB12")
hist(vb12_adult_s3s4_200_cont_final$LBXB12, breaks = 100, main = "VB12 (LBXB12) for adults", xlab = "LBXB12")

library (moments)
skewness(vb12_child_s3s4_200_cont_final$LBXB12)
skewness(vb12_adult_s3s4_200_cont_final$LBXB12)

transvb12_c <- log1p(vb12_child_s3s4_200_cont_final$LBXB12)
hist(transvb12_c, breaks = 100, main = "Log transformed VB12 (log LBXB12) for children", xlab = "log LBXB12")
skewness(transvb12_c)

transvb12_a <- log1p(vb12_adult_s3s4_200_cont_final$LBXB12)
hist(transvb12_a, breaks = 100, main = "Log transformed VB12 (log LBXB12) for adults", xlab = "log LBXB12")
skewness(transvb12_a)

#Log transform VB12 and name log transform column logVB12
vb12_child_s3s4_200_final_pz$logLBXB12 <- log1p(vb12_child_s3s4_200_cont_final$LBXB12)
vb12_child_s3s4_200_final_pz_log <- vb12_child_s3s4_200_final_pz

vb12_adult_s3s4_200_final_pz$logLBXB12 <- log1p(vb12_adult_s3s4_200_final_pz$LBXB12)
vb12_adult_s3s4_200_final_pz_log <- vb12_adult_s3s4_200_final_pz

#Drop the VB12 reading and related-variables
drop_item_VB12_child <- c("LBDHDD", "LBDHDL", "LBDLDL", "LBXSTR", "LBXTC","LBXTR", "LBXSCH", "DR1TCHOL","house_type","house_age","hepa","hepb","current_past_smoking","CVDVOMAX", "CVDESVO2", "CVDS1HR", "CVDS1SY", "CVDS1DI", "CVDS2HR", "CVDS2SY", "CVDS2DI", "CVDR1HR", "CVDR1SY", "CVDR1DI", "CVDR2HR", "CVDR2SY", "CVDR2DI", "physical_activity","LBXB12")
drop_item_VB12_adult <- c("LBDHDD", "LBDHDL", "LBDLDL", "LBXSTR", "LBXTC","LBXTR", "LBXSCH", "DR1TCHOL","house_type","house_age","hepa","hepb","current_past_smoking","CVDVOMAX", "CVDESVO2", "CVDS1HR", "CVDS1SY", "CVDS1DI", "CVDS2HR", "CVDS2SY", "CVDS2DI", "CVDR1HR", "CVDR1SY", "CVDR1DI", "CVDR2HR", "CVDR2SY", "CVDR2DI", "physical_activity","LBXB12")
vb12_child_s3s4_200_final_pz_final <- clarite::colfilter(d=vb12_child_s3s4_200_final_pz_log, cols=drop_item_VB12_child, exclude = TRUE)
vb12_adult_s3s4_200_final_pz_final <- clarite::colfilter(d=vb12_adult_s3s4_200_final_pz_log, cols=drop_item_VB12_adult, exclude = TRUE)

#Merge categorical and binary files (data frames)
vb12_child_s3s4_200_cat_bin <- clarite::merge_data(vb12_child_s3s4_200_cat_final, vb12_child_s3s4_200_bin)
vb12_adult_s3s4_200_cat_bin <- clarite::merge_data(vb12_adult_s3s4_200_cat_final, vb12_adult_s3s4_200_bin)

#Drop variables <200 and rename file
vb12_child_cat_final_rep <- clarite::min_cat_n(vb12_child_s3s4_200_cat_bin, skip = c("other_hispanic", "other_eth"))
vb12_child_cat_final_rep <- clarite::colfilter(d=vb12_child_cat_final_rep, cols=drop_item_VB12_child, exclude = TRUE)
vb12_adult_cat_final_rep  <- clarite::min_cat_n(vb12_adult_s3s4_200_cat_bin)
vb12_adult_cat_final_rep <- clarite::colfilter(d=vb12_adult_cat_final_rep, cols=drop_item_VB12_adult, exclude = TRUE)

vb12_child_s3s4_200_final_pz_200 <- clarite::min_n(vb12_child_s3s4_200_final_pz_final)
vb12_adult_s3s4_200_final_pz_200 <- clarite::min_n(vb12_adult_s3s4_200_final_pz_final)
```

#EWAS Preparation Discovery Group
```{r include=FALSE}
#Children
##Dataframe
vb12_child_final_dis <- merge(vb12_child_cat_final,vb12_child_s1s2_200_final_pz_200)
vb12_child_final_rep <- merge(vb12_child_cat_final_rep,vb12_child_s3s4_200_final_pz_200)

pheno_vb12 <- "logLBXB12"
vb_covars_c_cat <- c("female", "black", "mexican", "other_hispanic", "other_eth", "SES_LEVEL", "SDDSRVYR")
vb_covars_c_cont <- c("BMXBMI","RIDAGEYR", "DR1TVB12", "VITAMIN_B_12_mcg")

vb12_child_final_dis_list <-dput(names(vb12_child_final_dis))
vb12_child_final_rep_list <-dput(names(vb12_child_final_rep))
vb12_child_final_child_crosslist <- (intersect(vb12_child_final_dis_list,vb12_child_final_rep_list))
vb12_child_final_child_crosslist <- (intersect(vb12_child_final_child_crosslist,VarWeight$Variable))
vb12_child_final_child_crosslist_variables <- c("ID",vb12_child_final_child_crosslist,vb_covars_c,pheno_vb12)

col.num.child.dis <- which(colnames(vb12_child_final_dis) %in% vb12_child_final_child_crosslist_variables)
vb12_child_final_dis <- vb12_child_final_dis[,col.num.child.dis]

vb12_child_final_child_discovery_final <- merge_data(vb12_child_final_dis, survey_design_discovery, union = FALSE)

##Co-variables
vb12_child_final_dis_cat_vars <- dput(names(vb12_child_cat_final))
vb12_child_final_dis_cat_vars <- vb12_child_final_dis_cat_vars[vb12_child_final_dis_cat_vars %in% vb12_child_final_child_crosslist]

vb12_child_final_dis_cont_vars <- dput(names(vb12_child_s1s2_200_final_pz_200))
vb12_child_final_dis_cont_vars <- vb12_child_final_dis_cont_vars[vb12_child_final_dis_cont_vars %in% vb12_child_final_child_crosslist]

#Adults
##Dataframe
vb12_adult_final_dis <- merge(vb12_adult_cat_final,vb12_adult_s1s2_200_final_pz_200)
vb12_adult_final_rep <- merge(vb12_adult_cat_final_rep,vb12_adult_s3s4_200_final_pz_200)

vb_covars_a_cat <- c("female", "black", "mexican", "other_hispanic", "other_eth", "SES_LEVEL", "SDDSRVYR")
vb_covars_a_cont <- c("BMXBMI","RIDAGEYR", "DR1TVB12", "VITAMIN_B_12_mcg")

vb12_adult_final_dis_list <- dput(names(vb12_adult_final_dis))
vb12_adult_final_rep_list <- dput(names(vb12_adult_final_rep))
vb12_adult_final_adult_crosslist <- (intersect(vb12_adult_final_dis_list,vb12_adult_final_rep_list))
vb12_adult_final_adult_crosslist <- (intersect(vb12_adult_final_adult_crosslist,VarWeight$Variable))
vb12_adult_final_adult_crosslist_variables <- c("ID",vb12_adult_final_adult_crosslist,vb_covars_a,pheno_vb12)

col.num.adult.dis <- which(colnames(vb12_adult_final_dis) %in% vb12_adult_final_adult_crosslist_variables)
vb12_adult_final_dis <- vb12_adult_final_dis[,col.num.adult.dis]

vb12_adult_final_adult_discovery_final <- merge_data(vb12_adult_final_dis, survey_design_discovery, union = FALSE)

##Variables
vb12_adult_final_dis_cat_vars <- dput(names(vb12_adult_cat_final))
vb12_adult_final_dis_cat_vars <- vb12_adult_final_dis_cat_vars[vb12_adult_final_dis_cat_vars %in% vb12_adult_final_adult_crosslist]

vb12_adult_final_dis_cont_vars <- dput(names(vb12_adult_s1s2_200_final_pz_200))
vb12_adult_final_dis_cont_vars <- vb12_adult_final_dis_cont_vars[vb12_adult_final_dis_cont_vars %in% vb12_adult_final_adult_crosslist]
```

#EWAS Discovery Group
```{r}
#Children EWAS
vb12_EWAS_Children_discovery_results <- ewas(d = vb12_child_final_child_discovery_final,
                          cat_vars=vb12_child_final_dis_cat_vars,
                          cont_vars=vb12_child_final_dis_cont_vars,
                          y=pheno_vb12,
                          cat_covars=vb_covars_c_cat,
                          cont_covars=vb_covars_c_cont,
                          regression_family="gaussian",
                          allowed_nonvarying=c("female", "SDDSRVYR"),
                          weights=weights_discovery,
                          ids="SDMVPSU",
                          strata="SDMVSTRA",
                          nest=TRUE,
                          drop_unweighted = TRUE)
write.table(vb12_EWAS_Children_discovery_results, file = "EWAS_vb12_Children_discovery_results.txt", row.names = F)

vb12_EWAS_Children_discovery_results_adj <- ewas_pval_adjust(vb12_EWAS_Children_discovery_results)
write.table(vb12_EWAS_Children_discovery_results_adj, file = "EWAS_vb12_Children_discovery_results_adj.txt", row.names = F)

#Adults EWAS
vb12_EWAS_adult_discovery_results <- ewas(d = vb12_adult_final_adult_discovery_final,
                          cat_vars=vb12_adult_final_dis_cat_vars,
                          cont_vars=vb12_adult_final_dis_cont_vars,
                          y=pheno_vb12,
                          cat_covars=vb_covars_a_cat,
                          cont_covars=vb_covars_a_cont,
                          regression_family="gaussian",
                          allowed_nonvarying=c("female", "SDDSRVYR"),
                          weights=weights_discovery,
                          ids="SDMVPSU",
                          strata="SDMVSTRA",
                          nest=TRUE,
                          drop_unweighted = TRUE)
write.table(vb12_EWAS_adult_discovery_results, file = "EWAS_vb12_adult_discovery_results.txt", row.names = F)

vb12_EWAS_adult_discovery_results_adj <- ewas_pval_adjust(vb12_EWAS_adult_discovery_results)
write.table(vb12_EWAS_adult_discovery_results_adj, file = "EWAS_vb12_adult_discovery_results_adj.txt", row.names = F)
```

#EWAS Vitamin B12 Preparation Replication Group
```{r include=FALSE}
#Adults
pvalue_fdr_rank_vb12_adult <- vb12_EWAS_adult_discovery_results_adj[order(vb12_EWAS_adult_discovery_results_adj$pvalue_FDR), ]
selected_variables_fdr_list_vb12_adult <- which(pvalue_fdr_rank_vb12_adult$pvalue_FDR < 0.1)
selected_variables_fdr_vb12_adult <- head(pvalue_fdr_rank_vb12_adult[,1],length(selected_variables_fdr_list_vb12_adult))

variables_fdr_vb12_adult <- c(paste(selected_variables_fdr_vb12_adult), vb_covars_a, pheno_vb12)
all_variable_filtered_vb12_adult <- vb12_adult_final_rep
rep_variable_vb12_adult <- colfilter(d=all_variable_filtered_vb12_adult, cols = variables_fdr_vb12_adult, exclude = FALSE)

vb12_adult_final_adult_replication_final <- merge_data(rep_variable_vb12_adult, survey_design_replication, union = FALSE)

##Variables
vb12_adult_final_rep_cat_vars <- dput(names(vb12_adult_cat_final_rep))
vb12_adult_final_rep_cat_vars_finallist <- dput(names(vb12_adult_final_adult_replication_final))
vb12_adult_final_rep_cat_vars <- intersect(vb12_adult_final_rep_cat_vars,vb12_adult_final_rep_cat_vars_finallist)
vb12_adult_final_rep_cat_vars <- vb12_adult_final_rep_cat_vars[!vb12_adult_final_rep_cat_vars %in% c(vb_covars_a, "ID")]

vb12_adult_final_rep_cont_vars <- dput(names(vb12_adult_s3s4_200_final_pz_200))
vb12_adult_final_rep_cont_vars_finallist <- dput(names(vb12_adult_final_adult_replication_final))
vb12_adult_final_rep_cont_vars <-vb12_adult_final_rep_cont_vars[vb12_adult_final_rep_cont_vars %in% vb12_adult_final_rep_cont_vars_finallist]
vb12_adult_final_rep_cont_vars <- vb12_adult_final_rep_cont_vars[!vb12_adult_final_rep_cont_vars %in% c(vb_covars_a, "ID", pheno_vb12)]

#Children
pvalue_fdr_rank_vb12_child <- vb12_EWAS_Children_discovery_results_adj[order(vb12_EWAS_Children_discovery_results_adj$pvalue_FDR), ]
selected_variables_fdr_list_vb12_child <- which(pvalue_fdr_rank_vb12_child$pvalue_FDR < 0.1)
selected_variables_fdr_vb12_child <- head(pvalue_fdr_rank_vb12_child[,1],length(selected_variables_fdr_list_vb12_child))

variables_fdr_vb12_child <- c(paste(selected_variables_fdr_vb12_child), vb_covars_c, pheno_vb12)
all_variable_filtered_vb12_child <- vb12_child_final_rep
rep_variable_vb12_child <- colfilter(d=all_variable_filtered_vb12_child, cols = variables_fdr_vb12_child, exclude = FALSE)

vb12_child_final_child_replication_final <- merge_data(rep_variable_vb12_child, survey_design_replication, union = FALSE)

##Variables
vb12_child_final_rep_cat_vars <- dput(names(vb12_child_cat_final_rep))
vb12_child_final_rep_cat_vars_finallist <- dput(names(vb12_child_final_child_replication_final))
vb12_child_final_rep_cat_vars <- intersect(vb12_child_final_rep_cat_vars,vb12_child_final_rep_cat_vars_finallist)
vb12_child_final_rep_cat_vars <- vb12_child_final_rep_cat_vars[!vb12_child_final_rep_cat_vars %in% c(vb_covars_c, "ID")]

vb12_child_final_rep_cont_vars <- dput(names(vb12_child_s3s4_200_final_pz_200))
vb12_child_final_rep_cont_vars_finallist <- dput(names(vb12_child_final_child_replication_final))
vb12_child_final_rep_cont_vars <-vb12_child_final_rep_cont_vars[vb12_child_final_rep_cont_vars %in% vb12_child_final_rep_cont_vars_finallist]
vb12_child_final_rep_cont_vars <- vb12_child_final_rep_cont_vars[!vb12_child_final_rep_cont_vars %in% c(vb_covars_c, "ID", pheno_vb12)]
```

#EWAS Vitamin B12 Replication Group
```{r}
# Adults
vb12_EWAS_adult_replication_results <- ewas(d = vb12_adult_final_adult_replication_final,
                            cat_vars=vb12_adult_final_rep_cat_vars,
                            cont_vars=vb12_adult_final_rep_cont_vars,
                            y=pheno_vb12,
                            cat_covars=vb_covars_a_cat,
                            cont_covars=vb_covars_a_cont,
                            regression_family="gaussian",
                            allowed_nonvarying=c("female", "SDDSRVYR"),
                            weights=weights_replication,
                            ids="SDMVPSU",
                            strata="SDMVSTRA",
                            nest=TRUE,
                            drop_unweighted = TRUE)
write.table(vb12_EWAS_adult_replication_results, file = "EWAS_vb12_adult_replication_results.txt", row.names = F)


vb12_EWAS_adult_replication_results_adj <- ewas_pval_adjust(vb12_EWAS_adult_replication_results)
write.table(vb12_EWAS_adult_replication_results_adj, file = "EWAS_vb12_adult_replication_results_adj.txt", row.names = F)

# Children
vb12_EWAS_Children_replication_results <- ewas(d = vb12_child_final_child_replication_final,
                            cat_vars=vb12_child_final_rep_cat_vars,
                            cont_vars=vb12_child_final_rep_cont_vars,
                            y=pheno_vb12,
                            cat_covars=vb_covars_c_cat,
                            cont_covars=vb_covars_c_cont,
                            regression_family="gaussian",
                            allowed_nonvarying=c("female", "SDDSRVYR"),
                            weights=weights_replication,
                            ids="SDMVPSU",
                            strata="SDMVSTRA",
                            nest=TRUE,
                            drop_unweighted = TRUE)
write.table(vb12_EWAS_Children_replication_results, file = "EWAS_vb12_Children_replication_results.txt", row.names = F)


vb12_EWAS_Children_replication_results_adj <- ewas_pval_adjust(vb12_EWAS_Children_replication_results)
write.table(vb12_EWAS_Children_replication_results_adj, file = "EWAS_vb12_Children_replication_results_adj.txt", row.names = F)
```

#EWAS Vitamin B12 Manhattan Plot
```{r}
#Adults
##Extract the variables and p-values
ewas_vb12_adult_dis_crt <- vb12_EWAS_adult_discovery_results_adj[,c(1,14)]
ewas_vb12_adult_rep_crt <- vb12_EWAS_adult_replication_results_adj[,c(1,13)]

##Add group
ewas_vb12_adult_dis_crt$Shape <- rep("Discovery", nrow(ewas_vb12_adult_dis_crt))
ewas_vb12_adult_rep_crt$Shape <- rep("Replication", nrow(ewas_vb12_adult_rep_crt))
colnames(ewas_vb12_adult_dis_crt)[2] <- "pvalue"
colnames(ewas_vb12_adult_rep_crt)[2] <- "pvalue"

##Combine groups
ewas_vb12_adult_all_crt <- rbind(ewas_vb12_adult_dis_crt,ewas_vb12_adult_rep_crt)
colnames(ewas_vb12_adult_all_crt)[1] <- "Variable"
colnames(ewas_vb12_adult_all_crt)[2] <- "pvalue"
ewas_vb12_adult_all_crt$pvalue = as.numeric(ewas_vb12_adult_all_crt$pvalue)

##Manhattan Plot
VarCat_nopf <- read.delim("/Users/Nicen/Desktop/Anemia/Data/VarCat_nopf.txt")

vb12_ewas_mplot_adult <- eman(ewas_vb12_adult_all_crt, ewas = FALSE, groups = VarCat_nopf, file = "M-Plot Vitamin B12 Adults", morecolors = FALSE, hgt = 7, wi = 12, res = 300)

ggsave(file = "M-Plot Vitamin B12 Adults.png", plot = vb12_ewas_mplot_adult, device = "png",path = "/Users/Nicen/Desktop/Anemia/Figures/Original Figures", width = 12, height = 7, dpi = 300)

#Children
##Extract the variables and p-values
ewas_vb12_child_dis_crt <- vb12_EWAS_Children_discovery_results_adj[,c(1,14)]
ewas_vb12_child_rep_crt <- vb12_EWAS_Children_replication_results_adj[,c(1,13)]

##Add group
ewas_vb12_child_dis_crt$Shape <- rep("Discovery", nrow(ewas_vb12_child_dis_crt))
ewas_vb12_child_rep_crt$Shape <- rep("Replication", nrow(ewas_vb12_child_rep_crt))
colnames(ewas_vb12_child_dis_crt)[2] <- "pvalue"
colnames(ewas_vb12_child_rep_crt)[2] <- "pvalue"

##Combine groups
ewas_vb12_child_all_crt <- rbind(ewas_vb12_child_dis_crt,ewas_vb12_child_rep_crt)
colnames(ewas_vb12_child_all_crt)[1] <- "Variable"
colnames(ewas_vb12_child_all_crt)[2] <- "pvalue"
ewas_vb12_child_all_crt$pvalue = as.numeric(ewas_vb12_child_all_crt$pvalue)

##Manhattan Plot
VarCat_nopf <- read.delim("/Users/Nicen/Desktop/Anemia/Data/VarCat_nopf.txt")
vb12_ewas_mplot_child <- eman(ewas_vb12_child_all_crt, ewas = FALSE, groups = VarCat_nopf, file = "M-Plot Vitamin B12 Children", morecolors = FALSE, hgt = 7, wi = 12, res = 300)

ggsave(file = "M-Plot Vitamin B12 Children.png", plot = vb12_ewas_mplot_child, device = "png",path = "/Users/Nicen/Desktop/Anemia/Figures/Original Figures", width = 12, height = 7, dpi = 300)
```

***

#RBC folate
##Discovery Group Quality Control
```{r}
colnames(Main_table)[1] <- "ID"
MainTable_keepvar_over18 <- read.delim("~/Desktop/Anemia/Data/MainTable_keepvar_over18.tsv")
keepvar <- dput(names(MainTable_keepvar_over18))
keepvar <- c(paste(keepvar),"SDDSRVYR", "LBXRBF")
MainTable_keepvar <- clarite::colfilter(d=Main_table, cols=keepvar, exclude=F)

Children <- MainTable_keepvar[MainTable_keepvar$RIDAGEYR < 15,]
Adults <- MainTable_keepvar[MainTable_keepvar$RIDAGEYR >= 15,]

##Filter complete.cases for each pheno + covars
RBF_covars_a <- c("female", "black", "mexican", "other_hispanic", "other_eth", "BMXBMI", "SES_LEVEL", "RIDAGEYR", "FOLIC_ACID_mcg","SDDSRVYR")
RBF_covars_c <- c("female", "black", "mexican", "other_hispanic", "other_eth", "BMXBMI", "SES_LEVEL", "RIDAGEYR", "FOLIC_ACID_mcg","SDDSRVYR")
pheno_RBF <- c("LBXRBF")
RBF_childid <- na.omit(clarite::colfilter(Children, cols=c(RBF_covars_c, "LBXRBF")))[, 1, drop=FALSE]
RBF_child <- clarite::merge_data(RBF_childid, Children, union = FALSE)
RBF_adultid <- na.omit(clarite::colfilter(Adults, cols=c(RBF_covars_a, "LBXRBF")))[, 1, drop=FALSE]
RBF_adult <- clarite::merge_data(RBF_adultid, Adults, union = FALSE)

##Filter by series 1&2
RBF_child_s1s2 <- RBF_child[RBF_child$SDDSRVYR==2 | RBF_child$SDDSRVYR==1, ]
RBF_adult_s1s2 <- RBF_adult[RBF_adult$SDDSRVYR==2 | RBF_adult$SDDSRVYR==1, ]


##Split into data type
#Get binary varibales into a separate file
RBF_child_s1s2_200_bin <- clarite::get_binary(RBF_child_s1s2)
RBF_adult_s1s2_200_bin <- clarite::get_binary(RBF_adult_s1s2)

#Get categorical variables into a separate file
RBF_child_s1s2_200_cat <- clarite::get_categorical(RBF_child_s1s2)
RBF_adult_s1s2_200_cat <- clarite::get_categorical(RBF_adult_s1s2)

#Changes values 7 and 9 using a pipeline format to NA. Cannot decipher meaning of values so make NA.
RBF_adult_s1s2_200_cat$SMQ077 <- ifelse(RBF_adult_s1s2_200_cat$SMQ077==7 | RBF_adult_s1s2_200_cat$SMQ077==9, NA, RBF_adult_s1s2_200_cat$SMQ077)

#Get continuous variables into a separate file
RBF_child_s1s2_200_cont <- clarite::get_continuous(RBF_child_s1s2)
RBF_adult_s1s2_200_cont <- clarite::get_continuous(RBF_adult_s1s2)

#Get ambiguous variables into a separate file
RBF_child_s1s2_200_check <- clarite::get_check(RBF_child_s1s2)
RBF_adult_s1s2_200_check <- clarite::get_check(RBF_adult_s1s2)

#Make vectors and label to remove or merge varibales to appropriate files
child_cont_merge <- c("ID", "RIDAGEYR", "LBXIHG", "URXUBE", "URXUPT", "LBXTO3", 
"DRD350BQ", "DRD350HQ", "DRD370AQ", "DRD370BQ", "DRD370DQ", "DRD370MQ", 
"DRD370TQ", "DRD370UQ", "supplement_count", "DSDCOUNT", "LBX194", 
"LBX196", "LBD199", "LBXDIE")
child_cat_merge <- c("house_age")
adult_cont_merge <- c("URXUBE", "URXUPT", "LBXTO3", "DUQ130", 
"DRD350BQ", "DRD350FQ", "DRD350IQ", "DRD370AQ", "DRD370DQ", "DRD370EQ", 
"DRD370FQ", "DRD370IQ", "DRD370KQ", "DRD370NQ", "DRD370UQ", "OMEGA_3_FATTY_ACIDS_mg", 
"ALANINE_mg", "ARGININE_mg", "BETA_CAROTENE_mg", "CAFFEINE_mg", 
"CYSTINE_mg", "HISTIDINE_mg", "ISOLEUCINE_mg", "LYSINE_mg", "PROLINE_mg", 
"SERINE_mg", "THREONINE_mg", "TRYPTOPHAN_mg", "TYROSINE_mg", 
"LBDSY3", "OTHER_FATTY_ACIDS_mg")
adult_cat_merge <- c("house_age")

#Remove columns and rename data frame then merge data from ambiguous file into continuous file
RBF_child_s1s2_200_contmerged <- clarite::merge_data(RBF_child_s1s2_200_cont, RBF_child_s1s2_200_check, union=TRUE)
RBF_child_s1s2_200_cont_final <- clarite::colfilter(d=RBF_child_s1s2_200_contmerged, cols=child_cat_merge, exclude=T)

RBF_adult_s1s2_200_contmerged <- clarite::merge_data(RBF_adult_s1s2_200_cont, RBF_adult_s1s2_200_check, union=TRUE)
RBF_adult_s1s2_200_cont_final <- clarite::colfilter(d=RBF_adult_s1s2_200_contmerged, cols=adult_cat_merge, exclude=T)

RBF_child_s1s2_200_catmerged <- clarite::merge_data(RBF_child_s1s2_200_cat, RBF_child_s1s2_200_check, union=TRUE)
RBF_child_s1s2_200_cat_final <- clarite::colfilter(d=RBF_child_s1s2_200_catmerged, cols=child_cont_merge, exclude=T)

RBF_adult_s1s2_200_catmerged <- clarite::merge_data(RBF_adult_s1s2_200_cat, RBF_adult_s1s2_200_check, union=TRUE)
RBF_adult_s1s2_200_cat_final <- clarite::colfilter(d=RBF_adult_s1s2_200_catmerged, cols=adult_cont_merge, exclude=T)

#Some categorical have 77, 99 as "Don't Know" so replace with missing in variables that would not otherwise be dropped
RBF_child_s1s2_200_cat_final$house_age <- ifelse(RBF_child_s1s2_200_cat_final$house_age==77 | RBF_child_s1s2_200_cat_final$house_age==99, NA, RBF_child_s1s2_200_cat_final$house_age)
RBF_adult_s1s2_200_cat_final$house_age <- ifelse(RBF_adult_s1s2_200_cat_final$house_age==77 | RBF_adult_s1s2_200_cat_final$house_age==99, NA, RBF_adult_s1s2_200_cat_final$house_age)

#Extract unique values and return vector from columns in data dictionary
desc_info <- unique(VarDescription[, colnames(VarDescription) %in% c("tab_desc", "module", "var", "var_desc")])

#Define functions with labels such as X, N, NNZ...etc and combine objects by rows. Return them out to finish function
get0 <- function(x){
  x <- as.numeric(as.character(x))
  N <- length(x)
  NNZ <- length(x[x>0])
  PZ <- (N-NNZ)/N
  out <- rbind(N=N, NNZ=NNZ, PZ=PZ)
  return(out)
}

#Drop >90% of the samples with get0 function. Combine columns and create data another data frame with PZ as label for dropped variables. Write to text file.
RBF_child_s1s2_200_cont_0 <- as.data.frame(t(sapply(RBF_child_s1s2_200_cont_final[, -1], get0)))
RBF_child_s1s2_200_cont_0 <- cbind(rownames(RBF_child_s1s2_200_cont_0), data.frame(RBF_child_s1s2_200_cont_0, row.names=NULL))
names(RBF_child_s1s2_200_cont_0) <- c("var", "N", "NNZ", "PZ")
RBF_child_s1s2_200_cont_full <- merge(RBF_child_s1s2_200_cont_0, desc_info, by="var")
RBF_child_s1s2_200_cont_full <- RBF_child_s1s2_200_cont_full[order(RBF_child_s1s2_200_cont_full$PZ, decreasing=TRUE), ]
write.table(RBF_child_s1s2_200_cont_full, file="RBF_children_percent_zero_values_series1-2.txt", sep="\t", quote=FALSE, row.names=FALSE)

RBF_adult_s1s2_200_cont_0 <- as.data.frame(t(sapply(RBF_adult_s1s2_200_cont_final[, -1], get0)))
RBF_adult_s1s2_200_cont_0 <- cbind(rownames(RBF_adult_s1s2_200_cont_0), data.frame(RBF_adult_s1s2_200_cont_0, row.names=NULL))
names(RBF_adult_s1s2_200_cont_0) <- c("var", "N", "NNZ", "PZ")
RBF_adult_s1s2_200_cont_full <- merge(RBF_adult_s1s2_200_cont_0, desc_info, by="var")
RBF_adult_s1s2_200_cont_full <- RBF_adult_s1s2_200_cont_full[order(RBF_adult_s1s2_200_cont_full$PZ, decreasing=TRUE), ]
write.table(RBF_adult_s1s2_200_cont_full, file="RBF_adult_percent_zero_values_series1-2.txt", sep="\t", quote=FALSE, row.names=FALSE)

#Remove PZ >= 0.90
RBF_child_pz <- RBF_child_s1s2_200_cont_full[RBF_child_s1s2_200_cont_full$PZ >= 0.9, 1, drop=FALSE]
RBF_adult_pz <- RBF_adult_s1s2_200_cont_full[RBF_adult_s1s2_200_cont_full$PZ >= 0.9, 1, drop=FALSE]

#Filter out the >= 0.90 samples from continuous file.
RBF_child_s1s2_200_final_pz <- clarite::colfilter(d=RBF_child_s1s2_200_cont_final, cols=RBF_child_pz, exclude = TRUE)
RBF_adult_s1s2_200_final_pz <- clarite::colfilter(d=RBF_adult_s1s2_200_cont_final, cols=RBF_adult_pz, exclude = TRUE)

##Make plot to visualize phenotype.
#If skewness is less than -1 or greater than 1, the distribution is highly skewed.
#If skewness is between -1 and -0.5 or between 0.5 and 1, the distribution is moderately skewed.
#If skewness is between -0.5 and 0.5, the distribution is approximately symmetric.

hist(RBF_child_s1s2_200_cont_final$LBXRBF, breaks = 100, main = "RBC folate (LBXRBF) for children", xlab = "LBXRBF")
hist(RBF_adult_s1s2_200_cont_final$LBXRBF, breaks = 100, main = "RBC folate (LBXRBF) for adults", xlab = "LBXRBF")

library (moments)
skewness(RBF_child_s1s2_200_cont_final$LBXRBF)
skewness(RBF_adult_s1s2_200_cont_final$LBXRBF)

transRBF_c <- log1p(RBF_child_s1s2_200_cont_final$LBXRBF)
hist(transRBF_c, breaks = 100, main = "Log transformed RBC folate (log LBXRBF) for children", xlab = "log LBXRBF")
skewness(transRBF_c)

transRBF_a <- log1p(RBF_adult_s1s2_200_cont_final$LBXRBF)
hist(transRBF_a, breaks = 100, main = "Log transformed RBC folate (log LBXRBF) for adults", xlab = "log LBXRBF")
skewness(transRBF_a)

#Log transform RBF and name log transform column logRBF
RBF_child_s1s2_200_final_pz$logLBXRBF <- log1p(RBF_child_s1s2_200_cont_final$LBXRBF)
RBF_child_s1s2_200_final_pz_log <- RBF_child_s1s2_200_final_pz

RBF_adult_s1s2_200_final_pz$logLBXRBF <- log1p(RBF_adult_s1s2_200_final_pz$LBXRBF)
RBF_adult_s1s2_200_final_pz_log <- RBF_adult_s1s2_200_final_pz

#Drop the RBF reading
drop_item_RBF_child <- c("LBDHDD", "LBDHDL", "LBDLDL", "LBXSTR", "LBXTC","LBXTR", "LBXSCH", "DR1TCHOL","house_type","house_age","hepa","hepb","current_past_smoking","CVDVOMAX", "CVDESVO2", "CVDS1HR", "CVDS1SY", "CVDS1DI", "CVDS2HR", "CVDS2SY", "CVDS2DI", "CVDR1HR", "CVDR1SY", "CVDR1DI", "CVDR2HR", "CVDR2SY", "CVDR2DI", "physical_activity","LBXRBF","LBXFOL")
drop_item_RBF_adult <- c("LBDHDD", "LBDHDL", "LBDLDL", "LBXSTR", "LBXTC","LBXTR", "LBXSCH", "DR1TCHOL","house_type","house_age","hepa","hepb","current_past_smoking","CVDVOMAX", "CVDESVO2", "CVDS1HR", "CVDS1SY", "CVDS1DI", "CVDS2HR", "CVDS2SY", "CVDS2DI", "CVDR1HR", "CVDR1SY", "CVDR1DI", "CVDR2HR", "CVDR2SY", "CVDR2DI", "physical_activity","LBXRBF","LBXFOL")
RBF_child_s1s2_200_final_pz_final <- clarite::colfilter(d=RBF_child_s1s2_200_final_pz_log, cols=drop_item_RBF_child, exclude = TRUE)
RBF_adult_s1s2_200_final_pz_final <- clarite::colfilter(d=RBF_adult_s1s2_200_final_pz_log, cols=drop_item_RBF_adult, exclude = TRUE)

#Merge categorical and binary files (data frames)
RBF_child_s1s2_200_cat_bin <- clarite::merge_data(RBF_child_s1s2_200_cat_final, RBF_child_s1s2_200_bin)
RBF_adult_s1s2_200_cat_bin <- clarite::merge_data(RBF_adult_s1s2_200_cat_final, RBF_adult_s1s2_200_bin)

#Drop variables <200 and rename file
skip_RBF <- RBF_covars_a[!RBF_covars_a %in% c("BMXBMI","RIDAGEYR", "FOLIC_ACID_mcg")]
RBF_child_cat_final <- clarite::min_cat_n(RBF_child_s1s2_200_cat_bin, skip = skip_RBF)
RBF_child_cat_final <- clarite::colfilter(d=RBF_child_cat_final, cols=drop_item_RBF_child, exclude = TRUE)
RBF_adult_cat_final <- clarite::min_cat_n(RBF_adult_s1s2_200_cat_bin, skip = skip_RBF)
RBF_adult_cat_final <- clarite::colfilter(d=RBF_adult_cat_final, cols=drop_item_RBF_adult, exclude = TRUE)

RBF_child_s1s2_200_final_pz_200 <- clarite::min_n(RBF_child_s1s2_200_final_pz_final)
RBF_adult_s1s2_200_final_pz_200 <- clarite::min_n(RBF_adult_s1s2_200_final_pz_final)
```

##Replication Group Quality Control
```{r}
##Filter by series 3&4
RBF_child_s3s4 <- RBF_child[RBF_child$SDDSRVYR==3 | RBF_child$SDDSRVYR==4, ]
RBF_adult_s3s4 <- RBF_adult[RBF_adult$SDDSRVYR==3 | RBF_adult$SDDSRVYR==4, ]

##Split into data type
#Get binary varibales into a separate file
RBF_child_s3s4_200_bin <- clarite::get_binary(RBF_child_s3s4)
RBF_adult_s3s4_200_bin <- clarite::get_binary(RBF_adult_s3s4)

#Get categorical variables into a separate file
RBF_child_s3s4_200_cat <- clarite::get_categorical(RBF_child_s3s4)
RBF_adult_s3s4_200_cat <- clarite::get_categorical(RBF_adult_s3s4)

#Changes values 7 and 9 using a pipeline format to NA. Cannot decipher meaning of values so make NA.
RBF_adult_s3s4_200_cat$SMQ077 <- ifelse(RBF_adult_s3s4_200_cat$SMQ077==7 | RBF_adult_s3s4_200_cat$SMQ077==9, NA, RBF_adult_s3s4_200_cat$SMQ077)

#Get continuous variables into a separate file
RBF_child_s3s4_200_cont <- clarite::get_continuous(RBF_child_s3s4)
RBF_adult_s3s4_200_cont <- clarite::get_continuous(RBF_adult_s3s4)

#Get ambiguous variables into a separate file
RBF_child_s3s4_200_check <- clarite::get_check(RBF_child_s3s4)
RBF_adult_s3s4_200_check <- clarite::get_check(RBF_adult_s3s4)

#Make vectors and label to remove or merge varibales to appropriate files
child_cont_merge <- c("RIDAGEYR", "LBXTO2", "LBXEPAH", "LBXPFSA", "LBXPFUA", 
"URXMOP", "SMD080", "DRD350AQ", "DRD350GQ", "DRD350HQ", 
"DRD370AQ", "DRD370DQ", "DRD370FQ", "DRD370MQ", "DRD370RQ", "DRD370TQ", 
"DRD370UQ", "supplement_count", "DSDCOUNT", "OMEGA_3_FATTY_ACIDS_mg", 
"LBX2DF", "URXUAC", "URXP21", "SMD641")
child_cat_merge <- c("house_age")
adult_cont_merge <- c("LBXVCT", "LBXV3A", "URXUBE", "LBXTO2", "LBXPFDO", 
"RHQ598", "how_long_estrogen_progestin_patch", "DRD350AQ", "DRD350BQ", 
"DRD350CQ", "DRD350DQ", "DRD350EQ", "DRD350FQ", "DRD350GQ", "DRD350HQ", 
"DRD350IQ", "DRD370AQ", "DRD370CQ", "DRD370DQ", "DRD370EQ", "DRD370FQ", 
"DRD370GQ", "DRD370HQ", "DRD370IQ", "DRD370KQ", "DRD370NQ", "DRD370RQ", 
"DRD370SQ", "DRD370UQ", "ALANINE_mg", "ARGININE_mg", "BETA_CAROTENE_mg", 
"CAFFEINE_mg", "CYSTINE_mg", "HISTIDINE_mg", "ISOLEUCINE_mg", 
"LEUCINE_mg", "LYSINE_mg", "PHENYLALANINE_mg", "PROLINE_mg", 
"SERINE_mg", "THREONINE_mg", "TRYPTOPHAN_mg", "TYROSINE_mg", 
"VALINE_mg", "LBXV2T", "LBXV4T", "LBXVDM", "URXUTM", "LBXPFBS", 
"DUQ280", "DUQ360")
adult_cat_merge <- c("house_age")

#Remove columns and rename data frame then merge data from ambiguous file into continuous file
RBF_child_s3s4_200_contmerged <- clarite::merge_data(RBF_child_s3s4_200_cont, RBF_child_s3s4_200_check, union=TRUE)
RBF_child_s3s4_200_cont_final <- clarite::colfilter(d=RBF_child_s3s4_200_contmerged, cols=child_cat_merge, exclude=T)

RBF_adult_s3s4_200_contmerged <- clarite::merge_data(RBF_adult_s3s4_200_cont, RBF_adult_s3s4_200_check, union=TRUE)
RBF_adult_s3s4_200_cont_final <- clarite::colfilter(d=RBF_adult_s3s4_200_contmerged, cols=adult_cat_merge, exclude=T)

RBF_child_s3s4_200_catmerged <- clarite::merge_data(RBF_child_s3s4_200_cat, RBF_child_s3s4_200_check, union=TRUE)
RBF_child_s3s4_200_cat_final <- clarite::colfilter(d=RBF_child_s3s4_200_catmerged, cols=child_cont_merge, exclude=T)

RBF_adult_s3s4_200_catmerged <- clarite::merge_data(RBF_adult_s3s4_200_cat, RBF_adult_s3s4_200_check, union=TRUE)
RBF_adult_s3s4_200_cat_final <- clarite::colfilter(d=RBF_adult_s3s4_200_catmerged, cols=adult_cont_merge, exclude=T)

#Some categorical have 77, 99 as "Don't Know" so replace with missing in variables that would not otherwise be dropped
RBF_child_s3s4_200_cat_final$house_age <- ifelse(RBF_child_s3s4_200_cat_final$house_age==77 | RBF_child_s3s4_200_cat_final$house_age==99, NA, RBF_child_s3s4_200_cat_final$house_age)
RBF_adult_s3s4_200_cat_final$house_age <- ifelse(RBF_adult_s3s4_200_cat_final$house_age==77 | RBF_adult_s3s4_200_cat_final$house_age==99, NA, RBF_adult_s3s4_200_cat_final$house_age)

#Extract unique values and return vector from columns in data dictionary
desc_info <- unique(VarDescription[, colnames(VarDescription) %in% c("tab_desc", "module", "var", "var_desc")])

#Define functions with labels such as X, N, NNZ...etc and combine objects by rows. Return them out to finish function
get0 <- function(x){
  x <- as.numeric(as.character(x))
  N <- length(x)
  NNZ <- length(x[x>0])
  PZ <- (N-NNZ)/N
  out <- rbind(N=N, NNZ=NNZ, PZ=PZ)
  return(out)
}

#Drop >90% of the samples with get0 function. Combine columns and create data another data frame with PZ as label for dropped variables. Write to text file.
RBF_child_s3s4_200_cont_0 <- as.data.frame(t(sapply(RBF_child_s3s4_200_cont_final[, -1], get0)))
RBF_child_s3s4_200_cont_0 <- cbind(rownames(RBF_child_s3s4_200_cont_0), data.frame(RBF_child_s3s4_200_cont_0, row.names=NULL))
names(RBF_child_s3s4_200_cont_0) <- c("var", "N", "NNZ", "PZ")
RBF_child_s3s4_200_cont_full <- merge(RBF_child_s3s4_200_cont_0, desc_info, by="var")
RBF_child_s3s4_200_cont_full <- RBF_child_s3s4_200_cont_full[order(RBF_child_s3s4_200_cont_full$PZ, decreasing=TRUE), ]
write.table(RBF_child_s3s4_200_cont_full, file="RBF_children_percent_zero_values_series1-2.txt", sep="\t", quote=FALSE, row.names=FALSE)

RBF_adult_s3s4_200_cont_0 <- as.data.frame(t(sapply(RBF_adult_s3s4_200_cont_final[, -1], get0)))
RBF_adult_s3s4_200_cont_0 <- cbind(rownames(RBF_adult_s3s4_200_cont_0), data.frame(RBF_adult_s3s4_200_cont_0, row.names=NULL))
names(RBF_adult_s3s4_200_cont_0) <- c("var", "N", "NNZ", "PZ")
RBF_adult_s3s4_200_cont_full <- merge(RBF_adult_s3s4_200_cont_0, desc_info, by="var")
RBF_adult_s3s4_200_cont_full <- RBF_adult_s3s4_200_cont_full[order(RBF_adult_s3s4_200_cont_full$PZ, decreasing=TRUE), ]
write.table(RBF_adult_s3s4_200_cont_full, file="RBF_adult_percent_zero_values_series1-2.txt", sep="\t", quote=FALSE, row.names=FALSE)

#Remove PZ >= 0.90
RBF_child_pz <- RBF_child_s3s4_200_cont_full[RBF_child_s3s4_200_cont_full$PZ >= 0.9, 1, drop=FALSE]
RBF_adult_pz <- RBF_adult_s3s4_200_cont_full[RBF_adult_s3s4_200_cont_full$PZ >= 0.9, 1, drop=FALSE]

#Filter out the >= 0.90 samples from continuous file.
RBF_child_s3s4_200_final_pz <- clarite::colfilter(d=RBF_child_s3s4_200_cont_final, cols=RBF_child_pz, exclude = TRUE)
RBF_adult_s3s4_200_final_pz <- clarite::colfilter(d=RBF_adult_s3s4_200_cont_final, cols=RBF_adult_pz, exclude = TRUE)

##Make plot to visualize phenotype.
#If skewness is less than -1 or greater than 1, the distribution is highly skewed.
#If skewness is between -1 and -0.5 or between 0.5 and 1, the distribution is moderately skewed.
#If skewness is between -0.5 and 0.5, the distribution is approximately symmetric.

hist(RBF_child_s3s4_200_cont_final$LBXRBF, breaks = 100, main = "RBC folate (LBXRBF) for children", xlab = "LBXRBF")
hist(RBF_adult_s3s4_200_cont_final$LBXRBF, breaks = 100, main = "RBC folate (LBXRBF) for adults", xlab = "LBXRBF")

library (moments)
skewness(RBF_child_s3s4_200_cont_final$LBXRBF)
skewness(RBF_adult_s3s4_200_cont_final$LBXRBF)

transRBF_c <- log1p(RBF_child_s3s4_200_cont_final$LBXRBF)
hist(transRBF_c, breaks = 100, main = "Log transformed RBC folate (log LBXRBF) for children", xlab = "log LBXRBF")
skewness(transRBF_c)

transRBF_a <- log1p(RBF_adult_s3s4_200_cont_final$LBXRBF)
hist(transRBF_a, breaks = 100, main = "Log transformed RBC folate (log LBXRBF) for adults", xlab = "log LBXRBF")
skewness(transRBF_a)

#Log transform RBF and name log transform column logRBF
RBF_child_s3s4_200_final_pz$logLBXRBF <- log1p(RBF_child_s3s4_200_cont_final$LBXRBF)
RBF_child_s3s4_200_final_pz_log <- RBF_child_s3s4_200_final_pz

RBF_adult_s3s4_200_final_pz$logLBXRBF <- log1p(RBF_adult_s3s4_200_final_pz$LBXRBF)
RBF_adult_s3s4_200_final_pz_log <- RBF_adult_s3s4_200_final_pz

#Drop the RBF reading
drop_item_RBF_child <- c("LBDHDD", "LBDHDL", "LBDLDL", "LBXSTR", "LBXTC","LBXTR", "LBXSCH", "DR1TCHOL","house_type","house_age","hepa","hepb","current_past_smoking","CVDVOMAX", "CVDESVO2", "CVDS1HR", "CVDS1SY", "CVDS1DI", "CVDS2HR", "CVDS2SY", "CVDS2DI", "CVDR1HR", "CVDR1SY", "CVDR1DI", "CVDR2HR", "CVDR2SY", "CVDR2DI", "physical_activity","LBXRBF","LBXFOL")
drop_item_RBF_adult <- c("LBDHDD", "LBDHDL", "LBDLDL", "LBXSTR", "LBXTC","LBXTR", "LBXSCH", "DR1TCHOL","house_type","house_age","hepa","hepb","current_past_smoking","CVDVOMAX", "CVDESVO2", "CVDS1HR", "CVDS1SY", "CVDS1DI", "CVDS2HR", "CVDS2SY", "CVDS2DI", "CVDR1HR", "CVDR1SY", "CVDR1DI", "CVDR2HR", "CVDR2SY", "CVDR2DI", "physical_activity","LBXRBF","LBXFOL")
RBF_child_s3s4_200_final_pz_final <- clarite::colfilter(d=RBF_child_s3s4_200_final_pz_log, cols=drop_item_RBF_child, exclude = TRUE)
RBF_adult_s3s4_200_final_pz_final <- clarite::colfilter(d=RBF_adult_s3s4_200_final_pz_log, cols=drop_item_RBF_adult, exclude = TRUE)

#Merge categorical and binary files (data frames)
RBF_child_s3s4_200_cat_bin <- clarite::merge_data(RBF_child_s3s4_200_cat_final, RBF_child_s3s4_200_bin)
RBF_adult_s3s4_200_cat_bin <- clarite::merge_data(RBF_adult_s3s4_200_cat_final, RBF_adult_s3s4_200_bin)

#Drop variables <200 and rename file
RBF_child_cat_final_rep <- clarite::min_cat_n(RBF_child_s3s4_200_cat_bin, skip = skip_RBF)
RBF_child_cat_final_rep <- clarite::colfilter(d=RBF_child_cat_final_rep, cols=drop_item_RBF_child, exclude = TRUE)
RBF_adult_cat_final_rep <- clarite::min_cat_n(RBF_adult_s3s4_200_cat_bin, skip = skip_RBF)
RBF_adult_cat_final_rep <- clarite::colfilter(d=RBF_adult_cat_final_rep, cols=drop_item_RBF_adult, exclude = TRUE)

RBF_child_s3s4_200_final_pz_200 <- clarite::min_n(RBF_child_s3s4_200_final_pz_final)
RBF_adult_s3s4_200_final_pz_200 <- clarite::min_n(RBF_adult_s3s4_200_final_pz_final)
```

#EWAS Preparation Discovery Group
```{r include=FALSE}
#Children
##Dataframe
RBF_child_final_dis <- merge(RBF_child_cat_final,RBF_child_s1s2_200_final_pz_200)
RBF_child_final_rep <- merge(RBF_child_cat_final_rep,RBF_child_s3s4_200_final_pz_200)

pheno_RBF <- "logLBXRBF"
RBF_covars_c_cat <- c("female", "black", "mexican", "other_hispanic", "other_eth", "SES_LEVEL","SDDSRVYR")
RBF_covars_c_cont <- c("BMXBMI","RIDAGEYR", "FOLIC_ACID_mcg")

RBF_child_final_dis_list <-dput(names(RBF_child_final_dis))
RBF_child_final_rep_list <-dput(names(RBF_child_final_rep))
RBF_child_final_child_crosslist <- (intersect(RBF_child_final_dis_list,RBF_child_final_rep_list))
RBF_child_final_child_crosslist <- (intersect(RBF_child_final_child_crosslist,VarWeight$Variable))
RBF_child_final_child_crosslist_variables <- c("ID",RBF_child_final_child_crosslist,RBF_covars_c,pheno_RBF)

col.num.child.dis <- which(colnames(RBF_child_final_dis) %in% RBF_child_final_child_crosslist_variables)
RBF_child_final_dis <- RBF_child_final_dis[,col.num.child.dis]

RBF_child_final_child_discovery_final <- merge_data(RBF_child_final_dis, survey_design_discovery, union = FALSE)

##Co-variables
RBF_child_final_dis_cat_vars <- dput(names(RBF_child_cat_final))
RBF_child_final_dis_cat_vars <- RBF_child_final_dis_cat_vars[RBF_child_final_dis_cat_vars %in% RBF_child_final_child_crosslist]

RBF_child_final_dis_cont_vars <- dput(names(RBF_child_s1s2_200_final_pz_200))
RBF_child_final_dis_cont_vars <- RBF_child_final_dis_cont_vars[RBF_child_final_dis_cont_vars %in% RBF_child_final_child_crosslist]

#Adults
##Dataframe
RBF_adult_final_dis <- merge(RBF_adult_cat_final,RBF_adult_s1s2_200_final_pz_200)
RBF_adult_final_rep <- merge(RBF_adult_cat_final_rep,RBF_adult_s3s4_200_final_pz_200)

RBF_covars_a_cat <- c("female", "black", "mexican", "other_hispanic", "other_eth", "SES_LEVEL","SDDSRVYR")
RBF_covars_a_cont <- c("BMXBMI","RIDAGEYR", "FOLIC_ACID_mcg")

RBF_adult_final_dis_list <- dput(names(RBF_adult_final_dis))
RBF_adult_final_rep_list <- dput(names(RBF_adult_final_rep))
RBF_adult_final_adult_crosslist <- (intersect(RBF_adult_final_dis_list,RBF_adult_final_rep_list))
RBF_adult_final_adult_crosslist <- (intersect(RBF_adult_final_adult_crosslist,VarWeight$Variable))
RBF_adult_final_adult_crosslist_variables <- c("ID",RBF_adult_final_adult_crosslist,RBF_covars_a,pheno_RBF)

col.num.adult.dis <- which(colnames(RBF_adult_final_dis) %in% RBF_adult_final_adult_crosslist_variables)
RBF_adult_final_dis <- RBF_adult_final_dis[,col.num.adult.dis]

RBF_adult_final_adult_discovery_final <- merge_data(RBF_adult_final_dis, survey_design_discovery, union = FALSE)

##Variables
RBF_adult_final_dis_cat_vars <- dput(names(RBF_adult_cat_final))
RBF_adult_final_dis_cat_vars <- RBF_adult_final_dis_cat_vars[RBF_adult_final_dis_cat_vars %in% RBF_adult_final_adult_crosslist]

RBF_adult_final_dis_cont_vars <- dput(names(RBF_adult_s1s2_200_final_pz_200))
RBF_adult_final_dis_cont_vars <- RBF_adult_final_dis_cont_vars[RBF_adult_final_dis_cont_vars %in% RBF_adult_final_adult_crosslist]
```

#EWAS Discovery Group
```{r}
#Children EWAS
RBF_EWAS_Children_discovery_results <- ewas(d = RBF_child_final_child_discovery_final,
                          cat_vars=RBF_child_final_dis_cat_vars,
                          cont_vars=RBF_child_final_dis_cont_vars,
                          y=pheno_RBF,
                          cat_covars=RBF_covars_c_cat,
                          cont_covars=RBF_covars_c_cont,
                          regression_family="gaussian",
                          allowed_nonvarying=c("female", "SDDSRVYR"),
                          weights=weights_discovery,
                          ids="SDMVPSU",
                          strata="SDMVSTRA",
                          nest=TRUE,
                          drop_unweighted = TRUE)
write.table(RBF_EWAS_Children_discovery_results, file = "EWAS_RBF_Children_discovery_results.txt", row.names = F)

RBF_EWAS_Children_discovery_results_adj <- ewas_pval_adjust(RBF_EWAS_Children_discovery_results)
write.table(RBF_EWAS_Children_discovery_results_adj, file = "EWAS_RBF_Children_discovery_results_adj.txt", row.names = F)

#Adults EWAS
RBF_EWAS_adult_discovery_results <- ewas(d = RBF_adult_final_adult_discovery_final,
                          cat_vars=RBF_adult_final_dis_cat_vars,
                          cont_vars=RBF_adult_final_dis_cont_vars,
                          y=pheno_RBF,
                          cat_covars=RBF_covars_a_cat,
                          cont_covars=RBF_covars_a_cont,
                          regression_family="gaussian",
                          allowed_nonvarying=c("female", "SDDSRVYR"),
                          weights=weights_discovery,
                          ids="SDMVPSU",
                          strata="SDMVSTRA",
                          nest=TRUE,
                          drop_unweighted = TRUE)
write.table(RBF_EWAS_adult_discovery_results, file = "EWAS_RBF_adult_discovery_results.txt", row.names = F)

RBF_EWAS_adult_discovery_results_adj <- ewas_pval_adjust(RBF_EWAS_adult_discovery_results)
write.table(RBF_EWAS_adult_discovery_results_adj, file = "EWAS_RBF_adult_discovery_results_adj.txt", row.names = F)
```

#EWAS RBC Folate Preparation Replication Group
```{r include=FALSE}
#Adults
pvalue_fdr_rank_RBF_adult <- RBF_EWAS_adult_discovery_results_adj[order(RBF_EWAS_adult_discovery_results_adj$pvalue_FDR), ]
selected_variables_fdr_list_RBF_adult <- which(pvalue_fdr_rank_RBF_adult$pvalue_FDR < 0.1)
selected_variables_fdr_RBF_adult <- head(pvalue_fdr_rank_RBF_adult[,1],length(selected_variables_fdr_list_RBF_adult))

variables_fdr_RBF_adult <- c(paste(selected_variables_fdr_RBF_adult), RBF_covars_a, pheno_RBF)
all_variable_filtered_RBF_adult <- RBF_adult_final_rep
rep_variable_RBF_adult <- colfilter(d=all_variable_filtered_RBF_adult, cols = variables_fdr_RBF_adult, exclude = FALSE)

RBF_adult_final_adult_replication_final <- merge_data(rep_variable_RBF_adult, survey_design_replication, union = FALSE)

##Variables
RBF_adult_final_rep_cat_vars <- dput(names(RBF_adult_cat_final_rep))
RBF_adult_final_rep_cat_vars_finallist <- dput(names(RBF_adult_final_adult_replication_final))
RBF_adult_final_rep_cat_vars <- intersect(RBF_adult_final_rep_cat_vars,RBF_adult_final_rep_cat_vars_finallist)
RBF_adult_final_rep_cat_vars <- RBF_adult_final_rep_cat_vars[!RBF_adult_final_rep_cat_vars %in% c(RBF_covars_a, "ID")]

RBF_adult_final_rep_cont_vars <- dput(names(RBF_adult_s3s4_200_final_pz_200))
RBF_adult_final_rep_cont_vars_finallist <- dput(names(RBF_adult_final_adult_replication_final))
RBF_adult_final_rep_cont_vars <-RBF_adult_final_rep_cont_vars[RBF_adult_final_rep_cont_vars %in% RBF_adult_final_rep_cont_vars_finallist]
RBF_adult_final_rep_cont_vars <- RBF_adult_final_rep_cont_vars[!RBF_adult_final_rep_cont_vars %in% c(RBF_covars_a, "ID", pheno_RBF)]

#Children
pvalue_fdr_rank_RBF_child <- RBF_EWAS_Children_discovery_results_adj[order(RBF_EWAS_Children_discovery_results_adj$pvalue_FDR), ]
selected_variables_fdr_list_RBF_child <- which(pvalue_fdr_rank_RBF_child$pvalue_FDR < 0.1)
selected_variables_fdr_RBF_child <- head(pvalue_fdr_rank_RBF_child[,1],length(selected_variables_fdr_list_RBF_child))

variables_fdr_RBF_child <- c(paste(selected_variables_fdr_RBF_child), RBF_covars_c, pheno_RBF)
all_variable_filtered_RBF_child <- RBF_child_final_rep
rep_variable_RBF_child <- colfilter(d=all_variable_filtered_RBF_child, cols = variables_fdr_RBF_child, exclude = FALSE)

RBF_child_final_child_replication_final <- merge_data(rep_variable_RBF_child, survey_design_replication, union = FALSE)

##Variables
RBF_child_final_rep_cat_vars <- dput(names(RBF_child_cat_final_rep))
RBF_child_final_rep_cat_vars_finallist <- dput(names(RBF_child_final_child_replication_final))
RBF_child_final_rep_cat_vars <- intersect(RBF_child_final_rep_cat_vars,RBF_child_final_rep_cat_vars_finallist)
RBF_child_final_rep_cat_vars <- RBF_child_final_rep_cat_vars[!RBF_child_final_rep_cat_vars %in% c(RBF_covars_c, "ID")]

RBF_child_final_rep_cont_vars <- dput(names(RBF_child_s3s4_200_final_pz_200))
RBF_child_final_rep_cont_vars_finallist <- dput(names(RBF_child_final_child_replication_final))
RBF_child_final_rep_cont_vars <-RBF_child_final_rep_cont_vars[RBF_child_final_rep_cont_vars %in% RBF_child_final_rep_cont_vars_finallist]
RBF_child_final_rep_cont_vars <- RBF_child_final_rep_cont_vars[!RBF_child_final_rep_cont_vars %in% c(RBF_covars_c, "ID", pheno_RBF)]
```

#EWAS RBC Folate Replication Group
```{r}
# Adults
RBF_EWAS_adult_replication_results <- ewas(d = RBF_adult_final_adult_replication_final,
                            cat_vars=RBF_adult_final_rep_cat_vars,
                            cont_vars=RBF_adult_final_rep_cont_vars,
                            y=pheno_RBF,
                            cat_covars=RBF_covars_a_cat,
                            cont_covars=RBF_covars_a_cont,
                            regression_family="gaussian",
                            allowed_nonvarying=c("female", "SDDSRVYR"),
                            weights=weights_replication,
                            ids="SDMVPSU",
                            strata="SDMVSTRA",
                            nest=TRUE,
                            drop_unweighted = TRUE)
write.table(RBF_EWAS_adult_replication_results, file = "EWAS_RBF_adult_replication_results.txt", row.names = F)


RBF_EWAS_adult_replication_results_adj <- ewas_pval_adjust(RBF_EWAS_adult_replication_results)
write.table(RBF_EWAS_adult_replication_results_adj, file = "EWAS_RBF_adult_replication_results_adj.txt", row.names = F)

# Children
RBF_EWAS_Children_replication_results <- ewas(d = RBF_child_final_child_replication_final,
                            cat_vars=RBF_child_final_rep_cat_vars,
                            cont_vars=RBF_child_final_rep_cont_vars,
                            y=pheno_RBF,
                            cat_covars=RBF_covars_c_cat,
                            cont_covars=RBF_covars_c_cont,
                            regression_family="gaussian",
                            allowed_nonvarying=c("female", "SDDSRVYR"),
                            weights=weights_replication,
                            ids="SDMVPSU",
                            strata="SDMVSTRA",
                            nest=TRUE,
                            drop_unweighted = TRUE)
write.table(RBF_EWAS_Children_replication_results, file = "EWAS_RBF_Children_replication_results.txt", row.names = F)


RBF_EWAS_Children_replication_results_adj <- ewas_pval_adjust(RBF_EWAS_Children_replication_results)
write.table(RBF_EWAS_Children_replication_results_adj, file = "EWAS_RBF_Children_replication_results_adj.txt", row.names = F)
```

#EWAS RBC Folate Manhattan Plot
```{r}
#Adults
##Extract the variables and p-values
ewas_RBF_adult_dis_crt <- RBF_EWAS_adult_discovery_results_adj[,c(1,14)]
ewas_RBF_adult_rep_crt <- RBF_EWAS_adult_replication_results_adj[,c(1,13)]

##Add group
ewas_RBF_adult_dis_crt$Shape <- rep("Discovery", nrow(ewas_RBF_adult_dis_crt))
ewas_RBF_adult_rep_crt$Shape <- rep("Replication", nrow(ewas_RBF_adult_rep_crt))
colnames(ewas_RBF_adult_dis_crt)[2] <- "pvalue"
colnames(ewas_RBF_adult_rep_crt)[2] <- "pvalue"

##Combine groups
ewas_RBF_adult_all_crt <- rbind(ewas_RBF_adult_dis_crt,ewas_RBF_adult_rep_crt)
colnames(ewas_RBF_adult_all_crt)[1] <- "Variable"
colnames(ewas_RBF_adult_all_crt)[2] <- "pvalue"
ewas_RBF_adult_all_crt$pvalue = as.numeric(ewas_RBF_adult_all_crt$pvalue)

##Manhattan Plot
VarCat_nopf <- read.delim("/Users/Nicen/Desktop/Anemia/Data/VarCat_nopf.txt")

RBF_ewas_mplot_adult <- eman(ewas_RBF_adult_all_crt, ewas = FALSE, groups = VarCat_nopf, file = "M-Plot RBC Folate Adults", morecolors = FALSE, hgt = 7, wi = 12, res = 300)

ggsave(file = "M-Plot RBC Folate Adults.png", plot = RBF_ewas_mplot_adult, device = "png",path = "/Users/Nicen/Desktop/Anemia/Figures/Original Figures", width = 12, height = 7, dpi = 300)

#Children
##Extract the variables and p-values
ewas_RBF_child_dis_crt <- RBF_EWAS_Children_discovery_results_adj[,c(1,14)]
ewas_RBF_child_rep_crt <- RBF_EWAS_Children_replication_results_adj[,c(1,13)]

##Add group
ewas_RBF_child_dis_crt$Shape <- rep("Discovery", nrow(ewas_RBF_child_dis_crt))
ewas_RBF_child_rep_crt$Shape <- rep("Replication", nrow(ewas_RBF_child_rep_crt))
colnames(ewas_RBF_child_dis_crt)[2] <- "pvalue"
colnames(ewas_RBF_child_rep_crt)[2] <- "pvalue"

##Combine groups
ewas_RBF_child_all_crt <- rbind(ewas_RBF_child_dis_crt,ewas_RBF_child_rep_crt)
colnames(ewas_RBF_child_all_crt)[1] <- "Variable"
colnames(ewas_RBF_child_all_crt)[2] <- "pvalue"
ewas_RBF_child_all_crt$pvalue = as.numeric(ewas_RBF_child_all_crt$pvalue)

##Manhattan Plot
VarCat_nopf <- read.delim("/Users/Nicen/Desktop/Anemia/Data/VarCat_nopf.txt")
RBF_ewas_mplot_child <- eman(ewas_RBF_child_all_crt, ewas = FALSE, groups = VarCat_nopf, file = "M-Plot RBC Folate Children", morecolors = FALSE, hgt = 7, wi = 12, res = 300)
  
ggsave(file = "M-Plot RBC Folate Children.png", plot = RBF_ewas_mplot_child, device = "png",path = "/Users/Nicen/Desktop/Anemia/Figures/Original Figures", width = 12, height = 7, dpi = 300)
```

#Iron
##Discovery Group Quality Control
```{r}
MainTable_keepvar_over18 <- read.delim("~/Desktop/Anemia/Data/MainTable_keepvar_over18.tsv")
keepvar <- dput(names(MainTable_keepvar_over18))
keepvar_iron <- c(paste(keepvar),"LBXSIR","SDDSRVYR")
MainTable_keepvar_iron <- clarite::colfilter(d=Main_table, cols=keepvar_iron, exclude=F)

colnames(MainTable_keepvar_iron)[1] <- "ID"
Children <- MainTable_keepvar_iron[MainTable_keepvar_iron$RIDAGEYR < 15,]
Adults <- MainTable_keepvar_iron[MainTable_keepvar_iron$RIDAGEYR >= 15,]

##Filter complete.cases for each pheno + covars
IRN_covars_a <- c("female", "black", "mexican", "other_hispanic", "other_eth", "BMXBMI", "SES_LEVEL", "RIDAGEYR","SDDSRVYR")
IRN_covars_c <- c("female", "black", "mexican", "other_hispanic", "other_eth", "BMXBMI", "SES_LEVEL", "RIDAGEYR","SDDSRVYR")
pheno_IRN_a <- c("LBXSIR")
pheno_IRN_c <- c("LBXIRN")
pheno_IRN_cc <- c("LBXIRN_SIR")

Children$LBXIRN_SIR <- ifelse(!is.na(Children$LBXIRN),Children$LBXIRN,Children$LBXSIR)

IRN_childid <- na.omit(clarite::colfilter(Children, cols=c(IRN_covars_c, pheno_IRN_c)))[, 1, drop=FALSE]
IRN_child <- clarite::merge_data(IRN_childid, Children, union = FALSE)

IRN_childidcc <- na.omit(clarite::colfilter(Children, cols=c(IRN_covars_c, pheno_IRN_cc)))[, 1, drop=FALSE]
IRN_childcc <- clarite::merge_data(IRN_childidcc, Children, union = FALSE)

IRN_adultid <- na.omit(clarite::colfilter(Adults, cols=c(IRN_covars_a, pheno_IRN_a)))[, 1, drop=FALSE]
IRN_adult <- clarite::merge_data(IRN_adultid, Adults, union = FALSE)

##Filter by series 1&2
IRN_child_s1s2 <- IRN_child[IRN_child$SDDSRVYR==2 | IRN_child$SDDSRVYR==1, ]
IRN_child_s1s2cc <- IRN_childcc[IRN_childcc$SDDSRVYR==2 | IRN_childcc$SDDSRVYR==1, ]
IRN_adult_s1s2 <- IRN_adult[IRN_adult$SDDSRVYR==2 | IRN_adult$SDDSRVYR==1, ]

##Split into data type
#Get binary varibales into a separate file
IRN_child_s1s2_200_bin <- clarite::get_binary(IRN_child_s1s2)
IRN_child_s1s2_200_bincc <- clarite::get_binary(IRN_child_s1s2cc)
IRN_adult_s1s2_200_bin <- clarite::get_binary(IRN_adult_s1s2)

#Get categorical variables into a separate file
IRN_child_s1s2_200_cat <- clarite::get_categorical(IRN_child_s1s2)
IRN_child_s1s2_200_catcc <- clarite::get_categorical(IRN_child_s1s2cc)
IRN_adult_s1s2_200_cat <- clarite::get_categorical(IRN_adult_s1s2)

#Changes values 7 and 9 using a pipeline format to NA. Cannot decipher meaning of values so make NA.
IRN_adult_s1s2_200_cat$SMQ077 <- ifelse(IRN_adult_s1s2_200_cat$SMQ077==7 | IRN_adult_s1s2_200_cat$SMQ077==9, NA, IRN_adult_s1s2_200_cat$SMQ077)

#Get continuous variables into a separate file
IRN_child_s1s2_200_cont <- clarite::get_continuous(IRN_child_s1s2)
IRN_child_s1s2_200_contcc <- clarite::get_continuous(IRN_child_s1s2cc)
IRN_adult_s1s2_200_cont <- clarite::get_continuous(IRN_adult_s1s2)

#Get ambiguous variables into a separate file
IRN_child_s1s2_200_check <- clarite::get_check(IRN_child_s1s2)
IRN_child_s1s2_200_checkcc <- clarite::get_check(IRN_child_s1s2cc)
IRN_adult_s1s2_200_check <- clarite::get_check(IRN_adult_s1s2)

#Make vectors and label to remove or merge varibales to appropriate files
child_cont_merge <- c("RIDAGEYR", "LBXIHG", "URXUBE", "URXUPT", "LBXTO3",
"DRD350BQ", "DRD350HQ", "DRD370AQ", "DRD370BQ", "DRD370DQ", "DRD370MQ", 
"DRD370TQ", "DRD370UQ", "supplement_count", "DSDCOUNT", "LBX194", 
"LBX196", "LBD199", "LBXDIE")
child_cat_merge <- c("house_age")

child_cont_mergecc <- c("RIDAGEYR", "LBXIHG", "URXUBE", "URXUPT", "LBXTO3",
"DRD350BQ", "DRD350HQ", "DRD370AQ", "DRD370BQ", "DRD370DQ", "DRD370MQ", 
"DRD370TQ", "DRD370UQ", "supplement_count", "DSDCOUNT", "LBX194", 
"LBX196", "LBD199", "LBXDIE")
child_cat_mergecc <- c("house_age")

adult_cont_merge <- c("URXUBE", "URXUPT", "LBXTO3", "DUQ130", 
"DRD350BQ", "DRD350FQ", "DRD350IQ", "DRD370AQ", "DRD370DQ", "DRD370EQ", 
"DRD370FQ", "DRD370IQ", "DRD370KQ", "DRD370NQ", "DRD370UQ", "OMEGA_3_FATTY_ACIDS_mg", 
"ALANINE_mg", "ARGININE_mg", "BETA_CAROTENE_IU", "BETA_CAROTENE_mg", 
"CAFFEINE_mg", "CYSTINE_mg", "PROLINE_mg", "SERINE_mg", "TRYPTOPHAN_mg", 
"TYROSINE_mg", "LBDSY3", "OTHER_FATTY_ACIDS_mg")
adult_cat_merge <- c("house_age")

#Remove columns and rename data frame then merge data from ambiguous file into continuous file
IRN_child_s1s2_200_contmerged <- clarite::merge_data(IRN_child_s1s2_200_cont, IRN_child_s1s2_200_check, union=TRUE)
IRN_child_s1s2_200_cont_final <- clarite::colfilter(d=IRN_child_s1s2_200_contmerged, cols=child_cat_merge, exclude=T)

IRN_child_s1s2_200_contmergedcc <- clarite::merge_data(IRN_child_s1s2_200_contcc, IRN_child_s1s2_200_checkcc, union=TRUE)
IRN_child_s1s2_200_cont_finalcc <- clarite::colfilter(d=IRN_child_s1s2_200_contmergedcc, cols=child_cat_mergecc, exclude=T)

IRN_adult_s1s2_200_contmerged <- clarite::merge_data(IRN_adult_s1s2_200_cont, IRN_adult_s1s2_200_check, union=TRUE)
IRN_adult_s1s2_200_cont_final <- clarite::colfilter(d=IRN_adult_s1s2_200_contmerged, cols=adult_cat_merge, exclude=T)

IRN_child_s1s2_200_catmerged <- clarite::merge_data(IRN_child_s1s2_200_cat, IRN_child_s1s2_200_check, union=TRUE)
IRN_child_s1s2_200_cat_final <- clarite::colfilter(d=IRN_child_s1s2_200_catmerged, cols=child_cont_merge, exclude=T)

IRN_child_s1s2_200_catmergedcc <- clarite::merge_data(IRN_child_s1s2_200_catcc, IRN_child_s1s2_200_checkcc, union=TRUE)
IRN_child_s1s2_200_cat_finalcc <- clarite::colfilter(d=IRN_child_s1s2_200_catmergedcc, cols=child_cont_mergecc, exclude=T)

IRN_adult_s1s2_200_catmerged <- clarite::merge_data(IRN_adult_s1s2_200_cat, IRN_adult_s1s2_200_check, union=TRUE)
IRN_adult_s1s2_200_cat_final <- clarite::colfilter(d=IRN_adult_s1s2_200_catmerged, cols=adult_cont_merge, exclude=T)

#Some categorical have 77, 99 as "Don't Know" so replace with missing in variables that would not otherwise be dropped
IRN_child_s1s2_200_cat_final$house_age <- ifelse(IRN_child_s1s2_200_cat_final$house_age==77 | IRN_child_s1s2_200_cat_final$house_age==99, NA, IRN_child_s1s2_200_cat_final$house_age)
IRN_child_s1s2_200_cat_finalcc$house_age <- ifelse(IRN_child_s1s2_200_cat_finalcc$house_age==77 | IRN_child_s1s2_200_cat_finalcc$house_age==99, NA, IRN_child_s1s2_200_cat_finalcc$house_age)
IRN_adult_s1s2_200_cat_final$house_age <- ifelse(IRN_adult_s1s2_200_cat_final$house_age==77 | IRN_adult_s1s2_200_cat_final$house_age==99, NA, IRN_adult_s1s2_200_cat_final$house_age)

#Extract unique values and return vector from columns in data dictionary
desc_info <- unique(VarDescription[, colnames(VarDescription) %in% c("tab_desc", "module", "var", "var_desc")])

#Define functions with labels such as X, N, NNZ...etc and combine objects by rows. Return them out to finish function
get0 <- function(x){
  x <- as.numeric(as.character(x))
  N <- length(x)
  NNZ <- length(x[x>0])
  PZ <- (N-NNZ)/N
  out <- rbind(N=N, NNZ=NNZ, PZ=PZ)
  return(out)
}

#Drop >90% of the samples with get0 function. Combine columns and create data another data frame with PZ as label for dropped variables. Write to text file.
IRN_child_s1s2_200_cont_0 <- as.data.frame(t(sapply(IRN_child_s1s2_200_cont_final[, -1], get0)))
IRN_child_s1s2_200_cont_0 <- cbind(rownames(IRN_child_s1s2_200_cont_0), data.frame(IRN_child_s1s2_200_cont_0, row.names=NULL))
names(IRN_child_s1s2_200_cont_0) <- c("var", "N", "NNZ", "PZ")
IRN_child_s1s2_200_cont_full <- merge(IRN_child_s1s2_200_cont_0, desc_info, by="var")
IRN_child_s1s2_200_cont_full <- IRN_child_s1s2_200_cont_full[order(IRN_child_s1s2_200_cont_full$PZ, decreasing=TRUE), ]
write.table(IRN_child_s1s2_200_cont_full, file="IRN_children_percent_zero_values_series1-2.txt", sep="\t", quote=FALSE, row.names=FALSE)

IRN_child_s1s2_200_cont_0cc <- as.data.frame(t(sapply(IRN_child_s1s2_200_cont_finalcc[, -1], get0)))
IRN_child_s1s2_200_cont_0cc <- cbind(rownames(IRN_child_s1s2_200_cont_0cc), data.frame(IRN_child_s1s2_200_cont_0cc, row.names=NULL))
names(IRN_child_s1s2_200_cont_0cc) <- c("var", "N", "NNZ", "PZ")
IRN_child_s1s2_200_cont_fullcc <- merge(IRN_child_s1s2_200_cont_0cc, desc_info, by="var")
IRN_child_s1s2_200_cont_fullcc <- IRN_child_s1s2_200_cont_fullcc[order(IRN_child_s1s2_200_cont_fullcc$PZ, decreasing=TRUE), ]
write.table(IRN_child_s1s2_200_cont_fullcc, file="IRN_children_percent_zero_values_series1-2cc.txt", sep="\t", quote=FALSE, row.names=FALSE)

IRN_adult_s1s2_200_cont_0 <- as.data.frame(t(sapply(IRN_adult_s1s2_200_cont_final[, -1], get0)))
IRN_adult_s1s2_200_cont_0 <- cbind(rownames(IRN_adult_s1s2_200_cont_0), data.frame(IRN_adult_s1s2_200_cont_0, row.names=NULL))
names(IRN_adult_s1s2_200_cont_0) <- c("var", "N", "NNZ", "PZ")
IRN_adult_s1s2_200_cont_full <- merge(IRN_adult_s1s2_200_cont_0, desc_info, by="var")
IRN_adult_s1s2_200_cont_full <- IRN_adult_s1s2_200_cont_full[order(IRN_adult_s1s2_200_cont_full$PZ, decreasing=TRUE), ]
write.table(IRN_adult_s1s2_200_cont_full, file="IRN_adult_percent_zero_values_series1-2.txt", sep="\t", quote=FALSE, row.names=FALSE)

#Remove PZ >= 0.90
IRN_child_pz <- IRN_child_s1s2_200_cont_full[IRN_child_s1s2_200_cont_full$PZ >= 0.9, 1, drop=FALSE]
IRN_child_pzcc <- IRN_child_s1s2_200_cont_fullcc[IRN_child_s1s2_200_cont_fullcc$PZ >= 0.9, 1, drop=FALSE]
IRN_adult_pz <- IRN_adult_s1s2_200_cont_full[IRN_adult_s1s2_200_cont_full$PZ >= 0.9, 1, drop=FALSE]

#Filter out the >= 0.90 samples from continuous file.
IRN_child_s1s2_200_final_pz <- clarite::colfilter(d=IRN_child_s1s2_200_cont_final, cols=IRN_child_pz, exclude = TRUE)
IRN_child_s1s2_200_final_pzcc <- clarite::colfilter(d=IRN_child_s1s2_200_cont_finalcc, cols=IRN_child_pzcc, exclude = TRUE)
IRN_adult_s1s2_200_final_pz <- clarite::colfilter(d=IRN_adult_s1s2_200_cont_final, cols=IRN_adult_pz, exclude = TRUE)

##Make plot to visualize phenotype.
#If skewness is less than -1 or greater than 1, the distribution is highly skewed.
#If skewness is between -1 and -0.5 or between 0.5 and 1, the distribution is moderately skewed.
#If skewness is between -0.5 and 0.5, the distribution is approximately symmetric.

hist(IRN_child_s1s2_200_cont_final$LBXIRN, breaks = 100, main = "Iron (LBXIRN) for children", xlab = "LBXIRN")
hist(IRN_child_s1s2_200_cont_finalcc$LBXIRN_SIR, breaks = 100, main = "Iron (LBXIRN_SIR) for children", xlab = "LBXIRN_SIR")
hist(IRN_adult_s1s2_200_cont_final$LBXSIR, breaks = 100, main = "Iron (LBXSIR) for adults", xlab = "LBXSIR")

library (moments)
skewness(IRN_child_s1s2_200_cont_final$LBXIRN)
skewness(IRN_child_s1s2_200_cont_finalcc$LBXIRN_SIR)
skewness(IRN_adult_s1s2_200_cont_final$LBXSIR)

transIRN_c <- log1p(IRN_child_s1s2_200_cont_final$LBXIRN)
hist(transIRN_c, breaks = 100, main = "Log transformed Iron (log LBXIRN) for children", xlab = "log LBXIRN")
skewness(transIRN_c)

transIRN_cc <- log1p(IRN_child_s1s2_200_cont_finalcc$LBXIRN_SIR)
hist(transIRN_cc, breaks = 100, main = "Log transformed Iron (log LBXIRN_SIR) for children", xlab = "log LBXIRN_SIR")
skewness(transIRN_cc)

transIRN_a <- log1p(IRN_adult_s1s2_200_cont_final$LBXSIR)
hist(transIRN_a, breaks = 100, main = "Log transformed Iron (log LBXSIR) for adults", xlab = "log LBXSIR")
skewness(transIRN_a)

#Log transform RBF and name log transform column logRBF
IRN_child_s1s2_200_final_pz$logLBXIRN <- log1p(IRN_child_s1s2_200_cont_final$LBXIRN)
IRN_child_s1s2_200_final_pz_log <- IRN_child_s1s2_200_final_pz

IRN_child_s1s2_200_final_pzcc$logLBXIRN_SIR <- log1p(IRN_child_s1s2_200_cont_finalcc$LBXIRN_SIR)
IRN_child_s1s2_200_final_pz_logcc <- IRN_child_s1s2_200_final_pzcc

IRN_adult_s1s2_200_final_pz$logLBXSIR <- log1p(IRN_adult_s1s2_200_final_pz$LBXSIR)
IRN_adult_s1s2_200_final_pz_log <- IRN_adult_s1s2_200_final_pz

#Drop the RBF reading
drop_item_IRN_child <- c("LBDHDD", "LBDHDL", "LBDLDL", "LBXSTR", "LBXTC","LBXTR", "LBXSCH", "DR1TCHOL","house_type","house_age","hepa","hepb","current_past_smoking","CVDVOMAX", "CVDESVO2", "CVDS1HR", "CVDS1SY", "CVDS1DI", "CVDS2HR", "CVDS2SY", "CVDS2DI", "CVDR1HR", "CVDR1SY", "CVDR1DI", "CVDR2HR", "CVDR2SY", "CVDR2DI", "physical_activity","LBXSIR","LBXFOL","LBXIRN_SIR")
drop_item_IRN_childcc <- c("LBDHDD", "LBDHDL", "LBDLDL", "LBXSTR", "LBXTC","LBXTR", "LBXSCH", "DR1TCHOL","house_type","house_age","hepa","hepb","current_past_smoking","CVDVOMAX", "CVDESVO2", "CVDS1HR", "CVDS1SY", "CVDS1DI", "CVDS2HR", "CVDS2SY", "CVDS2DI", "CVDR1HR", "CVDR1SY", "CVDR1DI", "CVDR2HR", "CVDR2SY", "CVDR2DI", "physical_activity","LBXSIR","LBXIRN","LBXFOL")
drop_item_IRN_adult <- c("LBDHDD", "LBDHDL", "LBDLDL", "LBXSTR", "LBXTC","LBXTR", "LBXSCH", "DR1TCHOL","house_type","house_age","hepa","hepb","current_past_smoking","CVDVOMAX", "CVDESVO2", "CVDS1HR", "CVDS1SY", "CVDS1DI", "CVDS2HR", "CVDS2SY", "CVDS2DI", "CVDR1HR", "CVDR1SY", "CVDR1DI", "CVDR2HR", "CVDR2SY", "CVDR2DI", "physical_activity","LBXIRN","LBXFOL","LBXIRN_SIR")
IRN_child_s1s2_200_final_pz_final <- clarite::colfilter(d=IRN_child_s1s2_200_final_pz_log, cols=drop_item_IRN_child, exclude = TRUE)
IRN_child_s1s2_200_final_pz_finalcc <- clarite::colfilter(d=IRN_child_s1s2_200_final_pz_logcc, cols=drop_item_IRN_childcc, exclude = TRUE)
IRN_adult_s1s2_200_final_pz_final <- clarite::colfilter(d=IRN_adult_s1s2_200_final_pz_log, cols=drop_item_IRN_adult, exclude = TRUE)

#Merge categorical and binary files (data frames)
IRN_child_s1s2_200_cat_bin <- clarite::merge_data(IRN_child_s1s2_200_cat_final, IRN_child_s1s2_200_bin)
IRN_child_s1s2_200_cat_bincc <- clarite::merge_data(IRN_child_s1s2_200_cat_finalcc, IRN_child_s1s2_200_bincc)
IRN_adult_s1s2_200_cat_bin <- clarite::merge_data(IRN_adult_s1s2_200_cat_final, IRN_adult_s1s2_200_bin)

#Drop variables <200 and rename file
skip_RBF <- IRN_covars_a[!IRN_covars_a %in% c("BMXBMI","RIDAGEYR")]
IRN_child_cat_final <- clarite::min_cat_n(IRN_child_s1s2_200_cat_bin, skip = skip_RBF)
IRN_child_cat_final <- clarite::colfilter(d=IRN_child_cat_final, cols=drop_item_IRN_child, exclude = TRUE)

IRN_child_cat_finalcc <- clarite::min_cat_n(IRN_child_s1s2_200_cat_bincc, skip = skip_RBF)
IRN_child_cat_finalcc <- clarite::colfilter(d=IRN_child_cat_finalcc, cols=drop_item_IRN_childcc, exclude = TRUE)

IRN_adult_cat_final <- clarite::min_cat_n(IRN_adult_s1s2_200_cat_bin, skip = skip_RBF)
IRN_adult_cat_final <- clarite::colfilter(d=IRN_adult_cat_final, cols=drop_item_IRN_adult, exclude = TRUE)

IRN_child_s1s2_200_final_pz_200 <- clarite::min_n(IRN_child_s1s2_200_final_pz_final)
IRN_child_s1s2_200_final_pz_200cc <- clarite::min_n(IRN_child_s1s2_200_final_pz_finalcc)
IRN_adult_s1s2_200_final_pz_200 <- clarite::min_n(IRN_adult_s1s2_200_final_pz_final)
```

##Replication Group Quality Control
```{r}
##Filter by series 3&4
IRN_child_s3s4 <- IRN_child[IRN_child$SDDSRVYR==3 | IRN_child$SDDSRVYR==4, ]
IRN_child_s3s4cc <- IRN_child[IRN_child$SDDSRVYR==3 | IRN_child$SDDSRVYR==4, ]
IRN_adult_s3s4 <- IRN_adult[IRN_adult$SDDSRVYR==3 | IRN_adult$SDDSRVYR==4, ]


##Split into data type
#Get binary varibales into a separate file
IRN_child_s3s4_200_bin <- clarite::get_binary(IRN_child_s3s4)
IRN_child_s3s4_200_bincc <- clarite::get_binary(IRN_child_s3s4cc)
IRN_adult_s3s4_200_bin <- clarite::get_binary(IRN_adult_s3s4)

#Get categorical variables into a separate file
IRN_child_s3s4_200_cat <- clarite::get_categorical(IRN_child_s3s4)
IRN_child_s3s4_200_catcc <- clarite::get_categorical(IRN_child_s3s4cc)
IRN_adult_s3s4_200_cat <- clarite::get_categorical(IRN_adult_s3s4)

#Changes values 7 and 9 using a pipeline format to NA. Cannot decipher meaning of values so make NA.
IRN_adult_s3s4_200_cat$SMQ077 <- ifelse(IRN_adult_s3s4_200_cat$SMQ077==7 | IRN_adult_s3s4_200_cat$SMQ077==9, NA, IRN_adult_s3s4_200_cat$SMQ077)

#Get continuous variables into a separate file
IRN_child_s3s4_200_cont <- clarite::get_continuous(IRN_child_s3s4)
IRN_child_s3s4_200_contcc <- clarite::get_continuous(IRN_child_s3s4cc)
IRN_adult_s3s4_200_cont <- clarite::get_continuous(IRN_adult_s3s4)

#Get ambiguous variables into a separate file
IRN_child_s3s4_200_check <- clarite::get_check(IRN_child_s3s4)
IRN_child_s3s4_200_checkcc <- clarite::get_check(IRN_child_s3s4cc)
IRN_adult_s3s4_200_check <- clarite::get_check(IRN_adult_s3s4)

#Make vectors and label to remove or merge varibales to appropriate files
child_cont_merge <- c("LBXWME", "LBXV4C", "URXUPT", "LBXTO1", "LBXEPAH", "LBXPFDE", 
"LBXPFHP", "LBXPFSA", "LBXPFUA", "URXMCP", "URXOP6", "URXP08", 
"URXP11", "URXP14", "URXP15", "URXP16", "URX1TB", 
"DR1TALCO", "DRD350HQ", "DRD370AQ", "DRD370BQ", "DRD370DQ", "DRD370MQ", 
"DRD370TQ", "URXUAS3", "URXUAS5", "LBX189", "LBXBR1", "URXP22", 
"LBXE72")
child_cat_merge <- c("house_age")

child_cont_mergecc <- c("LBXWME", "LBXV4C", "URXUPT", "LBXTO1", "LBXEPAH", "LBXPFDE", 
"LBXPFHP", "LBXPFSA", "LBXPFUA", "URXMCP", "URXOP6", "URXP08", 
"URXP11", "URXP14", "URXP15", "URXP16", "URX1TB", 
"DR1TALCO", "DRD350HQ", "DRD370AQ", "DRD370BQ", "DRD370DQ", "DRD370MQ", 
"DRD370TQ", "URXUAS3", "URXUAS5", "LBX189", "LBXBR1", "URXP22", 
"LBXE72")
child_cat_mergecc <- c("house_age")

adult_cont_merge <- c("LBXVCT", "LBXV3A", "URXUBE", "LBXTO2", "LBXPFDO",
"RHQ598", "how_long_estrogen_progestin_patch", "DRD350AQ", "DRD350BQ", 
"DRD350CQ", "DRD350DQ", "DRD350EQ", "DRD350FQ", "DRD350GQ", "DRD350HQ", 
"DRD350IQ", "DRD370AQ", "DRD370CQ", "DRD370DQ", "DRD370EQ", "DRD370FQ", 
"DRD370GQ", "DRD370HQ", "DRD370IQ", "DRD370KQ", "DRD370NQ", "DRD370RQ", 
"DRD370SQ", "DRD370UQ", "ALANINE_mg", "ARGININE_mg", "BETA_CAROTENE_mg", 
"CAFFEINE_mg", "CYSTINE_mg", "HISTIDINE_mg", "ISOLEUCINE_mg", 
"LEUCINE_mg", "LYSINE_mg", "PHENYLALANINE_mg", "PROLINE_mg", 
"SERINE_mg", "THREONINE_mg", "TRYPTOPHAN_mg", "TYROSINE_mg", 
"VALINE_mg", "LBXV2T", "LBXV4T", "LBXVDM", "URXUTM", "LBXPFBS", 
"DUQ280", "DUQ360")
adult_cat_merge <- c("house_age")

#Remove columns and rename data frame then merge data from ambiguous file into continuous file
IRN_child_s3s4_200_contmerged <- clarite::merge_data(IRN_child_s3s4_200_cont, IRN_child_s3s4_200_check, union=TRUE)
IRN_child_s3s4_200_cont_final <- clarite::colfilter(d=IRN_child_s3s4_200_contmerged, cols=child_cat_merge, exclude=T)

IRN_child_s3s4_200_contmergedcc <- clarite::merge_data(IRN_child_s3s4_200_contcc, IRN_child_s3s4_200_checkcc, union=TRUE)
IRN_child_s3s4_200_cont_finalcc <- clarite::colfilter(d=IRN_child_s3s4_200_contmergedcc, cols=child_cat_mergecc, exclude=T)

IRN_adult_s3s4_200_contmerged <- clarite::merge_data(IRN_adult_s3s4_200_cont, IRN_adult_s3s4_200_check, union=TRUE)
IRN_adult_s3s4_200_cont_final <- clarite::colfilter(d=IRN_adult_s3s4_200_contmerged, cols=adult_cat_merge, exclude=T)

IRN_child_s3s4_200_catmerged <- clarite::merge_data(IRN_child_s3s4_200_cat, IRN_child_s3s4_200_check, union=TRUE)
IRN_child_s3s4_200_cat_final <- clarite::colfilter(d=IRN_child_s3s4_200_catmerged, cols=child_cont_merge, exclude=T)

IRN_child_s3s4_200_catmergedcc <- clarite::merge_data(IRN_child_s3s4_200_catcc, IRN_child_s3s4_200_checkcc, union=TRUE)
IRN_child_s3s4_200_cat_finalcc <- clarite::colfilter(d=IRN_child_s3s4_200_catmergedcc, cols=child_cont_mergecc, exclude=T)

IRN_adult_s3s4_200_catmerged <- clarite::merge_data(IRN_adult_s3s4_200_cat, IRN_adult_s3s4_200_check, union=TRUE)
IRN_adult_s3s4_200_cat_final <- clarite::colfilter(d=IRN_adult_s3s4_200_catmerged, cols=adult_cont_merge, exclude=T)

#Some categorical have 77, 99 as "Don't Know" so replace with missing in variables that would not otherwise be dropped
IRN_child_s3s4_200_cat_final$house_age <- ifelse(IRN_child_s3s4_200_cat_final$house_age==77 | IRN_child_s3s4_200_cat_final$house_age==99, NA, IRN_child_s3s4_200_cat_final$house_age)
IRN_child_s3s4_200_cat_finalcc$house_age <- ifelse(IRN_child_s3s4_200_cat_finalcc$house_age==77 | IRN_child_s3s4_200_cat_finalcc$house_age==99, NA, IRN_child_s3s4_200_cat_finalcc$house_age)
IRN_adult_s3s4_200_cat_final$house_age <- ifelse(IRN_adult_s3s4_200_cat_final$house_age==77 | IRN_adult_s3s4_200_cat_final$house_age==99, NA, IRN_adult_s3s4_200_cat_final$house_age)

#Extract unique values and return vector from columns in data dictionary
desc_info <- unique(VarDescription[, colnames(VarDescription) %in% c("tab_desc", "module", "var", "var_desc")])

#Define functions with labels such as X, N, NNZ...etc and combine objects by rows. Return them out to finish function
get0 <- function(x){
  x <- as.numeric(as.character(x))
  N <- length(x)
  NNZ <- length(x[x>0])
  PZ <- (N-NNZ)/N
  out <- rbind(N=N, NNZ=NNZ, PZ=PZ)
  return(out)
}

#Drop >90% of the samples with get0 function. Combine columns and create data another data frame with PZ as label for dropped variables. Write to text file.
IRN_child_s3s4_200_cont_0 <- as.data.frame(t(sapply(IRN_child_s3s4_200_cont_final[, -1], get0)))
IRN_child_s3s4_200_cont_0 <- cbind(rownames(IRN_child_s3s4_200_cont_0), data.frame(IRN_child_s3s4_200_cont_0, row.names=NULL))
names(IRN_child_s3s4_200_cont_0) <- c("var", "N", "NNZ", "PZ")
IRN_child_s3s4_200_cont_full <- merge(IRN_child_s3s4_200_cont_0, desc_info, by="var")
IRN_child_s3s4_200_cont_full <- IRN_child_s3s4_200_cont_full[order(IRN_child_s3s4_200_cont_full$PZ, decreasing=TRUE), ]
write.table(IRN_child_s3s4_200_cont_full, file="IRN_children_percent_zero_values_series1-2.txt", sep="\t", quote=FALSE, row.names=FALSE)

IRN_child_s3s4_200_cont_0cc <- as.data.frame(t(sapply(IRN_child_s3s4_200_cont_finalcc[, -1], get0)))
IRN_child_s3s4_200_cont_0cc <- cbind(rownames(IRN_child_s3s4_200_cont_0cc), data.frame(IRN_child_s3s4_200_cont_0cc, row.names=NULL))
names(IRN_child_s3s4_200_cont_0cc) <- c("var", "N", "NNZ", "PZ")
IRN_child_s3s4_200_cont_fullcc <- merge(IRN_child_s3s4_200_cont_0cc, desc_info, by="var")
IRN_child_s3s4_200_cont_fullcc <- IRN_child_s3s4_200_cont_fullcc[order(IRN_child_s3s4_200_cont_fullcc$PZ, decreasing=TRUE), ]
write.table(IRN_child_s3s4_200_cont_fullcc, file="IRN_children_percent_zero_values_series1-2cc.txt", sep="\t", quote=FALSE, row.names=FALSE)

IRN_adult_s3s4_200_cont_0 <- as.data.frame(t(sapply(IRN_adult_s3s4_200_cont_final[, -1], get0)))
IRN_adult_s3s4_200_cont_0 <- cbind(rownames(IRN_adult_s3s4_200_cont_0), data.frame(IRN_adult_s3s4_200_cont_0, row.names=NULL))
names(IRN_adult_s3s4_200_cont_0) <- c("var", "N", "NNZ", "PZ")
IRN_adult_s3s4_200_cont_full <- merge(IRN_adult_s3s4_200_cont_0, desc_info, by="var")
IRN_adult_s3s4_200_cont_full <- IRN_adult_s3s4_200_cont_full[order(IRN_adult_s3s4_200_cont_full$PZ, decreasing=TRUE), ]
write.table(IRN_adult_s3s4_200_cont_full, file="IRN_adult_percent_zero_values_series1-2.txt", sep="\t", quote=FALSE, row.names=FALSE)

#Remove PZ >= 0.90
IRN_child_pz <- IRN_child_s3s4_200_cont_full[IRN_child_s3s4_200_cont_full$PZ >= 0.9, 1, drop=FALSE]
IRN_child_pzcc <- IRN_child_s3s4_200_cont_fullcc[IRN_child_s3s4_200_cont_fullcc$PZ >= 0.9, 1, drop=FALSE]
IRN_adult_pz <- IRN_adult_s3s4_200_cont_full[IRN_adult_s3s4_200_cont_full$PZ >= 0.9, 1, drop=FALSE]

#Filter out the >= 0.90 samples from continuous file.
IRN_child_s3s4_200_final_pz <- clarite::colfilter(d=IRN_child_s3s4_200_cont_final, cols=IRN_child_pz, exclude = TRUE)
IRN_child_s3s4_200_final_pzcc <- clarite::colfilter(d=IRN_child_s3s4_200_cont_finalcc, cols=IRN_child_pzcc, exclude = TRUE)
IRN_adult_s3s4_200_final_pz <- clarite::colfilter(d=IRN_adult_s3s4_200_cont_final, cols=IRN_adult_pz, exclude = TRUE)

##Make plot to visualize phenotype.
#If skewness is less than -1 or greater than 1, the distribution is highly skewed.
#If skewness is between -1 and -0.5 or between 0.5 and 1, the distribution is moderately skewed.
#If skewness is between -0.5 and 0.5, the distribution is approximately symmetric.

hist(IRN_child_s3s4_200_cont_final$LBXIRN, breaks = 100, main = "Iron (LBXIRN) for children", xlab = "LBXIRN")
hist(IRN_child_s3s4_200_cont_finalcc$LBXIRN_SIR, breaks = 100, main = "Iron (LBXIRN_SIR) for children", xlab = "LBXIRN_SIR")
hist(IRN_adult_s3s4_200_cont_final$LBXSIR, breaks = 100, main = "Iron (LBXSIR) for adults", xlab = "LBXSIR")

library (moments)
skewness(IRN_child_s3s4_200_cont_final$LBXIRN)
skewness(IRN_child_s3s4_200_cont_finalcc$LBXIRN_SIR)
skewness(IRN_adult_s3s4_200_cont_final$LBXSIR)

transIRN_c <- log1p(IRN_child_s3s4_200_cont_final$LBXIRN)
hist(transIRN_c, breaks = 100, main = "Log transformed Iron (log LBXIRN) for children", xlab = "log LBXIRN")
skewness(transIRN_c)

transIRN_cc <- log1p(IRN_child_s3s4_200_cont_final$LBXIRN_SIR)
hist(transIRN_cc, breaks = 100, main = "Log transformed Iron (log LBXIRN_SIR) for children", xlab = "log LBXIRN_SIR")
skewness(transIRN_cc)

transIRN_a <- log1p(IRN_adult_s3s4_200_cont_final$LBXSIR)
hist(transIRN_a, breaks = 100, main = "Log transformed Iron (log LBXSIR) for adults", xlab = "log LBXSIR")
skewness(transIRN_a)

#Log transform RBF and name log transform column logRBF
IRN_child_s3s4_200_final_pz$logLBXIRN <- log1p(IRN_child_s3s4_200_cont_final$LBXIRN)
IRN_child_s3s4_200_final_pz_log <- IRN_child_s3s4_200_final_pz

IRN_child_s3s4_200_final_pzcc$logLBXIRN_SIR <- log1p(IRN_child_s3s4_200_cont_final$LBXIRN_SIR)
IRN_child_s3s4_200_final_pz_logcc <- IRN_child_s3s4_200_final_pz

IRN_adult_s3s4_200_final_pz$logLBXSIR <- log1p(IRN_adult_s3s4_200_final_pz$LBXSIR)
IRN_adult_s3s4_200_final_pz_log <- IRN_adult_s3s4_200_final_pz

#Drop the RBF reading
IRN_child_s3s4_200_final_pz_final <- clarite::colfilter(d=IRN_child_s3s4_200_final_pz_log, cols=drop_item_IRN_child, exclude = TRUE)
IRN_child_s3s4_200_final_pz_finalcc <- clarite::colfilter(d=IRN_child_s3s4_200_final_pz_logcc, cols=drop_item_IRN_childcc, exclude = TRUE)
IRN_adult_s3s4_200_final_pz_final <- clarite::colfilter(d=IRN_adult_s3s4_200_final_pz_log, cols=drop_item_IRN_adult, exclude = TRUE)

#Merge categorical and binary files (data frames)
IRN_child_s3s4_200_cat_bin <- clarite::merge_data(IRN_child_s3s4_200_cat_final, IRN_child_s3s4_200_bin)
IRN_child_s3s4_200_cat_bincc <- clarite::merge_data(IRN_child_s3s4_200_cat_finalcc, IRN_child_s3s4_200_bincc)
IRN_adult_s3s4_200_cat_bin <- clarite::merge_data(IRN_adult_s3s4_200_cat_final, IRN_adult_s3s4_200_bin)

#Drop variables <200 and rename file
IRN_child_cat_final_rep <- clarite::min_cat_n(IRN_child_s3s4_200_cat_bin, skip = skip_RBF)
IRN_child_cat_final_rep <- clarite::colfilter(d=IRN_child_cat_final_rep, cols=drop_item_IRN_child, exclude = TRUE)

IRN_child_cat_final_repcc <- clarite::min_cat_n(IRN_child_s3s4_200_cat_bincc, skip = skip_RBF)
IRN_child_cat_final_repcc <- clarite::colfilter(d=IRN_child_cat_final_repcc, cols=drop_item_IRN_childcc, exclude = TRUE)

IRN_adult_cat_final_rep <- clarite::min_cat_n(IRN_adult_s3s4_200_cat_bin, skip = skip_RBF)
IRN_adult_cat_final_rep <- clarite::colfilter(d=IRN_adult_cat_final_rep, cols=drop_item_IRN_adult, exclude = TRUE)

IRN_child_s3s4_200_final_pz_200 <- clarite::min_n(IRN_child_s3s4_200_final_pz_final)
IRN_child_s3s4_200_final_pz_200cc <- clarite::min_n(IRN_child_s3s4_200_final_pz_finalcc)
IRN_adult_s3s4_200_final_pz_200 <- clarite::min_n(IRN_adult_s3s4_200_final_pz_final)
```

#EWAS Preparation Discovery Group
```{r include=FALSE}
#Children
##Dataframe
IRN_child_final_dis <- merge(IRN_child_cat_final,IRN_child_s1s2_200_final_pz_200)
IRN_child_final_rep <- merge(IRN_child_cat_final_rep,IRN_child_s3s4_200_final_pz_200)

IRN_covar_cat <- c("female", "black", "mexican", "other_hispanic", "other_eth", "SES_LEVEL","SDDSRVYR")
IRN_covar_cont <- c("BMXBMI","RIDAGEYR")

IRN_child_final_dis_list <-dput(names(IRN_child_final_dis))
IRN_child_final_rep_list <-dput(names(IRN_child_final_rep))
IRN_child_final_child_crosslist <- (intersect(IRN_child_final_dis_list,IRN_child_final_rep_list))
IRN_child_final_child_crosslist <- (intersect(IRN_child_final_child_crosslist,VarWeight$Variable))
IRN_child_final_child_crosslist_variables <- c("ID",IRN_child_final_child_crosslist,IRN_covars_c,pheno_IRN_c)

col.num.child.dis <- which(colnames(IRN_child_final_dis) %in% IRN_child_final_child_crosslist_variables)
IRN_child_final_dis <- IRN_child_final_dis[,col.num.child.dis]

IRN_child_final_child_discovery_final <- merge_data(IRN_child_final_dis, survey_design_discovery, union = FALSE)

##Co-variables
IRN_child_final_dis_cat_vars <- dput(names(IRN_child_cat_final))
IRN_child_final_dis_cat_vars <- IRN_child_final_dis_cat_vars[IRN_child_final_dis_cat_vars %in% IRN_child_final_child_crosslist]

IRN_child_final_dis_cont_vars <- dput(names(IRN_child_s1s2_200_final_pz_200))
IRN_child_final_dis_cont_vars <- IRN_child_final_dis_cont_vars[IRN_child_final_dis_cont_vars %in% IRN_child_final_child_crosslist]

#Children Combined
##Dataframe
IRN_child_final_discc <- merge(IRN_child_cat_finalcc,IRN_child_s1s2_200_final_pz_200cc)
IRN_child_final_repcc <- merge(IRN_child_cat_final_repcc,IRN_child_s3s4_200_final_pz_200cc)

IRN_child_final_dis_listcc <-dput(names(IRN_child_final_discc))
IRN_child_final_rep_listcc <-dput(names(IRN_child_final_repcc))
IRN_child_final_child_crosslistcc <- (intersect(IRN_child_final_dis_listcc,IRN_child_final_rep_listcc))
IRN_child_final_child_crosslistcc <- (intersect(IRN_child_final_child_crosslistcc,VarWeight$Variable))
IRN_child_final_child_crosslist_variablescc <- c("ID",IRN_child_final_child_crosslist,IRN_covars_c,pheno_IRN_cc)

col.num.child.discc <- which(colnames(IRN_child_final_discc) %in% IRN_child_final_child_crosslist_variablescc)
IRN_child_final_discc <- IRN_child_final_discc[,col.num.child.discc]

IRN_child_final_child_discovery_finalcc <- merge_data(IRN_child_final_discc, survey_design_discovery, union = FALSE)

##Co-variables
IRN_child_final_dis_cat_varscc <- dput(names(IRN_child_cat_finalcc))
IRN_child_final_dis_cat_varscc <- IRN_child_final_dis_cat_varscc[IRN_child_final_dis_cat_varscc %in% IRN_child_final_child_crosslistcc]

IRN_child_final_dis_cont_varscc <- dput(names(IRN_child_s1s2_200_final_pz_200cc))
IRN_child_final_dis_cont_varscc <- IRN_child_final_dis_cont_varscc[IRN_child_final_dis_cont_varscc %in% IRN_child_final_child_crosslistcc]

#Adults
##Dataframe
IRN_adult_final_dis <- merge(IRN_adult_cat_final,IRN_adult_s1s2_200_final_pz_200)
IRN_adult_final_rep <- merge(IRN_adult_cat_final_rep,IRN_adult_s3s4_200_final_pz_200)

IRN_adult_final_dis_list <- dput(names(IRN_adult_final_dis))
IRN_adult_final_rep_list <- dput(names(IRN_adult_final_rep))
IRN_adult_final_adult_crosslist <- (intersect(IRN_adult_final_dis_list,IRN_adult_final_rep_list))
IRN_adult_final_adult_crosslist <- (intersect(IRN_adult_final_adult_crosslist,VarWeight$Variable))
IRN_adult_final_adult_crosslist_variables <- c("ID",IRN_adult_final_adult_crosslist,IRN_covars_a,pheno_IRN_a)

col.num.adult.dis <- which(colnames(IRN_adult_final_dis) %in% IRN_adult_final_adult_crosslist_variables)
IRN_adult_final_dis <- IRN_adult_final_dis[,col.num.adult.dis]

IRN_adult_final_adult_discovery_final <- merge_data(IRN_adult_final_dis, survey_design_discovery, union = FALSE)

##Variables
IRN_adult_final_dis_cat_vars <- dput(names(IRN_adult_cat_final))
IRN_adult_final_dis_cat_vars <- IRN_adult_final_dis_cat_vars[IRN_adult_final_dis_cat_vars %in% IRN_adult_final_adult_crosslist]

IRN_adult_final_dis_cont_vars <- dput(names(IRN_adult_s1s2_200_final_pz_200))
IRN_adult_final_dis_cont_vars <- IRN_adult_final_dis_cont_vars[IRN_adult_final_dis_cont_vars %in% IRN_adult_final_adult_crosslist]
```

#EWAS Discovery Group
```{r}
#Children EWAS
IRN_EWAS_Children_discovery_results <- ewas(d = IRN_child_final_child_discovery_final,
                                            cat_vars=IRN_child_final_dis_cat_vars,
                                            cont_vars=IRN_child_final_dis_cont_vars,
                                            y=pheno_IRN_c,
                                            cat_covars=IRN_covar_cat,
                                            cont_covars=IRN_covar_cont,
                                            regression_family="gaussian",
                                            allowed_nonvarying=c("female", "SDDSRVYR"),
                                            weights=weights_discovery,
                                            ids="SDMVPSU",
                                            strata="SDMVSTRA",
                                            nest=TRUE,
                                            drop_unweighted = TRUE)
write.table(IRN_EWAS_Children_discovery_results, file = "EWAS_IRN_Children_discovery_results.txt", row.names = F)

IRN_EWAS_Children_discovery_results_adj <- ewas_pval_adjust(IRN_EWAS_Children_discovery_results)
write.table(IRN_EWAS_Children_discovery_results_adj, file = "EWAS_IRN_Children_discovery_results_adj.txt", row.names = F)

#Children combined EWAS
IRN_EWAS_Children_discovery_resultscc <- ewas(d = IRN_child_final_child_discovery_finalcc,
                                            cat_vars=IRN_child_final_dis_cat_varscc,
                                            cont_vars=IRN_child_final_dis_cont_varscc,
                                            y=pheno_IRN_cc,
                                            cat_covars=IRN_covar_cat,
                                            cont_covars=IRN_covar_cont,
                                            regression_family="gaussian",
                                            allowed_nonvarying=c("female", "SDDSRVYR"),
                                            weights=weights_discovery,
                                            ids="SDMVPSU",
                                            strata="SDMVSTRA",
                                            nest=TRUE,
                                            drop_unweighted = TRUE)
write.table(IRN_EWAS_Children_discovery_resultscc, file = "EWAS_IRN_Children_discovery_resultscc.txt", row.names = F)

IRN_EWAS_Children_discovery_results_adjcc <- ewas_pval_adjust(IRN_EWAS_Children_discovery_resultscc)
write.table(IRN_EWAS_Children_discovery_results_adjcc, file = "EWAS_IRN_Children_discovery_results_adjcc.txt", row.names = F)


#Adults EWAS
IRN_EWAS_adult_discovery_results <- ewas(d = IRN_adult_final_adult_discovery_final,
                                         cat_vars=IRN_adult_final_dis_cat_vars,
                                         cont_vars=IRN_adult_final_dis_cont_vars,
                                         y=pheno_IRN_a,
                                         cat_covars=IRN_covar_cat,
                                         cont_covars=IRN_covar_cont,
                                         regression_family="gaussian",
                                         allowed_nonvarying=c("female", "SDDSRVYR"),
                                         weights=weights_discovery,
                                         ids="SDMVPSU",
                                         strata="SDMVSTRA",
                                         nest=TRUE,
                                         drop_unweighted = TRUE)
write.table(IRN_EWAS_adult_discovery_results, file = "EWAS_IRN_adult_discovery_results.txt", row.names = F)

IRN_EWAS_adult_discovery_results_adj <- ewas_pval_adjust(IRN_EWAS_adult_discovery_results)
write.table(IRN_EWAS_adult_discovery_results_adj, file = "EWAS_IRN_adult_discovery_results_adj.txt", row.names = F)
```

#EWAS Iron Preparation Replication Group
```{r include=FALSE}
#Adults
pvalue_fdr_rank_IRN_adult <- IRN_EWAS_adult_discovery_results_adj[order(IRN_EWAS_adult_discovery_results_adj$pvalue_FDR), ]
selected_variables_fdr_list_IRN_adult <- which(pvalue_fdr_rank_IRN_adult$pvalue_FDR < 0.1)
selected_variables_fdr_IRN_adult <- head(pvalue_fdr_rank_IRN_adult[,1],length(selected_variables_fdr_list_IRN_adult))

variables_fdr_IRN_adult <- c(paste(selected_variables_fdr_IRN_adult), IRN_covars_a, pheno_IRN_a)
all_variable_filtered_IRN_adult <- IRN_adult_final_rep
rep_variable_IRN_adult <- colfilter(d=all_variable_filtered_IRN_adult, cols = variables_fdr_IRN_adult, exclude = FALSE)

IRN_adult_final_adult_replication_final <- merge_data(rep_variable_IRN_adult, survey_design_replication, union = FALSE)

##Variables
IRN_adult_final_rep_cat_vars <- dput(names(IRN_adult_cat_final_rep))
IRN_adult_final_rep_cat_vars_finallist <- dput(names(IRN_adult_final_adult_replication_final))
IRN_adult_final_rep_cat_vars <- intersect(IRN_adult_final_rep_cat_vars,IRN_adult_final_rep_cat_vars_finallist)
IRN_adult_final_rep_cat_vars <- IRN_adult_final_rep_cat_vars[!IRN_adult_final_rep_cat_vars %in% c(IRN_covars_a, "ID")]

IRN_adult_final_rep_cont_vars <- dput(names(IRN_adult_s3s4_200_final_pz_200))
IRN_adult_final_rep_cont_vars_finallist <- dput(names(IRN_adult_final_adult_replication_final))
IRN_adult_final_rep_cont_vars <-IRN_adult_final_rep_cont_vars[IRN_adult_final_rep_cont_vars %in% IRN_adult_final_rep_cont_vars_finallist]
IRN_adult_final_rep_cont_vars <- IRN_adult_final_rep_cont_vars[!IRN_adult_final_rep_cont_vars %in% c(IRN_covars_a, "ID", pheno_IRN_a)]

#Children
pvalue_fdr_rank_IRN_child <- IRN_EWAS_Children_discovery_results_adj[order(IRN_EWAS_Children_discovery_results_adj$pvalue_FDR), ]
selected_variables_fdr_list_IRN_child <- which(pvalue_fdr_rank_IRN_child$pvalue_FDR < 0.1)
selected_variables_fdr_IRN_child <- head(pvalue_fdr_rank_IRN_child[,1],length(selected_variables_fdr_list_IRN_child))

variables_fdr_IRN_child <- c(paste(selected_variables_fdr_IRN_child), IRN_covars_c, pheno_IRN_c)
all_variable_filtered_IRN_child <- IRN_child_final_rep
rep_variable_IRN_child <- colfilter(d=all_variable_filtered_IRN_child, cols = variables_fdr_IRN_child, exclude = FALSE)

IRN_child_final_child_replication_final <- merge_data(rep_variable_IRN_child, survey_design_replication, union = FALSE)

##Variables
IRN_child_final_rep_cat_vars <- dput(names(IRN_child_cat_final_rep))
IRN_child_final_rep_cat_vars_finallist <- dput(names(IRN_child_final_child_replication_final))
IRN_child_final_rep_cat_vars <- intersect(IRN_child_final_rep_cat_vars,IRN_child_final_rep_cat_vars_finallist)
IRN_child_final_rep_cat_vars <- IRN_child_final_rep_cat_vars[!IRN_child_final_rep_cat_vars %in% c(IRN_covars_c, "ID")]

IRN_child_final_rep_cont_vars <- dput(names(IRN_child_s3s4_200_final_pz_200))
IRN_child_final_rep_cont_vars_finallist <- dput(names(IRN_child_final_child_replication_final))
IRN_child_final_rep_cont_vars <-IRN_child_final_rep_cont_vars[IRN_child_final_rep_cont_vars %in% IRN_child_final_rep_cont_vars_finallist]
IRN_child_final_rep_cont_vars <- IRN_child_final_rep_cont_vars[!IRN_child_final_rep_cont_vars %in% c(IRN_covars_c, "ID", pheno_IRN_c)]

#Children combined
pvalue_fdr_rank_IRN_childcc <- IRN_EWAS_Children_discovery_results_adjcc[order(IRN_EWAS_Children_discovery_results_adjcc$pvalue_FDR), ]
selected_variables_fdr_list_IRN_childcc <- which(pvalue_fdr_rank_IRN_childcc$pvalue_FDR < 0.1)
selected_variables_fdr_IRN_childcc <- head(pvalue_fdr_rank_IRN_childcc[,1],length(selected_variables_fdr_list_IRN_childcc))

variables_fdr_IRN_childcc <- c(paste(selected_variables_fdr_IRN_childcc), IRN_covars_c, pheno_IRN_cc)
all_variable_filtered_IRN_childcc <- IRN_child_final_repcc
rep_variable_IRN_childcc <- colfilter(d=all_variable_filtered_IRN_childcc, cols = variables_fdr_IRN_childcc, exclude = FALSE)

IRN_child_final_child_replication_finalcc <- merge_data(rep_variable_IRN_childcc, survey_design_replication, union = FALSE)

##Variables
IRN_child_final_rep_cat_varscc <- dput(names(IRN_child_cat_final_repcc))
IRN_child_final_rep_cat_vars_finallistcc <- dput(names(IRN_child_final_child_replication_finalcc))
IRN_child_final_rep_cat_varscc <- intersect(IRN_child_final_rep_cat_varscc,IRN_child_final_rep_cat_vars_finallistcc)
IRN_child_final_rep_cat_varscc <- IRN_child_final_rep_cat_varscc[!IRN_child_final_rep_cat_varscc %in% c(IRN_covars_c, "ID")]

IRN_child_final_rep_cont_varscc <- dput(names(IRN_child_s3s4_200_final_pz_200cc))
IRN_child_final_rep_cont_vars_finallistcc <- dput(names(IRN_child_final_child_replication_finalcc))
IRN_child_final_rep_cont_varscc <-IRN_child_final_rep_cont_varscc[IRN_child_final_rep_cont_varscc %in% IRN_child_final_rep_cont_vars_finallistcc]
IRN_child_final_rep_cont_varscc <- IRN_child_final_rep_cont_varscc[!IRN_child_final_rep_cont_varscc %in% c(IRN_covars_c, "ID", pheno_IRN_cc)]
```

#EWAS Iron Replication Group
```{r}
# Adults
IRN_EWAS_adult_replication_results <- ewas(d = IRN_adult_final_adult_replication_final,
                                           cat_vars=IRN_adult_final_rep_cat_vars,
                                           cont_vars=IRN_adult_final_rep_cont_vars,
                                           y=pheno_IRN_a,
                                           cat_covars=IRN_covar_cat,
                                           cont_covars=IRN_covar_cont,
                                           regression_family="gaussian",
                                           allowed_nonvarying=c("female", "SDDSRVYR"),
                                           weights=weights_replication,
                                           ids="SDMVPSU",
                                           strata="SDMVSTRA",
                                           nest=TRUE,
                                           drop_unweighted = TRUE)
write.table(IRN_EWAS_adult_replication_results, file = "EWAS_IRN_adult_replication_results.txt", row.names = F)


IRN_EWAS_adult_replication_results_adj <- ewas_pval_adjust(IRN_EWAS_adult_replication_results)
write.table(IRN_EWAS_adult_replication_results_adj, file = "EWAS_IRN_adult_replication_results_adj.txt", row.names = F)

# Children
IRN_EWAS_Children_replication_results <- ewas(d = IRN_child_final_child_replication_final,
                                              cat_vars=IRN_child_final_rep_cat_vars,
                                              cont_vars=IRN_child_final_rep_cont_vars,
                                              y=pheno_IRN_c,
                                              cat_covars=IRN_covar_cat,
                                              cont_covars=IRN_covar_cont,
                                              regression_family="gaussian",
                                              allowed_nonvarying=c("female", "SDDSRVYR"),
                                              weights=weights_replication,
                                              ids="SDMVPSU",
                                              strata="SDMVSTRA",
                                              nest=TRUE,
                                              drop_unweighted = TRUE)
write.table(IRN_EWAS_Children_replication_results, file = "EWAS_IRN_Children_replication_results.txt", row.names = F)


IRN_EWAS_Children_replication_results_adj <- ewas_pval_adjust(IRN_EWAS_Children_replication_results)
write.table(IRN_EWAS_Children_replication_results_adj, file = "EWAS_IRN_Children_replication_results_adj.txt", row.names = F)

# Children combined
IRN_EWAS_Children_replication_resultscc <- ewas(d = IRN_child_final_child_replication_finalcc,
                                              cat_vars=IRN_child_final_rep_cat_varscc,
                                              cont_vars=IRN_child_final_rep_cont_varscc,
                                              y=pheno_IRN_cc,
                                              cat_covars=IRN_covar_cat,
                                              cont_covars=IRN_covar_cont,
                                              regression_family="gaussian",
                                              allowed_nonvarying=c("female", "SDDSRVYR"),
                                              weights=weights_replication,
                                              ids="SDMVPSU",
                                              strata="SDMVSTRA",
                                              nest=TRUE,
                                              drop_unweighted = TRUE)
write.table(IRN_EWAS_Children_replication_resultscc, file = "EWAS_IRN_Children_replication_resultscc.txt", row.names = F)


IRN_EWAS_Children_replication_results_adjcc <- ewas_pval_adjust(IRN_EWAS_Children_replication_resultscc)
write.table(IRN_EWAS_Children_replication_results_adjcc, file = "EWAS_IRN_Children_replication_results_adjcc.txt", row.names = F)
```

#EWAS Iron Manhattan Plot
```{r}
#Adults
##Extract the variables and p-values
ewas_IRN_adult_dis_crt <- IRN_EWAS_adult_discovery_results_adj[,c(1,14)]
ewas_IRN_adult_rep_crt <- IRN_EWAS_adult_replication_results_adj[,c(1,13)]

##Add group
ewas_IRN_adult_dis_crt$Shape <- rep("Discovery", nrow(ewas_IRN_adult_dis_crt))
ewas_IRN_adult_rep_crt$Shape <- rep("Replication", nrow(ewas_IRN_adult_rep_crt))
colnames(ewas_IRN_adult_dis_crt)[2] <- "pvalue"
colnames(ewas_IRN_adult_rep_crt)[2] <- "pvalue"

##Combine groups
ewas_IRN_adult_all_crt <- rbind(ewas_IRN_adult_dis_crt,ewas_IRN_adult_rep_crt)
colnames(ewas_IRN_adult_all_crt)[1] <- "Variable"
colnames(ewas_IRN_adult_all_crt)[2] <- "pvalue"
ewas_IRN_adult_all_crt$pvalue = as.numeric(ewas_IRN_adult_all_crt$pvalue)

##Manhattan Plot
VarCat_nopf <- read.delim("/Users/Nicen/Desktop/Anemia/Data/VarCat_nopf.txt")

IRN_ewas_mplot_adult <- eman(ewas_IRN_adult_all_crt, ewas = FALSE, groups = VarCat_nopf, file = "M-Plot Iron Adults", morecolors = FALSE, hgt = 7, wi = 12, res = 300)

ggsave(file = "M-Plot Iron Adults.png", plot = IRN_ewas_mplot_adult, device = "png",path = "/Users/Nicen/Desktop/Anemia/Figures/Original Figures", width = 12, height = 7, dpi = 300)

#Children
##Extract the variables and p-values
ewas_IRN_child_dis_crt <- IRN_EWAS_Children_discovery_results_adj[,c(1,14)]
ewas_IRN_child_rep_crt <- IRN_EWAS_Children_replication_results_adj[,c(1,13)]

##Add group
ewas_IRN_child_dis_crt$Shape <- rep("Discovery", nrow(ewas_IRN_child_dis_crt))
ewas_IRN_child_rep_crt$Shape <- rep("Replication", nrow(ewas_IRN_child_rep_crt))
colnames(ewas_IRN_child_dis_crt)[2] <- "pvalue"
colnames(ewas_IRN_child_rep_crt)[2] <- "pvalue"

##Combine groups
ewas_IRN_child_all_crt <- rbind(ewas_IRN_child_dis_crt,ewas_IRN_child_rep_crt)
colnames(ewas_IRN_child_all_crt)[1] <- "Variable"
colnames(ewas_IRN_child_all_crt)[2] <- "pvalue"
ewas_IRN_child_all_crt$pvalue = as.numeric(ewas_IRN_child_all_crt$pvalue)

##Manhattan Plot
VarCat_nopf <- read.delim("/Users/Nicen/Desktop/Anemia/Data/VarCat_nopf.txt")
IRN_ewas_mplot_child <- eman(ewas_IRN_child_all_crt, ewas = FALSE, groups = VarCat_nopf, file = "M-Plot Iron Children", morecolors = FALSE, hgt = 7, wi = 12, res = 300)

ggsave(file = "M-Plot Iron Children.png", plot = IRN_ewas_mplot_child, device = "png",path = "/Users/Nicen/Desktop/Anemia/Figures/Original Figures", width = 12, height = 7, dpi = 300)

#Children combined
##Extract the variables and p-values
ewas_IRN_child_dis_crtcc <- IRN_EWAS_Children_discovery_results_adjcc[,c(1,14)]
ewas_IRN_child_rep_crtcc <- IRN_EWAS_Children_replication_results_adjcc[,c(1,13)]

##Add group
ewas_IRN_child_dis_crtcc$Shape <- rep("Discovery", nrow(ewas_IRN_child_dis_crtcc))
ewas_IRN_child_rep_crtcc$Shape <- rep("Replication", nrow(ewas_IRN_child_rep_crtcc))
colnames(ewas_IRN_child_dis_crtcc)[2] <- "pvalue"
colnames(ewas_IRN_child_rep_crtcc)[2] <- "pvalue"

##Combine groups
ewas_IRN_child_all_crtcc <- rbind(ewas_IRN_child_dis_crtcc,ewas_IRN_child_rep_crtcc)
colnames(ewas_IRN_child_all_crtcc)[1] <- "Variable"
colnames(ewas_IRN_child_all_crtcc)[2] <- "pvalue"
ewas_IRN_child_all_crtcc$pvalue = as.numeric(ewas_IRN_child_all_crtcc$pvalue)

##Manhattan Plot
VarCat_nopf <- read.delim("/Users/Nicen/Desktop/Anemia/Data/VarCat_nopf.txt")
IRN_ewas_mplot_childcc <- eman(ewas_IRN_child_all_crtcc, ewas = FALSE, groups = VarCat_nopf, file = "M-Plot Iron Childrencc", morecolors = FALSE, hgt = 7, wi = 12, res = 300)

ggsave(file = "M-Plot Iron Childrencc.png", plot = IRN_ewas_mplot_childcc, device = "png",path = "/Users/Nicen/Desktop/Anemia/Figures/Original Figures", width = 12, height = 7, dpi = 300)
```

***

```{r}
library(hudson)
ewas_IRN_child_result <- data.frame(ewas_IRN_child_all_crt, Group=VarCat_nopf[match(ewas_IRN_child_all_crt$Variable, VarCat_nopf$Variable), 2])

ewas_IRN_childcc_result <- data.frame(ewas_IRN_child_all_crtcc, Group=VarCat_nopf[match(ewas_IRN_child_all_crtcc$Variable, VarCat_nopf$Variable), 2])

t_child <- (0.05/nrow(ewas_IRN_child_dis_crt))
t_child_r <- (0.05/nrow(ewas_IRN_child_rep_crt))
b_child <- (0.05/nrow(ewas_IRN_child_dis_crtcc))
b_child_r <- (0.05/nrow(ewas_IRN_child_rep_crtcc))

hudson_child <- emirror(top=ewas_IRN_child_result, bottom=ewas_IRN_childcc_result, tline=c(t_child), bline=c(b_child), annotate_p = c(t_child,b_child),
highlight_p= c(t_child,b_child), rotatelabels=1, labelangle=20, highlighter="red", color1='#53868B', color2 = '#4D4D4D', toptitle = "EWAS results with Iron from frozen measurements in Children", 
bottomtitle = "EWAS results with Iron from combined measurements in Children")

ggsave(file = "H-Plot Iron Children.png", plot = hudson_child, device = "png",path = "/Users/Nicen/Desktop/Anemia/Figures/Original Figures", width = 12, height = 7, dpi = 300)
```

```{r}
#Plots
# Read in the Results
anemia_adult_dis_adj <- read.csv("/Users/Nicen/Desktop/Anemia/EWAS_Anemia_Adult_discovery_results_adj.txt", sep="")
anemia_adult_rep_adj <- read.csv("/Users/Nicen/Desktop/Anemia/EWAS_anemia_case_adult_replication_results_adj.txt", sep="")
anemia_child_dis_adj <- read.csv("/Users/Nicen/Desktop/Anemia/EWAS_Anemia_Children_discovery_results_adj.txt", sep="")
anemia_child_rep_adj <- read.csv("/Users/Nicen/Desktop/Anemia/EWAS_anemia_case_Children_replication_results_adj.txt", sep="")

hemo_adult_dis_adj <- read.csv("/Users/Nicen/Desktop/Anemia/EWAS_hemo_adult_discovery_results_adj.txt", sep="")
hemo_adult_rep_adj <- read.csv("/Users/Nicen/Desktop/Anemia/EWAS_hemo_adult_replication_results_adj.txt", sep="")
hemo_child_dis_adj <- read.csv("/Users/Nicen/Desktop/Anemia/EWAS_hemo_Children_discovery_results_adj.txt", sep="")
hemo_child_rep_adj <- read.csv("/Users/Nicen/Desktop/Anemia/EWAS_hemo_Children_replication_results_adj.txt", sep="")

ida_adult_dis_adj <- read.csv("/Users/Nicen/Desktop/Anemia/EWAS_IDA_Adult_discovery_results_adj.txt", sep="")
ida_adult_rep_adj <- read.csv("/Users/Nicen/Desktop/Anemia/EWAS_IDA_case_adult_replication_results_adj.txt", sep="")

ckda_adult_dis_only_adj <- read.csv("/Users/Nicen/Desktop/Anemia/EWAS_CKDA_Adult_discovery_results_adj.txt", sep="")

irn_adult_dis_adj <- read.csv("/Users/Nicen/Desktop/Anemia/EWAS_IRN_adult_discovery_results_adj.txt", sep="")
irn_adult_rep_adj <- read.csv("/Users/Nicen/Desktop/Anemia/EWAS_IRN_adult_replication_results_adj.txt", sep="")
irn_child_dis_adj <- read.csv("/Users/Nicen/Desktop/Anemia/EWAS_IRN_Children_discovery_results_adj.txt", sep="")
irn_child_rep_adj <- read.csv("/Users/Nicen/Desktop/Anemia/EWAS_IRN_Children_replication_results_adj.txt", sep="")

rbf_adult_dis_adj <- read.csv("/Users/Nicen/Desktop/Anemia/EWAS_RBF_adult_discovery_results_adj.txt", sep="")
rbf_adult_rep_adj <- read.csv("/Users/Nicen/Desktop/Anemia/EWAS_RBF_adult_replication_results_adj.txt", sep="")
rbf_child_dis_adj <- read.csv("/Users/Nicen/Desktop/Anemia/EWAS_RBF_Children_discovery_results_adj.txt", sep="")
rbf_child_rep_adj <- read.csv("/Users/Nicen/Desktop/Anemia/EWAS_RBF_Children_replication_results_adj.txt", sep="")

vb12_adult_dis_adj <- read.csv("/Users/Nicen/Desktop/Anemia/EWAS_vb12_adult_discovery_results_adj.txt", sep="")
vb12_adult_rep_adj <- read.csv("/Users/Nicen/Desktop/Anemia/EWAS_vb12_adult_replication_results_adj.txt", sep="")
vb12_child_dis_adj <- read.csv("/Users/Nicen/Desktop/Anemia/EWAS_vb12_Children_discovery_results_adj.txt", sep="")
vb12_child_rep_adj <- read.csv("/Users/Nicen/Desktop/Anemia/EWAS_vb12_Children_replication_results_adj.txt", sep="")


ua_adult_dis_adj <- read.csv("/Users/Nicen/Desktop/Anemia/EWAS_UA_Adult_discovery_results_adj.txt", sep="")
ua_adult_rep_adj <- read.csv("/Users/Nicen/Desktop/Anemia/EWAS_UA_case_adult_replication_results_adj.txt", sep="")
ua_child_dis_only_adj <- read.csv("/Users/Nicen/Desktop/Anemia/EWAS_UA_Children_discovery_results_adj.txt", sep="")

VarCat_nopf <- read.delim("/Users/Nicen/Desktop/Anemia/Data/VarCat_nopf.txt")

anemia_adult_dis_adj <- data.frame(anemia_adult_dis_adj, Group=VarCat_nopf[match(anemia_adult_dis_adj$Variable, VarCat_nopf$Variable), 2])
anemia_adult_rep_adj <- data.frame(anemia_adult_rep_adj, Group=VarCat_nopf[match(anemia_adult_rep_adj$Variable, VarCat_nopf$Variable), 2])
anemia_child_dis_adj <- data.frame(anemia_child_dis_adj, Group=VarCat_nopf[match(anemia_child_dis_adj$Variable, VarCat_nopf$Variable), 2])
anemia_child_rep_adj <- data.frame(anemia_child_rep_adj, Group=VarCat_nopf[match(anemia_child_rep_adj$Variable, VarCat_nopf$Variable), 2])
anemia_adult_dis_adj$Set <- rep("Discovery", nrow(anemia_adult_dis_adj))
anemia_adult_dis_adj$Pheno <- rep("Anemia", nrow(anemia_adult_dis_adj))
anemia_adult_rep_adj$Set <- rep("Replication", nrow(anemia_adult_rep_adj))
anemia_adult_rep_adj$Pheno <- rep("Anemia", nrow(anemia_adult_rep_adj))
anemia_child_dis_adj$Set <- rep("Discovery", nrow(anemia_child_dis_adj))
anemia_child_dis_adj$Pheno <- rep("Anemia", nrow(anemia_child_dis_adj))
anemia_child_rep_adj$Set <- rep("Replication", nrow(anemia_child_rep_adj))
anemia_child_rep_adj$Pheno <- rep("Anemia", nrow(anemia_child_rep_adj))

hemo_adult_dis_adj <- data.frame(hemo_adult_dis_adj, Group=VarCat_nopf[match(hemo_adult_dis_adj$Variable, VarCat_nopf$Variable), 2])
hemo_adult_rep_adj <- data.frame(hemo_adult_rep_adj, Group=VarCat_nopf[match(hemo_adult_rep_adj$Variable, VarCat_nopf$Variable), 2])
hemo_child_dis_adj <- data.frame(hemo_child_dis_adj, Group=VarCat_nopf[match(hemo_child_dis_adj$Variable, VarCat_nopf$Variable), 2])
hemo_child_rep_adj <- data.frame(hemo_child_rep_adj, Group=VarCat_nopf[match(hemo_child_rep_adj$Variable, VarCat_nopf$Variable), 2])
hemo_adult_dis_adj$Set <- rep("Discovery", nrow(hemo_adult_dis_adj))
hemo_adult_dis_adj$Pheno <- rep("Hemoglobin", nrow(hemo_adult_dis_adj))
hemo_adult_rep_adj$Set <- rep("Replication", nrow(hemo_adult_rep_adj))
hemo_adult_rep_adj$Pheno <- rep("Hemoglobin", nrow(hemo_adult_rep_adj))
hemo_child_dis_adj$Set <- rep("Discovery", nrow(hemo_child_dis_adj))
hemo_child_dis_adj$Pheno <- rep("Hemoglobin", nrow(hemo_child_dis_adj))
hemo_child_rep_adj$Set <- rep("Replication", nrow(hemo_child_rep_adj))
hemo_child_rep_adj$Pheno <- rep("Hemoglobin", nrow(hemo_child_rep_adj))

ida_adult_dis_adj <- data.frame(ida_adult_dis_adj, Group=VarCat_nopf[match(ida_adult_dis_adj$Variable, VarCat_nopf$Variable), 2])
ida_adult_rep_adj <- data.frame(ida_adult_rep_adj, Group=VarCat_nopf[match(ida_adult_rep_adj$Variable, VarCat_nopf$Variable), 2])
ida_adult_dis_adj$Set <- rep("Discovery", nrow(ida_adult_dis_adj))
ida_adult_dis_adj$Pheno <- rep("IDA", nrow(ida_adult_dis_adj))
ida_adult_rep_adj$Set <- rep("Replication", nrow(ida_adult_rep_adj))
ida_adult_rep_adj$Pheno <- rep("IDA", nrow(ida_adult_rep_adj))

ckda_adult_dis_only_adj <- data.frame(ckda_adult_dis_only_adj, Group=VarCat_nopf[match(ckda_adult_dis_only_adj$Variable, VarCat_nopf$Variable), 2])
ckda_adult_dis_only_adj$Set <- rep("Discovery", nrow(ckda_adult_dis_only_adj))
ckda_adult_dis_only_adj$Pheno <- rep("CKDA", nrow(ckda_adult_dis_only_adj))

irn_adult_dis_adj <- data.frame(irn_adult_dis_adj, Group=VarCat_nopf[match(irn_adult_dis_adj$Variable, VarCat_nopf$Variable), 2])
irn_adult_rep_adj <- data.frame(irn_adult_rep_adj, Group=VarCat_nopf[match(irn_adult_rep_adj$Variable, VarCat_nopf$Variable), 2])
irn_child_dis_adj <- data.frame(irn_child_dis_adj, Group=VarCat_nopf[match(irn_child_dis_adj$Variable, VarCat_nopf$Variable), 2])
irn_child_rep_adj <- data.frame(irn_child_rep_adj, Group=VarCat_nopf[match(irn_child_rep_adj$Variable, VarCat_nopf$Variable), 2])
irn_adult_dis_adj$Set <- rep("Discovery", nrow(irn_adult_dis_adj))
irn_adult_dis_adj$Pheno <- rep("Iron", nrow(irn_adult_dis_adj))
irn_adult_rep_adj$Set <- rep("Replication", nrow(irn_adult_rep_adj))
irn_adult_rep_adj$Pheno <- rep("Iron", nrow(irn_adult_rep_adj))
irn_child_dis_adj$Set <- rep("Discovery", nrow(irn_child_dis_adj))
irn_child_dis_adj$Pheno <- rep("Iron", nrow(irn_child_dis_adj))
irn_child_rep_adj$Set <- rep("Replication", nrow(irn_child_rep_adj))
irn_child_rep_adj$Pheno <- rep("Iron", nrow(irn_child_rep_adj))

rbf_adult_dis_adj <- data.frame(rbf_adult_dis_adj, Group=VarCat_nopf[match(rbf_adult_dis_adj$Variable, VarCat_nopf$Variable), 2])
rbf_adult_rep_adj <- data.frame(rbf_adult_rep_adj, Group=VarCat_nopf[match(rbf_adult_rep_adj$Variable, VarCat_nopf$Variable), 2])
rbf_child_dis_adj <- data.frame(rbf_child_dis_adj, Group=VarCat_nopf[match(rbf_child_dis_adj$Variable, VarCat_nopf$Variable), 2])
rbf_child_rep_adj <- data.frame(rbf_child_rep_adj, Group=VarCat_nopf[match(rbf_child_rep_adj$Variable, VarCat_nopf$Variable), 2])
rbf_adult_dis_adj$Set <- rep("Discovery", nrow(rbf_adult_dis_adj))
rbf_adult_dis_adj$Pheno <- rep("Folate", nrow(rbf_adult_dis_adj))
rbf_adult_rep_adj$Set <- rep("Replication", nrow(rbf_adult_rep_adj))
rbf_adult_rep_adj$Pheno <- rep("Folate", nrow(rbf_adult_rep_adj))
rbf_child_dis_adj$Set <- rep("Discovery", nrow(rbf_child_dis_adj))
rbf_child_dis_adj$Pheno <- rep("Folate", nrow(rbf_child_dis_adj))
rbf_child_rep_adj$Set <- rep("Replication", nrow(rbf_child_rep_adj))
rbf_child_rep_adj$Pheno <- rep("Folate", nrow(rbf_child_rep_adj))

vb12_adult_dis_adj <- data.frame(vb12_adult_dis_adj, Group=VarCat_nopf[match(vb12_adult_dis_adj$Variable, VarCat_nopf$Variable), 2])
vb12_adult_rep_adj <- data.frame(vb12_adult_rep_adj, Group=VarCat_nopf[match(vb12_adult_rep_adj$Variable, VarCat_nopf$Variable), 2])
vb12_child_dis_adj <- data.frame(vb12_child_dis_adj, Group=VarCat_nopf[match(vb12_child_dis_adj$Variable, VarCat_nopf$Variable), 2])
vb12_child_rep_adj <- data.frame(vb12_child_rep_adj, Group=VarCat_nopf[match(vb12_child_rep_adj$Variable, VarCat_nopf$Variable), 2])
vb12_adult_dis_adj$Set <- rep("Discovery", nrow(vb12_adult_dis_adj))
vb12_adult_dis_adj$Pheno <- rep("VB12", nrow(vb12_adult_dis_adj))
vb12_adult_rep_adj$Set <- rep("Replication", nrow(vb12_adult_rep_adj))
vb12_adult_rep_adj$Pheno <- rep("VB12", nrow(vb12_adult_rep_adj))
vb12_child_dis_adj$Set <- rep("Discovery", nrow(vb12_child_dis_adj))
vb12_child_dis_adj$Pheno <- rep("VB12", nrow(vb12_child_dis_adj))
vb12_child_rep_adj$Set <- rep("Replication", nrow(vb12_child_rep_adj))
vb12_child_rep_adj$Pheno <- rep("VB12", nrow(vb12_child_rep_adj))

ua_adult_dis_adj <- data.frame(ua_adult_dis_adj, Group=VarCat_nopf[match(ua_adult_dis_adj$Variable, VarCat_nopf$Variable), 2])
ua_adult_rep_adj <- data.frame(ua_adult_rep_adj, Group=VarCat_nopf[match(ua_adult_rep_adj$Variable, VarCat_nopf$Variable), 2])
ua_child_dis_only_adj <- data.frame(ua_child_dis_only_adj, Group=VarCat_nopf[match(ua_child_dis_only_adj$Variable, VarCat_nopf$Variable), 2])
ua_adult_dis_adj$Set <- rep("Discovery", nrow(ua_adult_dis_adj))
ua_adult_dis_adj$Pheno <- rep("UA", nrow(ua_adult_dis_adj))
ua_adult_rep_adj$Set <- rep("Replication", nrow(ua_adult_rep_adj))
ua_adult_rep_adj$Pheno <- rep("UA", nrow(ua_adult_rep_adj))
ua_child_dis_only_adj$Set <- rep("Discovery", nrow(ua_child_dis_only_adj))
ua_child_dis_only_adj$Pheno <- rep("UA", nrow(ua_child_dis_only_adj))

# Output the Variables that Past QC
All_discovery_results <- rbind.data.frame(anemia_adult_dis_adj,hemo_adult_dis_adj,ida_adult_dis_adj,ckda_adult_dis_only_adj,irn_adult_dis_adj,rbf_adult_dis_adj,vb12_adult_dis_adj,ua_adult_dis_adj)

All_discovery_results_Des <- data.frame(All_discovery_results, Description = VarDescription[match(All_discovery_results$Variable, VarDescription$var), 6])

Variable_After_QC_Category = All_discovery_results_Des[,c("Pheno","Variable","Description","Group")]

Variable_After_QC_Category$Population = rep("Adults",nrow(Variable_After_QC_Category))

All_discovery_results_child <- rbind.data.frame(anemia_child_dis_adj,hemo_child_dis_adj,irn_child_dis_adj,rbf_child_dis_adj,vb12_child_dis_adj,ua_child_dis_only_adj)

All_discovery_results_child_Des <- data.frame(All_discovery_results_child, Description = VarDescription[match(All_discovery_results_child$Variable, VarDescription$var), 6])

Variable_After_QC_Category_child = All_discovery_results_child_Des[,c("Pheno","Variable","Description","Group")]

Variable_After_QC_Category_child$Population = rep("Children",nrow(Variable_After_QC_Category_child))

Variable_After_QC_Category = rbind(Variable_After_QC_Category,Variable_After_QC_Category_child)

write.table(Variable_After_QC_Category, file="/Users/Nicen/Desktop/Anemia/Variable_After_QC_Category.txt", sep="\t", quote=FALSE, row.names=FALSE)

#################################
All_results <- rbind.data.frame(anemia_adult_dis_adj,anemia_adult_rep_adj,hemo_adult_dis_adj,hemo_adult_rep_adj,ida_adult_dis_adj,ida_adult_rep_adj,ckda_adult_dis_only_adj,irn_adult_dis_adj,irn_adult_rep_adj,rbf_adult_dis_adj,rbf_adult_rep_adj,vb12_adult_dis_adj,vb12_adult_rep_adj,ua_adult_dis_adj,ua_adult_rep_adj)

All_results_dis <- All_results[All_results$pvalue_FDR < 0.1 & All_results$Set == "Discovery", ]
write.table(All_results_dis, file="/Users/Nicen/Desktop/Anemia/All_results_dis_adults.txt", sep="\t", quote=FALSE, row.names=FALSE)
All_results_rep <- All_results[All_results$pvalue_Bonf < 0.05 & All_results$Set == "Replication", ]
write.table(All_results_rep, file="/Users/Nicen/Desktop/Anemia/All_results_rep_adults.txt", sep="\t", quote=FALSE, row.names=FALSE)

All_results <- rbind.data.frame(All_results_dis,All_results_rep)
completeFun <- function(data, desiredCols) {
  completeVec <- complete.cases(data[, desiredCols])
  return(data[completeVec, ])
} #Function to remove the individuals who have the NA in certain variable
All_results <- completeFun(All_results, "Variable")

All_results <- All_results[,c(17,16,15)]

library(dplyr)
library(tidyr)
df <- All_results %>%
  filter(!is.na(Group)) %>%
  group_by(Pheno,Set,Group) %>%
  tally()

colnames(df) <- c('Pheno','Set',"individual", "value")

df = df %>% arrange(Pheno, Set, value)

df2 <- df %>%
  unite(group, c("Pheno", "Set"))

df2 = df2 %>% arrange(group, value)

data <- df2

data$group <- as.factor(data$group)
levels(data$group)
data$value <- data$value * 2.5

data$group <- df$Pheno
data$group <- as.factor(data$group)
levels(data$group)

# library
library(tidyverse)
library(ggplot2)
# Set a number of 'empty bar' to add at the end of each group
empty_bar <- 3
to_add <- data.frame( matrix(NA, empty_bar*nlevels(data$group), ncol(data)) )
colnames(to_add) <- colnames(data)
to_add$group <- rep(levels(data$group), each=empty_bar)
data <- rbind(data, to_add)
data <- data %>% arrange(group)
#write.table(data, file="/Users/Nicen/Desktop/Anemia/data_adult.txt", sep="\t", quote=FALSE, row.names=FALSE)
data <- read.delim("/Users/Nicen/Desktop/Anemia/data_adult.txt")
data$id <- seq(1, nrow(data))

# Get the name and the y position of each label
label_data <- data
number_of_bar <- nrow(label_data)
angle <- 90 - 360 * (label_data$id-0.5) /number_of_bar     # I substract 0.5 because the letter must have the angle of the center of the bars. Not extreme right(1) or extreme left (0)
label_data$hjust <- ifelse( angle < -90, 1, 0)
label_data$angle <- ifelse(angle < -90, angle+180, angle)

# prepare a data frame for base lines
base_data <- data %>% 
  group_by(group) %>% 
  summarize(start=min(id), end=max(id) - empty_bar) %>% 
  rowwise() %>% 
  mutate(title=mean(c(start, end)))

# prepare a data frame for grid (scales)
grid_data <- base_data
grid_data$end <- grid_data$end[ c( nrow(grid_data), 1:nrow(grid_data)-1)] + 1
grid_data$start <- grid_data$start - 1
grid_data <- grid_data[-1,]

# Make the plot
p <- ggplot(data, aes(x=as.factor(id), y=value, fill=group)) +       # Note that id is a factor. If x is numeric, there is some space between the first bar
  
  geom_bar(aes(x=as.factor(id), y=value, fill=group), stat="identity", alpha=0.5) +
  
  # Add a val=100/75/50/25 lines. I do it at the beginning to make sur barplots are OVER it.
  geom_segment(data=grid_data, aes(x = end, y = 80, xend = start, yend = 80), colour = "grey", alpha=1, size=0.3 , inherit.aes = FALSE ) +
  geom_segment(data=grid_data, aes(x = end, y = 60, xend = start, yend = 60), colour = "grey", alpha=1, size=0.3 , inherit.aes = FALSE ) +
  geom_segment(data=grid_data, aes(x = end, y = 40, xend = start, yend = 40), colour = "grey", alpha=1, size=0.3 , inherit.aes = FALSE ) +
  geom_segment(data=grid_data, aes(x = end, y = 20, xend = start, yend = 20), colour = "grey", alpha=1, size=0.3 , inherit.aes = FALSE ) +
  
  # Add text showing the value of each 100/75/50/25 lines
  annotate("text", x = rep(max(data$id),4), y = c(20, 40, 60, 80), label = c("8", "16", "24", "32") , color="black", size=3 , angle=0, fontface="bold", hjust=1) +
  
  geom_bar(aes(x=as.factor(id), y=value, fill=group), stat="identity", alpha=0.5) +
  ylim(-100,120) +
  theme_minimal() +
  theme(
    legend.position = "none",
    axis.text = element_blank(),
    axis.title = element_blank(),
    panel.grid = element_blank(),
    plot.margin = unit(rep(-1,4), "cm") 
  ) +
  coord_polar() + 
  geom_text(data=label_data, aes(x=id, y=value+10, label=individual, hjust=hjust), color="black", fontface="bold",alpha=0.6, size=2.5, angle= label_data$angle, inherit.aes = FALSE ) +
  
  # Add base line information
  geom_segment(data=base_data, aes(x = start, y = -5, xend = end, yend = -5), colour = "black", alpha=0.8, size=0.6 , inherit.aes = FALSE )  +
  geom_text(data=base_data, aes(x = title, y = -18, label=group), hjust=c(0.5,0.5,0.7,0.7,0.5,0,0,0), colour = "black", alpha=0.8, size=4, fontface="bold", inherit.aes = FALSE)

p


##############################

All_results <- rbind.data.frame(anemia_child_dis_adj,anemia_child_rep_adj,hemo_child_dis_adj,hemo_child_rep_adj,irn_child_dis_adj,irn_child_rep_adj,rbf_child_dis_adj,rbf_child_rep_adj,vb12_child_dis_adj,vb12_child_rep_adj,ua_child_dis_only_adj)

All_results_dis <- All_results[All_results$pvalue_FDR < 0.1 & All_results$Set == "Discovery", ]
write.table(All_results_dis, file="/Users/Nicen/Desktop/Anemia/All_results_dis_children.txt", sep="\t", quote=FALSE, row.names=FALSE)
All_results_rep <- All_results[All_results$pvalue_Bonf < 0.05 & All_results$Set == "Replication", ]
write.table(All_results_rep, file="/Users/Nicen/Desktop/Anemia/All_results_rep_children.txt", sep="\t", quote=FALSE, row.names=FALSE)

All_results <- rbind.data.frame(All_results_dis,All_results_rep)
completeFun <- function(data, desiredCols) {
  completeVec <- complete.cases(data[, desiredCols])
  return(data[completeVec, ])
} #Function to remove the individuals who have the NA in certain variable
All_results <- completeFun(All_results, "Variable")

All_results <- All_results[,c(17,16,15)]

library(dplyr)
df <- All_results %>%
  filter(!is.na(Group)) %>%
  group_by(Pheno,Set,Group) %>%
  tally()

colnames(df) <- c('Pheno','Set',"individual", "value")

df = df %>% arrange(Pheno, Set, value)

df2 <- df %>%
  unite(group, c("Pheno", "Set"))

df2 = df2 %>% arrange(group, value)

data <- df2
data$group <- as.factor(data$group)
levels(data$group)
data$value <- data$value * 5
data$group <- df$Pheno
data$group <- as.factor(data$group)
levels(data$group)


# library
library(tidyverse)
library(ggplot2)
# Set a number of 'empty bar' to add at the end of each group
empty_bar <- 3
to_add <- data.frame( matrix(NA, empty_bar*nlevels(data$group), ncol(data)) )
colnames(to_add) <- colnames(data)
to_add$group <- rep(levels(data$group), each=empty_bar)
data <- rbind(data, to_add)
data <- data %>% arrange(group)
#write.table(data, file="/Users/Nicen/Desktop/Anemia/data_child.txt", sep="\t", quote=FALSE, row.names=FALSE)
data <- read.delim("/Users/Nicen/Desktop/Anemia/data_child.txt")
data$id <- seq(1, nrow(data))

# Get the name and the y position of each label
label_data <- data
number_of_bar <- nrow(label_data)
angle <- 90 - 360 * (label_data$id-0.5) /number_of_bar     # I substract 0.5 because the letter must have the angle of the center of the bars. Not extreme right(1) or extreme left (0)
label_data$hjust <- ifelse( angle < -90, 1, 0)
label_data$angle <- ifelse(angle < -90, angle+180, angle)

# prepare a data frame for base lines
base_data <- data %>% 
  group_by(group) %>% 
  summarize(start=min(id), end=max(id) - empty_bar) %>% 
  rowwise() %>% 
  mutate(title=mean(c(start, end)))

# prepare a data frame for grid (scales)
grid_data <- base_data
grid_data$end <- grid_data$end[ c( nrow(grid_data), 1:nrow(grid_data)-1)] + 1
grid_data$start <- grid_data$start - 1
grid_data <- grid_data[-1,]

# Make the plot
p <- ggplot(data, aes(x=as.factor(id), y=value, fill=group)) +       # Note that id is a factor. If x is numeric, there is some space between the first bar
  
  geom_bar(aes(x=as.factor(id), y=value, fill=group), stat="identity", alpha=0.5) +
  
  # Add a val=100/75/50/25 lines. I do it at the beginning to make sur barplots are OVER it.
  geom_segment(data=grid_data, aes(x = end, y = 80, xend = start, yend = 80), colour = "grey", alpha=1, size=0.3 , inherit.aes = FALSE ) +
  geom_segment(data=grid_data, aes(x = end, y = 60, xend = start, yend = 60), colour = "grey", alpha=1, size=0.3 , inherit.aes = FALSE ) +
  geom_segment(data=grid_data, aes(x = end, y = 40, xend = start, yend = 40), colour = "grey", alpha=1, size=0.3 , inherit.aes = FALSE ) +
  geom_segment(data=grid_data, aes(x = end, y = 20, xend = start, yend = 20), colour = "grey", alpha=1, size=0.3 , inherit.aes = FALSE ) +
  
  # Add text showing the value of each 100/75/50/25 lines
  annotate("text", x = rep(max(data$id),4), y = c(20, 40, 60, 80), label = c("4", "8", "12", "16") , color="black", size=3 , angle=0, fontface="bold", hjust=1) +
  
  geom_bar(aes(x=as.factor(id), y=value, fill=group), stat="identity", alpha=0.5) +
  ylim(-100,120) +
  theme_minimal() +
  theme(
    legend.position = "none",
    axis.text = element_blank(),
    axis.title = element_blank(),
    panel.grid = element_blank(),
    plot.margin = unit(rep(-1,4), "cm") 
  ) +
  coord_polar() + 
  geom_text(data=label_data, aes(x=id, y=value+10, label=individual, hjust=hjust), color="black", fontface="bold",alpha=0.6, size=2.5, angle= label_data$angle, inherit.aes = FALSE ) +
  
  # Add base line information
  geom_segment(data=base_data, aes(x = start, y = -5, xend = end, yend = -5), colour = "black", alpha=0.8, size=0.6 , inherit.aes = FALSE )  +
  geom_text(data=base_data, aes(x = title, y = -18, label=group), hjust=c(0.5,0.7,0.6,0.6,0.5), colour = "black", alpha=0.8, size=4, fontface="bold", inherit.aes = FALSE)

p




################
VarDescription <- read.csv("/Users/Nicen/Desktop/Anemia/Data/VarDescription.csv")
vardes <- VarDescription[,c(5,6)]
library(tidyverse)
vardes <- vardes %>% distinct(var, .keep_all = TRUE)
colnames(vardes) <- c("Variable", 'VarDes')

All_results <- rbind.data.frame(anemia_adult_dis_adj,anemia_adult_rep_adj,hemo_adult_dis_adj,hemo_adult_rep_adj,ida_adult_dis_adj,ida_adult_rep_adj,ckda_adult_dis_only_adj,irn_adult_dis_adj,irn_adult_rep_adj,rbf_adult_dis_adj,rbf_adult_rep_adj,vb12_adult_dis_adj,vb12_adult_rep_adj,ua_adult_dis_adj,ua_adult_rep_adj)
All_results <- All_results[All_results$pvalue_Bonf < 0.05 & All_results$Set == "Replication", ]
All_results <- All_results[,c(17,16,15,1,5)]
completeFun <- function(data, desiredCols) {
  completeVec <- complete.cases(data[, desiredCols])
  return(data[completeVec, ])
} #Function to remove the individuals who have the NA in certain variable
All_results <- completeFun(All_results, "Beta")

library(dplyr)
All_results <- All_results %>% arrange(Group)
df1 <- All_results[,c(1,3,5)]
df1$Beta <- as.character(df1$Beta)
df1$Beta[df1$Beta == "None"] <- "0.01"
df1$Beta <- as.numeric(df1$Beta)
df1 <- completeFun(df1, "Group")

df2 <- All_results[,c(1,4,5)]  
df2$Beta <- as.character(df2$Beta)
df2$Beta[df2$Beta == "None"] <- "0.01"
df2$Beta <- as.numeric(df2$Beta) 

library(plyr)
df2_t <- join(df2, vardes, by = 'Variable')
df2 <- df2_t[,c(1,4,3)]
colnames(df2)[2] <- 'Variable'

library(circlize)

# Make the circular plot

chordDiagram(df1, transparency = 0.5,annotationTrack = c("grid"),preAllocateTracks = list(track.height = max(strwidth(unlist(dimnames(df1))))), big.gap = 20, small.gap = 3)
circos.track(track.index = 1, panel.fun = function(x, y) {
  circos.text(cex=1,font=2, CELL_META$xcenter, CELL_META$ylim[1], CELL_META$sector.index, 
              facing = "clockwise", niceFacing = TRUE, adj = c(0, 0.5))
}, bg.border = NA) # here set bg.border to NA is important
circos.clear()

chordDiagram(df2, transparency = 0.25,annotationTrack = c("grid"),preAllocateTracks = 2, big.gap = 20, small.gap = 3)
circos.track(track.index = 2, panel.fun = function(x, y) {
  circos.text(cex=0.7, font=2, CELL_META$xcenter, CELL_META$ylim[1], CELL_META$sector.index, 
              facing = "clockwise", niceFacing = TRUE, adj = c(0, 0.5))
}, bg.border = NA) # here set bg.border to NA is important

#b <- All_results[All_results$Group == "cotinine",]
#c <- All_results[All_results$Group == "food component recall",]
#d <- All_results[All_results$Group == "heavy metals",]
#e <- All_results[All_results$Group == "nutrients",]

#highlight.sector(b$Variable, track.index = 1, col = "orchid2", niceFacing = TRUE)
#highlight.sector(c$Variable, track.index = 1, col = "palegreen4", niceFacing = TRUE)
#highlight.sector(d$Variable, track.index = 1, col = "palevioletred4", niceFacing = TRUE)
#highlight.sector(e$Variable, track.index = 1, col = "yellowgreen", niceFacing = TRUE)

circos.clear()


# Flow Plots
library(networkD3)
adult_condensed_results <- df2
adult_freq = as.data.frame(table(adult_condensed_results$Pheno))
adult_sec_layer <- data.frame(
  Pheno=c(rep("Adult",nrow(adult_freq))), 
  Variable=adult_freq$Var1, 
  Beta=c(adult_freq$Freq),
  category = c(rep("Adult",nrow(adult_freq)))
)
adult_sec_layer = NULL

category =  VarDescription[,c(6,36)]
colnames(category)[1] = "Variable"
adult_condensed_final = merge(adult_condensed_results,category,by = c("Variable"))
adult_condensed_final <- rbind.data.frame(adult_condensed_final,adult_sec_layer)
adult_condensed_final <- adult_condensed_final[!duplicated(adult_condensed_final),]

##############################
All_results <- rbind.data.frame(anemia_child_dis_adj,anemia_child_rep_adj,hemo_child_dis_adj,hemo_child_rep_adj,irn_child_dis_adj,irn_child_rep_adj,rbf_child_dis_adj,rbf_child_rep_adj,vb12_child_dis_adj,vb12_child_rep_adj,ua_child_dis_only_adj)
All_results <- All_results[All_results$pvalue_Bonf < 0.05 & All_results$Set == "Replication", ]
All_results <- All_results[,c(17,16,15,1,5)]
completeFun <- function(data, desiredCols) {
  completeVec <- complete.cases(data[, desiredCols])
  return(data[completeVec, ])
} #Function to remove the individuals who have the NA in certain variable
All_results <- completeFun(All_results, "Beta")
library(dplyr)
All_results <- All_results %>% arrange(Group)
df1 <- All_results[,c(1,3,5)]
df2 <- All_results[,c(1,4,5)]  

library(plyr)
df2_t <- join(df2, vardes, by = 'Variable')
df2 <- df2_t[,c(1,4,3)]
colnames(df2)[2] <- 'Variable'

chordDiagram(df1, transparency = 0.5,annotationTrack = c("grid"),preAllocateTracks = list(track.height = max(strwidth(unlist(dimnames(df1))))), big.gap = 20, small.gap = 3)
circos.track(track.index = 1, panel.fun = function(x, y) {
  circos.text(cex=1,font=2, CELL_META$xcenter, CELL_META$ylim[1], CELL_META$sector.index, 
              facing = "clockwise", niceFacing = TRUE, adj = c(0, 0.5))
}, bg.border = NA) # here set bg.border to NA is important
circos.clear()

chordDiagram(df2, transparency = 0.25,annotationTrack = c("grid"),preAllocateTracks = 2, big.gap = 20, small.gap = 3)
circos.track(track.index = 2, panel.fun = function(x, y) {
  circos.text(cex=0.7, font=2, CELL_META$xcenter, CELL_META$ylim[1], CELL_META$sector.index, 
              facing = "clockwise", niceFacing = TRUE, adj = c(0, 0.5))
}, bg.border = NA) # here set bg.border to NA is important

#c <- All_results[All_results$Group == "food component recall",]
#d <- All_results[All_results$Group == "heavy metals",]
#e <- All_results[All_results$Group == "nutrients",]
#g <- All_results[All_results$Group == "supplement use",]

#highlight.sector(c$Variable, track.index = 1, col = "indianred3",
#                niceFacing = TRUE)
#highlight.sector(d$Variable, track.index = 1, col = "darkorange4", 
#                niceFacing = TRUE)
#highlight.sector(e$Variable, track.index = 1, col = "hotpink3",
#                niceFacing = TRUE)
#highlight.sector(g$Variable, track.index = 1, col = "black", 
#                niceFacing = TRUE)

circos.clear()

# Flow Plots
library(networkD3)
child_condensed_results <- df2
child_freq = as.data.frame(table(child_condensed_results$Pheno))
child_sec_layer <- data.frame(
  Pheno=c(rep("Childern",nrow(child_freq))), 
  Variable=child_freq$Var1, 
  Beta=c(child_freq$Freq),
  category = c(rep("Childern",nrow(child_freq)))
)

child_sec_layer = NULL

child_condensed_final = merge(child_condensed_results,category,by = c("Variable"),all.x = TRUE)
child_condensed_final <- child_condensed_final[!duplicated(child_condensed_final),]
colnames(child_condensed_final) = c("Variable","Pheno","Beta","category")
child_condensed_final <- rbind.data.frame(child_condensed_final,child_sec_layer)

condensed_final <- rbind.data.frame(adult_condensed_final,child_condensed_final)
write.table(condensed_final, file="condensed_final.txt", sep="\t", quote=FALSE, row.names=FALSE)

# From these flows we need to create a node data frame: it lists every entities involved in the flow
nodes <- data.frame(
  name=c(as.character(condensed_final$Pheno), 
         as.character(condensed_final$Variable)) %>% unique()
)

node.category = category
colnames(node.category)[1] = "name"
test.node = merge(nodes,node.category,by = "name", all.x = TRUE)
test.node = test.node[!duplicated(test.node$name),]
test.node = merge(nodes,test.node,by = "name", all.x = TRUE)
All_results <- rbind.data.frame(anemia_child_dis_adj,anemia_child_rep_adj,hemo_child_dis_adj,hemo_child_rep_adj,irn_child_dis_adj,irn_child_rep_adj,rbf_child_dis_adj,rbf_child_rep_adj,vb12_child_dis_adj,vb12_child_rep_adj,ua_child_dis_only_adj)
write.table(test.node, file="test.node.txt", sep="\t", quote=FALSE, row.names=FALSE)

test.node.modifed <- read.delim("~/Desktop/Anemia/test.node.modifed.txt", comment.char="#")
unique(test.node.modifed$category)
test.node.modifed$color[test.node.modifed$category == "AC"] = "red"
test.node.modifed$color[test.node.modifed$category == "nutrients"] = "#999999"
test.node.modifed$color[test.node.modifed$category == "food component recall"] = "#E69F00"
test.node.modifed$color[test.node.modifed$category == "AN"] = "cyan1"
test.node.modifed$color[test.node.modifed$category == "heavy metals"] = "#56B4E9"
test.node.modifed$color[test.node.modifed$category == "supplement use"] = "#009E73"
test.node.modifed$color[test.node.modifed$category == "cotinine"] = "#F0E442"
test.node.modifed$color[test.node.modifed$category == "smoking behavior"] = "#0072B2"
test.node.modifed$color[test.node.modifed$category == "alcohol use"] = "#D55E00"
test.node.modifed$color[test.node.modifed$category == "smoking family"] = "#CC79A7"
test.node.modifed$color[test.node.modifed$category == "phthalates"] = "#9999CC"
test.node.modifed$color[test.node.modifed$category == "pharmaceutical"] = "#66CC99"

test.node.final = merge(nodes,test.node.modifed,by = "name", all.x = TRUE)
test.node.final[is.na(test.node.final)] <- "grey"

# With networkD3, connection must be provided using id, not using real name like in the child_condensed_final dataframe.. So we need to reformat it.
condensed_final$IDsource <- match(condensed_final$Pheno, nodes$name)-1 
condensed_final$IDtarget <- match(condensed_final$Variable, nodes$name)-1
condensed_final$Beta <- abs(as.numeric(condensed_final$Beta))

links = condensed_final[,c(5,6,3)]

# Turn it into igraph object
library(igraph)
network <- graph_from_data_frame(d=condensed_final, directed=F) 
network.name = as.data.frame(V(network)$name)
test.node.final = test.node.final[order(match(test.node.final[,1],network.name[,1])),]
plot(network,vertex.label.cex = 0.3,vertex.size=2,vertex.label.color="black",vertex.color = test.node.final$color, vertex.frame.color = "white")
```

```{r}
sessionInfo()
```